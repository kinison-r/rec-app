<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è¡Œå‹•ãƒ­ã‚°</title>
  <meta name="theme-color" content="#28a745">
  
  <!-- ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ (Data URIã§åŸ‹ã‚è¾¼ã¿) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzI4YTc0NSIgcng9IjY0IiByeT0iNjQiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSJib2xkIiBmb250LXNpemU9IjI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zNWVtIiBmaWxsPSJ3aGl0ZSI+5YGlPC90ZXh0Pjwvc3ZnPg==">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzI4YTc0NSIgcng9IjY0IiByeT0iNjQiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSJib2xkIiBmb250LXNpemU9IjI1MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zNWVtIiBmaWxsPSJ3aGl0ZSI+5YGlPC90ZXh0Pjwvc3ZnPg==">

  <!-- Chart.js & Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- Cropper.js (ç”»åƒç·¨é›†) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    /* â–¼â–¼â–¼ è¿½åŠ : ãƒ†ãƒ¼ãƒç”¨CSSå¤‰æ•° â–¼â–¼â–¼ */
    :root {
      --bg-body: #f0f2f5;
      --text-main: #333;
      --text-sub: #555;
      --bg-card: #fff;
      --bg-input: #fcfcfc;
      --border-color: #ddd;
      --nav-bg: #f0f2f5;
    }
    body.dark-mode {
      --bg-body: #1a1a1a;      /* èƒŒæ™¯ã‚’çœŸã£é»’ã‹ã‚‰å°‘ã—æ˜ã‚‹ã */
      --text-main: #cccccc;    /* ãƒ†ã‚­ã‚¹ãƒˆã®ç™½ã‚’å°‘ã—æŠ‘ãˆã€ç›®ã«å„ªã—ã */
      --text-sub: #999999;     /* ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆã‚‚èª¿æ•´ */
      --bg-card: #282828;      /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ */
      --bg-input: #181818;     /* å…¥åŠ›æ¬„ã®èƒŒæ™¯ã‚’æš—ã */
      --border-color: #484848; /* å¢ƒç•Œç·šã®è‰²ã‚’èª¿æ•´ */
      --nav-bg: #282828;      /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã‚’ã‚«ãƒ¼ãƒ‰ã¨çµ±ä¸€ */
    }
    /* â–²â–²â–² è¿½åŠ  â–²â–²â–² */
    body {
      background: #8b67f7;
      background: var(--bg-body);
      padding-bottom: 80px;
      color: #333;
      color: var(--text-main);
      line-height: 1.4;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 10px;
    }
    /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºç”¨ */
    .header-bar {
      display: flex;
      justify-content: flex-end;
      padding: 2px 10px;
    }
    #ver-tag {
      font-size: 10px;
      color: #999;
      font-weight: bold;
      background: #e0e0e0;
      padding: 1px 6px;
      border-radius: 10px;
    }
    /* â–¼â–¼â–¼ è¿½åŠ : ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£CSSã‚¯ãƒ©ã‚¹ â–¼â–¼â–¼ */
    .d-flex { display: flex; }
    .d-grid { display: grid; }
    .gap-1 { gap: 5px; }
    .gap-2 { gap: 10px; }
    .mt-1 { margin-top: 5px; }
    .mt-2 { margin-top: 10px; }
    .mb-1 { margin-bottom: 5px; }
    .mb-2 { margin-bottom: 10px; }
    .p-2 { padding: 10px; }
    .align-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .flex-1 { flex: 1; }
    .flex-2 { flex: 2; }
    .text-right { text-align: right; }
    .w-auto { width: auto; }
    /* â–²â–²â–² è¿½åŠ  â–²â–²â–² */
    
    .card {
      background: #fff;
      background: var(--bg-card);
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: 1px solid transparent; /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å¢ƒç•Œç·šç”¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ */
    }
    body.dark-mode .card { border-color: var(--border-color); }
    .nav {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 600px;
      background: #f0f2f5;
      background: var(--nav-bg);
      padding: 5px 10px;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .nav button {
      padding: 10px 0;
      font-size: 11px;
      border: none;
      border-radius: 8px;
      background: #6c757d;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    .nav button.active {
      background: #007bff;
      box-shadow: 0 2px 4px rgba(0,123,255,0.4);
    }
    .container { padding-top: 60px; }
    .main-sel {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #007bff;
      border-radius: 10px;
      background: #fff;
      background: var(--bg-card);
      color: var(--text-main);
      margin-bottom: 15px;
      font-weight: bold;
    }
    #sel-in {
      background: rgba(255, 255, 255, 0.3);
    }
    body.dark-mode #sel-in { background: rgba(255, 255, 255, 0.1); color: #fff; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      background: #fcfcfc;
      background: var(--bg-input);
      color: var(--text-main);
      overflow-y: hidden; /* è‡ªå‹•èª¿æ•´ã®ãŸã‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
    }
    .btn-main {
      width: 100%;
      padding: 16px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
    }
    .btn-sub {
      background: #6c757d;
      color: #fff;
      padding: 6px 10px;
      border-radius: 5px;
      border: none;
      font-size: 11px;
      cursor: pointer;
    }
    .rec-row {
      background: #fff;
      background: var(--bg-card);
      margin-top: 5px;
      display: flex;
      border-radius: 8px;
      border-bottom: 1px solid #eee;
      border-bottom: 1px solid var(--border-color);
      overflow: hidden;
    }
    .rec-body {
      flex: 1;
      padding: 12px;
      text-align: left;
      border: none;
      background: none;
      color: var(--text-main);
      cursor: pointer;
    }
    .del-btn {
      background: #ff4d4d;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 11px;
      /* â†“â†“ å¤‰æ›´/è¿½åŠ  â†“â†“ */
      align-self: center; /* è¦ªã®é«˜ã•ã«ä¼¸ã³ãšã€å‚ç›´æ–¹å‘ã«ä¸­å¤®æƒãˆã«ã™ã‚‹ */
      padding: 6px 12px;  /* ä½™ç™½ã‚’èª¿æ•´ã—ã¦é«˜ã•ã‚’æŠ‘ãˆã‚‹ */
      border-radius: 6px; /* è§’ã‚’å°‘ã—ä¸¸ã‚ã‚‹ */
      margin-right: 5px;  /* å³ç«¯ã«å°‘ã—ä½™ç™½ã‚’ä½œã‚‹ */
    }
    .cat-tag {
      background: #cfe2ff;
      color: #084298;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      margin-right: 8px;
      font-weight: bold;
    }
    .field-tag {
      display: inline-block;
      background: #f1f3f5;
      color: #495057;
      padding: 4px 8px;
      border-radius: 16px;
      font-size: 12px;
      margin: 4px 4px 0 0;
      white-space: pre-wrap; /* æ”¹è¡Œã‚’åæ˜  */
      word-break: break-word; /* é•·ã„å˜èªã§æŠ˜ã‚Šè¿”ã— */
    }
    .field-tag b {
      color: #212529;
      margin-right: 5px;
    }
    label {
      display: block;
      font-size: 12px;
      font-weight: bold;
      color: #444;
      color: var(--text-sub);
      margin-top: 8px;
    }
    .section-title {
      font-size: 15px;
      border-left: 5px solid #007bff;
      padding-left: 10px;
      margin-bottom: 10px;
    }
    @media print {
      @page {
        margin-left: 1.5cm;
        margin-bottom: 1.5cm;
        counter-increment: page;
        @bottom-right { content: counter(page) " / " counter(pages); font-size: 8px; color: #666; vertical-align: top; }
      }
      .nav, .header-bar, #modal-overlay, .btn-sub, .no-print, .pagination-controls, details { display: none !important; }
      body, .container, .card { background: #fff !important; color: #000 !important; width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; border: none !important; }
      
      /* è¦ªã‚³ãƒ³ãƒ†ãƒŠã¯è¡¨ç¤º */
      #s-analysis, #s-stock { display: block !important; }
      /* ç›´ä¸‹ã®å­è¦ç´ ã¯ä¸€æ—¦ã™ã¹ã¦éè¡¨ç¤º */
      #s-analysis > *, #s-stock > * { display: none !important; }

      /* ã‚¯ãƒ©ã‚¹ã«å¿œã˜ã¦è¡¨ç¤º */
      body.print-mode-meal #meal-report-area { display: block !important; }
      body.print-mode-cal #cal-area { display: block !important; }
      body.print-mode-poop #poop-chart-area { display: block !important; }
      body.print-mode-mylan #mylan-chart-area { display: block !important; }
      body.print-mode-stock #stock-print-area { display: block !important; }
      body.print-mode-cross #cross-analysis-area { display: block !important; }
      
      /* æ¨ªæ–­åˆ†æç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
      .cross-top-scroll { overflow-x: auto; overflow-y: hidden; border: 1px solid #ddd; border-bottom: none; height: 20px; width: 100%; }
      .cross-top-scroll-content { height: 1px; }
      .cross-table-container { overflow: auto; max-height: 60vh; border: 1px solid #ddd; position: relative; }
      .resizer {
        position: absolute; top: 0; right: -2px; width: 5px; cursor: col-resize; user-select: none; height: 100%; z-index: 100;
      }
      .resizer:hover, .resizing { background-color: #007bff; }
      /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ */
      #cross-analysis-table th { position: relative; }
      /* å°åˆ·æ™‚ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ãªã©ã‚’éš ã™ */
      @media print { .cross-top-scroll, .resizer { display: none !important; } .cross-table-container { overflow: visible !important; max-height: none !important; } }
      
      #cal-month { border: none; appearance: none; background: none; font-weight: bold; font-size: 14px; }
      .print-only { display: block !important; }
    }
    .print-only { display: none; }
    /* ãƒªã‚¹ãƒˆç·¨é›†ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .list-edit-row { display: flex; gap: 5px; margin-bottom: 5px; }
    .list-edit-row input, .list-edit-row textarea { margin: 0; flex: 1; }
    .list-edit-row button { width: auto; padding: 0 10px; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    .list-add-row { display: flex; gap: 5px; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
    /* è‡ªå‹•å…¥åŠ›ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes highlightFade {
      0% { background-color: #fff3cd; border-color: #ffc107; box-shadow: 0 0 8px rgba(255, 193, 7, 0.6); transform: scale(1.02); }
      100% { background-color: #fcfcfc; border-color: #ddd; box-shadow: none; transform: scale(1); }
    }
    .highlight-change {
      animation: highlightFade 1.0s ease-out;
    }
    /* ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
    .scroll-top-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      background: rgba(0, 123, 255, 0.6);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 1500;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.3s;
    }
    .scroll-top-btn:hover {
      background: rgba(0, 123, 255, 0.9);
    }
    .scroll-to-save-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 45px;
      height: 45px;
      background: rgba(40, 167, 69, 0.6);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 1500;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.3s;
    }
    .scroll-to-save-btn:hover {
      background: rgba(40, 167, 69, 0.9);
    }
    @media print { .scroll-top-btn { display: none !important; } }
    @media print { .scroll-to-save-btn { display: none !important; } }
  </style>
  <style>
    .pagination-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-top: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .pagination-controls button { padding: 8px 12px; }
    .pagination-controls span { font-size: 14px; font-weight: bold; color: #555; }
  </style>
  <!-- ã‚¨ãƒ©ãƒ¼ç›£è¦–ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚ˆã‚Šå…ˆã«èª­ã¿è¾¼ã‚€ï¼‰ -->
  <script>
    function showCopyableError(title, errorDetails) {
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');
      const modalOverlay = document.getElementById('modal-overlay');

      if (modalTitle && modalBody && modalOverlay) {
        modalTitle.innerText = title;
        modalBody.innerHTML = `
          <p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é–‹ç™ºè€…ã«ä»¥ä¸‹ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å ±å‘Šã—ã¦ãã ã•ã„ã€‚</p>
          <textarea readonly style="width:100%; height:150px; margin-top:10px; font-family:monospace; font-size:12px; white-space:pre; word-wrap:break-word;">${errorDetails}</textarea>
        `;
        modalOverlay.style.display = 'flex';
      } else {
        alert(`ã€${title}ã€‘\n${errorDetails}`);
      }
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    window.onerror = function(msg, url, line, col, error) {
      const errorText = `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${msg}\nURL: ${url}\nè¡Œ: ${line}\nåˆ—: ${col}\nã‚¨ãƒ©ãƒ¼: ${error ? error.stack : 'N/A'}`;
      showCopyableError('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼', errorText);

      const loadingMsg = document.getElementById('loading-msg');
      if (loadingMsg) {
        loadingMsg.innerHTML += '<br><span style="color:red">ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ' + msg + '</span>';
      }
      return true; // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’æŠ‘åˆ¶
    };
  </script>
</head>
<body>

<div class="container">
  <div class="header-bar">
    <span id="ver-tag"></span>
  </div>

  <!-- èª­ã¿è¾¼ã¿çŠ¶æ…‹ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="loading-msg" style="padding:20px; text-align:center; font-weight:bold; color:#666;">
    ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...<br>
    <button onclick="idb.clear().then(()=>{localStorage.clear();location.reload()})" style="margin-top:20px; padding:10px; background:#dc3545; color:white; border:none; border-radius:5px;">ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿æ¶ˆå»ï¼‰</button>
  </div>

  <div class="nav" id="main-nav">
    <button data-view="input" id="b-input" class="active">è¨˜éŒ²</button>
    <button data-view="search" id="b-search">æ¤œç´¢</button>
    <button data-view="analysis" id="b-analysis">åˆ†æ</button>
    <button data-view="maint" id="b-maint">ä¿å®ˆ</button>
  </div>

  <div id="s-input" style="display:none">
    <div class="d-flex gap-1 mb-2" style="align-items: stretch;">
      <select id="sel-in" class="main-sel" style="margin-bottom:0; flex:1;" onchange="st.cur=this.value; cancelEdit(); r(); focusFirstInput();"></select>
      <button id="btn-mic-cat" class="btn-sub" style="width:50px; background:#17a2b8; font-size:20px; border-radius:10px; padding:0; display:flex; align-items:center; justify-content:center;" onclick="startCatVoiceInput()">ğŸ¤</button>
    </div>
    <div id="form-in"></div>
    <div id="list-in"></div>
    <div id="pagination-in" class="pagination-controls"></div>
  </div>

  <div id="s-search" style="display:none">
    <div class="card">
      <h2 class="section-title">è¨˜éŒ²æ¤œç´¢</h2>
      <!-- â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢ã‚¨ãƒªã‚¢ â–¼â–¼â–¼ -->
      <div style="background:#e7f1ff; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #b6d4fe;">
        <div style="font-size:12px; font-weight:bold; color:#0056b3; margin-bottom:5px;">ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢</div>
        <div class="d-flex gap-2 align-center" style="flex-wrap:wrap;">
           <button class="btn-sub" style="background:#17a2b8; color:white; flex:1; white-space:nowrap; padding:8px;" onclick="searchFutureRecords()">ğŸ“… äºˆå®šãƒ»æœªæ¥ (æœ¬æ—¥ä»¥é™)</button>
           <div class="d-flex align-center gap-1" style="flex:1; background:#fff; padding:4px 8px; border-radius:5px; border:1px solid #ddd;">
             <span style="font-size:12px; white-space:nowrap; color:#333; font-weight:bold;">å¿˜ã‚Œã¦ãªã„ï¼Ÿ</span>
             <input type="number" id="past-days-input" value="1" min="1" style="width:40px; padding:5px; text-align:center; margin:0; border:1px solid #eee; border-radius:3px; font-size:12px;">
             <span style="font-size:10px; white-space:nowrap; color:#666;">æ—¥å‰ã€œ</span>
             <button class="btn-sub" style="background:#fd7e14; color:white; padding:4px 10px;" onclick="checkForgottenItems()">ç¢ºèª</button>
           </div>
        </div>
      </div>
      <!-- â–²â–²â–² è¿½åŠ  â–²â–²â–² -->
      <div class="d-grid gap-2 mb-2">
        <select id="srch-cat" style="margin:0; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; background:#fcfcfc;"><option value="">å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼</option></select>
        <input type="text" id="srch" list="srch-datalist" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§çµã‚Šè¾¼ã¿..." style="margin:0;">
        <div class="d-flex align-center gap-2" style="background:#f8f9fa; padding: 8px; border-radius: 5px; margin: 0;">
          <span style="font-size:12px; font-weight:bold; color:#555; width:auto;">æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰:</span>
          <label style="font-size:13px; cursor:pointer; margin:0; display:flex; align-items:center; gap:4px;"><input type="radio" name="search-mode" value="and" checked style="width:auto; margin:0;"> AND (ã™ã¹ã¦å«ã‚€)</label>
          <label style="font-size:13px; cursor:pointer; margin:0; display:flex; align-items:center; gap:4px;"><input type="radio" name="search-mode" value="or" style="width:auto; margin:0;"> OR (ã„ãšã‚Œã‹ã‚’å«ã‚€)</label>
        </div>
        <datalist id="srch-datalist"></datalist>
        <div id="srch-history-area" style="min-width:0;"></div>
        <input type="text" id="srch-not" list="srch-not-datalist" placeholder="é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (NOT)..." style="margin:0; background:#fff0f0; border-color:#ffcccc;">
        <datalist id="srch-not-datalist"></datalist>
        <div id="srch-not-history-area" style="min-width:0;"></div>
        <div style="display:flex; flex-wrap:wrap; gap:10px;">
            <div style="flex:1; min-width:130px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label for="anlz-start-date" style="margin-top:0;">é–‹å§‹æ—¥</label>
                    <button class="btn-sub" style="padding:2px 6px; font-size:10px; width:auto;" onclick="document.getElementById('anlz-start-date').value=formatDateYMD(new Date())">ä»Šæ—¥</button>
                </div>
                <input type="date" id="anlz-start-date" style="margin:0; padding:8px; width:100%;">
            </div>
            <div style="flex:1; min-width:130px;">
                <label for="anlz-end-date" style="margin-top:0;">çµ‚äº†æ—¥</label>
                <input type="date" id="anlz-end-date" style="margin:0; padding:8px; width:100%;">
            </div>
        </div>
        <div class="d-flex align-center gap-2" style="background:#f8f9fa; padding: 8px; border-radius: 5px; margin: 0;">
          <span style="font-size:12px; font-weight:bold; color:#555; width:auto;">ä¸¦ã³é †:</span>
          <label style="font-size:13px; cursor:pointer; margin:0; display:flex; align-items:center; gap:4px;"><input type="radio" name="sort-order" value="desc" checked style="width:auto; margin:0;"> æ–°ã—ã„é † (é™é †)</label>
          <label style="font-size:13px; cursor:pointer; margin:0; display:flex; align-items:center; gap:4px;"><input type="radio" name="sort-order" value="asc" style="width:auto; margin:0;"> å¤ã„é † (æ˜‡é †)</label>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn-main flex-2" onclick="rAnlz(true, true)" style="margin:0; background:#007bff;">æ¤œç´¢</button>
        <button class="btn-main flex-1" onclick="clearSearch()" style="margin:0; background:#6c757d;">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div id="list-anlz"></div>
    <div id="pagination-anlz" class="pagination-controls"></div>
  </div>

  <div id="s-analysis" style="display:none">
    <div class="card">
      <h2 class="section-title">åˆ†æ</h2>
      
      <details id="stock-details" style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;" ontoggle="if(this.open) rStock()">
        <summary style="font-weight:bold; cursor:pointer;">åœ¨åº«ç®¡ç†</summary>
        <div class="mt-2">
          <div id="list-stock"></div>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">ãƒ‡ãƒ¼ã‚¿åˆ†æ (çµ±åˆ)</summary>
        <div class="mt-2">
          <!-- ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† -->
          <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
             <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ (å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«)</div>
             <input type="file" id="ext-csv-file" accept=".csv,text/csv,text/plain,application/vnd.ms-excel" onchange="loadExtCSV(this)" onclick="this.value=null" style="font-size:12px;">
             <button class="btn-sub" onclick="addExtFileFromPicker()" style="background:#17a2b8; margin-left:5px;">ï¼‹ ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ </button>
             <div id="ext-file-list" style="margin-top:5px; max-height:100px; overflow-y:auto; border:1px solid #ddd; padding:5px; background:#f9f9f9; display:none;"></div>
          </div>

          <!-- é …ç›®é¸æŠ -->
          <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">åˆ†æå¯¾è±¡é …ç›®ã‚’é¸æŠ (å†…éƒ¨ãƒ»å¤–éƒ¨)</div>
          <div style="padding:5px; background:#f8f9fa; border:1px solid #ddd; border-radius:4px; margin-bottom:10px;">
             <div style="text-align:right; margin-bottom:5px;">
               <button class="btn-sub" onclick="toggleAllAnalysisItems(true)">å…¨é¸æŠ</button>
               <button class="btn-sub" onclick="toggleAllAnalysisItems(false)">å…¨è§£é™¤</button>
             </div>
             <div id="analysis-item-selector" style="max-height:300px; overflow-y:auto;"></div>
          </div>

          <!-- è¨­å®š -->
          <div class="d-flex align-center gap-1 mt-2" style="flex-wrap:wrap;">
             <label style="font-size:12px; margin:0;">ç§»å‹•å¹³å‡(M):</label>
             <input type="number" id="ext-ma-period" value="3" min="2" style="width:50px; padding:5px; margin:0;">
             <div class="d-flex align-center gap-2" style="background:#fff; padding:2px 6px; border:1px solid #ddd; border-radius:4px;">
               <span style="font-size:11px; color:#666;">MA:</span>
               <label style="font-size:11px; cursor:pointer; margin:0;"><input type="radio" name="ext-ma-mode" value="off" style="width:auto; margin:0;"> OFF</label>
               <label style="font-size:11px; cursor:pointer; margin:0;"><input type="radio" name="ext-ma-mode" value="on" checked style="width:auto; margin:0;"> ON</label>
               <label style="font-size:11px; cursor:pointer; margin:0;"><input type="radio" name="ext-ma-mode" value="only" style="width:auto; margin:0;"> ã®ã¿</label>
             </div>
             <label style="font-size:12px; margin:0; margin-left:5px;">æœŸé–“:</label>
             <select id="ext-graph-range" style="width:auto; padding:5px; margin:0; font-size:12px;"><option value="all">å…¨æœŸé–“</option><option value="1y">éå»1å¹´</option><option value="2y">éå»2å¹´</option><option value="3y">éå»3å¹´</option></select>
             <div class="d-flex align-center gap-2" style="background:#fff; padding:2px 6px; border:1px solid #ddd; border-radius:4px; margin-left:5px;">
               <span style="font-size:11px; color:#666;">é›†è¨ˆ:</span>
               <label style="font-size:11px; cursor:pointer; margin:0;"><input type="radio" name="ext-agg-mode" value="daily" checked style="width:auto; margin:0;"> æ—¥åˆ¥</label>
               <label style="font-size:11px; cursor:pointer; margin:0;"><input type="radio" name="ext-agg-mode" value="raw" style="width:auto; margin:0;"> æ™‚åˆ»è¾¼</label>
             </div>
             <div class="d-flex align-center gap-2" style="background:#f0f8ff; padding:4px 8px; border:1px solid #cce5ff; border-radius:5px;">
               <span style="font-size:12px; font-weight:bold; color:#0056b3;">ã‚°ãƒ©ãƒ•:</span>
               <label style="font-size:12px; cursor:pointer; margin:0;"><input type="radio" name="ext-graph-mode" value="single" checked style="width:auto; margin:0;"> å˜ä¸€</label>
               <label style="font-size:12px; cursor:pointer; margin:0;"><input type="radio" name="ext-graph-mode" value="combined" style="width:auto; margin:0;"> è¤‡åˆ</label>
             </div>
          </div>

          <!-- å®Ÿè¡Œ -->
          <div class="d-flex gap-2 mt-2">
            <button class="btn-main flex-1" onclick="executeIntegratedAnalysis('table')">è¡¨ã‚’ä½œæˆ</button>
            <button class="btn-main flex-1" style="background:#17a2b8;" onclick="executeIntegratedAnalysis('graph')">ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º</button>
          </div>
          <div id="ext-result" style="margin-top:15px; overflow-x:auto;"></div>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">å†…éƒ¨ãƒ‡ãƒ¼ã‚¿åˆ†æ</summary>
        <div class="mt-2" style="padding:5px;">
          <div style="margin-bottom:15px;">
            <a href="javascript:void(0)" onclick="toggleCal()" style="font-size:16px; font-weight:bold; color:#6f42c1; text-decoration:underline;">æ’ä¾¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º</a>
          </div>
          <div style="margin-bottom:15px;">
            <a href="javascript:void(0)" onclick="togglePoopChart()" style="font-size:16px; font-weight:bold; color:#fd7e14; text-decoration:underline;">æ’ä¾¿çŠ¶æ³ï¼’é‡ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ</a>
          </div>
          <div style="margin-bottom:15px;">
            <a href="javascript:void(0)" onclick="toggleMylanChart()" style="font-size:16px; font-weight:bold; color:#20c997; text-decoration:underline;">ã‚¯ãƒ¬ãƒ¡ã‚¸ãƒ³ï¼ˆãƒã‚¤ãƒ©ãƒ³ï¼‰æœç”¨ã‹ã‚‰æ’ä¾¿ã¾ã§ã®æ—¥æ•°</a>
          </div>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;" ontoggle="if(this.open){const t=document.getElementById('meal-report-header-fields');if(t)autoResize(t);}">
        <summary style="font-weight:bold; cursor:pointer;">é£Ÿäº‹å ±å‘Šæ›¸ä½œæˆï¼ˆç®¡ç†æ „é¤Šå£«ç”¨ï¼‰</summary>
        <div class="mt-2">
          <p style="font-size:10px; color:#666; margin-bottom:10px;">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€Œé£Ÿäº‹ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«ã€å†™çœŸä»˜ãã®å ±å‘Šæ›¸ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
          <div class="d-flex gap-2 align-center mb-2" style="flex-wrap:wrap;">
            <label style="margin:0; font-size:12px;">é–‹å§‹: <input type="date" id="meal-start-date" style="margin:0; padding:4px;"></label>
            <label style="margin:0; font-size:12px;">çµ‚äº†: <input type="date" id="meal-end-date" style="margin:0; padding:4px;"></label>
          </div>
          <div class="d-flex gap-2">
            <button class="btn-main" onclick="renderMealReport()" style="background:#fd7e14; margin-top:0;">å ±å‘Šæ›¸ã‚’ä½œæˆ</button>
          </div>
          <div style="margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
             <label style="font-size:12px; font-weight:bold;">æ‰‹æ›¸ãè¨˜å…¥æ¬„ã®é …ç›® (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
             <div style="font-size:10px; color:#666; margin-bottom:4px;">â€»ã€Œé …ç›®åã€ã¾ãŸã¯ã€Œé …ç›®å:å€¤ã€ã§å…¥åŠ›ï¼ˆä¾‹: æ°å:å±±ç”°å¤ªéƒ, å¹´é½¢ï¼‰</div>
             <textarea id="meal-report-header-fields" rows="2" style="width:100%; padding:5px; font-size:12px; border:1px solid #ddd; border-radius:4px;" oninput="autoResize(this); updateMealReportSettings(this.value);" onfocus="autoResize(this)"></textarea>
          </div>
        </div>
      </details>
    </div>
    <div id="cal-area" style="display:none;">
      <div class="card">
        <div class="d-flex justify-between align-center mb-2">
          <h2 class="section-title" style="margin:0; border:none; padding:0;">æ’ä¾¿çŠ¶æ³</h2>
          <div class="d-flex gap-1 align-center">
            <button class="btn-sub" onclick="printArea('cal')">å°åˆ·</button>
            <select id="cal-month" class="w-auto" style="padding:5px; margin:0;" onchange="rCal()">
            </select>
          </div>
        </div>
        <div id="cal-body"></div>
      </div>
    </div>
    <div id="poop-chart-area" style="display:none;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h2 class="section-title" style="margin:0; border:none; padding:0;">æ’ä¾¿çŠ¶æ³ã‚°ãƒ©ãƒ•</h2>
          <div class="d-flex gap-1">
            <button class="btn-sub" onclick="printArea('poop')">å°åˆ·</button>
            <button class="btn-sub" onclick="document.getElementById('poop-chart-area').style.display='none'">é–‰ã˜ã‚‹</button>
          </div>
        </div>
        <div class="bg-light-gray p-2 rounded d-flex gap-2 align-center mb-2 no-print" style="flex-wrap:wrap;">
          <label style="margin:0; font-size:12px;">é–‹å§‹: <input type="date" id="poop-start-date" style="margin:0; padding:4px;"></label>
          <label style="margin:0; font-size:12px;">çµ‚äº†: <input type="date" id="poop-end-date" style="margin:0; padding:4px;"></label>
          <button class="btn-sub" onclick="renderPoopChart()" style="background:#007bff; color:white;">æ›´æ–°</button>
        </div>
        <div style="position:relative; height:500px; width:100%;"><canvas id="poopDoublePieChart"></canvas></div>
        <div id="poop-chart-details" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px; display:none;">
          <h4 style="font-size:14px; margin-bottom:5px; color:#333;">å†…è¨³ãƒªã‚¹ãƒˆ <span id="poop-detail-title" style="font-weight:normal; font-size:12px;"></span></h4>
          <div id="poop-chart-details-body" style="max-height:200px; overflow-y:auto; font-size:12px; border:1px solid #ddd; border-radius:4px; background:#fff;">
          </div>
        </div>
      </div>
    </div>
    <div id="mylan-chart-area" style="display:none;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h2 class="section-title" style="margin:0; border:none; padding:0;">ãƒã‚¤ãƒ©ãƒ³æœç”¨ã€œæ’ä¾¿æ—¥æ•°</h2>
          <div class="d-flex gap-1">
            <button class="btn-sub" onclick="printArea('mylan')">å°åˆ·</button>
            <button class="btn-sub" onclick="document.getElementById('mylan-chart-area').style.display='none'">é–‰ã˜ã‚‹</button>
          </div>
        </div>
        <div class="no-print bg-light-gray p-2 rounded d-flex gap-2 align-center mb-2" style="flex-wrap:wrap;">
          <label style="margin:0; font-size:12px;">é–‹å§‹: <input type="date" id="mylan-start-date" style="margin:0; padding:4px;"></label>
          <label style="margin:0; font-size:12px;">çµ‚äº†: <input type="date" id="mylan-end-date" style="margin:0; padding:4px;"></label>
          <button class="btn-sub" onclick="renderMylanChart()" style="background:#007bff; color:white;">æ›´æ–°</button>
        </div>
        <div style="position:relative; height:400px; width:100%;"><canvas id="mylanPieChart"></canvas></div>
        <div id="mylan-stats" style="margin-top:10px; font-size:12px; text-align:center; font-weight:bold;"></div>
      </div>
    </div>

    <div id="meal-report-area" style="display:none;">
      <div class="card">
        <div class="no-print" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
          <h2 class="section-title" style="margin:0; border:none; padding:0;">é£Ÿäº‹è¨˜éŒ²å ±å‘Šæ›¸</h2>
          <div class="d-flex gap-1"><button class="btn-sub" onclick="printArea('meal')">å°åˆ·</button><button class="btn-sub" onclick="document.getElementById('meal-report-area').style.display='none'">é–‰ã˜ã‚‹</button></div>
        </div>
        <div id="meal-report-body"></div>
      </div>
    </div>

    <div id="list-anlz"></div>
    <div id="pagination-anlz" class="pagination-controls"></div>
    <div id="stock-print-area" class="card" style="display:none;"></div>
  </div>

  <div id="s-maint" style="display:none">
    <div class="card">
      <h2 class="section-title">ä¿å®ˆãƒ»ç®¡ç†</h2>
      
      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">è¡¨ç¤ºè¨­å®š</summary>
        <div class="mt-2">
          <label style="display:flex; align-items:center; font-size:14px;">
            <input type="checkbox" id="dark-mode-switch" onchange="toggleDarkMode(this.checked)" style="width:auto; height:18px; width:18px; margin-right:10px;">
            ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹
          </label>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</summary>
        <div class="mt-2">
          <h3 id="title-c" style="font-size:14px; margin-bottom:5px;">ã‚«ãƒ†ã‚´ãƒªãƒ¼è¿½åŠ </h3>
          <input type="text" id="cat-name-in" placeholder="ã‚«ãƒ†ã‚´ãƒªå">
          <div style="margin:10px 0;">
            <label style="margin-bottom:5px;">è‰²è¨­å®š</label>
            <div id="cat-palette" class="d-flex gap-2" style="flex-wrap:wrap;"></div>
            <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
               <label style="margin:0; font-size:11px; color:#666;">ã‚«ã‚¹ã‚¿ãƒ :</label>
               <input type="color" id="cat-color-picker" oninput="setCatColor(this.value)" style="width:50px; height:30px; padding:0; border:1px solid #ddd; border-radius:4px;">
               <span id="cat-color-code" style="font-size:12px; font-family:monospace; color:#666;"></span>
            </div>
            <input type="hidden" id="cat-color-in">
          </div>
          <div style="margin:10px 0;">
            <label style="margin-bottom:5px;">ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š</label>
            <div id="cat-icon-palette" class="d-flex gap-2" style="flex-wrap:wrap; padding:5px; background:#f9f9f9; border-radius:5px;"></div>
            <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
               <label style="margin:0; font-size:11px; color:#666;">é¸æŠä¸­/ã‚«ã‚¹ã‚¿ãƒ :</label>
               <input type="text" id="cat-icon-in" placeholder="ğŸ“" style="width:60px; padding:5px; text-align:center; font-size:20px;" oninput="renderCatIconPalette()">
            </div>
          </div>
          <div style="margin:10px 0;">
             <label style="display:flex; align-items:center; cursor:pointer; font-size:12px;">
               <input type="checkbox" id="cat-fav-in" style="width:auto; margin-right:8px;">
               ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ï¼ˆè¨˜éŒ²ç”»é¢ã§ä¸Šéƒ¨ã«è¡¨ç¤ºï¼‰
             </label>
          </div>
          <div id="cat-rules-area" style="display:none; margin:10px 0; border-top:1px dashed #ddd; padding-top:10px;">
             <label style="margin-bottom:5px; font-size:12px;">è‡ªå‹•å…¥åŠ›ãƒ«ãƒ¼ãƒ« (è‡ªç„¶è¨€èª)</label>
             
             <!-- ãƒ«ãƒ¼ãƒ«ãƒ“ãƒ«ãƒ€ãƒ¼ -->
             <div style="background:#f0f8ff; padding:8px; border-radius:5px; margin-bottom:10px; border:1px solid #cce5ff;">
               <div style="font-size:11px; font-weight:bold; color:#0056b3; margin-bottom:5px;">â–¼ ãƒ«ãƒ¼ãƒ«ä½œæˆæ”¯æ´</div>
               
               <div id="rb-blocks-container"></div>

               <div class="d-flex gap-1 mt-2">
                 <button class="btn-sub" style="background:#6f42c1; color:#fff; width:auto;" onclick="addRbBlock('ELSE IF')">ï¼‹ Else If è¿½åŠ </button>
                 <button class="btn-sub" style="background:#17a2b8; color:#fff; flex:1;" onclick="reflectRuleBuilder()">â†“ ãƒ«ãƒ¼ãƒ«å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ</button>
               </div>
             </div>

             <div id="cat-rules-container"></div>
             <div class="list-add-row" style="flex-direction:column;">
               <textarea id="cat-rule-new" placeholder="ä¾‹: if [ä½“æ¸©] >= 37.5 then [ä½“èª¿]='æ‚ªã„'" style="width:100%; min-height:80px; font-family:monospace; overflow-y:hidden; margin-bottom:5px;" oninput="autoResize(this)" onfocus="autoResize(this)"></textarea>
               <div style="text-align:right;">
                 <button class="btn-sub" style="background:#28a745; height:auto; padding:8px 16px;" onclick="addRuleItem()">è¿½åŠ </button>
               </div>
             </div>
             <p style="font-size:10px; color:#666; margin-top:5px;">
               â€»ã€Œif [A]='ç©º' ...ã€ã®ã‚ˆã†ã«ã€Œç©ºã€ã€Œæœªå…¥åŠ›ã€ã€ŒEMPTYã€ã‚’æŒ‡å®šã™ã‚‹ã¨ã€å€¤ãŒç©ºã§ã‚ã‚‹ã“ã¨ã‚’æ¡ä»¶ã«ã§ãã¾ã™ã€‚
               â€»ã€Œif [A] >= 10 then [B]='OK'ã€ã®ã‚ˆã†ã«æ¯”è¼ƒæ¡ä»¶ï¼ˆ>=, <=, >, <, =, !=, ä»¥ä¸Š, ä»¥ä¸‹ãªã©ï¼‰ã‚‚ä½¿ãˆã¾ã™ã€‚
             </p>
          </div>
          <button class="btn-main" id="btn-cat-save" onclick="saveCat()">æ–°è¦ä½œæˆ</button>
          <button class="btn-main" id="btn-cat-cancel" style="display:none; background:#666;" onclick="cancelCat()">å–æ¶ˆ</button>
          <div id="list-c" style="margin-top:10px;"></div>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">é …ç›®è¨­å®š</summary>
        <div class="mt-2">
          <select id="sel-f" class="main-sel" onchange="st.cur=this.value; st.editF=null; st.editRef=null; r();"></select>
          <h3 id="title-f" style="font-size:14px; margin-bottom:5px;">é …ç›®è¿½åŠ </h3>
          <input id="f-n" placeholder="é …ç›®å">
          <select id="f-t" onchange="updateFieldUI()"><option value="text">ãƒ†ã‚­ã‚¹ãƒˆ(å±¥æ­´é¸æŠ)</option><option value="simple_text">ãƒ†ã‚­ã‚¹ãƒˆ(å˜ç´”)</option><option value="number">æ•°å€¤</option><option value="select">é¸æŠè‚¢</option><option value="multi_select">è¤‡æ•°é¸æŠè‚¢</option><option value="date">æ—¥ä»˜</option><option value="time">æ™‚åˆ»</option><option value="camera">ã‚«ãƒ¡ãƒ©</option><option value="file">ãƒ•ã‚¡ã‚¤ãƒ«å–ã‚Šè¾¼ã¿</option></select>
          
          <!-- å‹•çš„è¨­å®šã‚¨ãƒªã‚¢ -->
          <div id="f-config-area" style="margin-top:10px;"></div>

          <button class="btn-main" id="btn-f-save" onclick="saveF()">ä¿å­˜</button>
          <button class="btn-main" id="btn-f-cancel" style="display:none; background:#666;" onclick="st.editF=null; r();">å–æ¶ˆ</button>
          <div id="list-f" style="margin-top:10px;"></div>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">åœ¨åº«é€£æºè¨ºæ–­</summary>
        <div class="mt-2">
          <p style="font-size:11px; color:#666; margin-bottom:10px;">
            ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ã€Œå¸³ç°¿åœ¨åº«è‡ªå‹•è¨ˆç®—ã€ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚<br>
            â€»ä¸Šã®ã€Œé …ç›®è¨­å®šã€ã§å¯¾è±¡ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
          </p>
          <button class="btn-main" style="background:#17a2b8;" onclick="debugStockConfig()">è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹</button>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">ãƒ‡ãƒ¼ã‚¿ç®¡ç† (å…¥å‡ºåŠ›ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)</summary>
        
        <div class="mt-2">
          <div style="margin-bottom:15px; padding:10px; background:#e7f1ff; border-radius:5px; border:1px solid #b6d4fe;">
             <div style="font-size:12px; font-weight:bold; margin-bottom:5px; color:#0056b3;">å…±é€šä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ (CSV/JSON/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)</div>
             <div id="save-dir-status" style="font-size:11px; color:#333; margin-bottom:5px; font-weight:bold;">æœªè¨­å®š</div>
             <div id="save-dir-btns" class="d-flex gap-1">
               <button class="btn-sub" style="background:#007bff;" onclick="setupSaveDirectory()">ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
               <button class="btn-sub" style="background:#6c757d;" onclick="clearSaveDirectory()">è¨­å®šè§£é™¤</button>
             </div>
             <p id="save-dir-desc" style="font-size:10px; color:#666; margin-top:5px;">
               â€»è¨­å®šã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ãŒã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«è¡Œã‚ã‚Œã¾ã™ã€‚<br>
               â€»è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å›ºå®šåã§ä¸Šæ›¸ãã€æ‰‹å‹•å‡ºåŠ›ã¯æ—¥æ™‚åã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
               <b style="color:#dc3545;">ã€æ³¨æ„ã€‘</b>ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ã«ã‚ˆã‚ŠGoogle Driveç­‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ç›´æ¥é¸æŠã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ä¸€åº¦ç«¯æœ«å†…ã«ä¿å­˜å¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚¢ãƒ—ãƒªç­‰ã§ç§»å‹•ã—ã¦ãã ã•ã„ã€‚
             </p>
          </div>

          <h3 style="font-size:13px; margin-bottom:5px; border-bottom:1px solid #eee;">æ‰‹å‹•å…¥å‡ºåŠ›</h3>
          <div class="d-flex gap-1 mt-2" style="flex-wrap:wrap;">
            <select id="csv-sel" class="flex-2" style="margin:0; font-size:14px; min-width:120px;"></select>
            <button class="btn-main flex-1" style="margin:0; background:#007bff; padding:10px; font-size:14px; min-width:60px;" onclick="expCSV()">CSV</button>
            <button class="btn-main flex-1" style="margin:0; background:#6610f2; padding:10px; font-size:14px; min-width:80px;" onclick="expCSVSplit()">CSV(åˆ†å‰²)</button>
            <button class="btn-main flex-1" style="margin:0; background:#17a2b8; padding:10px; font-size:14px; min-width:60px;" onclick="expJSON()">JSON</button>
          </div>
          <button class="btn-main mt-2" style="background:#6f42c1;" onclick="expImages()">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€æ‹¬å‡ºåŠ› (ZIP)</button>
          <div class="mt-2 p-2 bg-light-gray border d-flex align-center gap-2" style="border-radius:5px;">
            <span style="font-size:12px; font-weight:bold; color:#555;">å–è¾¼ãƒ¢ãƒ¼ãƒ‰:</span>
            <label style="font-size:13px; cursor:pointer;"><input type="radio" name="json-import-mode" value="overwrite" checked> ä¸Šæ›¸ã</label>
            <label style="font-size:13px; cursor:pointer;"><input type="radio" name="json-import-mode" value="merge"> è¿½åŠ (ãƒãƒ¼ã‚¸)</label>
          </div>
          <button class="btn-main" style="background:#dc3545; margin-top:10px;" onclick="document.getElementById('file-ptr').click()">ï¼‹ JSONãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼</button>
          <input type="file" id="file-ptr" accept=".json,.zip" style="display:none;" onchange="importJSON(this)">
          
          <div style="margin-top:15px; border-top:1px dashed #ddd; padding-top:5px;">
            <div style="font-size:12px; font-weight:bold; color:#666; margin-bottom:5px;">å…¥å‡ºåŠ›å±¥æ­´ (éå»48æ™‚é–“)</div>
            <div id="io-logs" style="max-height:150px; overflow-y:auto;"></div>
          </div>
        </div>

        <div class="mt-2" style="margin-top:20px; border-top:2px solid #eee; padding-top:10px;">
          <h3 style="font-size:13px; margin-bottom:5px; border-bottom:1px solid #eee;">è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</h3>
          <div class="mt-2">
            <label style="display:flex; align-items:center; font-size:14px;">
              <input type="checkbox" id="realtime-backup-switch" onchange="toggleRealtimeBackup(this.checked)" style="width:auto; height:18px; width:18px; margin-right:10px;">
              ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«è‡ªå‹•ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
            </label>
            <p style="font-size:11px; color:#666; margin-top:5px; padding-left:28px;">
              æ³¨æ„: ã“ã®æ©Ÿèƒ½ã‚’ONã«ã™ã‚‹ã¨ã€è¨˜éŒ²ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãªã©ã‚’è¡Œã†ãŸã³ã«ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
            <div style="margin-top:10px; padding-left:28px;">
               <label for="backup-freq-slider">å®Ÿè¡Œé »åº¦: <span id="backup-freq-value">1</span>å›ã«1å›</label>
               <input type="range" id="backup-freq-slider" min="1" max="10" step="1" value="1" oninput="updateBackupFrequency(this.value)">
            </div>
          </div>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š</summary>
        <div class="mt-2">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:5px;">
             <label for="water-target-num" style="margin:0;">ç›®æ¨™æ°´åˆ†é‡ (ml):</label>
             <input type="number" id="water-target-num" min="0" max="5000" step="50" value="1500" style="width:80px; padding:5px; text-align:right;" oninput="updateWaterTarget(this.value)">
          </div>
          <input type="range" id="water-target-slider" min="500" max="3000" step="50" value="1500" style="width:100%;" oninput="updateWaterTarget(this.value)">
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer; outline:none;">ã‚°ãƒ©ãƒ•è¨­å®š</summary>
        <div style="margin-top:10px;">
          <label for="graph-height-slider">ã‚°ãƒ©ãƒ•é«˜ã•: <span id="graph-height-value">360</span>px</label>
          <input type="range" id="graph-height-slider" min="200" max="800" step="10" value="360" oninput="updateGraphSetting('Height', this.value)">
        </div>
        <div style="margin-top:10px;">
          <label for="graph-line-color-input">ã‚°ãƒ©ãƒ•ç·šã®è‰²:</label>
          <input type="color" id="graph-line-color-input" value="#007bff" oninput="updateGraphAppearanceSetting('graphLineColor', this.value)">
        </div>
        <div style="margin-top:10px;">
          <label for="graph-line-width-slider">ã‚°ãƒ©ãƒ•ç·šã®å¤ªã•: <span id="graph-line-width-value">3</span>px</label>
          <input type="range" id="graph-line-width-slider" min="1" max="10" step="1" value="3" oninput="updateGraphAppearanceSetting('graphLineWidth', this.value)">
        </div>
        <div style="margin-top:10px; border-top: 1px dashed #ddd; padding-top: 10px;">
          <label for="graph-ma-line-color-input">ç§»å‹•å¹³å‡ç·šã®è‰²:</label>
          <input type="color" id="graph-ma-line-color-input" value="#ff9800" oninput="updateGraphAppearanceSetting('graphMaLineColor', this.value)">
        </div>
        <div style="margin-top:10px;">
          <label for="graph-ma-line-width-slider">ç§»å‹•å¹³å‡ç·šã®å¤ªã•: <span id="graph-ma-line-width-value">3</span>px</label>
          <input type="range" id="graph-ma-line-width-slider" min="1" max="10" step="1" value="3" oninput="updateGraphAppearanceSetting('graphMaLineWidth', this.value)">
        </div>
        <div style="margin-top:10px; border-top: 1px dashed #ddd; padding-top: 10px;">
          <label for="graph-latest-line-color-input">æœ€æ–°å€¤ç·šã®è‰²:</label>
          <input type="color" id="graph-latest-line-color-input" value="#ff0000" oninput="updateGraphAppearanceSetting('graphLatestLineColor', this.value)">
        </div>
        <div style="margin-top:10px;">
          <label for="graph-latest-line-width-slider">æœ€æ–°å€¤ç·šã®å¤ªã•: <span id="graph-latest-line-width-value">1</span>px</label>
          <input type="range" id="graph-latest-line-width-slider" min="1" max="10" step="1" value="1" oninput="updateGraphAppearanceSetting('graphLatestLineWidth', this.value)">
        </div>
        <div style="margin-top:10px;">
          <label for="graph-font-size-slider">ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º (PC): <span id="graph-font-size-value">10</span>px</label>
          <input type="range" id="graph-font-size-slider" min="8" max="24" step="1" value="10" oninput="updateGraphAppearanceSetting('graphDataFontSize', this.value)">
          <p style="font-size:11px; color:#666; margin-top:5px;">
            â€»ã‚¹ãƒãƒ›/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã¯ã€ã“ã®è¨­å®šå€¤ã®2å€ã®ã‚µã‚¤ã‚ºã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </p>
        </div>
        <div style="margin-top:10px;">
          <label for="graph-min-label-spacing-slider">ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒ™ãƒ«æœ€å°é–“éš” (æ–‡å­—æ•°åˆ†): <span id="graph-min-label-spacing-value">8</span></label>
          <input type="range" id="graph-min-label-spacing-slider" min="0" max="20" step="0.5" value="8" oninput="updateGraphAppearanceSetting('graphMinLabelSpacing', this.value)">
          <p style="font-size:11px; color:#666; margin-top:5px;">
            â€»å€¤ã‚’å¤§ããã™ã‚‹ã¨ãƒ©ãƒ™ãƒ«ãŒé–“å¼•ã‹ã‚Œã€é‡ãªã‚Šã«ãããªã‚Šã¾ã™ã€‚
          </p>
        </div>
        <div style="margin-top:10px;">
          <label for="graph-xaxis-interval-select">Xè»¸ãƒ©ãƒ™ãƒ«è¡¨ç¤ºé–“éš”:</label>
          <select id="graph-xaxis-interval-select" onchange="updateGraphAppearanceSetting('graphXAxisInterval', this.value)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;">
            <option value="auto">è‡ªå‹•</option>
            <option value="1">1ãƒ¶æœˆ</option>
            <option value="2">2ãƒ¶æœˆ</option>
            <option value="3">3ãƒ¶æœˆ</option>
            <option value="6">6ãƒ¶æœˆ</option>
            <option value="12">1å¹´</option>
          </select>
        </div>
        <div style="margin-top:10px;">
          <label for="graph-axis-font-size-slider">è»¸ãƒ©ãƒ™ãƒ«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: <span id="graph-axis-font-size-value">10</span>px</label>
          <input type="range" id="graph-axis-font-size-slider" min="8" max="20" step="1" value="10" oninput="updateGraphAppearanceSetting('graphAxisFontSize', this.value)">
        </div>
        <div style="margin-top:10px;">
          <label for="graph-title-font-size-slider">ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º: <span id="graph-title-font-size-value">14</span>px</label>
          <input type="range" id="graph-title-font-size-slider" min="10" max="30" step="1" value="14" oninput="updateGraphAppearanceSetting('graphTitleFontSize', this.value)">
        </div>
        <div style="margin-top:10px; border-top: 1px dashed #ddd; padding-top: 10px;">
          <label style="display:flex; align-items:center; font-size:14px;">
            <input type="checkbox" id="graph-marker-show-switch" onchange="updateGraphAppearanceSetting('graphMarkerShow', this.checked)" style="width:auto; height:18px; width:18px; margin-right:10px;">
            ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
          </label>
        </div>
        <div style="margin-top:10px;">
          <label for="graph-marker-size-slider">ãƒãƒ¼ã‚«ãƒ¼ã‚µã‚¤ã‚º: <span id="graph-marker-size-value">4</span>px</label>
          <input type="range" id="graph-marker-size-slider" min="1" max="10" step="1" value="4" oninput="updateGraphAppearanceSetting('graphMarkerSize', this.value)">
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">ç”»åƒè¨­å®š (ã‚«ãƒ¡ãƒ©)</summary>
        <div class="mt-2">
          <label for="img-max-width-slider">æœ€å¤§ç”»åƒå¹…: <span id="img-max-width-value">800</span>px</label>
          <input type="range" id="img-max-width-slider" min="100" max="1600" step="100" value="800" oninput="updateImageSetting('imageMaxWidth', this.value)">
          
          <label for="img-quality-slider" style="margin-top:10px;">ç”»è³ª (JPEGåœ§ç¸®ç‡): <span id="img-quality-value">80</span>%</label>
          <input type="range" id="img-quality-slider" min="10" max="100" step="5" value="80" oninput="updateImageSetting('imageQuality', this.value)">
          <p style="font-size:11px; color:#666; margin-top:5px;">
            â€»å€¤ã‚’å°ã•ãã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒè»½ããªã‚Šã¾ã™ãŒã€ç”»è³ªãŒä½ä¸‹ã—ã¾ã™ã€‚
          </p>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">æ¤œç´¢è¨­å®š</summary>
        <div class="mt-2">
          <label for="search-history-count-slider">æ¤œç´¢å±¥æ­´ã®è¡¨ç¤ºä»¶æ•°: <span id="search-history-count-value">5</span>ä»¶</label>
          <input type="range" id="search-history-count-slider" min="1" max="20" step="1" value="5" oninput="updateSearchSetting('searchHistoryCount', this.value)">
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ± (å®¹é‡ãƒ»æ°¸ç¶šåŒ–)</summary>
        <div id="storage-stats" class="mt-2" style="font-size:13px; line-height:1.6;">
          <button class="btn-sub" onclick="checkStorage()">æƒ…å ±ã‚’å–å¾—ãƒ»æ›´æ–°</button>
        </div>
        <div style="margin-top:10px; font-size:11px; color:#666; background:#f9f9f9; padding:8px; border-radius:5px;">
          <b>æ°¸ç¶šåŒ–ã«ã¤ã„ã¦:</b><br>
          é€šå¸¸ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯ç«¯æœ«ã®ç©ºãå®¹é‡ãŒä¸è¶³ã™ã‚‹ã¨ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
          ã€Œæ°¸ç¶šåŒ–ã€ãŒè¨±å¯ã•ã‚Œã‚‹ã¨ã€è‡ªå‹•å‰Šé™¤ã•ã‚Œãªããªã‚Šã¾ã™ã€‚è¨±å¯ã•ã‚Œãªã„å ´åˆã§ã‚‚ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦é »ç¹ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã§è¨±å¯ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
          <button class="btn-sub" style="margin-top:5px; background:#17a2b8;" onclick="reqPersist()">æ°¸ç¶šåŒ–ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #dc3545; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer; color:#dc3545;">ãƒ‡ãƒ¼ã‚¿æ•´ç†ï¼ˆå¤ã„è¨˜éŒ²ã®å‰Šé™¤ï¼‰</summary>
        <div class="mt-2">
          <input type="date" id="cl-date">
          <button class="btn-main" style="background:#dc3545" onclick="clean()">å®Ÿè¡Œï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼†å‰Šé™¤ï¼‰</button>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer; color:#dc3545;">ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</summary>
        <div class="mt-2">
          <p style="font-size:11px; color:#666; margin-bottom:10px; line-height:1.5;">
            <b>ã€è­¦å‘Šã€‘</b>ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€é …ç›®ã€è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚<br>
            å®Ÿè¡Œå‰ã«å¿…ãšã€Œãƒ‡ãƒ¼ã‚¿å…¥å‡ºåŠ›ã€ã‹ã‚‰JSONå½¢å¼ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
          </p>
          <button class="btn-main" style="background:#dc3545;" onclick="resetApp()">ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ã™ã‚‹</button>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° (ã‚¹ãƒãƒ›ç¢ºèªç”¨)</summary>
        <div class="mt-2">
          <button class="btn-sub" onclick="renderDebugLogs()">ãƒ­ã‚°ã‚’æ›´æ–°è¡¨ç¤º</button>
          <button class="btn-sub" style="background:#dc3545;" onclick="st.debugLogs=[]; renderDebugLogs()">ã‚¯ãƒªã‚¢</button>
          <div id="debug-log-area" style="margin-top:10px; max-height:200px; overflow-y:auto; font-size:10px; font-family:monospace; background:#f0f0f0; padding:5px; border:1px solid #ccc; white-space:pre-wrap; word-break:break-all;"></div>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">é–‹ç™ºãƒ»å®Ÿé¨“æ©Ÿèƒ½</summary>
        <div class="mt-2">
          <button class="btn-main" style="background:#6c757d;" onclick="showGasMemo()">ãŒã™ï¼ˆGASé€£æºãƒ¡ãƒ¢ï¼‰</button>
        </div>
      </details>

      <details style="margin-top:10px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <summary style="font-weight:bold; cursor:pointer;">ã“ã®ã‚³ãƒ¼ãƒ‰</summary>
        <div class="mt-2">
          <button class="btn-main" style="background:#6c757d;" onclick="showAppSummary()">ã€Œè¡Œå‹•ãƒ­ã‚°ï¼–ï¼‘ï¼ã€ã®æ¦‚è¦ã‚’è¡¨ç¤º</button>
        </div>
      </details>

    </div>
  </div>
</div>

<div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; align-items:center; justify-content:center;" onclick="closeModal()">
  <div style="background:#fff; width:90%; max-width:400px; max-height:80vh; overflow-y:auto; padding:15px; border-radius:10px; position:relative;" onclick="event.stopPropagation()">
    <button style="position:absolute; top:5px; right:10px; border:none; background:none; font-size:24px; cursor:pointer; color:#666;" onclick="closeModal()">Ã—</button>
    <h3 id="modal-title" style="margin-bottom:10px; font-size:16px; border-bottom:2px solid #007bff; padding-bottom:5px;"></h3>
    <div id="modal-body"></div>
  </div>
</div>

<button id="scroll-top-btn" class="scroll-top-btn" onclick="scrollToTop()">â–²</button>
<button id="scroll-to-save-btn" class="scroll-to-save-btn" onclick="scrollToSave()">â–¼</button>

<script>
// â–¼â–¼â–¼ è¿½åŠ : ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆã‚¹ãƒãƒ›ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ â–¼â–¼â–¼
(function(){
    const oldLog = console.log;
    console.log = function(...args) {
        oldLog.apply(console, args);
        if(st && st.debugLogs) {
            const msg = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
            st.debugLogs.unshift(`[${new Date().toLocaleTimeString()}] ${msg}`);
            if(st.debugLogs.length > 50) st.debugLogs.length = 50;
        }
    };
})();
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â˜… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† â˜…
const VERSION = "v7.9.1";
const KEY = 'action_app_' + VERSION + '_data';
const KEY_EXT = KEY + '_ext';
const KEY_LOGS = KEY + '_logs';
const KEY_SETTINGS = KEY + '_settings';

// â–¼â–¼â–¼ è¿½åŠ : ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾© â–¼â–¼â–¼
let st = {
  view: 'input',
  cur: null,
  cats: [],
  stock: [],
  settings: {},
  form: {},
  editR: null,
  saveMode: null,
  editCat: null,
  editF: null,
  ioLogs: [],
  extFiles: [],
  extData: [],
  extCurrentIdx: -1,
  extSelectedItems: [],
  extFileName: null,
  extFileDate: null,
  extGraphMode: 0,
  extTableSort: { col: 'date', asc: false },
  analysisSelection: new Set(),
  pagination: { input: {}, analysis: 1 },
  debugLogs: []
};
let analysisRecordsCache = [];
const RECS_PER_PAGE = 20;
let backupCounter = 0;
let graphUpdateTimer = null;
let navHideTimer = null;
let navScrollListener = null;
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : å®šæ•° â–¼â–¼â–¼
const CAT_ID_TOILET = 'cat_other';
const KEY_STOCK = KEY + '_stock';
const CAT_ID_WATER = 'cat_water';
const FIELD_NAME_POOP_STATUS = 'ä¾¿ã®çŠ¶æ…‹';
const FIELD_NAME_POOP_AMOUNT = 'ä¾¿ã®é‡';
const FIELD_NAME_WATER_AMOUNT = 'æ°´åˆ†é‡';
const KEYWORD_MYLAN = 'ãƒã‚¤ãƒ©ãƒ³';
const KEYWORD_KREMEZIN = 'ã‚¯ãƒ¬ãƒ¡ã‚¸ãƒ³';

// â˜… IndexedDB Helper â˜…
const DB_NAME = 'HealthAppDB';
const DB_VER = 1;
const STORE = 'kv_store';
const idb = {
  db: null,
  async open() {
    if (this.db) return this.db;
    return new Promise((res, rej) => {
      const r = indexedDB.open(DB_NAME, DB_VER);
      r.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
      };
      r.onsuccess = (e) => { this.db = e.target.result; res(this.db); };
      r.onerror = (e) => rej(e);
    });
  },
  async get(key) {
    const db = await this.open();
    return new Promise((res, rej) => {
      const r = db.transaction(STORE, 'readonly').objectStore(STORE).get(key);
      r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error);
    });
  },
  async set(key, val) {
    const db = await this.open();
    return new Promise((res, rej) => {
      const r = db.transaction(STORE, 'readwrite').objectStore(STORE).put(val, key);
      r.onsuccess = () => res(); r.onerror = () => rej(r.error);
    });
  },
  async clear() {
    const db = await this.open();
    return new Promise((res, rej) => {
      const r = db.transaction(STORE, 'readwrite').objectStore(STORE).clear();
      r.onsuccess = () => res(); r.onerror = () => rej(r.error);
    });
  }
};

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
function esc(s) {
  return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]);
}

// â–¼â–¼â–¼ è¿½åŠ : ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªå‹•ãƒªã‚µã‚¤ã‚º â–¼â–¼â–¼
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight + 5) + 'px';
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆé–¢æ•° â–¼â–¼â–¼
function highlight(text, keyword) {
  if (!text) return '';
  if (!keyword) return esc(text);
  
  // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é…åˆ—åŒ–
  const keywords = keyword.trim().split(/[\sã€€]+/).filter(k => k);
  if (keywords.length === 0) return esc(text);

  const str = String(text);
  // æ­£è¦è¡¨ç¾ã‚’ä½œæˆ (å¤§æ–‡å­—å°æ–‡å­—ç„¡è¦–)
  const pattern = keywords.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
  const regex = new RegExp(`(${pattern})`, 'gi');
  
  return str.split(regex).map(part => {
    // partãŒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèªï¼ˆå¤§æ–‡å­—å°æ–‡å­—ç„¡è¦–ï¼‰
    if (keywords.some(k => k.toLowerCase() === part.toLowerCase())) {
        return `<span style="background:#ffeb3b; color:#000; font-weight:bold; border-radius:2px; padding:0 2px;">${esc(part)}</span>`;
    } else {
        return esc(part);
    }
  }).join('');
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : ç‰¹å®šã‚«ãƒ†ã‚´ãƒªå–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆãƒ­ã‚¸ãƒƒã‚¯å…±é€šåŒ–ï¼‰ â–¼â–¼â–¼
function getTargetCat(type) {
  if (type === 'toilet') return st.cats.find(c => c.id === CAT_ID_TOILET || c.name.includes('ãƒˆã‚¤ãƒ¬'));
  if (type === 'water') return st.cats.find(c => c.id === CAT_ID_WATER || c.name.includes('æ°´åˆ†'));
  return null;
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š â–¼â–¼â–¼
/**
 * ãƒ‡ãƒã‚¤ã‚¹ã®ç¨®é¡ã‚’åˆ¤å®šã—ã¾ã™ã€‚
 * @returns {'pc' | 'tablet' | 'smartphone'} ãƒ‡ãƒã‚¤ã‚¹ã®ç¨®é¡
 */
function getDeviceType() {
  const ua = navigator.userAgent;
  if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
    return "tablet";
  }
  if (/Mobile|iP(hone|od)|Android|BlackBerry|IEMobile|Kindle|NetFront|Silk-Accelerated|(hpw|web)OS|Fennec|Minimo|Opera M(obi|ini)|Blazer|Dolfin|Dolphin|Skyfire|Zune/.test(ua)) {
    return "smartphone";
  }
  return "pc";
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â˜… ã‚«ãƒ†ã‚´ãƒªãƒ¼è‰²è¨­å®š â˜…
const CAT_COLORS = [
  '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e', 
  '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', 
  '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#64748b',
  '#9ca3af', '#4b5563', '#1f2937', '#78716c', '#57534e', '#000000'
];
function renderCatPalette() {
  const cur = document.getElementById('cat-color-in').value || CAT_COLORS[0];
  document.getElementById('cat-palette').innerHTML = CAT_COLORS.map(c => 
    `<div onclick="setCatColor('${c}')" style="width:28px; height:28px; border-radius:50%; background:${c}; cursor:pointer; border:2px solid ${c.toLowerCase() === cur.toLowerCase() ? '#333' : '#fff'}; box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>`
  ).join('');
  
  const picker = document.getElementById('cat-color-picker');
  if(picker) {
    picker.value = cur;
    document.getElementById('cat-color-code').innerText = cur;
  }
}
const CAT_ICONS = ['ğŸ“', 'ğŸš½', 'ğŸ’§', 'ğŸ’Š', 'ğŸ¥', 'ğŸ’‰', 'ğŸŒ¡ï¸', 'ğŸƒ', 'ğŸ’¤', 'ğŸ½ï¸', 'ğŸ¥—', 'ğŸº', 'âš™ï¸', 'â¤ï¸', 'âš ï¸', 'ğŸ’©', 'ğŸ©¸', 'ğŸ©º', 'ğŸ‘€', 'ğŸ‘‚', 'ğŸ‘ƒ', 'ğŸ¦·', 'ğŸ¦µ', 'ğŸ§ '];
function renderCatIconPalette() {
  const cur = document.getElementById('cat-icon-in').value || '';
  document.getElementById('cat-icon-palette').innerHTML = CAT_ICONS.map(icon => 
    `<div onclick="setCatIcon('${icon}')" style="width:32px; height:32px; line-height:32px; text-align:center; font-size:20px; cursor:pointer; border-radius:4px; background:${icon === cur ? '#ddd' : 'transparent'}; border:1px solid ${icon === cur ? '#999' : 'transparent'};">${icon}</div>`
  ).join('');
}
function setCatIcon(icon) {
  document.getElementById('cat-icon-in').value = icon;
  renderCatIconPalette();
}

function setCatColor(c) {
  document.getElementById('cat-color-in').value = c;
  renderCatPalette();
}

// â˜… åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆå›èµ·å‹•æ™‚ã«ä½¿ç”¨ï¼‰ â˜…
const DEFAULT_DATA = [
  {
    "id": CAT_ID_WATER, "name": "æ°´åˆ†è£œçµ¦", "color": "#0dcaf0", "icon": "ğŸ’§",
    "fields": [
      {"id": "fw_1", "name": FIELD_NAME_WATER_AMOUNT, "type": "select", "options": ["100ml","150ml","200ml","250ml","300ml","500ml"]}
    ],
    "records": []
  }
];

// æ—¥ä»˜äº’æ›é–¢æ•°
function getDt(rec) {
  const d = rec.dt || rec.datetime;
  if (!d) return new Date();
  const p = new Date(d);
  return isNaN(p.getTime()) ? new Date() : p;
}
function getTS() {
  const n = new Date();
  return n.getFullYear() +
    String(n.getMonth() + 1).padStart(2, '0') +
    String(n.getDate()).padStart(2, '0') +
    String(n.getHours()).padStart(2, '0') +
    String(n.getMinutes()).padStart(2, '0') +
    String(n.getSeconds()).padStart(2, '0');
}

// â–¼â–¼â–¼ è¿½åŠ : JSTå¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function toJSTISOString(d) {
  const pad = (n) => String(n).padStart(2, '0');
  const pad3 = (n) => String(n).padStart(3, '0');
  const jst = new Date(d.getTime() + 9 * 60 * 60 * 1000);
  return jst.getUTCFullYear() + '-' +
         pad(jst.getUTCMonth() + 1) + '-' +
         pad(jst.getUTCDate()) + 'T' +
         pad(jst.getUTCHours()) + ':' +
         pad(jst.getUTCMinutes()) + ':' +
         pad(jst.getUTCSeconds()) + '.' +
         pad3(jst.getUTCMilliseconds()) + '+09:00';
}
const jsonJstReplacer = (k, v) => {
  if ((k === 'dt' || k === 'original_dt') && typeof v === 'string') {
    const d = new Date(v);
    if (!isNaN(d.getTime())) return toJSTISOString(d);
  }
  return v;
};
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼ (yyyy-mm-dd) â–¼â–¼â–¼
function formatDateYMD(d) {
  if (!d) return '';
  const date = new Date(d);
  if (isNaN(date.getTime())) return '';
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}
function formatDateYMDHM(d) {
  if (!d) return '';
  const date = new Date(d);
  if (isNaN(date.getTime())) return '';
  return `${formatDateYMD(date)} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}:${String(date.getSeconds()).padStart(2,'0')}`;
}
// â–¼â–¼â–¼ è¿½åŠ : æ›œæ—¥è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function getDowStr(dateVal) {
  if (!dateVal) return '';
  const d = new Date(dateVal);
  if (isNaN(d.getTime())) return '';
  const weeks = ['(æ—¥)', '(æœˆ)', '(ç«)', '(æ°´)', '(æœ¨)', '(é‡‘)', '(åœŸ)'];
  return weeks[d.getDay()];
}
function updateDayOfWeek(input, spanId) {
  const span = document.getElementById(spanId);
  if (span) span.innerText = getDowStr(input.value);
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

async function save(skipBackup = false) {
  try {
    await idb.set(KEY, st.cats);
    await idb.set(KEY_LOGS, st.ioLogs);
    await idb.set(KEY_STOCK, st.stock);
    // â–¼â–¼â–¼ å¤‰æ›´: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— â–¼â–¼â–¼
    if (!skipBackup && st.settings && st.settings.realtimeBackup) {
      backupCounter++;
      const freq = st.settings.backupFrequency || 1;
      if (backupCounter >= freq) {
        await realtimeBackup();
        backupCounter = 0;
      }
    }
    // â–²â–²â–² å¤‰æ›´ â–²â–²â–²
  } catch(e) {
    console.error('Save failed:', e);
  }
}

// â–¼â–¼â–¼ è¿½åŠ : è¨­å®šä¿å­˜ã¨åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ â–¼â–¼â–¼
async function saveSettings() {
  try {
    await idb.set(KEY_SETTINGS, st.settings);
  } catch(e) {
    console.error('Save settings failed:', e);
  }
}

async function toggleRealtimeBackup(isChecked) {
  if (isChecked && !window.showSaveFilePicker) {
    if (!confirm('ã€æ³¨æ„ã€‘\nãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆAndroidãªã©ï¼‰ã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸Šæ›¸ãä¿å­˜ã€ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ONã«ã™ã‚‹ã¨ã€ä¿å­˜ã®ãŸã³ã«æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå¢—ãˆç¶šã‘ã¾ã™ï¼‰ã€‚\n\nãã‚Œã§ã‚‚æœ‰åŠ¹ã«ã—ã¾ã™ã‹ï¼Ÿ')) {
      const sw = document.getElementById('realtime-backup-switch');
      if(sw) sw.checked = false;
      return;
    }
  }
  if (!st.settings) st.settings = {};
  st.settings.realtimeBackup = isChecked;
  await saveSettings();
  showToast(`è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒ ${isChecked ? 'ON' : 'OFF'} ã«ãªã‚Šã¾ã—ãŸã€‚`);
}

function updateBackupFrequency(val) {
  if (!st.settings) st.settings = {};
  const v = parseInt(val, 10);
  st.settings.backupFrequency = v;
  document.getElementById('backup-freq-value').innerText = v;
  saveSettings();
}

function toggleDarkMode(isChecked) {
  if (!st.settings) st.settings = {};
  st.settings.darkMode = isChecked;
  applyTheme();
  saveSettings();
}

function applyTheme() {
  document.body.classList.toggle('dark-mode', !!(st.settings && st.settings.darkMode));
}

function updateGraphSetting(key, value) {
  if (!st.settings) st.settings = {};
  const numValue = parseInt(value, 10);
  st.settings['graph' + key] = numValue;
  document.getElementById(`graph-${key.toLowerCase()}-value`).innerText = numValue;
  saveSettings();
}

function updateGraphAppearanceSetting(key, value) {
  if (!st.settings) st.settings = {};
  const isBoolean = typeof value === 'boolean';
  const isNumeric = !isBoolean && !key.includes('Color') && key !== 'graphXAxisInterval';
  let finalValue = value;
  if (isNumeric) {
    if (key === 'graphMinLabelSpacing') finalValue = parseFloat(value);
    else finalValue = parseInt(value, 10);
  }

  st.settings[key] = finalValue;
  
  if (key === 'graphLineWidth') {
    document.getElementById('graph-line-width-value').innerText = finalValue;
  } else if (key === 'graphMaLineWidth') {
    document.getElementById('graph-ma-line-width-value').innerText = finalValue;
  } else if (key === 'graphLatestLineWidth') {
    document.getElementById('graph-latest-line-width-value').innerText = finalValue;
  } else if (key === 'graphDataFontSize') {
    document.getElementById('graph-font-size-value').innerText = finalValue;
  } else if (key === 'graphMinLabelSpacing') {
    document.getElementById('graph-min-label-spacing-value').innerText = finalValue;
  } else if (key === 'graphAxisFontSize') {
    document.getElementById('graph-axis-font-size-value').innerText = finalValue;
  } else if (key === 'graphTitleFontSize') {
    document.getElementById('graph-title-font-size-value').innerText = finalValue;
  } else if (key === 'graphMarkerSize') {
    document.getElementById('graph-marker-size-value').innerText = finalValue;
  }
  
  saveSettings();

  // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã§ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
  clearTimeout(graphUpdateTimer);
  graphUpdateTimer = setTimeout(() => {
    const resDiv = document.getElementById('ext-result');
    if (st.view === 'analysis' && resDiv && (resDiv.querySelector('canvas') || resDiv.querySelector('svg'))) {
      renderExtGraph(true);
    }
  }, 300); // 300mså¾…ã£ã¦ã‹ã‚‰æ›´æ–°
}

function updateWaterTarget(value) {
  const numValue = parseInt(value, 10);
  if (isNaN(numValue)) return;
  if (!st.settings) st.settings = {};
  st.settings.waterTarget = numValue;
  
  const numInput = document.getElementById('water-target-num');
  const sliderInput = document.getElementById('water-target-slider');
  if (numInput && numInput.value != numValue) numInput.value = numValue;
  if (sliderInput && sliderInput.value != numValue) sliderInput.value = numValue;
  
  saveSettings();
}

function updateImageSetting(key, value) {
  if (!st.settings) st.settings = {};
  const numValue = parseInt(value, 10);
  st.settings[key] = numValue;
  const displayId = key === 'imageMaxWidth' ? 'img-max-width-value' : 'img-quality-value';
  document.getElementById(displayId).innerText = numValue;
  saveSettings();
}

function updateMealReportSettings(val) {
  if (!st.settings) st.settings = {};
  st.settings.mealReportHeaderFields = val;
  saveSettings();
}

function updateSearchSetting(key, value) {
  if (!st.settings) st.settings = {};
  const numValue = parseInt(value, 10);
  st.settings[key] = numValue;
  if (key === 'searchHistoryCount') {
    document.getElementById('search-history-count-value').innerText = numValue;
    document.getElementById('search-history-count-slider').value = numValue;
  }
  saveSettings();
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ â–¼â–¼â–¼
let saveDirHandle = null;
let isBackupInProgress = false;

async function realtimeBackup() {
  if (isBackupInProgress) {
    console.warn('Skipping realtime backup: Previous backup is still in progress.');
    return;
  }
  isBackupInProgress = true;

  try {
    const data = {
      format: 'full_backup',
      version: VERSION,
      cats: st.cats,
      stock: st.stock || [],
      settings: st.settings || {},
      extFiles: st.extFiles || []
    };
    const jsonStr = JSON.stringify(data, jsonJstReplacer, 2);

    if (!window.JSZip) throw new Error('JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
    const zip = new JSZip();
    zip.file('è¡Œå‹•ãƒ­ã‚°ï¼–ï¼‘ï¼ãƒªã‚¢ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—.json', jsonStr);
    const blob = await zip.generateAsync({type:'blob', mimeType:'application/zip', compression:'DEFLATE', compressionOptions:{level:6}});
    const filename = 'è¡Œå‹•ãƒ­ã‚°ï¼–ï¼‘ï¼ãƒªã‚¢ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—.zip';

    // saveBlobã«ä»»ã›ã‚‹ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®šãŒã‚ã‚Œã°ãã“ã«ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
    await saveBlob(blob, filename);
    if (saveDirHandle) showToast('è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  } catch (e) {
    console.error('Realtime backup failed:', e);
    showToast('è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—: ' + e.message);
  } finally {
    isBackupInProgress = false;
  }
}

async function updateSaveDirectoryStatus() {
  const el = document.getElementById('save-dir-status');
  const btnArea = document.getElementById('save-dir-btns');
  const desc = document.getElementById('save-dir-desc');
  if (!el) return;

  if (!window.showDirectoryPicker) {
    el.innerHTML = '<span style="color:#dc3545; font-weight:bold;">ã“ã®ç«¯æœ«(Androidç­‰)ã¯ãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šæœªå¯¾å¿œã§ã™</span>';
    if(btnArea) btnArea.style.display = 'none';
    if(desc) desc.innerHTML = 'â€»Androidç­‰ã®ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šãƒ•ã‚©ãƒ«ãƒ€ã®å›ºå®šãŒã§ãã¾ã›ã‚“ã€‚<br>â€»ãƒ•ã‚¡ã‚¤ãƒ«ã¯<b>ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€</b>ãƒ•ã‚©ãƒ«ãƒ€ç­‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>â€»Googleãƒ‰ãƒ©ã‚¤ãƒ–ã¸ä¿å­˜ã—ãŸã„å ´åˆã¯ã€ä¿å­˜å¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚¢ãƒ—ãƒªç­‰ã§ç§»å‹•ã™ã‚‹ã‹ã€Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‚¢ãƒ—ãƒªã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
    return;
  }
  
  if(btnArea) btnArea.style.display = 'flex';
  if(desc) desc.innerHTML = 'â€»è¨­å®šã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ãŒã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«è¡Œã‚ã‚Œã¾ã™ã€‚<br>â€»è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å›ºå®šåã§ä¸Šæ›¸ãã€æ‰‹å‹•å‡ºåŠ›ã¯æ—¥æ™‚åã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚';

  try {
    if (!saveDirHandle) saveDirHandle = await idb.get('save_dir_handle');
    if (saveDirHandle) el.innerHTML = '<span style="color:#28a745; font-weight:bold;">è¨­å®šæ¸ˆã¿</span> (' + (saveDirHandle.name || 'ãƒ•ã‚©ãƒ«ãƒ€') + ')';
    else el.innerHTML = '<span style="color:#666;">æœªè¨­å®š (æ¯å›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)</span>';
  } catch(e) { el.innerText = 'çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼'; }
}

async function setupSaveDirectory() {
  if (!window.showDirectoryPicker) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'); return; }
  try {
    const handle = await window.showDirectoryPicker();
    if (handle) { 
      saveDirHandle = handle; 
      await idb.set('save_dir_handle', handle); 
      updateSaveDirectoryStatus(); 
      alert('ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’è¨­å®šã—ã¾ã—ãŸã€‚\næ¬¡å›ã‹ã‚‰CSV/JSON/ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å…¨ã¦ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚'); 
    }
  } catch (e) { if (e.name !== 'AbortError') alert('è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message); }
}

async function clearSaveDirectory() {
  saveDirHandle = null;
  await idb.set('save_dir_handle', null);
  updateSaveDirectoryStatus();
  alert('ä¿å­˜å…ˆè¨­å®šã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

function showToast(msg) {
  const div = document.createElement('div');
  // ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚ˆã†ã«ç”»é¢ä¸‹éƒ¨ã«è¡¨ç¤ºå¤‰æ›´
  div.style.cssText = "position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:rgba(40,167,69,0.95); color:#fff; padding:12px 24px; border-radius:30px; z-index:2000; font-weight:bold; box-shadow:0 4px 10px rgba(0,0,0,0.3); transition:opacity 0.5s; font-size:14px; text-align:center; max-width:90%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;";
  div.innerText = msg;
  document.body.appendChild(div);
  setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 500); }, 3000);
}

// â–¼â–¼â–¼ è¿½åŠ : ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ï¼†ä¿å­˜ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³åˆ¶å¾¡ â–¼â–¼â–¼
function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function scrollToSave() {
  const btn = document.getElementById('btn-save-rec');
  if (btn) btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
window.addEventListener('scroll', () => {
  // ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³
  const btnTop = document.getElementById('scroll-top-btn');
  if(btnTop) {
    const y = window.scrollY || document.documentElement.scrollTop || document.body.scrollTop;
    btnTop.style.display = (y > 200) ? 'flex' : 'none';
  }
  // ä¿å­˜ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
  const btnSaveScroll = document.getElementById('scroll-to-save-btn');
  if (btnSaveScroll) {
    const saveBtn = document.getElementById('btn-save-rec');
    if (st.view === 'input' && saveBtn) {
       const rect = saveBtn.getBoundingClientRect();
       // ä¿å­˜ãƒœã‚¿ãƒ³ãŒç”»é¢ä¸‹ç«¯ã‚ˆã‚Šä¸‹ã«ã‚ã‚‹å ´åˆã«è¡¨ç¤º
       btnSaveScroll.style.display = (rect.top > window.innerHeight) ? 'flex' : 'none';
    } else {
       btnSaveScroll.style.display = 'none';
    }
  }
});
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : å°åˆ·åˆ¶å¾¡é–¢æ•° â–¼â–¼â–¼
function printArea(mode) {
  // æ—¢å­˜ã®å°åˆ·ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
  Array.from(document.body.classList).forEach(c => {
    if (c.startsWith('print-mode-')) document.body.classList.remove(c);
  });

  const cls = 'print-mode-' + mode;
  document.body.classList.add(cls);

  setTimeout(() => {
    window.print();
    // ãƒ¢ãƒã‚¤ãƒ«(éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°)å¯¾ç­–: ã‚¯ãƒ©ã‚¹ã‚’å³åº§ã«å‰Šé™¤ã›ãšã€é•·æ™‚é–“ç¶­æŒã™ã‚‹
    // (CSSã¯@media printå†…ã®ã¿ã§æœ‰åŠ¹ãªãŸã‚ã€ç”»é¢è¡¨ç¤ºã«ã¯å½±éŸ¿ã—ãªã„)
    setTimeout(() => document.body.classList.remove(cls), 60000);
  }, 500);
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

function v(name) {
  showNav(); // ã‚°ãƒ©ãƒ•è¡¨ç¤ºã§éš ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§è¡¨ç¤ºã«æˆ»ã™
  st.view = name;
  document.querySelectorAll('#main-nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('b-' + name).classList.add('active');
  r();
}

function r()  {
  // èª­ã¿è¾¼ã¿å®Œäº†ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’æ¶ˆã™
  const loader = document.getElementById('loading-msg');
  if(loader) loader.style.display = 'none';

  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºã®åæ˜ 
  document.title = "è¡Œå‹•ãƒ­ã‚° " + VERSION;
  document.getElementById('ver-tag').innerText = VERSION;

  // èƒŒæ™¯è‰²ãƒªã‚»ãƒƒãƒˆ (CSSå¤‰æ•°ã«ä»»ã›ã‚‹ãŸã‚ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«å‰Šé™¤)
  document.body.style.background = '';

  ['input', 'search', 'analysis', 'maint'].forEach(n => {
    document.getElementById('s-' + n).style.display = (st.view === n ? 'block' : 'none');
  });

  const c = st.cats.find(x => x.id === st.cur) || st.cats[0];
  if (c) st.cur = c.id;

  // è¨˜éŒ²ç”»é¢ã®å ´åˆã€ã‚«ãƒ†ã‚´ãƒªãƒ¼è‰²ã‚’èƒŒæ™¯ã«è–„ãé©ç”¨ (ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯é©ç”¨ã—ãªã„)
  if (st.view === 'input' && c && c.color && /^#[0-9A-Fa-f]{6}$/.test(c.color) && !(st.settings && st.settings.darkMode)) {
    const h = c.color;
    const r = parseInt(h.slice(1,3), 16), g = parseInt(h.slice(3,5), 16), b = parseInt(h.slice(5,7), 16);
    document.body.style.background = `rgba(${r},${g},${b},0.15)`;
  }

  // â–¼â–¼â–¼ å¤‰æ›´: ãŠæ°—ã«å…¥ã‚Šå¯¾å¿œï¼ˆè¨˜éŒ²ç”»é¢ã®ã¿ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ï¼‰ â–¼â–¼â–¼
  const makeOpt = (x) => `<option value="${x.id}" style="background:${x.color}; color:#fff;" ${x.id === st.cur ? 'selected' : ''}>${esc(x.name)}</option>`;
  
  // è¨˜éŒ²ç”»é¢ç”¨ (sel-in)
  const favs = st.cats.filter(c => c.favorite);
  const others = st.cats.filter(c => !c.favorite);
  let optsIn = '';
  if (favs.length > 0) {
    optsIn += `<optgroup label="ãŠæ°—ã«å…¥ã‚Š">` + favs.map(makeOpt).join('') + `</optgroup>`;
    optsIn += `<optgroup label="ãã®ä»–">` + others.map(makeOpt).join('') + `</optgroup>`;
  } else {
    optsIn = st.cats.map(makeOpt).join('');
  }
  document.getElementById('sel-in').innerHTML = optsIn || '<option>ãªã—</option>';

  // é …ç›®è¨­å®šç”¨ (sel-f) ã¯é€šå¸¸ã®ä¸¦ã³é †
  document.getElementById('sel-f').innerHTML = st.cats.map(makeOpt).join('') || '<option>ãªã—</option>';
  // â–²â–²â–² å¤‰æ›´ â–²â–²â–²
  
  const csvSel = document.getElementById('csv-sel');
  if (csvSel) {
    csvSel.innerHTML = '<option value="all">å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€æ‹¬</option>' + st.cats.map(x => `<option value="${x.id}">${esc(x.name)}</option>`).join('');
  }

  if (st.view === 'input' && c) rIn(c);
  if (st.view === 'search') {
    const el = document.getElementById('srch-cat');
    if(el) {
      const v = el.value;
      el.innerHTML = '<option value="">å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>' + st.cats.map(x => `<option value="${x.id}">${esc(x.name)}</option>`).join('');
      el.value = v;
    }
    
    // æ¤œç´¢å±¥æ­´ã®æç”»
    const history = st.settings.searchHistory || [];
    const dl = document.getElementById('srch-datalist');
    if(dl) dl.innerHTML = history.map(h => `<option value="${esc(h.text)}"></option>`).join('');
    
    const area = document.getElementById('srch-history-area');
    if(area) {
      if(history.length > 0) {
        let h = `<div style="margin-bottom: 5px; padding-top: 5px; border-top: 1px dashed #ccc;">`;
        h += `<label style="font-size:10px; color:#888;">å±¥æ­´ã‹ã‚‰å…¥åŠ›:</label>`;
        h += `<div style="display:flex; overflow-x:auto; gap:5px; margin-top:5px; padding-bottom:5px; -webkit-overflow-scrolling: touch; max-width:100%;">`;
        const historyCount = st.settings.searchHistoryCount || 5;
        history.slice(0, historyCount).forEach(item => {
          h += `<button class="btn-sub" style="background:#e9ecef; color:#495057; white-space:nowrap;" onclick="setSearchKeyword('${esc(item.text)}')">${esc(item.text)}</button>`;
        });
        h += `</div></div>`;
        area.innerHTML = h;
      } else { area.innerHTML = ''; }
    }
    
    // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±¥æ­´ã®æç”»
    const notHistory = st.settings.searchNotHistory || [];
    const dlNot = document.getElementById('srch-not-datalist');
    if(dlNot) dlNot.innerHTML = notHistory.map(h => `<option value="${esc(h.text)}"></option>`).join('');
    
    const areaNot = document.getElementById('srch-not-history-area');
    if(areaNot) {
      if(notHistory.length > 0) {
        let h = `<div style="margin-bottom: 5px; padding-top: 5px; border-top: 1px dashed #ccc;">`;
        h += `<label style="font-size:10px; color:#888;">å±¥æ­´ã‹ã‚‰é™¤å¤–:</label>`;
        h += `<div style="display:flex; overflow-x:auto; gap:5px; margin-top:5px; padding-bottom:5px; -webkit-overflow-scrolling: touch; max-width:100%;">`;
        const historyCount = st.settings.searchHistoryCount || 5;
        notHistory.slice(0, historyCount).forEach(item => {
          h += `<button class="btn-sub" style="background:#ffecec; color:#dc3545; white-space:nowrap;" onclick="setSearchNotKeyword('${esc(item.text)}')">${esc(item.text)}</button>`;
        });
        h += `</div></div>`;
        areaNot.innerHTML = h;
      } else { areaNot.innerHTML = ''; }
    }
    rAnlz(true, false);
  }
  if (st.view === 'maint') {
    rCat();
    if (c) rField(c);
    renderCatIconPalette(); // ã‚¢ã‚¤ã‚³ãƒ³ãƒ‘ãƒ¬ãƒƒãƒˆåˆæœŸåŒ–
    renderIoLogs();
    updateSaveDirectoryStatus();
    const backupSwitch = document.getElementById('realtime-backup-switch');
    if (backupSwitch) {
      backupSwitch.checked = !!(st.settings && st.settings.realtimeBackup);
    }
    const darkModeSwitch = document.getElementById('dark-mode-switch');
    if (darkModeSwitch) {
      darkModeSwitch.checked = !!(st.settings && st.settings.darkMode);
    }
    const backupFreqSlider = document.getElementById('backup-freq-slider');
    if (backupFreqSlider) {
      const freq = (st.settings && st.settings.backupFrequency) || 1;
      backupFreqSlider.value = freq;
      document.getElementById('backup-freq-value').innerText = freq;
    }
    const graphHeightSlider = document.getElementById('graph-height-slider');
    if (graphHeightSlider && st.settings.graphHeight) {
      graphHeightSlider.value = st.settings.graphHeight;
      document.getElementById('graph-height-value').innerText = st.settings.graphHeight;
    }

    const lineColorInput = document.getElementById('graph-line-color-input');
    if (lineColorInput) lineColorInput.value = st.settings.graphLineColor || '#007bff';

    const lineWidthSlider = document.getElementById('graph-line-width-slider');
    if (lineWidthSlider) {
      const width = st.settings.graphLineWidth || 3;
      lineWidthSlider.value = width;
      document.getElementById('graph-line-width-value').innerText = width;
    }

    const maLineColorInput = document.getElementById('graph-ma-line-color-input');
    if (maLineColorInput) maLineColorInput.value = st.settings.graphMaLineColor || '#ff9800';
    const maLineWidthSlider = document.getElementById('graph-ma-line-width-slider');
    if (maLineWidthSlider) {
      const width = st.settings.graphMaLineWidth || 3;
      maLineWidthSlider.value = width;
      document.getElementById('graph-ma-line-width-value').innerText = width;
    }
    const latestLineColorInput = document.getElementById('graph-latest-line-color-input');
    if (latestLineColorInput) latestLineColorInput.value = st.settings.graphLatestLineColor || '#ff0000';
    const latestLineWidthSlider = document.getElementById('graph-latest-line-width-slider');
    if (latestLineWidthSlider) {
      const width = st.settings.graphLatestLineWidth || 1;
      latestLineWidthSlider.value = width;
      document.getElementById('graph-latest-line-width-value').innerText = width;
    }

    const fontSizeSlider = document.getElementById('graph-font-size-slider');
    if (fontSizeSlider) {
      const size = st.settings.graphDataFontSize || 10;
      fontSizeSlider.value = size;
      document.getElementById('graph-font-size-value').innerText = size;
    }

    const minLabelSpacingSlider = document.getElementById('graph-min-label-spacing-slider');
    if (minLabelSpacingSlider) {
      const spacing = st.settings.graphMinLabelSpacing !== undefined ? st.settings.graphMinLabelSpacing : 8;
      minLabelSpacingSlider.value = spacing;
      document.getElementById('graph-min-label-spacing-value').innerText = spacing;
    }

    const xAxisIntervalSelect = document.getElementById('graph-xaxis-interval-select');
    if (xAxisIntervalSelect) {
      xAxisIntervalSelect.value = st.settings.graphXAxisInterval || 'auto';
    }

    const axisFontSizeSlider = document.getElementById('graph-axis-font-size-slider');
    if (axisFontSizeSlider) {
      const size = st.settings.graphAxisFontSize || 10;
      axisFontSizeSlider.value = size;
      document.getElementById('graph-axis-font-size-value').innerText = size;
    }

    const titleFontSizeSlider = document.getElementById('graph-title-font-size-slider');
    if (titleFontSizeSlider) {
      const size = st.settings.graphTitleFontSize || 14;
      titleFontSizeSlider.value = size;
      document.getElementById('graph-title-font-size-value').innerText = size;
    }

    const markerShowSwitch = document.getElementById('graph-marker-show-switch');
    if (markerShowSwitch) {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆtrue
      markerShowSwitch.checked = (st.settings.graphMarkerShow !== false);
    }
    const markerSizeSlider = document.getElementById('graph-marker-size-slider');
    if (markerSizeSlider) {
      const size = st.settings.graphMarkerSize || 4;
      markerSizeSlider.value = size;
      document.getElementById('graph-marker-size-value').innerText = size;
    }

    const waterTargetNum = document.getElementById('water-target-num');
    const waterTargetSlider = document.getElementById('water-target-slider');
    if (waterTargetNum && waterTargetSlider) {
      const target = st.settings.waterTarget || 1500;
      waterTargetNum.value = target;
      waterTargetSlider.value = target;
    }

    const imgWidthSlider = document.getElementById('img-max-width-slider');
    if (imgWidthSlider) {
      const w = st.settings.imageMaxWidth || 800;
      imgWidthSlider.value = w;
      document.getElementById('img-max-width-value').innerText = w;
    }
    const imgQualitySlider = document.getElementById('img-quality-slider');
    if (imgQualitySlider) {
      const q = st.settings.imageQuality || 80;
      imgQualitySlider.value = q;
      document.getElementById('img-quality-value').innerText = q;
    }
    const searchHistorySlider = document.getElementById('search-history-count-slider');
    if (searchHistorySlider) {
      const count = (st.settings && st.settings.searchHistoryCount) || 5;
      searchHistorySlider.value = count;
      document.getElementById('search-history-count-value').innerText = count;
    }
  }
  if (st.view === 'analysis') {
    const mealHeaderInput = document.getElementById('meal-report-header-fields');
    if (mealHeaderInput) {
      mealHeaderInput.value = st.settings.mealReportHeaderFields || 'æ°å,æ€§åˆ¥,å¹´é½¢,èº«é•·,ä½“é‡,æ¨™æº–ä½“é‡,åç¸®æœŸè¡€åœ§,æ‹¡å¼µæœŸè¡€åœ§,HbA1c,è¡€ç³–å€¤,é‹å‹•,é£²é…’,å–«ç…™';
    }
    renderIntegratedItemSelector();
    renderExtFileList();
  }
}

// ãƒ†ã‚­ã‚¹ãƒˆè¤‡æ•°å…¥åŠ›ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
function addMultiInput(boxId, fid) {
  const box = document.getElementById(boxId);
  const div = document.createElement('div');
  div.style.cssText = "display:flex; gap:5px; margin-bottom:5px;";
  div.innerHTML = `<textarea class="multi-${fid}" rows="1" placeholder="å…¥åŠ›ã¾ãŸã¯é¸æŠ" oninput="autoResize(this)" style="margin:0; flex:1; resize:none; min-height:40px;"></textarea><button class="btn-sub" onclick="this.parentElement.remove()" style="background:#dc3545; width:40px; height:40px; align-self:flex-start;">Ã—</button>`;
  box.appendChild(div);
  // è¿½åŠ ç›´å¾Œã«ãƒªã‚µã‚¤ã‚ºé©ç”¨
  const ta = div.querySelector('textarea');
  if(ta) autoResize(ta);
}

// â–¼â–¼â–¼ è¿½åŠ : DataURIã‹ã‚‰æ‹¡å¼µå­ã‚’åˆ¤å®š â–¼â–¼â–¼
function getExtFromDataURI(uri) {
  const match = uri.match(/^data:([^;]+);/);
  if (!match) return 'bin';
  const mime = match[1];
  const map = {
    'application/pdf': 'pdf', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
    'application/vnd.ms-excel': 'xls', 'text/csv': 'csv', 'text/plain': 'txt', 'application/zip': 'zip',
    'image/jpeg': 'jpg', 'image/png': 'png', 'image/webp': 'webp', 'image/gif': 'gif'
  };
  return map[mime] || 'bin';
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Blobã¨ã—ã¦é–‹ã â–¼â–¼â–¼
function openFileBlob(fid) {
  const val = st.form[fid];
  if(!val) return;
  try {
    const parts = val.split(',');
    if(parts.length < 2) return;
    const byteString = atob(parts[1]);
    const mimeString = parts[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) {
      ia[i] = byteString.charCodeAt(i);
    }
    const blob = new Blob([ab], {type: mimeString});
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  } catch(e) {
    console.error(e);
    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚');
  }
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// è¨˜éŒ²å‡¦ç†
function rIn(c) {
  let editHtml = '';
  if (st.editR) {
    const recDate = getDt(st.form);
    const yyyy = recDate.getFullYear();
    const mm = String(recDate.getMonth() + 1).padStart(2, '0');
    const dd = String(recDate.getDate()).padStart(2, '0');
    const hh = String(recDate.getHours()).padStart(2, '0');
    const mi = String(recDate.getMinutes()).padStart(2, '0');
    const ss = String(recDate.getSeconds()).padStart(2, '0');
    
    const isCopy = st.saveMode === 'copy';
    editHtml = `
      <div style="margin-bottom: 10px; padding: 10px; background: #e9ecef; border-radius: 8px; display:flex; gap:15px; align-items:center;">
        <span style="font-weight:bold; font-size:12px;">ãƒ¢ãƒ¼ãƒ‰:</span>
        <label style="cursor:pointer; font-size:12px; display:flex; align-items:center;"><input type="radio" name="save-mode" ${!isCopy?'checked':''} onclick="setSaveMode('update')" style="width:auto; margin-right:4px;">ä¸Šæ›¸ãç·¨é›†</label>
        <label style="cursor:pointer; font-size:12px; display:flex; align-items:center;"><input type="radio" name="save-mode" ${isCopy?'checked':''} onclick="setSaveMode('copy')" style="width:auto; margin-right:4px;">æ–°è¦ã¨ã—ã¦ä¿å­˜</label>
      </div>
    `;
    if (!isCopy) {
      const editDow = getDowStr(`${yyyy}-${mm}-${dd}`);
      editHtml += `
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #f9f9f9;">
          <label style="font-weight:bold; color:#333;">æ—¥æ™‚å¤‰æ›´</label>
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="date" id="edit-date" value="${yyyy}-${mm}-${dd}" style="flex:1.5;" oninput="updateDayOfWeek(this, 'edit-dow')">
            <span id="edit-dow" style="font-size:12px; color:#666; min-width:2.5em;">${editDow}</span>
            <input type="time" id="edit-time" value="${hh}:${mi}:${ss}" step="1" style="flex:1;">
          </div>
        </div>
      `;
    } else {
      editHtml += `<div style="border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #e7f1ff; color:#0056b3; font-size:12px; text-align:center;"><b>ç¾åœ¨æ™‚åˆ»</b> ã§æ–°è¦ç™»éŒ²ã—ã¾ã™</div>`;
    }
  }

  const fieldsHtml = c.fields.map(f => {
    let val = st.form[f.id] || '';
    let h = `<label>${esc(f.name)}</label>`;
    switch (f.type) {
      case 'select':
        let items = f.options || [];
        h += `<input type="hidden" id="i-${f.id}" value="${esc(val)}">`;
        h += `<div id="sel-grp-${f.id}" style="display:flex; flex-wrap:wrap; gap:5px;">`;
        items.forEach(o => {
            const t = typeof o === 'string' ? o : o.text;
            const isSel = val == t;
            const bg = isSel ? '#007bff' : '#fff';
            const color = isSel ? '#fff' : '#333';
            const hoverEvents = `onmouseover="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='lightblue'" onmouseout="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='#fff'" ontouchstart="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='lightblue'" ontouchmove="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='#fff'" ontouchcancel="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='#fff'"`;
            h += `<button type="button" class="btn-sub option-btn" data-fid="${f.id}" onclick="selectOption('${f.id}', '${esc(t)}', this)" style="background:${bg}; color:${color}; border:3px solid #ccc; padding:10px; flex:1; min-width:80px;" ${hoverEvents}>${esc(t)}</button>`;
        });
        h += `</div>`;
        break;
      case 'multi_select':
        let mItems = f.options || [];
        const mVal = val || '';
        const mSelected = mVal ? String(mVal).split(' ') : [];
        h += `<input type="hidden" id="i-${f.id}" value="${esc(mVal)}">`;
        h += `<div id="sel-grp-${f.id}" style="display:flex; flex-wrap:wrap; gap:5px;">`;
        mItems.forEach(o => {
            const t = typeof o === 'string' ? o : o.text;
            const isSel = mSelected.includes(t);
            const bg = isSel ? '#007bff' : '#fff';
            const color = isSel ? '#fff' : '#333';
            const hoverEvents = `onmouseover="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='lightblue'" onmouseout="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='#fff'" ontouchstart="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='lightblue'" ontouchmove="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='#fff'" ontouchcancel="if(this.style.backgroundColor !== 'rgb(0, 123, 255)') this.style.backgroundColor='#fff'"`;
            h += `<button type="button" class="btn-sub option-btn" onclick="toggleMultiOption('${f.id}', '${esc(t)}', this)" style="background:${bg}; color:${color}; border:3px solid #ccc; padding:10px; flex:1; min-width:80px;" ${hoverEvents}>${esc(t)}</button>`;
        });
        h += `</div>`;
        break;
      case 'text':
        const vals = val ? String(val).split(' ') : [''];
        h += `<div id="box-${f.id}">`;
        vals.forEach(v => {
          h += `<div style="display:flex; gap:5px; margin-bottom:5px;"><textarea class="multi-${f.id}" rows="1" placeholder="å…¥åŠ›ã¾ãŸã¯é¸æŠ" oninput="autoResize(this)" style="margin:0; flex:1; resize:none; min-height:40px;">${esc(v)}</textarea><button class="btn-sub" onclick="this.parentElement.remove()" style="background:#dc3545; width:40px; height:40px; align-self:flex-start;">Ã—</button></div>`;
        });
        h += `</div>`;
        h += `<button class="btn-sub" onclick="addMultiInput('box-${f.id}','${f.id}')" style="width:100%; margin-bottom:10px; background:#17a2b8;">ï¼‹ è¿½åŠ </button>`;
        const opts = (f.options || []).map(o => o.text); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
        h += `<datalist id="list-${f.id}">${opts.map(o => `<option value="${esc(o)}"></option>`).join('')}</datalist>`;
        
        // â–¼â–¼â–¼ å¤‰æ›´: å€™è£œã‚’æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è¡¨ç¤º â–¼â–¼â–¼
        if (f.options && f.options.length > 0) {
            h += `<div style="margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ccc;">`;
            h += `<label style="font-size:10px; color:#888;">å€™è£œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¥åŠ› (æœ€è¿‘ä½¿ã£ãŸé †):</label>`;
            h += `<div style="display:flex; overflow-x:auto; gap:5px; margin-top:5px; padding-bottom:5px; -webkit-overflow-scrolling: touch;">`;
            // f.optionsã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ— {text, ts}
            const historyCount = st.settings.searchHistoryCount || 5;
            (f.options || []).slice(0, historyCount).forEach(optObj => {
                h += `<button class="btn-sub" style="background:#e9ecef; color:#495057; white-space:nowrap;" onclick="addTextFromOption('${f.id}', '${esc(optObj.text)}')">${esc(optObj.text)}</button>`;
            });
            h += `</div></div>`;
        }
        // â–²â–²â–² å¤‰æ›´ â–²â–²â–²
        break;
      case 'simple_text':
        h += `<textarea id="i-${f.id}" rows="1" oninput="autoResize(this)" style="resize:none; min-height:40px;">${esc(val)}</textarea>`;
        break;
      case 'number':
        h += `<input type="number" id="i-${f.id}" value="${esc(val)}">`;
        break;
      case 'date':
        const dow = getDowStr(val);
        h += `<div style="display:flex; align-items:center; gap:5px;">
          <input type="date" id="i-${f.id}" value="${esc(val)}" oninput="updateDayOfWeek(this, 'dow-${f.id}')" style="flex:1; margin:0;">
          <span id="dow-${f.id}" style="font-size:14px; color:#666; min-width:2.5em;">${dow}</span>
        </div>`;
        break;
      case 'time':
        h += `<input type="time" id="i-${f.id}" value="${esc(val)}" step="1">`;
        break;
      case 'camera':
        h += `<div id="cam-box-${f.id}" style="border:1px solid #ddd; padding:10px; border-radius:8px;">`;
        if (val) {
            h += `<img src="${val}" style="max-width:100%; border-radius:5px; margin-bottom:10px; cursor:pointer;" onclick="showImage('${val}')">`;
            h += `<button class="btn-sub" style="background:#dc3545;" onclick="clearCameraInput('${f.id}')">ç”»åƒã‚’æ¶ˆå»</button>`;
        } else {
            h += `<input type="file" accept="image/*" capture="environment" id="i-${f.id}" onchange="handleCameraInput(this, '${f.id}')" style="margin-bottom:10px;">`;
            h += `<div id="cam-preview-${f.id}"></div>`;
            if (getDeviceType() === 'pc') {
               h += `<div style="margin-top:5px; text-align:center; font-size:12px; color:#666;">ã¾ãŸã¯</div>`;
               h += `<button class="btn-sub" style="width:100%; margin-top:5px; background:#17a2b8;" onclick="startWebCam('${f.id}')">ğŸ“· Webã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>`;
            }
        }
        h += `</div>`;
        break;
      case 'file':
        h += `<div id="file-box-${f.id}" style="border:1px solid #ddd; padding:10px; border-radius:8px;">`;
        if (val) {
            let preview = '<div style="font-size:30px; text-align:center;">ğŸ“„</div>';
            if (val.startsWith('data:image')) {
                preview = `<div style="text-align:center;"><img src="${val}" style="max-width:100%; max-height:150px; border-radius:5px;"></div>`;
            }
            const fileName = st.form[f.id + '_name'];
            if (fileName) preview += `<div style="text-align:center; font-size:12px; margin-top:5px; color:#666;">${esc(fileName)}</div>`;
            const ext = getExtFromDataURI(val);
            const dlName = fileName || `file_${Date.now()}.${ext}`;
            h += `${preview}<div style="display:flex; gap:10px; justify-content:center; margin-top:5px;">
              <button class="btn-sub" style="background:#007bff; color:white; padding:6px 12px;" onclick="openFileBlob('${f.id}')">é–‹ã</button>
              <a href="${val}" download="${esc(dlName)}" class="btn-sub" style="background:#17a2b8; text-decoration:none; color:white; padding:6px 12px;">ä¿å­˜</a>
              <button class="btn-sub" style="background:#dc3545;" onclick="clearFileInput('${f.id}')">å‰Šé™¤</button>
            </div>`;
        } else {
            h += `<input type="file" id="i-${f.id}" onchange="handleFileInput(this, '${f.id}')">`;
        }
        h += `</div>`;
        break;
    }
    return h;
  }).join('');

  document.getElementById('form-in').innerHTML = `
    <div class="card">
      <h2 class="section-title">${st.editR ? 'ç·¨é›†' : 'è¨˜éŒ²'}: ${c.icon ? `<span style="margin-right:5px;">${c.icon}</span>` : ''}${esc(c.name)}</h2>
      ${editHtml}
      ${fieldsHtml}
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="btn-save-rec" class="btn-main" onclick="saveRec()" style="margin-top:0; flex:2;">ä¿å­˜</button>
        <button class="btn-main" onclick="clearForm()" style="margin-top:0; flex:1; background:#6c757d;">ã‚¯ãƒªã‚¢</button>
      </div>
      ${st.editR ? '<button class="btn-main" style="background:#666" onclick="cancelEdit()">æˆ»ã‚‹</button>' : ''}
    </div>`;

  // æç”»å¾Œã«ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’èª¿æ•´
  document.querySelectorAll('#form-in textarea').forEach(el => autoResize(el));
  
  // ãƒœã‚¿ãƒ³è¡¨ç¤ºçŠ¶æ…‹æ›´æ–°ã®ãŸã‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
  window.dispatchEvent(new Event('scroll'));

  document.getElementById('list-in').innerHTML = c.records.map(rec => {
    let originalDtHtml = '';
    if (rec.original_dt) {
        originalDtHtml = `<br><small style="color: #dc3545; font-size: 10px;">(å…ƒã®æ™‚åˆ»: ${formatDateYMDHM(rec.original_dt)})</small>`;
    }
    return `<div class="rec-row">
      <button class="rec-body" onclick="editRec('${c.id}','${rec.id}')">
        <small>${formatDateYMDHM(getDt(rec))}</small>${originalDtHtml}
        <div style="margin-top: 4px;">
          ${c.fields.map(f => {
            if (!rec[f.id]) return '';
            if (f.type === 'camera') {
              return `<span class="field-tag"><b>${esc(f.name)}:</b> <img src="${rec[f.id]}" style="height:24px; vertical-align:middle; border-radius:3px; cursor:pointer;" onclick="event.stopPropagation(); showImage('${rec[f.id]}')"></span>`;
            }
            if (f.type === 'file') {
              const fname = rec[f.id + '_name'];
              const content = (rec[f.id].startsWith('data:image') ? `<img src="${rec[f.id]}" style="height:24px; vertical-align:middle; border-radius:3px;">` : 'ğŸ“„') + (fname ? ' ' + esc(fname) : '');
              return `<span class="field-tag"><b>${esc(f.name)}:</b> ${content}</span>`;
            }
            return `<span class="field-tag"><b>${esc(f.name)}:</b> ${esc(rec[f.id])}</span>`;
          }).filter(x => x).join('')}
        </div>
      </button>
      <button class="del-btn" onclick="delRec('${c.id}','${rec.id}')">å‰Šé™¤</button>
    </div>`;
  }).join('');
}

// â˜…è¿½åŠ : ãƒ•ã‚©ãƒ¼ãƒ ã®ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’ä¸€æ™‚ä¿å­˜ã™ã‚‹ï¼ˆå†æç”»å¯¾ç­–ï¼‰
function captureFormValues() {
  const c = st.cats.find(x => x.id === st.cur);
  if (!c) return;
  c.fields.forEach(f => {
    if (f.type === 'text') {
      const inputs = document.querySelectorAll(`.multi-${f.id}`);
      const vals = Array.from(inputs).map(i => i.value.trim()).filter(v => v);
      st.form[f.id] = vals.join(' ');
    } else if (f.type === 'select' || f.type === 'multi_select') {
      const el = document.getElementById('i-' + f.id);
      if (el) st.form[f.id] = el.value;
    } else {
      const el = document.getElementById('i-' + f.id);
      if (el) st.form[f.id] = el.value;
    }
  });
  if (st.editR) {
    const dateInput = document.getElementById('edit-date');
    const timeInput = document.getElementById('edit-time');
    if (dateInput && timeInput) {
      const newDt = new Date(`${dateInput.value}T${timeInput.value}`);
      if (!isNaN(newDt.getTime())) st.form.dt = toJSTISOString(newDt);
    }
  }
}

// â˜…è¿½åŠ : å€™è£œã‹ã‚‰ã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
function addTextFromOption(fieldId, optionText) {
    const box = document.getElementById(`box-${fieldId}`);
    const currentInputs = Array.from(box.querySelectorAll(`.multi-${fieldId}`));

    // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è§£é™¤ï¼ˆå‰Šé™¤ï¼‰
    const existing = currentInputs.find(input => input.value === optionText);
    if (existing) {
        existing.parentElement.remove();
        if (box.querySelectorAll(`.multi-${fieldId}`).length === 0) {
            addMultiInput(`box-${fieldId}`, fieldId);
        }
        return;
    }

    // æœ€åˆã®ç©ºã®å…¥åŠ›æ¬„ã‚’æ¢ã™
    let emptyInput = currentInputs.find(input => input.value.trim() === '');

    if (emptyInput) {
        emptyInput.value = optionText;
        emptyInput.dispatchEvent(new Event('change', {bubbles: true}));
    } else {
        // ç©ºã®å…¥åŠ›æ¬„ãŒãªã‘ã‚Œã°ã€æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ ã—ã¦å…¥åŠ›
        addMultiInput(`box-${fieldId}`, fieldId);
        const newInputs = box.querySelectorAll(`.multi-${fieldId}`);
        const newInput = newInputs[newInputs.length - 1];
        if (newInput) {
            newInput.value = optionText;
            newInput.dispatchEvent(new Event('change', {bubbles: true}));
        }
    }
}

// â˜…è¿½åŠ : ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›å‡¦ç†
async function handleFileInput(input, fieldId) {
    captureFormValues();
    const file = input.files[0];
    if (!file) return;

    // ç”»åƒã®å ´åˆã¯ç·¨é›†ç”»é¢ã‚’é–‹ã (åœ§ç¸®ãƒ»å›è»¢ãƒ»æ˜ã‚‹ã•èª¿æ•´ã®ãŸã‚)
    if (file.type.startsWith('image/')) {
        st.tempEditFileName = file.name;
        const reader = new FileReader();
        reader.onload = (e) => {
            openImageEditor(e.target.result, fieldId);
        };
        reader.readAsDataURL(file);
        input.value = '';
        return;
    }

    if (file.size > 5 * 1024 * 1024) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ (ä¸Šé™5MB)'); input.value = ''; return; }
    st.form[fieldId + '_name'] = file.name;
    const reader = new FileReader();
    reader.onload = (e) => { st.form[fieldId] = e.target.result; const c = st.cats.find(x => x.id === st.cur); rIn(c); };
    reader.readAsDataURL(file);
}
function clearFileInput(fieldId) {
    captureFormValues();
    st.form[fieldId] = '';
    delete st.form[fieldId + '_name'];
    const c = st.cats.find(x => x.id === st.cur);
    rIn(c);
}

// â–¼â–¼â–¼ è¿½åŠ : ç”»åƒç·¨é›†æ©Ÿèƒ½ (Cropper.js) â–¼â–¼â–¼
let currentCropper = null;
let currentEditFieldId = null;
let currentEditType = 'record';
let currentBrightness = 100;

function openImageEditor(dataUrl, fieldId, type = 'record') {
  currentEditFieldId = fieldId;
  currentEditType = type;
  currentBrightness = 100;
  
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  const modalOverlay = document.getElementById('modal-overlay');
  
  modalTitle.innerText = 'ç”»åƒã®ç·¨é›† (ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ»å›è»¢)';
  modalBody.innerHTML = `
    <div style="max-height: 60vh; overflow: hidden; background: #333; text-align: center;">
      <img id="image-to-edit" src="${dataUrl}" style="max-width: 100%; max-height: 60vh; display: block; margin: 0 auto;">
    </div>
    <div style="margin-top:10px; padding:0 5px;">
       <label style="font-size:12px; font-weight:bold; display:flex; justify-content:space-between;"><span>æ˜ã‚‹ã•</span><span id="brightness-val">100%</span></label>
       <input type="range" min="50" max="150" step="5" value="100" style="width:100%;" oninput="updateBrightness(this.value)">
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 10px; gap: 10px; flex-wrap: wrap;">
      <div style="display: flex; gap: 5px;">
        <button class="btn-sub" onclick="rotateImage(-90)" style="font-size: 18px; width: 40px;">â†º</button>
        <button class="btn-sub" onclick="rotateImage(90)" style="font-size: 18px; width: 40px;">â†»</button>
      </div>
      <div style="display: flex; gap: 5px;">
        <button class="btn-main" onclick="saveEditedImage()" style="margin: 0; padding: 8px 16px; background: #28a745;">æ±ºå®š</button>
        <button class="btn-sub" onclick="closeImageEditor()" style="background: #6c757d;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  `;
  
  modalOverlay.style.display = 'flex';
  modalOverlay.onclick = closeImageEditor; // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æŒ™å‹•ã‚’å¤‰æ›´
  
  const image = document.getElementById('image-to-edit');
  currentCropper = new Cropper(image, {
    aspectRatio: NaN, viewMode: 1, dragMode: 'move', autoCropArea: 0.9, restore: false, guides: true, center: true,
    highlight: false, cropBoxMovable: true, cropBoxResizable: true, toggleDragModeOnDblclick: false, background: false
  });
}

function rotateImage(deg) { if (currentCropper) currentCropper.rotate(deg); }

function updateBrightness(val) {
  currentBrightness = val;
  document.getElementById('brightness-val').innerText = val + '%';
  const imgs = document.querySelectorAll('.cropper-container img');
  imgs.forEach(img => {
    img.style.filter = `brightness(${val}%)`;
  });
}

function closeImageEditor() {
  if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
  currentEditFieldId = null;
  const overlay = document.getElementById('modal-overlay');
  overlay.style.display = 'none';
  overlay.onclick = closeModal; // å…ƒã«æˆ»ã™
}

function saveEditedImage() {
  if (!currentCropper) return;
  let canvas = currentCropper.getCroppedCanvas();
  if (!canvas) return;
  
  // æ˜ã‚‹ã•èª¿æ•´ã®é©ç”¨
  if (currentBrightness != 100) {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const ctx = tempCanvas.getContext('2d');
      ctx.filter = `brightness(${currentBrightness}%)`;
      ctx.drawImage(canvas, 0, 0);
      canvas = tempCanvas;
  }
  
  const maxWidth = st.settings.imageMaxWidth || 800;
  const quality = (st.settings.imageQuality || 80) / 100;
  let outputCanvas = canvas;
  if (canvas.width > maxWidth) {
      const scale = maxWidth / canvas.width;
      outputCanvas = document.createElement('canvas');
      outputCanvas.width = maxWidth; outputCanvas.height = canvas.height * scale;
      outputCanvas.getContext('2d').drawImage(canvas, 0, 0, outputCanvas.width, outputCanvas.height);
  }
  const resultDataUrl = outputCanvas.toDataURL('image/jpeg', quality);
  if (currentEditType === 'stock') {
      updateStockImage(currentEditFieldId, resultDataUrl);
  } else if (currentEditFieldId) {
      st.form[currentEditFieldId] = resultDataUrl;
      if (st.tempEditFileName) {
          let name = st.tempEditFileName;
          const lastDot = name.lastIndexOf('.');
          if (lastDot > 0) name = name.substring(0, lastDot);
          st.form[currentEditFieldId + '_name'] = name + '.jpg';
          delete st.tempEditFileName;
      }
      const c = st.cats.find(x => x.id === st.cur);
      rIn(c);
  }
  closeImageEditor();
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â˜…è¿½åŠ : ã‚«ãƒ¡ãƒ©å…¥åŠ›å‡¦ç†
async function handleCameraInput(input, fieldId) {
    captureFormValues(); // ç”»åƒå‡¦ç†ä¸­ã®å†æç”»ã§å…¥åŠ›ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«å€¤ã‚’ä¿å­˜
    const file = input.files[0];
    if (!file) return;

    const previewDiv = document.getElementById(`cam-preview-${fieldId}`);
    previewDiv.innerHTML = 'ç”»åƒå‡¦ç†ä¸­...';

    st.tempEditFileName = file.name;
    const reader = new FileReader();
    reader.onload = (e) => {
        previewDiv.innerHTML = '';
        openImageEditor(e.target.result, fieldId);
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function clearCameraInput(fieldId) {
    captureFormValues(); // å†æç”»å‰ã«å…¥åŠ›å€¤ã‚’ä¿å­˜
    st.form[fieldId] = '';
    const c = st.cats.find(x => x.id === st.cur);
    rIn(c);
}

// â˜…è¿½åŠ : Webã‚«ãƒ¡ãƒ©åˆ¶å¾¡ (PCç”¨)
let activeStream = null;
async function startWebCam(fid) {
  captureFormValues(); // å…¥åŠ›é€€é¿
  const box = document.getElementById(`cam-box-${fid}`);
  if(!box) return;
  
  box.innerHTML = `
    <div style="text-align:center; background:#000; border-radius:8px; overflow:hidden;">
      <video id="vid-${fid}" autoplay playsinline style="width:100%; max-height:300px; object-fit:contain;"></video>
    </div>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button class="btn-main" onclick="snapWebCam('${fid}')" style="background:#dc3545;">æ’®å½±</button>
      <button class="btn-main" onclick="stopWebCam('${fid}')" style="background:#6c757d;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  `;

  try {
    activeStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    const vid = document.getElementById(`vid-${fid}`);
    if(vid) vid.srcObject = activeStream;
  } catch(e) {
    alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    stopWebCam(fid);
  }
}

function stopWebCam(fid) {
  if(activeStream) {
    activeStream.getTracks().forEach(t => t.stop());
    activeStream = null;
  }
  const c = st.cats.find(x => x.id === st.cur);
  rIn(c);
}

function snapWebCam(fid) {
  const vid = document.getElementById(`vid-${fid}`);
  if(!vid) return;
  
  const canvas = document.createElement('canvas');
  canvas.width = vid.videoWidth;
  canvas.height = vid.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(vid, 0, 0);
  
  const dataUrl = canvas.toDataURL('image/jpeg');
  st.tempEditFileName = `webcam_${Date.now()}.jpg`;
  stopWebCam(fid);
  openImageEditor(dataUrl, fid);
}

// â˜…è¿½åŠ : ç”»åƒãƒªã‚µã‚¤ã‚ºé–¢æ•°
function resizeImage(file, maxWidth) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let { width, height } = img;
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const quality = (st.settings.imageQuality || 80) / 100;
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// â˜…è¿½åŠ : ç”»åƒæ‹¡å¤§è¡¨ç¤º
function showImage(dataUrl) {
  document.getElementById('modal-title').innerText = 'ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
  document.getElementById('modal-body').innerHTML = `<img src="${dataUrl}" style="max-width:100%; height:auto; display:block; margin:auto;">`;
  document.getElementById('modal-overlay').style.display = 'flex';
}

function clearForm() {
  st.form = {};
  st.editR = null;
  st.saveMode = null;
  r();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// â–¼â–¼â–¼ è¿½åŠ : åœ¨åº«è£œæ­£ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function parseStockValue(stockStr, drugNames) {
  const result = {};
  if (!stockStr) return result;
  const s = String(stockStr);
  
  let foundKeyed = false;
  drugNames.forEach(name => {
    const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // "Name:Val" or "Name=Val"
    const match = s.match(new RegExp(`${escapedName}\\s*[:=]\\s*(-?\\d+(\\.\\d+)?)`));
    if (match) {
      result[name] = parseFloat(match[1]);
      foundKeyed = true;
    }
  });

  // ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãšã€ã‹ã¤è–¬å‰¤ãŒ1ã¤ã®å ´åˆã¯å˜ä¸€æ•°å€¤ã¨ã—ã¦è§£æ
  if (!foundKeyed && drugNames.length === 1) {
    const match = s.match(/^-?\d+(\.\d+)?$/);
    if (match) {
      result[drugNames[0]] = parseFloat(match[0]);
    }
  }
  return result;
}

function propagateStockCorrection(c, originalRecord, newForm) {
  const fDrug = c.fields.find(f => f.name === 'è–¬å‰¤');
  const fStock = c.fields.find(f => f.name === 'å¸³ç°¿åœ¨åº«æ•°');
  
  if (!fDrug || !fStock) return;

  const oldDrugVal = originalRecord[fDrug.id];
  const oldStockVal = originalRecord[fStock.id];
  const newDrugVal = newForm[fDrug.id];
  const newStockVal = newForm[fStock.id];

  // è–¬å‰¤åãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è¿½è·¡å›°é›£ãªãŸã‚å¯¾è±¡å¤–
  if (oldDrugVal !== newDrugVal) return; 
  if (!oldStockVal || !newStockVal) return;
  if (oldStockVal === newStockVal) return;

  const drugs = oldDrugVal.split(/[\s,]+/).filter(d => d);
  const oldMap = parseStockValue(oldStockVal, drugs);
  const newMap = parseStockValue(newStockVal, drugs);
  
  const diffs = {};
  let hasDiff = false;
  drugs.forEach(d => {
    if (oldMap[d] !== undefined && newMap[d] !== undefined) {
      const diff = newMap[d] - oldMap[d];
      // æµ®å‹•å°æ•°ç‚¹ã®èª¤å·®ã‚’è€ƒæ…®ã—ã¦åˆ¤å®š
      if (Math.abs(diff) > 0.000001) {
        diffs[d] = diff;
        hasDiff = true;
      }
    }
  });

  if (!hasDiff) return;

  const targetDate = getDt(originalRecord);

  // æœªæ¥ã®è¨˜éŒ²ã‚’æŠ½å‡ºã—ã¦å¤ã„é †ï¼ˆæ™‚ç³»åˆ—é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
  const futureRecs = c.records.filter(r => {
      if (r.id === originalRecord.id) return false;
      return getDt(r) > targetDate;
  }).sort((a, b) => getDt(a) - getDt(b));

  // è£œæ­£å¯¾è±¡ã¨ãªã‚‹æœªæ¥ã®è¨˜éŒ²ãŒå®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const hasFutureTarget = futureRecs.some(r => {
      const rDrugVal = r[fDrug.id];
      if (!rDrugVal) return false;
      const rDrugs = rDrugVal.split(/[\s,]+/).filter(d => d);
      return rDrugs.some(d => diffs[d] !== undefined);
  });

  if (!hasFutureTarget) return;

  if (!confirm('åœ¨åº«æ•°ã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚\nã“ã®å¤‰æ›´ï¼ˆå·®åˆ†ï¼‰ã‚’ã€ã“ã®è¨˜éŒ²ä»¥é™ã®ã™ã¹ã¦ã®åœ¨åº«è¨˜éŒ²ã«åæ˜ ï¼ˆæ´—ã„æ›¿ãˆï¼‰ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ã€ŒOKã€ã‚’æŠ¼ã™ã¨ã€æœªæ¥ã®è¨˜éŒ²ã®åœ¨åº«æ•°ãŒè‡ªå‹•çš„ã«è£œæ­£ã•ã‚Œã¾ã™ã€‚')) return;

  const fType = c.fields.find(f => f.name === 'åœ¨åº«åŒºåˆ†');
  let count = 0;

  for (const r of futureRecs) {
    const rDrugVal = r[fDrug.id];
    const rStockVal = r[fStock.id];
    if (!rDrugVal || !rStockVal) continue;

    const rDrugs = rDrugVal.split(/[\s,]+/).filter(d => d);
    // å¤‰æ›´ãŒã‚ã£ãŸè–¬å‰¤ã‚’å«ã‚€è¨˜éŒ²ã‹ãƒã‚§ãƒƒã‚¯
    const relevantDrugs = rDrugs.filter(d => diffs[d] !== undefined);
    if (relevantDrugs.length === 0) continue;

    // æ£šå¸ãƒã‚§ãƒƒã‚¯: æ£šå¸ã®è¨˜éŒ²ãŒã‚ã‚Œã°ã€ãã®è–¬å‰¤ã®è£œæ­£ã¯ãã“ã§çµ‚äº†ï¼ˆä»¥é™ã®è¨˜éŒ²ã«ã¯æ³¢åŠã•ã›ãªã„ï¼‰
    if (fType && r[fType.id] === 'æ£šå¸') {
        relevantDrugs.forEach(d => delete diffs[d]);
        if (Object.keys(diffs).length === 0) break; // å…¨è–¬å‰¤ã®è£œæ­£ãŒçµ‚äº†ã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—æŠœã‘
        continue;
    }

    const rMap = parseStockValue(rStockVal, rDrugs);
    let modified = false;
    
    relevantDrugs.forEach(d => {
      if (rMap[d] !== undefined) {
        rMap[d] += diffs[d];
        // èª¤å·®å¯¾ç­–
        rMap[d] = parseFloat(rMap[d].toFixed(6));
        modified = true;
      }
    });

    if (modified) {
      // åœ¨åº«æ–‡å­—åˆ—ã®å†æ§‹ç¯‰
      if (rDrugs.length === 1 && Object.keys(rMap).length === 1) {
         r[fStock.id] = rMap[rDrugs[0]];
      } else {
         // "Name:Val Name:Val" å½¢å¼
         const parts = rDrugs.map(d => {
             const val = rMap[d] !== undefined ? rMap[d] : '?';
             return `${d}:${val}`;
         });
         r[fStock.id] = parts.join(' ');
      }
      count++;
    }
  }
  
  if (count > 0) {
      showToast(`${count}ä»¶ã®æœªæ¥ã®è¨˜éŒ²ã‚’è£œæ­£ã—ã¾ã—ãŸ`);
  } else {
      showToast('è£œæ­£å¯¾è±¡ã®æœªæ¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  }
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

function saveRec() {
  const c = st.cats.find(x => x.id === st.cur);
  if (!c) return;

  // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å„é …ç›®ã®å€¤ã‚’å–å¾—
  c.fields.forEach(f => {
    if (f.type === 'text') {
      const inputs = document.querySelectorAll(`.multi-${f.id}`);
      const vals = Array.from(inputs).map(i => i.value.trim()).filter(v => v);
      st.form[f.id] = vals.join(' ');
      
      // â–¼â–¼â–¼ å¤‰æ›´: å€™è£œã®å­¦ç¿’ã¨å¤ã„ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ â–¼â–¼â–¼
      if (!f.options) f.options = [];
      const oneMonthAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;

      // ã¾ãšã€ä¸€ãƒ¶æœˆä»¥ä¸Šå‰ã®å¤ã„å€™è£œã‚’å‰Šé™¤
      f.options = f.options.filter(o => o.ts >= oneMonthAgo);

      // ä»Šå›ä½¿ç”¨ã—ãŸå€¤ã‚’æ›´æ–°ã¾ãŸã¯è¿½åŠ 
      vals.forEach(v => {
        // æ—¢å­˜ã®å€™è£œã‹ã‚‰åŒã˜ãƒ†ã‚­ã‚¹ãƒˆã®ã‚‚ã®ã‚’å‰Šé™¤
        f.options = f.options.filter(o => o.text !== v);
        // æ–°ã—ã„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§å…ˆé ­ã«è¿½åŠ 
        f.options.unshift({ text: v, ts: Date.now() });
      });

      if (f.options.length > 30) f.options.length = 30;
      // â–²â–²â–² å¤‰æ›´ â–²â–²â–²
    } else if (f.type === 'select') {
      const el = document.getElementById('i-' + f.id);
      if (el) {
        const val = el.value;
        st.form[f.id] = val;
      }
    } else {
      const el = document.getElementById('i-' + f.id);
      if (el) st.form[f.id] = el.value;
    }
    // cameraã®å ´åˆã¯handleCameraInputã§st.formã«ã‚»ãƒƒãƒˆæ¸ˆã¿ãªã®ã§ä½•ã‚‚ã—ãªã„
  });

  if (st.editR && st.saveMode !== 'copy') { // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    const recordIndex = c.records.findIndex(x => x.id === st.editR);
    if (recordIndex === -1) { cancelEdit(); return; }

    const originalRecord = c.records[recordIndex];
    
    // â–¼â–¼â–¼ è¿½åŠ : åœ¨åº«è£œæ­£ â–¼â–¼â–¼
    propagateStockCorrection(c, originalRecord, st.form);
    // â–²â–²â–² è¿½åŠ  â–²â–²â–²

    const updatedRecord = { ...originalRecord, ...st.form };

    // æ—¥æ™‚å¤‰æ›´ã®å‡¦ç†
    const dateInput = document.getElementById('edit-date');
    const timeInput = document.getElementById('edit-time');
    if (dateInput && timeInput) {
        const newDt = new Date(`${dateInput.value}T${timeInput.value}`);
        if (!isNaN(newDt.getTime())) {
            const newTimestamp = toJSTISOString(newDt);
            const oldTimestamp = toJSTISOString(getDt(originalRecord));

            if (newTimestamp !== oldTimestamp) {
                // å…ƒã®æ™‚åˆ»ã‚’ä¿å­˜
                if (!updatedRecord.original_dt) {
                    updatedRecord.original_dt = oldTimestamp;
                }
                updatedRecord.dt = newTimestamp;
            }
        }
    }
    c.records[recordIndex] = updatedRecord;
    // æ—¥ä»˜ãŒå¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ã‚½ãƒ¼ãƒˆã™ã‚‹
    c.records.sort((a, b) => getDt(b) - getDt(a));

  } else { // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
    const newRec = { ...st.form };
    delete newRec.id;
    delete newRec.original_dt;
    c.records.unshift({ ...newRec, id: 'r' + Date.now(), dt: toJSTISOString(new Date()) });
    
    // â–¼â–¼â–¼ è¿½åŠ : åœ¨åº«è‡ªå‹•æ¸›ç®—å‡¦ç† â–¼â–¼â–¼
    if (st.stock && st.stock.length > 0) {
      // å…¥åŠ›ã•ã‚ŒãŸå…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆã—ã¦æ¤œç´¢å¯¾è±¡ã«ã™ã‚‹
      const inputValues = Object.values(st.form).join(' ').toLowerCase();
      let stockChanged = false;
      
      st.stock.forEach(item => {
        if (item.keywords) {
          const keys = item.keywords.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
          // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ãŒå…¥åŠ›ã«å«ã¾ã‚Œã¦ã„ã‚Œã°åœ¨åº«ã‚’æ¸›ã‚‰ã™
          if (keys.some(k => inputValues.includes(k))) {
            changeStock(item.id, -1, 'auto'); // è‡ªå‹•æ¸›ç®—
            stockChanged = true;
            showToast(`åœ¨åº«ã‚’æ¸›ã‚‰ã—ã¾ã—ãŸ: ${esc(item.name)} (-1)`);
          }
        }
      });
    }
    // â–²â–²â–² è¿½åŠ  â–²â–²â–²
  }
  cancelEdit();
  save();
  r();
  const saveBtn = document.getElementById('btn-save-rec');
  if (saveBtn) {
    const navHeight = document.querySelector('.nav') ? document.querySelector('.nav').offsetHeight : 60;
    const y = saveBtn.getBoundingClientRect().top + (window.scrollY || window.pageYOffset) - navHeight - 10;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }
}
function editRec(cid, rid) {
  st.cur = cid;
  const c = st.cats.find(x => x.id === cid);
  st.form = { ...c.records.find(x => x.id === rid) };
  st.editR = rid;
  st.saveMode = 'update';
  v('input');
  window.scrollTo(0, 0);
}
function setSaveMode(mode) {
  captureFormValues();
  st.saveMode = mode;
  const c = st.cats.find(x => x.id === st.cur);
  rIn(c);
}
function cancelEdit() {
  st.editR = null;
  st.form = {};
  r();
}
function delRec(cid, rid) {
  if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    const c = st.cats.find(x => x.id === cid);
    c.records = c.records.filter(x => x.id !== rid);
    save();
    r();
  }
}

// ã‚«ãƒ†ã‚´ãƒªç®¡ç†
function rCat() {
  document.getElementById('list-c').innerHTML = st.cats.map((category, index) => `
    <div class="card">
      <div style="margin-bottom:8px; word-break:break-all;">
        <b><span style="display:inline-block; width:12px; height:12px; background:${category.color||'#ccc'}; border-radius:50%; margin-right:8px; vertical-align:middle;"></span>${category.favorite ? '<span style="color:#f59e0b; margin-right:4px;">â˜…</span>' : ''}${category.icon ? `<span style="margin-right:4px;">${category.icon}</span>` : ''}${esc(category.name)}</b>
      </div>
      <div style="text-align:right;">
        <button class="btn-sub" onclick="moveCat('${category.id}',-1)" ${index === 0 ? 'disabled style="opacity:0.3"' : ''}>â†‘</button>
        <button class="btn-sub" onclick="moveCat('${category.id}',1)" ${index === st.cats.length - 1 ? 'disabled style="opacity:0.3"' : ''}>â†“</button>
        <button class="btn-sub" onclick="editCat('${category.id}')">ç·¨é›†</button>
        <button class="btn-sub" style="background:#ff4d4d" onclick="delC('${category.id}')">å‰Šé™¤</button>
      </div>
    </div>`).join('');
}
function editCat(id) {
  const category = st.cats.find(cat => cat.id === id);
  if (!category) return;
  st.editCat = id;
  document.getElementById('cat-name-in').value = category.name;
  document.getElementById('cat-color-in').value = category.color || CAT_COLORS[0];
  document.getElementById('cat-icon-in').value = category.icon || '';
  document.getElementById('cat-fav-in').checked = !!category.favorite;
  renderCatPalette();
  renderCatIconPalette();
  document.getElementById('cat-rules-area').style.display = 'block';
  renderListEditor('cat-rules-container', category.rules || [], 'loadRuleToBuilder');
  renderRuleBuilder(id); // ãƒ«ãƒ¼ãƒ«ãƒ“ãƒ«ãƒ€ãƒ¼åˆæœŸåŒ–
  document.getElementById('title-c').innerText = "ã‚«ãƒ†ã‚´ãƒªãƒ¼ç·¨é›†";
  document.getElementById('btn-cat-save').innerText = "æ›´æ–°ä¿å­˜";
  document.getElementById('btn-cat-cancel').style.display = "block";
}
function cancelCat() {
  st.editCat = null;
  document.getElementById('cat-name-in').value = '';
  document.getElementById('cat-color-in').value = CAT_COLORS[0];
  document.getElementById('cat-icon-in').value = '';
  document.getElementById('cat-fav-in').checked = false;
  renderCatPalette();
  renderCatIconPalette();
  document.getElementById('cat-rules-area').style.display = 'none';
  document.getElementById('cat-rules-container').innerHTML = '';
  document.getElementById('cat-rule-new').value = '';
  document.getElementById('title-c').innerText = "ã‚«ãƒ†ã‚´ãƒªãƒ¼è¿½åŠ ";
  document.getElementById('btn-cat-save').innerText = "æ–°è¦ä½œæˆ";
  document.getElementById('btn-cat-cancel').style.display = "none";
}
function saveCat() {
  const name = document.getElementById('cat-name-in').value;
  const color = document.getElementById('cat-color-in').value || CAT_COLORS[0];
  const icon = document.getElementById('cat-icon-in').value || '';
  const isFav = document.getElementById('cat-fav-in').checked;
  if (!name) return;
  if (st.editCat) {
    const categoryToEdit = st.cats.find(cat => cat.id === st.editCat);
    if (categoryToEdit) {
      categoryToEdit.name = name;
      categoryToEdit.color = color;
      categoryToEdit.icon = icon;
      categoryToEdit.favorite = isFav;
      categoryToEdit.rules = getListItems('cat-rules-container');
    }
    st.editCat = null;
  } else {
    const newCategoryId = 'c' + Date.now();
    st.cats.push({ id: newCategoryId, name: name, color: color, icon: icon, favorite: isFav, fields: [], records: [] });
    st.cur = newCategoryId;
  }
  cancelCat();
  save();
  r();
}
function moveCat(id, d) {
  const index = st.cats.findIndex(cat => cat.id === id);
  if (index < 0 || index + d < 0 || index + d >= st.cats.length) return;
  [st.cats[index], st.cats[index + d]] = [st.cats[index + d], st.cats[index]];
  save();
  r();
}
function delC(id) {
  if (confirm('å…¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™')) {
    st.cats = st.cats.filter(cat => cat.id !== id);
    save();
    r();
  }
}

// â˜… ãƒªã‚¹ãƒˆç·¨é›†ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ â˜…
function renderListEditor(containerId, items, onEditCallbackName) {
  const c = document.getElementById(containerId); c.innerHTML = '';
  items.forEach(val => {
    const div = document.createElement('div'); div.className = 'list-edit-row';
    div.style.flexDirection = 'column';
    const editBtn = onEditCallbackName ? `<button style="background:#17a2b8; padding:8px;" onclick="${onEditCallbackName}(this.closest('.list-edit-row').querySelector('textarea').value)">Set</button>` : '';
    div.innerHTML = `<textarea style="font-family:monospace; min-height:60px; margin-bottom:5px; flex:none; width:100%; overflow-y:hidden;" oninput="autoResize(this)" onfocus="autoResize(this)">${esc(val)}</textarea>
      <div style="display:flex; gap:5px; justify-content:flex-end;">
        ${editBtn}
        <button style="background:#6c757d; padding:8px;" onclick="moveListItem(this,-1)">â†‘</button>
        <button style="background:#6c757d; padding:8px;" onclick="moveListItem(this,1)">â†“</button>
        <button style="background:#dc3545; padding:8px;" onclick="this.closest('.list-edit-row').remove()">å‰Šé™¤</button>
      </div>`;
    c.appendChild(div);
    autoResize(div.querySelector('textarea'));
  });
}
function addListItem(containerId, inputId, onEditCallbackName) {
  const input = document.getElementById(inputId); const val = input.value.trim(); if(!val) return;
  const c = document.getElementById(containerId);
  const div = document.createElement('div'); div.className = 'list-edit-row';
  div.style.flexDirection = 'column';
  const editBtn = onEditCallbackName ? `<button style="background:#17a2b8; padding:8px;" onclick="${onEditCallbackName}(this.closest('.list-edit-row').querySelector('textarea').value)">Set</button>` : '';
  div.innerHTML = `<textarea style="font-family:monospace; min-height:60px; margin-bottom:5px; flex:none; width:100%; overflow-y:hidden;" oninput="autoResize(this)" onfocus="autoResize(this)">${esc(val)}</textarea>
    <div style="display:flex; gap:5px; justify-content:flex-end;">
      ${editBtn}
      <button style="background:#6c757d; padding:8px;" onclick="moveListItem(this,-1)">â†‘</button>
      <button style="background:#6c757d; padding:8px;" onclick="moveListItem(this,1)">â†“</button>
      <button style="background:#dc3545; padding:8px;" onclick="this.closest('.list-edit-row').remove()">å‰Šé™¤</button>
    </div>`;
  c.appendChild(div);
  autoResize(div.querySelector('textarea'));
  input.value = ''; input.focus();
  autoResize(input);
}
function moveListItem(btn, dir) {
  const row = btn.closest('.list-edit-row');
  if(dir === -1 && row.previousElementSibling) row.parentElement.insertBefore(row, row.previousElementSibling);
  if(dir === 1 && row.nextElementSibling) row.parentElement.insertBefore(row.nextElementSibling, row);
}
function getListItems(containerId) {
  return Array.from(document.querySelectorAll(`#${containerId} textarea`)).map(i => i.value.trim()).filter(v=>v);
}

// â˜… ãƒ†ã‚­ã‚¹ãƒˆé …ç›®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç·¨é›†ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆé€šçŸ¥æ™‚é–“ä»˜ãï¼‰ â˜…
function renderTextOptionEditor(containerId, options, showDuration) {
  const c = document.getElementById(containerId); c.innerHTML = '';
  options.forEach(opt => {
    const div = document.createElement('div'); div.className = 'list-edit-row';
    div.style.flexDirection = 'column';
    let h = `<input type="text" class="opt-text" value="${esc(opt.text)}" placeholder="é …ç›®å" style="width:100%; margin-bottom:5px;">`;
    h += `<div style="display:flex; gap:5px; justify-content:flex-end; align-items:center;">`;
    if (showDuration) {
      h += `<input type="number" class="opt-dur" value="${opt.duration||''}" placeholder="åˆ†" style="width:60px;" title="é€šçŸ¥ã¾ã§ã®æ™‚é–“(åˆ†)">`;
    }
    h += `
      <button style="background:#6c757d" onclick="moveListItem(this,-1)">â†‘</button>
      <button style="background:#6c757d" onclick="moveListItem(this,1)">â†“</button>
      <button style="background:#dc3545" onclick="this.closest('.list-edit-row').remove()">å‰Šé™¤</button></div>`;
    div.innerHTML = h;
    c.appendChild(div);
  });
}
function addTextOptionItem(containerId, textId, durId) {
  const tIn = document.getElementById(textId); 
  const dIn = durId ? document.getElementById(durId) : null;
  const val = tIn.value.trim(); if(!val) return;
  const dur = dIn ? dIn.value.trim() : '';
  const c = document.getElementById(containerId);
  const div = document.createElement('div'); div.className = 'list-edit-row';
  div.style.flexDirection = 'column';
  let h = `<input type="text" class="opt-text" value="${esc(val)}" style="width:100%; margin-bottom:5px;">`;
  h += `<div style="display:flex; gap:5px; justify-content:flex-end; align-items:center;">`;
  if (dIn) {
    h += `<input type="number" class="opt-dur" value="${esc(dur)}" placeholder="åˆ†" style="width:60px;">`;
  }
  h += `<button style="background:#6c757d" onclick="moveListItem(this,-1)">â†‘</button><button style="background:#6c757d" onclick="moveListItem(this,1)">â†“</button><button style="background:#dc3545" onclick="this.closest('.list-edit-row').remove()">å‰Šé™¤</button></div>`;
  div.innerHTML = h;
  c.appendChild(div);
  tIn.value = ''; if(dIn) dIn.value = ''; tIn.focus();
}
function getTextOptionItems(containerId) {
  return Array.from(document.getElementById(containerId).children).map(row => {
    const t = row.querySelector('.opt-text').value.trim();
    const dEl = row.querySelector('.opt-dur');
    const d = dEl ? dEl.value.trim() : null;
    return t ? { text: t, duration: d ? parseInt(d) : null } : null;
  }).filter(v=>v);
}

// é …ç›®ç®¡ç†
function rField(c) {
  const list = document.getElementById('list-f');
  const validFields = (c.fields || []).filter(f => f && f.name);
  list.innerHTML = validFields.map((f, i) => `
    <div class="card">
      <div style="margin-bottom:8px; word-break:break-all;">
        <b>${esc(f.name)}</b> <span style="font-size:0.9em; color:#666;">(${f.type})</span>
      </div>
      <div style="text-align:right;">
        <button class="btn-sub" onclick="moveF('${f.id}',-1)" ${i === 0 ? 'disabled style="opacity:0.3"' : ''}>â†‘</button>
        <button class="btn-sub" onclick="moveF('${f.id}',1)" ${i === validFields.length - 1 ? 'disabled style="opacity:0.3"' : ''}>â†“</button>
        <button class="btn-sub" onclick="editF('${f.id}')">ç·¨é›†</button>
        <button class="btn-sub" style="background:#ff4d4d" onclick="delF('${f.id}')">å‰Šé™¤</button>
      </div>
    </div>`).join('');

  if (st.editF) {
    const f = validFields.find(x => x.id === st.editF);
    if (!f) { st.editF = null; r(); return; }
    document.getElementById('title-f').innerText = "é …ç›®ã‚’ç·¨é›†";
    document.getElementById('f-n').value = f.name;
    document.getElementById('f-t').value = f.type;
    updateFieldUI(); // UIåˆ‡ã‚Šæ›¿ãˆ
    if(f.type === 'select' || f.type === 'text' || f.type === 'multi_select') {
        // æ–‡å­—åˆ—é…åˆ—ã®å ´åˆã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã«å¤‰æ›ã—ã¦è¡¨ç¤º
        const opts = (f.options || []).map(o => typeof o === 'string' ? {text:o} : o);
        renderTextOptionEditor('f-opts-list', opts);
    }
    document.getElementById('btn-f-save').innerText = "æ›´æ–°ä¿å­˜";
    document.getElementById('btn-f-cancel').style.display = "block";
  } else {
    document.getElementById('title-f').innerText = "é …ç›®è¿½åŠ ";
    document.getElementById('f-n').value = '';
    document.getElementById('f-t').value = 'text';
    updateFieldUI();
    document.getElementById('btn-f-save').innerText = "è¿½åŠ ";
    document.getElementById('btn-f-cancel').style.display = "none";
  }
}
function updateFieldUI() {
  const t = document.getElementById('f-t').value;
  const area = document.getElementById('f-config-area');
  
  // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é€€é¿
  let currentOpts = [];
  const listEl = document.getElementById('f-opts-list');
  if (listEl) {
    currentOpts = getTextOptionItems('f-opts-list');
  }

  area.innerHTML = '';
  if(t === 'select' || t === 'text' || t === 'multi_select') {
    const isSelect = (t === 'select' || t === 'multi_select');
    area.innerHTML = `
      <div style="border:1px solid #ddd; padding:10px; border-radius:8px; background:#f9f9f9;">
        <label>${isSelect ? 'é¸æŠè‚¢ãƒªã‚¹ãƒˆ' : 'å…¥åŠ›å€™è£œ (ä»»æ„)'}</label>
        <div style="font-size:11px; color:#666; margin-bottom:5px;">${isSelect ? 'é¸æŠè‚¢ã‚’ç™»éŒ²ã—ã¾ã™ã€‚' : 'ã‚ˆãå…¥åŠ›ã™ã‚‹é …ç›®ã‚’ç™»éŒ²ã—ã¦ãŠãã¨ã€è¨˜éŒ²æ™‚ã«ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚'}</div>
        <div id="f-opts-list"></div>
        <div class="list-add-row" style="flex-direction:column;"><input id="f-opt-new" placeholder="é …ç›®å" style="width:100%; margin-bottom:5px;"><div style="text-align:right;"><button class="btn-sub" style="background:#28a745" onclick="addTextOptionItem('f-opts-list','f-opt-new')">è¿½åŠ </button></div></div>
      </div>`;
      
    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒ
    if (currentOpts.length > 0) {
        renderTextOptionEditor('f-opts-list', currentOpts);
    }
  }
}
function editF(id) {
  st.editF = id;
  r();
}
function saveF() {
  const c = st.cats.find(x => x.id === st.cur);
  const n = document.getElementById('f-n').value;
  if (!n) return;
  const t = document.getElementById('f-t').value;
  
  let finalOpts;
  if(t === 'select' || t === 'multi_select') {
    finalOpts = getTextOptionItems('f-opts-list');
  } else if (t === 'text') {
    const newTextOpts = getTextOptionItems('f-opts-list'); // {text, duration}ã®é…åˆ—
    const oldField = st.editF ? c.fields.find(x => x.id === st.editF) : null;
    const oldOpts = (oldField && oldField.options) ? oldField.options : [];
    
    finalOpts = newTextOpts.map(newItem => {
      const existing = oldOpts.find(o => o.text === newItem.text);
      // æ—¢å­˜ã®tsã‚’ç¶­æŒ (durationã¯ä¿å­˜ã—ãªã„)
      return { text: newItem.text, ts: existing ? existing.ts : Date.now() };
    });
  } else {
    finalOpts = [];
  }

  const data = { id: st.editF || 'f' + Date.now(), name: n, type: t, options: finalOpts };
  if (st.editF) {
    const i = c.fields.findIndex(x => x.id === st.editF);
    c.fields[i] = data;
    st.editF = null;
  } else {
    c.fields.push(data);
  }
  save();
  r();
}
function moveF(id, d) {
  const c = st.cats.find(x => x.id === st.cur);
  const i = c.fields.findIndex(x => x.id === id);
  if (i < 0 || i + d < 0 || i + d >= c.fields.length) return;
  [c.fields[i], c.fields[i + d]] = [c.fields[i + d], c.fields[i]];
  save();
  r();
}
function delF(id) {
  if (confirm('é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    const c = st.cats.find(x => x.id === st.cur);
    c.fields = c.fields.filter(x => x.id !== id);
    save();
    r();
  }
}

// â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢ãƒ»ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ â–¼â–¼â–¼
function searchFutureRecords() {
  const today = new Date();
  document.getElementById('anlz-start-date').value = formatDateYMD(today);
  document.getElementById('anlz-end-date').value = '';
  document.getElementById('srch').value = '';
  if(document.getElementById('srch-cat')) document.getElementById('srch-cat').value = '';
  rAnlz(true, true, new Date(), true, true);
}

function checkForgottenItems() {
  const daysInput = document.getElementById('past-days-input');
  const days = parseFloat(daysInput ? daysInput.value : 1) || 1;
  
  // åŸºæº–æ—¥æ™‚: æŒ‡å®šæ—¥æ•°ã®ç¿Œæ—¥00:00 (ä¾‹: 1æ—¥å‰ãªã‚‰ä»Šæ—¥ã®00:00)
  // ã“ã‚Œã‚ˆã‚Šæ–°ã—ã„è¨˜éŒ²ãŒå¿…è¦
  const limitDate = new Date();
  limitDate.setDate(limitDate.getDate() - days);
  limitDate.setHours(24, 0, 0, 0); // æŒ‡å®šæ—¥ã®24:00 (ç¿Œæ—¥ã®00:00)

  // ä»Šæ—¥ã®é–‹å§‹æ—¥æ™‚ï¼ˆå›æ•°ã‚«ã‚¦ãƒ³ãƒˆç”¨ï¼‰
  const todayStart = new Date();
  todayStart.setHours(0, 0, 0, 0);

  const itemLastSeen = {}; // { "è–¬å‰¤å": Date }
  const itemTodayCount = {}; // { "è–¬å‰¤å": int }
  
  // 1. å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’èµ°æŸ»ã—ã¦ã€é …ç›®ã®æœ€çµ‚åˆ©ç”¨æ—¥æ™‚ã¨ä»Šæ—¥ã®å›æ•°ã‚’åé›†
  st.cats.forEach(c => {
    const targetFields = c.fields.filter(f => 
        f.name.includes('è–¬') || f.name.includes('ã‚µãƒ—ãƒª') || f.name.includes('åœ¨åº«') || 
        f.type === 'select' || f.type === 'multi_select'
    );
    
    if (targetFields.length === 0) return;

    c.records.forEach(r => {
        const dt = getDt(r);
        targetFields.forEach(f => {
            const val = r[f.id];
            if (!val) return;
            const items = String(val).split(/[\s,ã€]+/).filter(s => s);
            items.forEach(item => {
                if (!itemLastSeen[item] || dt > itemLastSeen[item]) {
                    itemLastSeen[item] = dt;
                }
                if (dt >= todayStart) {
                    itemTodayCount[item] = (itemTodayCount[item] || 0) + 1;
                }
            });
        });
    });
  });

  // 2. ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®é …ç›®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
  const stockMap = {};
  if (st.stock) st.stock.forEach(s => stockMap[s.name] = s);

  const checkTargets = new Set();
  if (st.stock) st.stock.forEach(s => checkTargets.add(s.name));
  st.cats.forEach(c => {
      c.fields.forEach(f => {
          if (f.name.includes('è–¬') || f.name.includes('ã‚µãƒ—ãƒª')) {
              if (f.options) f.options.forEach(o => checkTargets.add(typeof o === 'string' ? o : o.text));
          }
      });
  });

  const forgotten = [];
  checkTargets.forEach(name => {
      if (!name) return;
      
      const lastDt = itemLastSeen[name];
      const todayCount = itemTodayCount[name] || 0;
      
      // é »åº¦æƒ…å ±ã®å–å¾— (åœ¨åº«ã®å‚™è€ƒæ¬„ã‹ã‚‰)
      let freq = 0;
      if (stockMap[name] && stockMap[name].remarks) {
          freq = estimateDailyFrequency(stockMap[name].remarks);
      }

      // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
      let isForgotten = false;
      let msg = '';

      // 1æ—¥è¤‡æ•°å›ã®å ´åˆã®ãƒã‚§ãƒƒã‚¯ (åŸºæº–æ—¥ãŒã€Œä»Šæ—¥ã€ã®å ´åˆã®ã¿æœ‰åŠ¹)
      if (freq > 1 && limitDate.getTime() >= todayStart.getTime()) {
          if (todayCount < freq) {
              isForgotten = true;
              msg = `æœ¬æ—¥${todayCount}/${freq}å›`;
          }
      }
      
      // ã¾ã NGã§ãªã‘ã‚Œã°ã€å¾“æ¥ã®æœ€çµ‚æ—¥æ™‚ãƒã‚§ãƒƒã‚¯
      if (!isForgotten) {
          if (lastDt) {
              if (lastDt < limitDate) {
                  isForgotten = true;
                  msg = `æœ€çµ‚: ${formatDateYMDHM(lastDt)}`;
              }
          } else if (stockMap[name]) {
              // è¨˜éŒ²ãªã— (åœ¨åº«ã«ã‚ã‚‹ã®ã«ä¸€åº¦ã‚‚ä½¿ã‚ã‚Œã¦ã„ãªã„)
              isForgotten = true;
              msg = 'è¨˜éŒ²ãªã—';
          }
      }

      if (isForgotten) {
          forgotten.push({ name: name, date: lastDt, ts: lastDt ? lastDt.getTime() : 0, msg: msg });
      }
  });

  if (forgotten.length === 0) alert(`${days}æ—¥ä»¥å†…ã«è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„ï¼ˆã¾ãŸã¯å›æ•°ä¸è¶³ã®ï¼‰è–¬å‰¤ãƒ»é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
  else {
      let msg = `ã€ç¢ºèªãŒå¿…è¦ãªé …ç›®ã€‘\n(åŸºæº–: ${formatDateYMDHM(limitDate)} ä»¥é™)\n\n`;
      forgotten.sort((a,b) => a.ts - b.ts);
      const maxDisplay = 20;
      forgotten.slice(0, maxDisplay).forEach(f => {
          msg += `ãƒ»${f.name} (${f.msg})\n`;
      });
      if (forgotten.length > maxDisplay) msg += `\nä»– ${forgotten.length - maxDisplay} ä»¶...`;
      alert(msg);
  }
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

window.clearSearch = function() {
  try {
    if(document.getElementById('srch-cat')) document.getElementById('srch-cat').value = '';
    document.getElementById('srch').value = '';
    if(document.getElementById('srch-not')) document.getElementById('srch-not').value = '';
    document.getElementById('anlz-start-date').value = '';
    document.getElementById('anlz-end-date').value = '';
    const andRadio = document.querySelector('input[name="search-mode"][value="and"]');
    if (andRadio) andRadio.checked = true;
    const sortDesc = document.querySelector('input[name="sort-order"][value="desc"]');
    if (sortDesc) sortDesc.checked = true;
    rAnlz(true);
  } catch (e) { showCopyableError('æ¤œç´¢ã‚¯ãƒªã‚¢å‡¦ç†ã‚¨ãƒ©ãƒ¼', e.stack); }
};

async function expSearchCSV() {
  if (!analysisRecordsCache || analysisRecordsCache.length === 0) { alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
  
  let txt = "\uFEFFã‚«ãƒ†ã‚´ãƒª,æ—¥æ™‚,å†…å®¹\n";
  analysisRecordsCache.forEach(rec => {
    const data = rec._fs.map(f => `${f.name}:${rec[f.id]||''}`).join('|');
    txt += `${rec._cn},${toJSTISOString(getDt(rec))},"${data.replace(/"/g, '""')}"\n`;
  });

  const blob = new Blob([txt], {type:'text/csv'});
  const ts = getTS();
  const name = `${VERSION}_${ts}_search_result.csv`;
  if(await saveBlob(blob, name)) { addIoLog('export', name, true); showToast('ä¿å­˜ã—ã¾ã—ãŸ: ' + name); }
}

// â–¼â–¼â–¼ è¿½åŠ : 1æ—¥ã‚ãŸã‚Šã®æ¶ˆè²»é‡æ¨å®šãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function estimateDailyDose(text) {
  if (!text) return 0;
  const t = text.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .replace(/[\sã€€]+/g, '');
  
  // ãƒ‘ã‚¿ãƒ¼ãƒ³: "Xæ—¥Yå›Zå˜ä½" (ä¾‹: "14æ—¥1å›1å˜ä½") - â˜…å„ªå…ˆåº¦ã‚’ä¸Šã’ã¦æœ€åˆã«åˆ¤å®š
  const patternDays = t.match(/(\d+)æ—¥(\d+)å›(\d+(\.\d+)?)[éŒ åŒ…å€‹mgmLå˜ä½ç“¶]/);
  if (patternDays) {
    const days = parseFloat(patternDays[1]);
    const count = parseFloat(patternDays[2]);
    const amount = parseFloat(patternDays[3]);
    if (days > 0) {
      return (count * amount) / days;
    }
  }

  // ãƒ‘ã‚¿ãƒ¼ãƒ³A: "1æ—¥Xå›YéŒ " (ä¾‹: "1æ—¥2å›1å˜ä½")
  const patternXY = t.match(/1æ—¥(\d+)å›(\d+(\.\d+)?)[éŒ åŒ…å€‹mgmLå˜ä½ç“¶]/);
  if (patternXY) {
    return parseFloat(patternXY[1]) * parseFloat(patternXY[2]);
  }

  // ãƒ‘ã‚¿ãƒ¼ãƒ³1: "1æ—¥3å› 1å›1éŒ " ã®ã‚ˆã†ã«å›æ•°ã¨1å›é‡ãŒæ˜è¨˜ã•ã‚Œã¦ã„ã‚‹å ´åˆ
  const countMatch = t.match(/1æ—¥(\d+)å›/);
  const amountMatch = t.match(/1å›(\d+(\.\d+)?)/);
  if (countMatch && amountMatch) {
    return parseFloat(countMatch[1]) * parseFloat(amountMatch[1]);
  }
  
  // ãƒ‘ã‚¿ãƒ¼ãƒ³2: "1æ—¥3éŒ " ã®ã‚ˆã†ã«1æ—¥é‡ãŒæ˜è¨˜ã•ã‚Œã¦ã„ã‚‹å ´åˆ
  const dailyMatch = t.match(/1æ—¥(\d+(\.\d+)?)[éŒ åŒ…å€‹mgmLå˜ä½ç“¶]/);
  if (dailyMatch) return parseFloat(dailyMatch[1]);
  
  // ãƒ‘ã‚¿ãƒ¼ãƒ³3: "æœå¤•1éŒ " (2å›), "æ¯é£Ÿå¾Œ1éŒ " (3å›) ãªã©ã®æ…£ç”¨å¥ - â˜…å„ªå…ˆåº¦ã‚’ä¸‹ã’ã‚‹
  if (t.match(/(æœå¤•|æœæ™©).*1[éŒ åŒ…å€‹å˜ä½ç“¶]/)) return 2;
  if (t.match(/æ¯é£Ÿ.*1[éŒ åŒ…å€‹å˜ä½ç“¶]/) || t.match(/æœæ˜¼å¤•.*1[éŒ åŒ…å€‹å˜ä½ç“¶]/)) return 3;

  return 0;
}

// â–¼â–¼â–¼ è¿½åŠ : 1æ—¥ã‚ãŸã‚Šã®å›æ•°æ¨å®šãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function estimateDailyFrequency(text) {
  if (!text) return 0;
  const t = text.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .replace(/[\sã€€]+/g, '');
  
  // é “æœãªã©ã¯å›æ•°ãƒã‚§ãƒƒã‚¯ã®å¯¾è±¡å¤–(0)ã¨ã™ã‚‹
  if (t.includes('é “æœ') || t.includes('æ™‚') || t.includes('ç—›ã„') || t.includes('ç™ºä½œ')) return 0;

  // "1æ—¥Xå›"
  const match = t.match(/1æ—¥(\d+)å›/);
  if (match) return parseInt(match[1]);

  // æ…£ç”¨å¥
  if (t.match(/æœæ˜¼å¤•æ™©|æœæ˜¼å¤•å¤œ/)) return 4;
  if (t.match(/(æœæ˜¼å¤•|æœæ˜¼æ™©|æ¯é£Ÿ)/)) return 3;
  if (t.match(/(æœå¤•|æœæ™©)/)) return 2;
  if (t.match(/(å¯ã‚‹å‰|èµ·åºŠ|æœ|æ˜¼|å¤•|æ™©)/)) return 1; 

  return 0;
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : åœ¨åº«ç®¡ç†æ©Ÿèƒ½ â–¼â–¼â–¼
function getStockData() {
  // è¨­å®šåˆæœŸåŒ–
  if (!st.settings.stockSortKey) st.settings.stockSortKey = 'name';
  if (st.settings.stockSortAsc === undefined) st.settings.stockSortAsc = true;
  if (!st.settings.stockPeriodMonths) st.settings.stockPeriodMonths = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ãƒ¶æœˆ

  // â–¼â–¼â–¼ è¿½åŠ : ç—…é™¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç‰¹å®šãƒ˜ãƒ«ãƒ‘ãƒ¼ (è¤‡æ•°å€™è£œå–å¾—) â–¼â–¼â–¼
  const getHospitalFields = (fields) => {
    return fields.filter(f => {
        const n = f.name.replace(/[\sã€€]+/g, '');
        return n.includes('åŒ»ç™‚æ©Ÿé–¢') || n.includes('ç—…é™¢') || n.includes('ã‚¯ãƒªãƒ‹ãƒƒã‚¯') || n.includes('è¡Œå…ˆ') || n.includes('å—è¨ºå…ˆ') || n.includes('è–¬å±€');
    }).sort((a, b) => {
        const score = (name) => {
            const n = name.replace(/[\sã€€]+/g, '');
            if (n.includes('åŒ»ç™‚æ©Ÿé–¢') || n.includes('ç—…é™¢') || n.includes('ã‚¯ãƒªãƒ‹ãƒƒã‚¯')) return 3;
            if (n.includes('è¡Œå…ˆ') || n.includes('å—è¨ºå…ˆ')) return 2;
            return 1;
        };
        return score(b.name) - score(a.name);
    });
  };
  // â–²â–²â–² è¿½åŠ  â–²â–²â–²

  // â–¼â–¼â–¼ è¿½åŠ : é€šé™¢æ—¥æƒ…å ±ã®åé›† â–¼â–¼â–¼
  const hospitalMap = {}; // { "ç—…é™¢å": { next: Date, nextNext: Date } }
  const cutoffDate = new Date();
  cutoffDate.setHours(0, 0, 0, 0);
  st.cats.forEach(c => {
    // â–¼â–¼â–¼ å¤‰æ›´: é€šé™¢æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç‰¹å®šãƒ­ã‚¸ãƒƒã‚¯æ”¹è‰¯ â–¼â–¼â–¼
    const normName = (f) => f.name.replace(/[\sã€€]+/g, '');
    const candidates = c.fields.filter(f => {
        const n = normName(f);
        return n.includes('é€šé™¢æ—¥') || n.includes('å—è¨ºæ—¥') || n.includes('äºˆç´„æ—¥');
    });
    
    let fNext = null;
    let fNextNext = null;

    // 1. "æ¬¡æ¬¡å›" ã‚’å«ã‚€ã‚‚ã®ã¯ç¢ºå®Ÿã« fNextNext (ä¾‹: æ¬¡æ¬¡å›é€šé™¢æ—¥)
    fNextNext = candidates.find(f => normName(f).includes('æ¬¡æ¬¡å›'));
    
    // 2. "æ¬¡å›" ã‚’å«ã‚€ã‚‚ã® (fNextNextã¨ã—ã¦é¸ã°ã‚ŒãŸã‚‚ã®ã¯é™¤ã) (ä¾‹: æ¬¡å›é€šé™¢æ—¥)
    const fJikai = candidates.find(f => normName(f).includes('æ¬¡å›') && f !== fNextNext);
    
    // 3. "æ¬¡å›"ã‚‚"æ¬¡æ¬¡å›"ã‚‚å«ã¾ãªã„ "é€šé™¢æ—¥" (ä¾‹: é€šé™¢æ—¥)
    const fNormal = candidates.find(f => !normName(f).includes('æ¬¡å›') && !normName(f).includes('æ¬¡æ¬¡å›'));
    
    if (fNormal) {
        // "é€šé™¢æ—¥" ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’ç›´è¿‘ã®äºˆå®š(fNext)ã¨ã™ã‚‹
        fNext = fNormal;
        // "é€šé™¢æ—¥" ãŒã‚ã‚Šã€ã‹ã¤ "æ¬¡å›é€šé™¢æ—¥" ãŒã‚ã‚‹ãªã‚‰ã€"æ¬¡å›" ã®æ–¹ã‚’ "æ¬¡æ¬¡å›(fNextNext)" æ‰±ã„ã¨ã™ã‚‹
        if (fJikai && !fNextNext) fNextNext = fJikai;
    } else {
        // "é€šé™¢æ—¥" ãŒãªã„å ´åˆï¼ˆå¾“æ¥ãƒ‘ã‚¿ãƒ¼ãƒ³: "æ¬¡å›é€šé™¢æ—¥" ã‚’ç›´è¿‘ã¨ã™ã‚‹ï¼‰
        if (fJikai) fNext = fJikai;
    }
    // â–²â–²â–² å¤‰æ›´ â–²â–²â–²

    // åŒ»ç™‚æ©Ÿé–¢åã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™ (è¤‡æ•°å€™è£œ)
    const hospitalFields = getHospitalFields(c.fields);
    
    const processDates = (rec) => {
        let d1 = fNext ? rec[fNext.id] : null;
        let d2 = fNextNext ? rec[fNextNext.id] : null;
        let date1 = d1 ? new Date(d1) : null;
        let date2 = d2 ? new Date(d2) : null;
        let valid1 = date1 && !isNaN(date1.getTime()) && date1 >= cutoffDate;
        let valid2 = date2 && !isNaN(date2.getTime()) && date2 >= cutoffDate;
        let finalNext = null;
        let finalNextNext = null;
        if (valid1) {
            finalNext = d1;
            if (valid2 && date2 > date1) finalNextNext = d2;
        } else if (valid2) {
            finalNext = d2;
            finalNextNext = null;
        }
        return { next: finalNext, nextNext: finalNextNext };
    };

    // â–¼â–¼â–¼ å¤‰æ›´: ç—…é™¢æƒ…å ±åé›†ãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„ (å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰èµ°æŸ») â–¼â–¼â–¼
    const hospitalSchedule = {}; 

    c.records.forEach(rec => {
        let hNames = [];
        if (hospitalFields.length > 0) {
            hospitalFields.forEach(f => {
                if (rec[f.id]) hNames.push(rec[f.id]);
            });
        } else {
            hNames.push(c.name);
        }

        hNames.forEach(hName => {
            const dates = processDates(rec);
            if (dates.next) {
                const nextDate = new Date(dates.next);
                const current = hospitalSchedule[hName];
                // æ—¥ä»˜ãŒã‚ˆã‚Šè¿‘ã„ã€ã¾ãŸã¯åŒã˜æ—¥ä»˜ã§æ¬¡æ¬¡å›æƒ…å ±ãŒã‚ã‚‹å ´åˆï¼ˆæƒ…å ±é‡ãŒå¤šã„æ–¹ï¼‰ã‚’å„ªå…ˆã—ã¦æ›´æ–°
                if (!current || nextDate < current.next || (nextDate.getTime() === current.next.getTime() && dates.nextNext)) {
                    hospitalSchedule[hName] = {
                        next: nextDate,
                        nextNext: dates.nextNext ? new Date(dates.nextNext) : null
                    };
                }
            }
        });
    });

    Object.keys(hospitalSchedule).forEach(hName => {
        hospitalMap[hName] = hospitalSchedule[hName];
    });
  });
  // â–²â–²â–² è¿½åŠ  â–²â–²â–²

  // 1. é›†è¨ˆ: åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
  const stockMap = {};

  // å‚™è€ƒãƒ‡ãƒ¼ã‚¿ã®äº‹å‰åé›†
  const remarksMap = {};
  const imagesMap = {};
  if (st.stock && Array.isArray(st.stock)) {
    st.stock.forEach(item => {
      if (item.remarks) remarksMap[item.name] = item.remarks;
      if (item.image) imagesMap[item.name] = item.image;
    });
  }

  // 1-a. æ‰‹å‹•/å–è¾¼ãƒ‡ãƒ¼ã‚¿ã®åæ˜  (st.stock)
  if (st.stock && Array.isArray(st.stock)) {
    st.stock.forEach(item => {
      stockMap[item.name] = {
        name: item.name,
        qty: item.qty || 0,
        dt: new Date(0), // å„ªå…ˆåº¦ä½ (1970å¹´)
        catName: 'å–è¾¼/æ‰‹å‹•',
        isManual: true, // æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ©ã‚°
        remarks: item.remarks || '',
        hospital: item.hospital || '', // è¿½åŠ : ç—…é™¢æŒ‡å®š
        dailyDoseInput: item.dailyDose, // è¿½åŠ : 1æ—¥é‡æŒ‡å®š
        unit: item.unit || '', // è¿½åŠ : å˜ä½
        prescribedDays: item.prescribedDays, // è¿½åŠ : å‡¦æ–¹æ—¥æ•°
        image: item.image || null
      };
    });
  }
  
  // æŒ‡å®šæœŸé–“å‰ã®æ—¥æ™‚ã‚’è¨ˆç®—
  const limitDate = new Date();
  limitDate.setMonth(limitDate.getMonth() - st.settings.stockPeriodMonths);

  st.cats.forEach(c => {
    const fDrug = c.fields.find(f => f.name === 'è–¬å‰¤');
    const fStock = c.fields.find(f => f.name === 'å¸³ç°¿åœ¨åº«æ•°');
    const hospitalFields = getHospitalFields(c.fields);
    
    if (!fDrug || !fStock) return;

    // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ–°ã—ã„é †ã«èµ°æŸ»
    const sortedRecs = c.records.slice().sort((a, b) => getDt(b) - getDt(a));
    
    sortedRecs.forEach(r => {
      const drugVal = r[fDrug.id];
      const stockVal = r[fStock.id];
      if (!drugVal || stockVal === undefined || stockVal === null || stockVal === '') return;

      // è–¬å‰¤åã®ãƒªã‚¹ãƒˆåŒ– (ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šç­‰)
      const drugs = drugVal.split(/[\s,]+/).filter(d => d);
      
      const rDt = getDt(r);

      drugs.forEach(drugName => {
        // æ—¢ã«æœ€æ–°ã®å€¤(ãƒ¬ã‚³ãƒ¼ãƒ‰ç”±æ¥)ãŒå–å¾—æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ— (å„è–¬å‰¤ã«ã¤ãæœ€æ–°1ä»¶ã®ã¿)
        const existing = stockMap[drugName];
        if (existing && !existing.isManual) return;

        // â˜…å¤‰æ›´: æœ€çµ‚æ›´æ–°ãŒæŒ‡å®šæœŸé–“ã‚ˆã‚Šå¤ã„è¨˜éŒ²ã¯ç„¡è¦–ã™ã‚‹
        if (rDt < limitDate) return;

        // åœ¨åº«æ•°ã®ãƒ‘ãƒ¼ã‚¹
        let qty = null;
        const sStockVal = String(stockVal);
        // "è–¬A:10 è–¬B:20" å½¢å¼ã®ãƒã‚§ãƒƒã‚¯
        const escapedName = drugName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // æ­£è¦è¡¨ç¾: åå‰ + åŒºåˆ‡ã‚Šæ–‡å­—(:=) + æ•°å€¤
        const match = sStockVal.match(new RegExp(`${escapedName}\\s*[:=]\\s*(-?\\d+(\\.\\d+)?)`));
        
        if (match) {
          qty = parseFloat(match[1]);
        } else if (drugs.length === 1 && /^-?\d+(\.\d+)?$/.test(sStockVal)) {
          // è–¬å‰¤ãŒ1ã¤ã ã‘ã§ã€åœ¨åº«æ•°ãŒæ•°å€¤ã®ã¿ã®å ´åˆ
          qty = parseFloat(sStockVal);
        }

        if (qty !== null) {
          stockMap[drugName] = {
            name: drugName,
            qty: qty,
            dt: rDt,
            catName: c.name,
            isManual: false,
            remarks: remarksMap[drugName] || '',
            hospital: (st.stock && st.stock.find(s => s.name === drugName)?.hospital) || '',
            dailyDoseInput: (st.stock && st.stock.find(s => s.name === drugName)?.dailyDose),
            unit: (st.stock && st.stock.find(s => s.name === drugName)?.unit) || '',
            prescribedDays: (st.stock && st.stock.find(s => s.name === drugName)?.prescribedDays),
            image: imagesMap[drugName] || null,
            sourceHospital: hospitalFields.reduce((acc, f) => acc || r[f.id], null) // æœ€åˆã®æœ‰åŠ¹ãªå€¤ã‚’ä½¿ç”¨
          };
        }
      });
    });
  });

  // 2. ãƒªã‚¹ãƒˆåŒ– (getStockDataã®æˆ»ã‚Šå€¤)
  let items = Object.values(stockMap);

  // â–¼â–¼â–¼ è¿½åŠ : äºˆå®šæ®‹è–¬æ•°ãƒ»æ¬¡å›å‡¦æ–¹æ•°ã®è¨ˆç®— â–¼â–¼â–¼
  items.forEach(item => {
    // 1æ—¥é‡ã®æ±ºå®š (æ‰‹å‹•å…¥åŠ› > ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã®æ¨å®š)
    if (item.dailyDoseInput !== undefined && item.dailyDoseInput !== null && item.dailyDoseInput !== '') {
        item.dailyDose = parseFloat(item.dailyDoseInput);
    } else {
        item.dailyDose = estimateDailyDose(item.remarks);
    }

    // å½“æ—¥æœç”¨åˆ†ã‚’ãƒã‚¤ãƒŠã‚¹ã—ã¦è¡¨ç¤ºã™ã‚‹ï¼ˆæ¬¡å›å‡¦æ–¹èª¿æ•´ç”¨ï¼‰
    if (item.dailyDose > 0) {
        item.qty = item.qty - item.dailyDose;
        item.qty = parseFloat(item.qty.toFixed(2));
    }

    item.estStock = null;
    item.nextPrescription = null;
    item.daysToNext = null;
    item.matchedHospital = null; // ãƒãƒƒãƒã—ãŸç—…é™¢åã‚’ä¿æŒ
    item.nextDate = null;
    item.nextNextDate = null;
    item.daysNextToNext = null;

    let hospitalName = null;
    
    // 1. æ‰‹å‹•æŒ‡å®šã•ã‚ŒãŸç—…é™¢åãŒã‚ã‚Œã°æœ€å„ªå…ˆ
    if (item.hospital && hospitalMap[item.hospital]) {
        hospitalName = item.hospital;
    } 
    // 2. ãªã‘ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆ(é©ç”¨)æ¬„ã‹ã‚‰æ¨æ¸¬
    else {
        const normRemarks = (item.remarks || '').replace(/[\sã€€]+/g, '');
        hospitalName = Object.keys(hospitalMap).find(name => {
            const n = name.replace(/[\sã€€]+/g, '');
            if (n.length < 2) return false;
            return normRemarks.includes(n) || n.includes(normRemarks);
        });
    }
    
    // ç—…é™¢åãŒé©ç”¨æ¬„ã«ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!hospitalName) {
        // 1. åœ¨åº«æ›´æ–°å…ƒã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ç—…é™¢åãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
        if (item.sourceHospital) {
            if (hospitalMap[item.sourceHospital]) {
                hospitalName = item.sourceHospital;
            } else {
                // éƒ¨åˆ†ä¸€è‡´æ¤œç´¢ (sourceHospital ãŒ mapKey ã«å«ã¾ã‚Œã‚‹ã€ã¾ãŸã¯ãã®é€†)
                const normSource = item.sourceHospital.replace(/[\sã€€]+/g, '');
                const fuzzyKey = Object.keys(hospitalMap).find(k => {
                    const normK = k.replace(/[\sã€€]+/g, '');
                    return normK && (normK.includes(normSource) || normSource.includes(normK));
                });
                if (fuzzyKey) hospitalName = fuzzyKey;
            }
        }
        // 2. ã‚«ãƒ†ã‚´ãƒªåãŒç—…é™¢ãƒãƒƒãƒ—ã«å­˜åœ¨ã™ã‚‹å ´åˆï¼ˆç—…é™¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ã‚«ãƒ†ã‚´ãƒªã®å ´åˆãªã©ï¼‰
        else if (item.catName && hospitalMap[item.catName]) {
            hospitalName = item.catName;
        }
    }
    
    if (hospitalName) {
      item.matchedHospital = hospitalName;
      const info = hospitalMap[hospitalName];
      item.nextDate = info.next;
      item.nextNextDate = info.nextNext;

      if (item.dailyDose > 0 && info.next) {
        const today = new Date();
        today.setHours(0,0,0,0);
        
        const nextDate = new Date(info.next);
        nextDate.setHours(0,0,0,0);
        
        // ä»Šæ—¥ã‹ã‚‰æ¬¡å›é€šé™¢æ—¥ã¾ã§ã®æ—¥æ•°
        const diffTime = nextDate - today;
        const daysToNext = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        item.daysToNext = daysToNext;
        
        // äºˆå®šæ®‹è–¬æ•° = ç¾åœ¨åœ¨åº«(å½“æ—¥åˆ†å¼•æ¸ˆ) - (1æ—¥æ¶ˆè²» * (æ—¥æ•°-1))
        const consumeDays = Math.max(0, daysToNext - 1);
        item.estStock = item.qty - (item.dailyDose * consumeDays);
        
        // æ¬¡å›å‡¦æ–¹æ•° = 1æ—¥æ¶ˆè²» * (æ¬¡å›ã€œæ¬¡æ¬¡å›ã®æ—¥æ•°)
        if (info.nextNext) {
            const nextNextDate = new Date(info.nextNext);
            nextNextDate.setHours(0,0,0,0);
            const diffTime2 = nextNextDate - nextDate;
            const daysNextToNext = Math.ceil(diffTime2 / (1000 * 60 * 60 * 24));
            item.daysNextToNext = daysNextToNext;
            if (daysNextToNext > 0) {
              item.nextPrescription = item.dailyDose * daysNextToNext;
            }
        }
      }
    }
  });
  // â–²â–²â–² è¿½åŠ  â–²â–²â–²

  // 3. ã‚½ãƒ¼ãƒˆ
  const sortKey = st.settings.stockSortKey;
  const sortAsc = st.settings.stockSortAsc;
  
  items.sort((a, b) => {
    let valA = a[sortKey];
    let valB = b[sortKey];
    
    if (sortKey === 'name' || sortKey === 'remarks') {
      const strA = valA || '';
      const strB = valB || '';
      return sortAsc ? strA.localeCompare(strB) : strB.localeCompare(strA);
    } else if (sortKey === 'dt') {
      return sortAsc ? a.dt - b.dt : b.dt - a.dt;
    } else {
      // æ•°å€¤æ¯”è¼ƒ (qty, estStock)
      // nullã®å ´åˆã¯ç„¡é™å¤§æ‰±ã„ã¨ã—ã¦æœ«å°¾ã«é€ã‚‹ï¼ˆæ˜‡é †ï¼å°‘ãªã„é †ã®ã¨ãï¼‰
      const numA = (valA !== null && valA !== undefined) ? valA : (sortAsc ? Infinity : -Infinity);
      const numB = (valB !== null && valB !== undefined) ? valB : (sortAsc ? Infinity : -Infinity);
      return sortAsc ? numA - numB : numB - numA;
    }
  });

  return items;
}

function rStock() {
  const items = getStockData();
  const sortKey = st.settings.stockSortKey;
  const sortAsc = st.settings.stockSortAsc;

  // â–¼â–¼â–¼ è¿½åŠ : åŒ»ç™‚æ©Ÿé–¢ãƒªã‚¹ãƒˆã®ç”Ÿæˆ (é¸æŠè‚¢ç”¨) â–¼â–¼â–¼
  const hospitalCat = st.cats.find(c => c.name.includes('åŒ»ç™‚æ©Ÿé–¢'));
  let hospitalOptions = [];
  if (hospitalCat) {
    const destField = hospitalCat.fields.find(f => f.name.includes('è¡Œå…ˆ'));
    if (destField) {
        // å±¥æ­´(options)ã¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å®Ÿç¸¾å€¤ã‚’ãƒãƒ¼ã‚¸ã—ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹
        const opts = (destField.options || []).map(o => typeof o === 'string' ? o : o.text);
        const recVals = hospitalCat.records.map(r => r[destField.id]).filter(v => v);
        hospitalOptions = [...new Set([...opts, ...recVals])].sort();
    }
  }
  const hospitalSelectOpts = `<option value="">(è‡ªå‹•åˆ¤å®š)</option>` + hospitalOptions.map(h => `<option value="${esc(h)}">${esc(h)}</option>`).join('');
  // â–²â–²â–² è¿½åŠ  â–²â–²â–²

  const list = document.getElementById('list-stock');
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆã‚½ãƒ¼ãƒˆãƒ»è¡¨ç¤ºåˆ‡æ›¿ï¼‰
  const headerHtml = `
    <div style="padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:10px; border:1px solid #eee;">
      <div style="display:flex; justify-content:flex-end; gap:5px; margin-bottom:10px;">
        <button class="btn-sub" style="background:#6f42c1; color:white; font-weight:bold; padding:4px 10px;" onclick="showStockPrint()">æ®‹è–¬ãƒªã‚¹ãƒˆ</button>
        <button class="btn-sub" style="background:#28a745; color:white; font-weight:bold; padding:4px 10px;" onclick="expStockCSV()">CSVå‡ºåŠ›</button>
        <button class="btn-sub" style="background:#17a2b8; color:white; font-weight:bold; padding:4px 10px;" onclick="importStockFromRecords()">è–¬å‰¤å–è¾¼</button>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <div style="font-size:12px; font-weight:bold;">
          ä¸¦ã³æ›¿ãˆ: 
          <button class="btn-sub" onclick="setStockSort('name')" style="${sortKey==='name'?'background:#007bff;color:white;':''}">åå‰</button>
          <button class="btn-sub" onclick="setStockSort('remarks')" style="${sortKey==='remarks'?'background:#007bff;color:white;':''}">æ‘˜è¦</button>
          <button class="btn-sub" onclick="setStockSort('qty')" style="${sortKey==='qty'?'background:#007bff;color:white;':''}">åœ¨åº«æ•°</button>
          <button class="btn-sub" onclick="setStockSort('estStock')" style="${sortKey==='estStock'?'background:#007bff;color:white;':''}">ä¸è¶³é †(äºˆæ¸¬)</button>
          <button class="btn-sub" onclick="setStockSort('dt')" style="${sortKey==='dt'?'background:#007bff;color:white;':''}">æ›´æ–°æ—¥</button>
          <span style="cursor:pointer; margin-left:5px;" onclick="toggleStockSortOrder()">${sortAsc ? 'â–²' : 'â–¼'}</span>
        </div>
        <div style="font-size:12px; font-weight:bold; display:flex; align-items:center; gap:5px;">
           å¯¾è±¡æœŸé–“: <input type="number" min="1" max="60" value="${st.settings.stockPeriodMonths}" onchange="updateStockPeriod(this.value)" style="width:50px; padding:4px; font-size:12px; margin:0; border:1px solid #ddd; border-radius:4px;"> ãƒ¶æœˆä»¥å†…
        </div>
      </div>
    </div>
  `;

  if (items.length === 0) {
    list.innerHTML = headerHtml + '<div class="card" style="text-align:center; color:#666; padding:30px;">è¡¨ç¤ºã™ã‚‹åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>è¨˜éŒ²ç”»é¢ã§ã€Œè–¬å‰¤ã€ã¨ã€Œå¸³ç°¿åœ¨åº«æ•°ã€ã‚’å…¥åŠ›ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>';
    return;
  }
  
  const listHtml = items.map((item, index) => {
    const isEpoch = item.dt.getTime() === 0;
    const dateStr = isEpoch ? '-' : formatDateYMDHM(item.dt);
    const color = item.qty <= 0 ? '#dc3545' : '#28a745';
    
    // äºˆæ¸¬æƒ…å ±ã®è¡¨ç¤º
    let estInfo = '';
    if (item.estStock !== null) {
        const estColor = item.estStock < 0 ? '#dc3545' : '#007bff';
        estInfo = `<div style="margin-top:5px; padding:5px; background:#f0f8ff; border-radius:4px; font-size:11px;">
          <b>é€šé™¢æ—¥æ®‹:</b> <span style="color:${estColor}; font-weight:bold;">${item.estStock.toFixed(1)}</span> (ã‚ã¨${item.daysToNext}æ—¥)
          ${item.nextPrescription !== null ? ` / <b>æ¬¡å›å‡¦æ–¹:</b> <span style="font-weight:bold;">${item.nextPrescription.toFixed(1)}</span>` : ''}
        </div>`;
    } else if (item.remarks) {
        // è¨ˆç®—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ’ãƒ³ãƒˆè¡¨ç¤º
        const reasons = [];
        if (item.dailyDose === 0) reasons.push('æœç”¨é‡ä¸æ˜');
        if (!item.matchedHospital) reasons.push('ç—…é™¢åãªã—/ä¸ä¸€è‡´');
        else if (!item.daysToNext) reasons.push('æ¬¡å›é€šé™¢æ—¥æœªè¨­å®š');
        
        if (reasons.length > 0) {
            estInfo = `<div style="margin-top:5px; padding:5px; background:#fff3cd; border-radius:4px; font-size:10px; color:#856404;">âš ï¸ è‡ªå‹•è¨ˆç®—ä¸å¯: ${reasons.join(', ')}</div>`;
        }
    }
    
    let hospitalInfo = '';
    if (item.nextDate) {
        const weeks = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        const d1 = item.nextDate;
        const d1Str = `${formatDateYMD(d1)}(${weeks[d1.getDay()]})`;
        let d2Str = '';
        if (item.nextNextDate) {
            const d2 = item.nextNextDate;
            const daysStr = item.daysNextToNext ? ` <span style="font-size:11px; color:#666;">(æ—¥æ•°:${item.daysNextToNext}æ—¥)</span>` : '';
            d2Str = ` / <b>æ¬¡å›é€šé™¢æ—¥:</b> ${formatDateYMD(d2)}(${weeks[d2.getDay()]})${daysStr}`;
        }
        hospitalInfo = `<div style="margin-top:5px; font-size:11px; color:#555;"><b>é€šé™¢æ—¥:</b> ${d1Str}${d2Str} <span style="color:#999;">(${esc(item.matchedHospital)})</span></div>`;
    }
    
    const safeName = esc(item.name.replace(/'/g, "\\'"));
    const camBoxId = `stock-cam-box-${index}`;
    const dailyDoseVal = (item.dailyDoseInput !== undefined && item.dailyDoseInput !== null) ? item.dailyDoseInput : '';
    const unitVal = item.unit || '';
    const prescribedDaysVal = (item.prescribedDays !== undefined && item.prescribedDays !== null) ? item.prescribedDays : '';
    const imgHtml = item.image 
      ? `<div style="margin:8px 0; text-align:center; position:relative; background:#f9f9f9; border-radius:5px; padding:5px;">
           <img src="${item.image}" style="max-height:120px; max-width:100%; border-radius:4px; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.2);" onclick="showImage('${item.image}')">
           <button class="btn-sub" onclick="deleteStockImage('${safeName}')" style="position:absolute; top:-5px; right:-5px; background:#dc3545; color:white; border-radius:50%; width:24px; height:24px; padding:0; line-height:24px; font-size:14px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">Ã—</button>
         </div>`
      : `<div style="margin:5px 0;">
           <label class="btn-sub" style="cursor:pointer; background:#fff; color:#17a2b8; border:1px solid #17a2b8; display:inline-flex; align-items:center; gap:4px; padding:4px 8px; font-size:11px; border-radius:15px;">
             <span>ğŸ“· å†™çœŸç™»éŒ²</span>
             <input type="file" accept="image/*" capture="environment" style="display:none;" onchange="handleStockImageInput(this, '${safeName}')">
           </label>
           <div id="${camBoxId}" style="margin-top:5px;"></div>
           ${getDeviceType() === 'pc' ? `<button class="btn-sub" style="margin-top:5px; background:#17a2b8;" onclick="startStockWebCam('${camBoxId}', '${safeName}')">ğŸ“· Webã‚«ãƒ¡ãƒ©</button>` : ''}
         </div>`;

    return `
    <div class="card" style="background:#fff; border-left: 5px solid ${color}; position:relative;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:bold; font-size:16px; color:#333;">
            ${esc(item.name)}
          </div>
          <div style="font-size:11px; color:#666; margin-top:4px;">
            æœ€çµ‚æ›´æ–°: ${dateStr} <span style="color:#999;">(${esc(item.catName)})</span>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:24px; font-weight:bold; color:${color};">${item.qty}</div>
        </div>
      </div>
      ${hospitalInfo}
      ${estInfo}
      ${imgHtml}
      
      <div style="margin-top:8px; padding-top:8px; border-top:1px dashed #eee;">
        <div style="display:flex; gap:5px; margin-bottom:5px; flex-wrap:wrap;">
          <div style="flex:2; min-width:120px;">
            <label style="font-size:10px; color:#666;">ç—…é™¢ãƒ»è¨ºç™‚ç§‘</label>
            <select onchange="updateStockAttribute('${safeName}', 'hospital', this.value)" style="padding:6px; font-size:12px; margin:0;">${hospitalSelectOpts.replace(`value="${esc(item.hospital||'')}"`, `value="${esc(item.hospital||'')}" selected`)}</select>
          </div>
          <div style="flex:1; min-width:60px;">
            <label style="font-size:10px; color:#666;">1æ—¥é‡</label>
            <input type="number" step="0.01" placeholder="è‡ªå‹•" value="${dailyDoseVal}" onchange="updateStockAttribute('${safeName}', 'dailyDose', this.value)" style="padding:6px; font-size:12px; margin:0; text-align:right;">
          </div>
          <div style="flex:1; min-width:50px;">
            <label style="font-size:10px; color:#666;">å˜ä½</label>
            <input type="text" placeholder="éŒ " value="${esc(unitVal)}" onchange="updateStockAttribute('${safeName}', 'unit', this.value)" style="padding:6px; font-size:12px; margin:0;">
          </div>
          <div style="flex:1; min-width:60px;">
            <label style="font-size:10px; color:#666;">å‡¦æ–¹æ—¥æ•°</label>
            <input type="number" placeholder="æ—¥" value="${prescribedDaysVal}" onchange="updateStockAttribute('${safeName}', 'prescribedDays', this.value)" style="padding:6px; font-size:12px; margin:0; text-align:right;">
          </div>
        </div>
      <div style="position:relative;">
        <label style="font-size:10px; color:#666;">ã‚³ãƒ¡ãƒ³ãƒˆ (æ—§:é©ç”¨)</label>
        <textarea placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ" data-name="${esc(item.name)}" oninput="autoResize(this)" onchange="updateStockAttribute(this.dataset.name, 'remarks', this.value)" onfocus="showStockHelper(this, '${esc(item.name).replace(/'/g, "\\'")}')" style="width:100%; min-height:3.5em; padding:6px; margin:0; font-size:12px; border:1px solid #ddd; border-radius:4px; background:#fcfcfc; resize:none; font-family:sans-serif; overflow-y:hidden;">${esc(item.remarks||'')}</textarea>
        <div class="stock-helper" style="display:none; background:#f0f8ff; padding:8px; border:1px solid #cce5ff; border-radius:4px; margin-top:5px; z-index:10;"></div>
      </div>
      </div>

      <div style="margin-top:10px; text-align:right;">
        <button class="btn-sub" onclick="showStockHistory('${safeName}')" style="background:#17a2b8; color:white; margin-right:5px;">å±¥æ­´</button>
        <button class="btn-sub" onclick="deleteStockItem('${esc(item.name)}')" style="background:#dc3545;">å‰Šé™¤</button>
      </div>
    </div>`;
  }).join('');

  list.innerHTML = headerHtml + listHtml;
  document.querySelectorAll('#list-stock textarea').forEach(el => autoResize(el));
}

function setStockSort(key) {
  if (st.settings.stockSortKey === key) {
    st.settings.stockSortAsc = !st.settings.stockSortAsc;
  } else {
    st.settings.stockSortKey = key;
    st.settings.stockSortAsc = true;
  }
  saveSettings();
  rStock();
}

function toggleStockSortOrder() {
  st.settings.stockSortAsc = !st.settings.stockSortAsc;
  saveSettings();
  rStock();
}

function updateStockPeriod(val) {
  let v = parseInt(val);
  if (isNaN(v) || v < 1) v = 1;
  st.settings.stockPeriodMonths = v;
  saveSettings();
  rStock();
}

function showStockPrint() {
  const items = getStockData();
  const d = new Date();
  const dateStr = formatDateYMD(d);
  
  let html = `
    <style>@media print { @page { size: landscape; margin: 5mm; } body { margin: 0; } }</style>
    <div class="no-print" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
      <h3 style="margin:0;">æ®‹è–¬ãƒªã‚¹ãƒˆ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼)</h3>
      <div class="d-flex gap-1">
        <button class="btn-sub" onclick="printArea('stock')" style="background:#007bff; color:white; font-size:14px; padding:8px 16px;">ğŸ–¨ï¸ å°åˆ·</button>
        <button class="btn-sub" onclick="closeStockPrint()" style="background:#6c757d; color:white; font-size:14px; padding:8px 16px;">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    
    <div style="font-family:'Hiragino Mincho ProN', 'Yu Mincho', serif;">
      <h1 style="text-align:center; border-bottom:2px solid #333; padding-bottom:10px; margin-bottom:20px; font-size:20px;">æ®‹è–¬ãƒªã‚¹ãƒˆ</h1>
      <div style="text-align:right; margin-bottom:10px; font-size:12px;">å°åˆ·æ—¥: ${dateStr}</div>
      <table style="width:100%; border-collapse:collapse; border:1px solid #333; font-size:14px;">
        <thead>
          <tr style="background:#f0f0f0;">
            <th style="border:1px solid #333; padding:4px; text-align:left; width:20%;">é©ç”¨</th>
            <th style="border:1px solid #333; padding:1px; width:70px; text-align:center;">é€šé™¢æ—¥</th>
            <th style="border:1px solid #333; padding:1px; width:70px; text-align:center;">æ¬¡å›é€šé™¢æ—¥</th>
            <th style="border:1px solid #333; padding:4px; text-align:center; width:80px;">å†™çœŸ</th>
            <th style="border:1px solid #333; padding:4px; text-align:left; width:15%;">è–¬å‰¤å</th>
            <th style="border:1px solid #333; padding:4px; width:50px; text-align:right;">å¸³ç°¿<br>åœ¨åº«</th>
            <th style="border:1px solid #333; padding:4px; width:50px; text-align:right;">äºˆå®š<br>æ®‹è–¬</th>
            <th style="border:1px solid #333; padding:4px; width:50px; text-align:right;">æ¬¡å›<br>å‡¦æ–¹</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(item => {
            const weeks = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const d1 = item.nextDate ? `${formatDateYMD(item.nextDate)}(${weeks[item.nextDate.getDay()]})` : '-';
            let d2 = '-';
            if (item.nextNextDate) {
                d2 = `${formatDateYMD(item.nextNextDate)}(${weeks[item.nextNextDate.getDay()]})`;
                if (item.daysNextToNext) d2 += ` <span style="color:#666;">(${item.daysNextToNext}æ—¥)</span>`;
            }
            let diffHtml = '';
            let nextPrescriptionDisp = '-';
            if (item.nextPrescription !== null) {
                const nextVal = Math.ceil(item.nextPrescription);
                nextPrescriptionDisp = nextVal;
                if (item.estStock !== null) {
                    const diff = Math.ceil(nextVal - (item.estStock > 0 ? item.estStock : 0));
                    diffHtml = `<br><span style="color:red; font-weight:bold;">â–¶${diff}</span>`;
                }
            }
            const imgHtml = item.image 
              ? `<img src="${item.image}" style="max-height:45px; max-width:60px; object-fit:contain;">` 
              : '';
            return `
            <tr style="height: 3.5em;">
              <td style="border:1px solid #333; padding:4px; vertical-align:middle; font-size:10px; line-height:1.2;">
                <div style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${esc(item.remarks||'')}</div>
              </td>
              <td style="border:1px solid #333; padding:1px; vertical-align:middle; text-align:center; white-space:nowrap; font-size:12px; font-weight:bold;">${d1}</td>
              <td style="border:1px solid #333; padding:1px; vertical-align:middle; text-align:center; white-space:nowrap; font-size:12px; font-weight:bold;">${d2}</td>
              <td style="border:1px solid #333; padding:2px; text-align:center; vertical-align:middle;">${imgHtml}</td>
              <td style="border:1px solid #333; padding:4px; vertical-align:middle;">
                <div style="font-weight:bold; word-break:break-all;">${esc(item.name)}</div>
              </td>
              <td style="border:1px solid #333; padding:4px; vertical-align:middle; text-align:right; font-weight:bold;">${item.qty}</td>
              <td style="border:1px solid #333; padding:4px; vertical-align:middle; text-align:right;">${item.estStock !== null ? item.estStock.toFixed(1) : '-'}</td>
              <td style="border:1px solid #333; padding:4px; vertical-align:middle; text-align:right;">${nextPrescriptionDisp}${diffHtml}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
  
  const printArea = document.getElementById('stock-print-area');
  const listArea = document.getElementById('list-stock');
  const details = document.getElementById('stock-details');
  
  printArea.innerHTML = html;
  printArea.style.display = 'block';
  listArea.style.display = 'none';
  if(details) details.style.display = 'none';
  
  window.scrollTo(0, 0);
}

function closeStockPrint() {
  document.getElementById('stock-print-area').style.display = 'none';
  document.getElementById('stock-print-area').innerHTML = '';
  document.getElementById('list-stock').style.display = 'block';
  const details = document.getElementById('stock-details');
  if(details) details.style.display = 'block';
}

function toggleStockHidden(name) {
  if (!st.settings.stockHiddenItems) st.settings.stockHiddenItems = [];
  const idx = st.settings.stockHiddenItems.indexOf(name);
  if (idx >= 0) {
    st.settings.stockHiddenItems.splice(idx, 1);
  } else {
    st.settings.stockHiddenItems.push(name);
  }
  saveSettings();
  rStock();
}

function updateStockAttribute(name, key, val) {
  if (!st.stock) st.stock = [];
  let item = st.stock.find(i => i.name === name);
  if (item) {
    item[key] = val;
  } else {
    const newItem = { id: 's' + Date.now(), name: name, qty: 0 };
    newItem[key] = val;
    st.stock.push(newItem);
  }
  save();
}

function deleteStockItem(name) {
  const period = st.settings.stockPeriodMonths || 3;
  if (!confirm(`ã€Œ${name}ã€ã‚’åœ¨åº«ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»å–è¾¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç‰©ç†å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nâ€»ãŸã ã—ã€${period}ãƒ¶æœˆä»¥å†…ã®è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€å†æç”»æ™‚ã«å¾©æ´»ã—ã¾ã™ã€‚`)) return;
  
  if (!st.stock) st.stock = [];
  st.stock = st.stock.filter(item => item.name !== name);
  
  save();
  rStock();
}

function handleStockImageInput(input, name) {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => { openImageEditor(e.target.result, name, 'stock'); };
  reader.readAsDataURL(file);
  input.value = '';
}

function updateStockImage(name, dataUrl) {
  if (!st.stock) st.stock = [];
  let item = st.stock.find(i => i.name === name);
  if (item) {
    item.image = dataUrl;
  } else {
    st.stock.push({ id: 's' + Date.now(), name: name, qty: 0, image: dataUrl });
  }
  save();
  rStock();
}

function deleteStockImage(name) {
  if (!confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  if (!st.stock) return;
  let item = st.stock.find(i => i.name === name);
  if (item) {
    delete item.image;
    save();
    rStock();
  }
}

// â–¼â–¼â–¼ è¿½åŠ : åœ¨åº«ç”¨Webã‚«ãƒ¡ãƒ©åˆ¶å¾¡ â–¼â–¼â–¼
let activeStockStream = null;
function startStockWebCam(boxId, name) {
  const box = document.getElementById(boxId);
  if(!box) return;
  box.innerHTML = `
    <div style="text-align:center; background:#000; border-radius:8px; overflow:hidden;">
      <video id="vid-${boxId}" autoplay playsinline style="width:100%; max-height:200px; object-fit:contain;"></video>
    </div>
    <div style="display:flex; gap:10px; margin-top:5px; justify-content:center;">
      <button class="btn-sub" onclick="snapStockWebCam('${boxId}', '${name}')" style="background:#dc3545;">æ’®å½±</button>
      <button class="btn-sub" onclick="stopStockWebCam('${boxId}')" style="background:#6c757d;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>`;
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => {
      activeStockStream = stream;
      const vid = document.getElementById(`vid-${boxId}`);
      if(vid) vid.srcObject = stream;
    })
    .catch(e => { alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + e.message); box.innerHTML = ''; });
}
function stopStockWebCam(boxId) {
  if(activeStockStream) { activeStockStream.getTracks().forEach(t => t.stop()); activeStockStream = null; }
  const box = document.getElementById(boxId); if(box) box.innerHTML = '';
}
function snapStockWebCam(boxId, name) {
  const vid = document.getElementById(`vid-${boxId}`); if(!vid) return;
  const canvas = document.createElement('canvas'); canvas.width = vid.videoWidth; canvas.height = vid.videoHeight;
  const ctx = canvas.getContext('2d'); ctx.drawImage(vid, 0, 0);
  
  const dataUrl = canvas.toDataURL('image/jpeg');
  stopStockWebCam(boxId);
  openImageEditor(dataUrl, name, 'stock');
}

// â–¼â–¼â–¼ è¿½åŠ : åœ¨åº«å…¥åŠ›ãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function showStockHelper(el, name) {
  // ä»–ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’é–‰ã˜ã‚‹
  document.querySelectorAll('.stock-helper').forEach(h => {
    if (h !== el.nextElementSibling) h.style.display = 'none';
  });
  
  const helper = el.nextElementSibling;
  if(!helper || !helper.classList.contains('stock-helper')) return;

  // å±¥æ­´åé›†
  const words = {};
  if(st.stock) {
    st.stock.forEach(s => {
      if(s.remarks) {
        const parts = s.remarks.split(/[\s,ã€]+/);
        parts.forEach(p => {
          const w = p.trim();
          if(w) words[w] = (words[w] || 0) + 1;
        });
      }
    });
  }
  // é »åº¦é †ã‚½ãƒ¼ãƒˆ
  const sortedWords = Object.keys(words).sort((a,b) => words[b] - words[a]);
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€™è£œ
  const defaults = ['æœ', 'æ˜¼', 'å¤•', 'å¯ã‚‹å‰', 'æ¯é£Ÿå¾Œ', '1éŒ ', '2éŒ ', '0.5éŒ ', 'é “æœ', 'ç—›ã„æ™‚', '1æ—¥1å›', '1æ—¥2å›', '1æ—¥3å›'];
  defaults.forEach(d => { if(!words[d]) sortedWords.push(d); });

  let html = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
    <span style="font-size:10px; font-weight:bold; color:#0056b3;">å…¥åŠ›ãƒ˜ãƒ«ãƒ‘ãƒ¼ (ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ )</span>
    <button class="btn-sub" onclick="this.parentElement.parentElement.style.display='none'" style="padding:2px 6px; font-size:10px;">é–‰ã˜ã‚‹</button>
  </div>`;
  
  html += `<div style="display:flex; flex-wrap:wrap; gap:5px;">`;
  sortedWords.slice(0, 40).forEach(w => {
    const safeName = name.replace(/'/g, "\\'");
    const safeWord = w.replace(/'/g, "\\'");
    html += `<button class="btn-sub" style="background:#fff; color:#333; border:1px solid #ddd; padding:4px 8px;" onclick="addStockRemarkWord('${safeName}', '${safeWord}')">${esc(w)}</button>`;
  });
  html += `</div>`;
  
  helper.innerHTML = html;
  helper.style.display = 'block';
}

function addStockRemarkWord(name, word) {
  const textareas = Array.from(document.querySelectorAll('textarea[data-name]'));
  const ta = textareas.find(t => t.dataset.name === name);
  
  if(!ta) return;
  
  let val = ta.value.trim();
  if(val) val += ' ' + word;
  else val = word;
  
  ta.value = val;
  updateStockAttribute(name, 'remarks', val);
  ta.focus();
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : è–¬å‰¤å–è¾¼æ©Ÿèƒ½ â–¼â–¼â–¼
function importStockFromRecords() {
  if (!st.stock) st.stock = [];
  let count = 0;
  const existingNames = new Set(st.stock.map(i => i.name));

  // é …ç›®åãŒã€Œè–¬å‰¤ã€ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é¸æŠè‚¢ã‚’åé›†ã—ã€åœ¨åº«ãƒªã‚¹ãƒˆã«è¿½åŠ 
  st.cats.forEach(c => {
    const fDrug = c.fields.find(f => f.name === 'è–¬å‰¤');
    if (fDrug && fDrug.options) {
       fDrug.options.forEach(o => {
         const n = typeof o === 'string' ? o : o.text;
         // ãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ã€ã‹ã¤åœ¨åº«ãƒªã‚¹ãƒˆã«æœªç™»éŒ²ã®å ´åˆã«è¿½åŠ 
         if (n && !existingNames.has(n)) {
            st.stock.push({ id: 's' + Date.now() + Math.random(), name: n, qty: 0 });
            existingNames.add(n);
            count++;
         }
       });
    }
  });

  if (count > 0) {
    save();
    rStock();
    alert(`${count}ä»¶ã®è–¬å‰¤ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸã€‚\nï¼ˆé …ç›®è¨­å®šã®é¸æŠè‚¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è–¬å‰¤ï¼‰`);
  } else {
    alert('æ–°ã—ã„è–¬å‰¤ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nâ€»é …ç›®è¨­å®šã®é¸æŠè‚¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è–¬å‰¤ã®ã¿ãŒå–è¾¼å¯¾è±¡ã§ã™ã€‚');
  }
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : åœ¨åº«CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â–¼â–¼â–¼
async function expStockCSV() {
  const items = getStockData();
  if (items.length === 0) { alert('å‡ºåŠ›ã™ã‚‹åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }

  let txt = "\uFEFFè–¬å‰¤å,é©ç”¨,åœ¨åº«æ•°,æœ€çµ‚æ›´æ–°æ—¥æ™‚,ã‚«ãƒ†ã‚´ãƒª\n";
  items.forEach(item => {
    const dtStr = item.dt.getTime() === 0 ? '-' : toJSTISOString(item.dt);
    txt += `"${item.name}","${item.remarks||''}",${item.qty},"${dtStr}","${item.catName}"\n`;
  });

  const blob = new Blob([txt], {type:'text/csv'});
  const ts = getTS();
  const name = `${VERSION}_${ts}_stock_list.csv`;
  if(await saveBlob(blob, name)) { addIoLog('export', name, true); showToast('ä¿å­˜ã—ã¾ã—ãŸ: ' + name); }
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¡¨ç¤ºæ©Ÿèƒ½ â–¼â–¼â–¼
function renderDebugLogs() {
  const el = document.getElementById('debug-log-area');
  if(!el) return;
  el.innerText = (st.debugLogs || []).join('\n');
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// æ—§é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ã‹ã€ä¸è¦ãªã‚‰å‰Šé™¤ã€‚ä»Šå›ã¯å‚ç…§ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ãƒ€ãƒŸãƒ¼åŒ–ï¼‰
function editStockItem(id) {}
function saveStockItemFromModal() {}
function changeStock(id, delta, type) {}
function showStockHistory(name) {
  const history = [];
  st.cats.forEach(c => {
    const fDrug = c.fields.find(f => f.name === 'è–¬å‰¤');
    const fType = c.fields.find(f => f.name === 'åœ¨åº«åŒºåˆ†');
    const fAmount = c.fields.find(f => f.name === 'ç™»éŒ²æ•°');
    const fStock = c.fields.find(f => f.name === 'å¸³ç°¿åœ¨åº«æ•°');
    
    if (!fDrug) return;

    c.records.forEach(r => {
      const rDrug = r[fDrug.id];
      if (rDrug && String(rDrug).includes(name)) {
        const dt = getDt(r);
        const type = fType ? (r[fType.id] || '-') : '-';
        const amount = fAmount ? (r[fAmount.id] || '') : '';
        let stockVal = '';
        
        if (fStock && r[fStock.id]) {
           const rStockVal = String(r[fStock.id]);
           const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
           const match = rStockVal.match(new RegExp(`${escapedName}\\s*[:=]\\s*(-?\\d+(\\.\\d+)?)`));
           if (match) {
             stockVal = match[1];
           } else if (!rStockVal.includes(':') && !rStockVal.includes('=')) {
             if (/^-?\d+(\.\d+)?$/.test(rStockVal)) stockVal = rStockVal;
           }
        }
        
        history.push({ dt: dt, catName: c.name, type: type, amount: amount, stock: stockVal, cid: c.id, rid: r.id });
      }
    });
  });

  history.sort((a, b) => b.dt - a.dt);

  let html = `<div style="max-height:60vh; overflow-y:auto;"><table style="width:100%; border-collapse:collapse; font-size:12px;">
    <thead style="position:sticky; top:0; background:#f0f0f0; z-index:1;">
      <tr><th style="border:1px solid #ddd; padding:5px;">æ—¥æ™‚</th><th style="border:1px solid #ddd; padding:5px;">åŒºåˆ†</th><th style="border:1px solid #ddd; padding:5px;">æ•°é‡</th><th style="border:1px solid #ddd; padding:5px;">åœ¨åº«</th><th style="border:1px solid #ddd; padding:5px;">æ“ä½œ</th></tr>
    </thead><tbody>`;
  
  if (history.length === 0) {
    html += `<tr><td colspan="5" style="padding:10px; text-align:center;">å±¥æ­´ãªã—</td></tr>`;
  } else {
    history.forEach(h => {
      html += `<tr><td style="border:1px solid #ddd; padding:5px;">${formatDateYMDHM(h.dt)}<br><span style="font-size:10px; color:#666;">${esc(h.catName)}</span></td><td style="border:1px solid #ddd; padding:5px; text-align:center;">${esc(h.type)}</td><td style="border:1px solid #ddd; padding:5px; text-align:right;">${esc(h.amount)}</td><td style="border:1px solid #ddd; padding:5px; text-align:right; font-weight:bold;">${esc(h.stock)}</td><td style="border:1px solid #ddd; padding:5px; text-align:center;"><button class="btn-sub" onclick="closeModal(); editRec('${h.cid}','${h.rid}')">ç·¨é›†</button></td></tr>`;
    });
  }
  html += `</tbody></table></div>`;

  document.getElementById('modal-title').innerText = `ã€Œ${esc(name)}ã€ã®ä½¿ç”¨å±¥æ­´`;
  document.getElementById('modal-body').innerHTML = html;
  document.getElementById('modal-overlay').style.display = 'flex';
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// åˆ†æãƒ»CSV
function rAnlz(resetPage = false, saveHistory = false, customMinDate = null, sortAsc = null, excludeNextVisit = false) {
   if (resetPage) {
     st.pagination.analysis = 1;
   }

  const sRaw = document.getElementById('srch').value.trim();
  const sNotRaw = document.getElementById('srch-not') ? document.getElementById('srch-not').value.trim() : '';
  
  // æ¤œç´¢ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é…åˆ— (å°æ–‡å­—åŒ–)
  const sKeywords = sRaw ? sRaw.toLowerCase().split(/[\sã€€]+/).filter(k => k) : [];
  const sNotKeywords = sNotRaw ? sNotRaw.toLowerCase().split(/[\sã€€]+/).filter(k => k) : [];

  // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰å–å¾—
  const searchMode = document.querySelector('input[name="search-mode"]:checked')?.value || 'and';

  const catId = document.getElementById('srch-cat') ? document.getElementById('srch-cat').value : '';
  const startDateVal = document.getElementById('anlz-start-date').value;
  const endDateVal = document.getElementById('anlz-end-date').value;
  let startDate = null, endDate = null;
  if (startDateVal) { startDate = new Date(startDateVal); startDate.setHours(0, 0, 0, 0); }
  if (customMinDate) {
    if (!startDate || customMinDate > startDate) startDate = customMinDate;
  }
  if (endDateVal) { endDate = new Date(endDateVal); endDate.setHours(23, 59, 59, 999); }

  // æ¤œç´¢å±¥æ­´ä¿å­˜
  if (saveHistory && (sRaw || sNotRaw)) {
    let changed = false;
    if (sRaw) {
      if (!st.settings.searchHistory) st.settings.searchHistory = [];
      st.settings.searchHistory = st.settings.searchHistory.filter(h => h.text !== sRaw); // é‡è¤‡å‰Šé™¤
      st.settings.searchHistory.unshift({ text: sRaw, ts: Date.now() });
      if (st.settings.searchHistory.length > 5) st.settings.searchHistory.length = 5;
      changed = true;
    }
    if (sNotRaw) {
      if (!st.settings.searchNotHistory) st.settings.searchNotHistory = [];
      st.settings.searchNotHistory = st.settings.searchNotHistory.filter(h => h.text !== sNotRaw); // é‡è¤‡å‰Šé™¤
      st.settings.searchNotHistory.unshift({ text: sNotRaw, ts: Date.now() });
      if (st.settings.searchNotHistory.length > 5) st.settings.searchNotHistory.length = 5;
      changed = true;
    }
    if (changed) {
      saveSettings();
      r(); // å±¥æ­´ãƒœã‚¿ãƒ³æ›´æ–°ã®ãŸã‚å†æç”»ï¼ˆæ³¨æ„: ç„¡é™ãƒ«ãƒ¼ãƒ—ã—ãªã„ã‚ˆã†r()å†…ã§ã¯saveHistory=falseã§å‘¼ã¶ï¼‰
      return; // r()ãŒå†åº¦rAnlzã‚’å‘¼ã¶ã®ã§ã“ã“ã§çµ‚äº†
    }
  }

  // åœ¨åº«ã®é©ç”¨ï¼ˆå‚™è€ƒï¼‰ã‚’æ¤œç´¢å¯¾è±¡ã«å«ã‚ã‚‹ãŸã‚ã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
  const remarksMap = {};
  if (st.stock && Array.isArray(st.stock)) {
    st.stock.forEach(item => {
      if (item.remarks) {
        remarksMap[item.name.toLowerCase()] = item.remarks;
      }
    });
  }

  let allRecords = [];
  st.cats.forEach(c => c.records.forEach(rec => {
    allRecords.push({ ...rec, _cn: c.name, _cid: c.id, _fs: c.fields, _cc: c.color || '#999', _icon: c.icon || 'ğŸ“' });
  }));

  let filteredRecs = allRecords.filter(rec => {
    const recDate = getDt(rec);
    // â–¼â–¼â–¼ å¤‰æ›´: é–‹å§‹æ—¥åˆ¤å®šã®æ‹¡å¼µ (ç™»éŒ²æ—¥ or æ—¥ä»˜é …ç›®) â–¼â–¼â–¼
    if (startDate) {
      let hit = (recDate >= startDate);
      // excludeNextVisitãŒtrueï¼ˆã‚¯ã‚¤ãƒƒã‚¯æ¤œç´¢ï¼‰ã®å ´åˆã®ã¿ã€æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ¤œç´¢å¯¾è±¡ã«å«ã‚ã‚‹
      if (!hit && excludeNextVisit) {
        const dateFields = rec._fs.filter(f => f.type === 'date');
        for (const f of dateFields) {
          if (excludeNextVisit && f.name && f.name.includes('æ¬¡å›é€šé™¢æ—¥')) continue;
          const val = rec[f.id];
          if (val) {
            const d = new Date(val);
            if (!isNaN(d.getTime())) {
              // æ—¥ä»˜é …ç›®ã®å ´åˆã¯ã€Œãã®æ—¥ã®çµ‚ã‚ã‚Šã€ã¨æ¯”è¼ƒã™ã‚‹ã“ã¨ã§ã€
              // ã€Œä»Šæ—¥ã€ã®äºˆå®šãŒç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå‰ï¼ˆ00:00ãªã©ï¼‰ã§ã‚ã£ã¦ã‚‚ãƒ’ãƒƒãƒˆã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
              const dEnd = new Date(d);
              dEnd.setHours(23, 59, 59, 999);
              if (dEnd >= startDate) { hit = true; break; }
            }
          }
        }
      }
      if (!hit) return false;
    }
    // â–²â–²â–² å¤‰æ›´ â–²â–²â–²
    if (endDate && recDate > endDate) return false;
    if (catId && rec._cid !== catId) return false;
    if (sKeywords.length > 0 || sNotKeywords.length > 0) {
        let searchableString = rec._cn;
        rec._fs.forEach(f => {
            const val = rec[f.id];
            if (val) {
              searchableString += ' ' + f.name + ' ' + val;
              if (f.type === 'file' && rec[f.id + '_name']) searchableString += ' ' + rec[f.id + '_name'];
              // å€¤ã‚’å˜èªã«åˆ†å‰²ã—ã€ãã‚Œãã‚ŒãŒè–¬å‰¤åã‹ãƒã‚§ãƒƒã‚¯
              String(val).toLowerCase().split(/[\s,]+/).forEach(word => {
                // è–¬å‰¤åã«ä¸€è‡´ã™ã‚‹é©ç”¨ï¼ˆå‚™è€ƒï¼‰ãŒã‚ã‚Œã°æ¤œç´¢å¯¾è±¡ã«è¿½åŠ 
                if (remarksMap[word]) searchableString += ' ' + remarksMap[word];
              });
            }
        });
        const target = searchableString.toLowerCase();
        
        // AND/ORæ¤œç´¢
        if (sKeywords.length > 0) {
          if (searchMode === 'and') {
            if (!sKeywords.every(k => target.includes(k))) return false;
          } else { // or
            if (!sKeywords.some(k => target.includes(k))) return false;
          }
        }
        
        // é™¤å¤–æ¤œç´¢: ã„ãšã‚Œã‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚ã°é™¤å¤–
        if (sNotKeywords.length > 0 && sNotKeywords.some(k => target.includes(k))) return false;
    }
    return true;
  });

  // ã‚½ãƒ¼ãƒˆé †æ±ºå®š
  let isAsc = false;
  const sortRadioAsc = document.querySelector('input[name="sort-order"][value="asc"]');
  const sortRadioDesc = document.querySelector('input[name="sort-order"][value="desc"]');

  if (sortAsc !== null) {
    isAsc = sortAsc;
    if (isAsc && sortRadioAsc) sortRadioAsc.checked = true;
    if (!isAsc && sortRadioDesc) sortRadioDesc.checked = true;
  } else {
    if (sortRadioAsc && sortRadioAsc.checked) isAsc = true;
  }

  // ã‚½ãƒ¼ãƒˆç”¨æ—¥ä»˜æƒ…å ±ã®è¨ˆç®—ã¨ä»˜ä¸
  const criterion = startDate ? new Date(startDate) : new Date();
  criterion.setHours(0, 0, 0, 0);

  filteredRecs.forEach(rec => {
    // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’ç¢ºèª
    const dateFields = rec._fs.filter(f => f.type === 'date');
    const validDates = [];
    dateFields.forEach(f => {
        if (excludeNextVisit && f.name && f.name.includes('æ¬¡å›é€šé™¢æ—¥')) return;
        const val = rec[f.id];
        if (val) {
            const d = new Date(val);
            if (!isNaN(d.getTime())) validDates.push({ date: d, label: f.name });
        }
    });

    // åŸºæº–æ—¥ä»¥é™ã®æ—¥ä»˜é …ç›®ãŒã‚ã‚Œã°ã€ãã‚Œã‚’å„ªå…ˆã™ã‚‹
    const futureDates = validDates.filter(d => {
        const dCheck = new Date(d.date);
        dCheck.setHours(23, 59, 59, 999); // ãã®æ—¥ã®çµ‚ã‚ã‚Šã¾ã§å«ã‚ã‚‹
        return dCheck >= criterion;
    });

    if (futureDates.length > 0) {
        // æœªæ¥ã®æ—¥ä»˜ã®ä¸­ã§æœ€ã‚‚ç›´è¿‘ã®ã‚‚ã®ã‚’æ¡ç”¨
        futureDates.sort((a, b) => a.date - b.date);
        rec._sortDate = futureDates[0].date;
        rec._sortLabel = futureDates[0].label;
        rec._isScheduled = true;
    } else {
        // ãªã‘ã‚Œã°ç™»éŒ²æ—¥æ™‚ã‚’ä½¿ç”¨
        rec._sortDate = getDt(rec);
        rec._sortLabel = 'ç™»éŒ²æ—¥æ™‚';
        rec._isScheduled = false;
    }
  });

  if (isAsc) {
    filteredRecs.sort((a, b) => a._sortDate - b._sortDate);
  } else {
    filteredRecs.sort((a, b) => b._sortDate - a._sortDate);
  }

  analysisRecordsCache = filteredRecs;

  renderAnalysisList();
}

// â–¼â–¼â–¼ è¿½åŠ : æ¤œç´¢çµæœæç”»ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢ â–¼â–¼â–¼
function renderAnalysisList() {
  const currentPage = st.pagination.analysis;
  const totalRecords = analysisRecordsCache.length;
  const totalAll = st.cats.reduce((sum, c) => sum + c.records.length, 0);
  const startIndex = (currentPage - 1) * RECS_PER_PAGE;
  const endIndex = startIndex + RECS_PER_PAGE;
  const paginatedRecords = analysisRecordsCache.slice(startIndex, endIndex);

  const countHtml = `<div style="padding:5px 10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; background:#fff; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
      <span style="font-size:12px; font-weight:bold; color:#555;">æ¤œç´¢: ${totalRecords}ä»¶ <span style="font-size:10px; color:#999;">(å…¨${totalAll}ä»¶)</span></span>
      <button class="btn-sub" style="background:#28a745; color:white; padding:4px 10px;" onclick="expSearchCSV()">CSVå‡ºåŠ›</button>
  </div>`;

  if (totalRecords === 0) {
    // æ¤œç´¢æ¡ä»¶å…¥åŠ›æ¬„ã®çŠ¶æ…‹ã‚’ç¢ºèª
    const sRaw = document.getElementById('srch').value.trim();
    const sNotRaw = document.getElementById('srch-not') ? document.getElementById('srch-not').value.trim() : '';
    const startDateVal = document.getElementById('anlz-start-date').value;
    const endDateVal = document.getElementById('anlz-end-date').value;
    
    const msg = (sRaw || sNotRaw || startDateVal || endDateVal) ? 'æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' : 'è¡¨ç¤ºã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
    let html = (totalAll > 0) ? countHtml : '';
    html += `<div class="card" style="text-align:center; color:#666;">${msg}</div>`;
    document.getElementById('list-anlz').innerHTML = html;
    document.getElementById('pagination-anlz').innerHTML = '';
    return;
  }

  // ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å–å¾—
  const sRaw = document.getElementById('srch').value.trim();

  document.getElementById('list-anlz').innerHTML = countHtml + paginatedRecords.map(rec => {
    let dateHtml = formatDateYMDHM(getDt(rec));
    if (rec._isScheduled) {
       // äºˆå®šæ—¥ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ãƒ¡ã‚¤ãƒ³ã«
       const dow = getDowStr(rec._sortDate);
       dateHtml = `<span style="color:#0056b3; font-weight:bold;">${formatDateYMD(rec._sortDate)}${dow} <span style="font-size:10px; font-weight:normal; color:#555;">(${rec._sortLabel})</span></span> <span style="font-size:10px; color:#999;">(ç™»éŒ²: ${formatDateYMDHM(getDt(rec))})</span>`;
    }
    return `
    <div class="rec-row">
      <button class="rec-body" onclick="editRec('${rec._cid}','${rec.id}')">
        <small><span class="cat-tag" style="background:${rec._cc}20; color:${rec._cc}; border:1px solid ${rec._cc}40;">${rec._icon} ${highlight(rec._cn, sRaw)}</span> ${dateHtml}</small>
        <div style="margin-top: 4px;">
          ${rec._fs.map(f => {
            if (!rec[f.id]) return '';
            if (f.type === 'camera') {
              return `<span class="field-tag"><b>${esc(f.name)}:</b> <img src="${rec[f.id]}" style="height:24px; vertical-align:middle; border-radius:3px; cursor:pointer;" onclick="event.stopPropagation(); showImage('${rec[f.id]}')"></span>`;
            }
            if (f.type === 'file') {
              const fname = rec[f.id + '_name'];
              const content = (rec[f.id].startsWith('data:image') ? `<img src="${rec[f.id]}" style="height:24px; vertical-align:middle; border-radius:3px;">` : 'ğŸ“„') + (fname ? ' ' + highlight(fname, sRaw) : '');
              return `<span class="field-tag"><b>${highlight(f.name, sRaw)}:</b> ${content}</span>`;
            }
            return `<span class="field-tag"><b>${highlight(f.name, sRaw)}:</b> ${highlight(rec[f.id], sRaw)}</span>`;
          }).filter(x => x).join('')}
        </div>
      </button>
    </div>`;
  }).join('');
  
  renderPaginationControls('pagination-anlz', currentPage, totalRecords, "changeAnalysisPage");
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

function setSearchKeyword(text) {
  document.getElementById('srch').value = text;
  rAnlz(true, true);
}

function setSearchNotKeyword(text) {
  document.getElementById('srch-not').value = text;
  rAnlz(true, true);
}

// â–¼â–¼â–¼ è¿½åŠ : å®‰å…¨ãªæ›¸ãè¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼ (ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±) â–¼â–¼â–¼
async function writeSafe(dirHandle, filename, blob) {
  const tempName = `${filename}.tmp.${Date.now()}`;
  let tempHandle = null;
  try {
    // 1. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»æ›¸ãè¾¼ã¿
    tempHandle = await dirHandle.getFileHandle(tempName, { create: true });
    const writable = await tempHandle.createWritable();
    await writable.write(blob);
    await writable.close();

    // 2. ãƒªãƒãƒ¼ãƒ  (move)
    if (tempHandle.move) {
      // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦ãŠã (ä¸Šæ›¸ãã®ãŸã‚)
      try {
        await dirHandle.removeEntry(filename);
      } catch (e) {
        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯NotFoundErrorã«ãªã‚‹ã®ã§ç„¡è¦–
        if (e.name !== 'NotFoundError') console.warn('Target file remove failed:', e);
      }
      // ãƒªãƒãƒ¼ãƒ å®Ÿè¡Œ
      await tempHandle.move(filename);
    } else {
      throw new Error('move() method not supported');
    }
    return true;
  } catch (e) {
    console.warn('Safe write failed, falling back to direct write:', e);
    // å¤±æ•—æ™‚ã¯ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    if (tempHandle) {
      try { await dirHandle.removeEntry(tempName); } catch (cleanupErr) {}
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥æ›¸ãè¾¼ã¿
    const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();
    return true;
  }
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆFile System Access APIå¯¾å¿œï¼‰
async function saveBlob(blob, name) {
  try {
    // 1. å…±é€šä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if (saveDirHandle) {
      const opts = { mode: 'readwrite' };
      // æ¨©é™ç¢ºèª
      if ((await saveDirHandle.queryPermission(opts)) !== 'granted') {
         if ((await saveDirHandle.requestPermission(opts)) !== 'granted') {
             // æ¨©é™æ‹’å¦ã•ã‚ŒãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¸
         } else {
             // æ¨©é™å–å¾—æˆåŠŸ
             return await writeSafe(saveDirHandle, name, blob);
         }
      } else {
         // æ¨©é™ã‚ã‚Š
         return await writeSafe(saveDirHandle, name, blob);
      }
    }

    // 2. å¾“æ¥ã®æ–¹æ³• (showSaveFilePicker)
    if(window.showSaveFilePicker) {
      const h = await window.showSaveFilePicker({ suggestedName: name, types: [{ description: 'File', accept: { [blob.type]: ['.'+name.split('.').pop()] } }] });
      const w = await h.createWritable(); await w.write(blob); await w.close(); return true;
    }
  } catch(e) {
    if(e.name === 'AbortError') return false;
    console.error(e);
  }
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click();
  return true;
}

async function expCSV() {
  const mode = document.getElementById('csv-sel').value;
  let txt = "\uFEFFã‚«ãƒ†ã‚´ãƒª,æ—¥æ™‚,å†…å®¹\n";
  st.cats.forEach(c => {
    if(mode !== 'all' && c.id !== mode) return;
    c.records.forEach(r => { const data = c.fields.map(f=>`${f.name}:${r[f.id]||''}`).join('|'); txt += `${c.name},${toJSTISOString(getDt(r))},"${data}"\n`; });
  });
  const blob = new Blob([txt], {type:'text/csv'});
  const ts = getTS();
  const name = mode === 'all' ? `${VERSION}_${ts}_move_all.csv` : `${VERSION}_${ts}_action_${st.cats.find(x=>x.id===mode).name}.csv`;
  if(await saveBlob(blob, name)) { addIoLog('export', name, true); showToast('ä¿å­˜ã—ã¾ã—ãŸ: ' + name); }
}
async function expCSVSplit() {
  const mode = document.getElementById('csv-sel').value;
  let txt = "\uFEFFã‚«ãƒ†ã‚´ãƒª,æ—¥æ™‚,å†…å®¹\n";
  st.cats.forEach(c => {
    if(mode !== 'all' && c.id !== mode) return;

    c.records.forEach(r => {
      const dt = toJSTISOString(getDt(r));
      
      // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’èµ°æŸ»ã—ã¦ã€å€¤ãŒã‚ã‚‹ã‚‚ã®ã‚’1è¡Œã¨ã—ã¦å‡ºåŠ›
      c.fields.forEach(f => {
        // å†™çœŸã‚„ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯é™¤å¤–
        if (f.type === 'camera' || f.name.includes('å†™çœŸ') || f.name.includes('ç”»åƒ')) return;
        
        let val = r[f.id];
        // å€¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡ºåŠ› (0ã¯å‡ºåŠ›ã€ç©ºæ–‡å­—ãƒ»nullãƒ»undefinedã¯å‡ºåŠ›ã—ãªã„)
        if (val !== undefined && val !== null && val !== '') {
            if (Array.isArray(val)) val = val.join(' ');
            val = String(val);
            const content = `${f.name}:${val}`;
            txt += `${c.name},${dt},"${content.replace(/"/g, '""')}"\n`;
        }
      });
      
      if (r.comment) {
          txt += `${c.name},${dt},"ã‚³ãƒ¡ãƒ³ãƒˆ:${String(r.comment).replace(/"/g, '""')}"\n`;
      }
    });
  });
  const blob = new Blob([txt], {type:'text/csv'});
  const ts = getTS();
  const catName = mode === 'all' ? 'all' : st.cats.find(x=>x.id===mode).name;
  const name = `${VERSION}_${ts}_split_${catName}.csv`;
  if(await saveBlob(blob, name)) { addIoLog('export', name, true); showToast('ä¿å­˜ã—ã¾ã—ãŸ: ' + name); }
}
async function expJSON() {
  const mode = document.getElementById('csv-sel').value;
  let data;
  let jsonName;
  const ts = getTS();

  if(mode === 'all') {
    // å…¨ä»¶å‡ºåŠ›æ™‚ã¯ã€åœ¨åº«ãƒ»è¨­å®šå«ã‚€ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å½¢å¼ã«ã™ã‚‹
    data = { format: 'full_backup', version: VERSION, cats: st.cats, stock: st.stock || [], settings: st.settings || {}, extFiles: st.extFiles || [] };
    jsonName = `${VERSION}_${ts}_action_all_full.json`;
  } else {
    // å€‹åˆ¥å‡ºåŠ›ã¯å¾“æ¥é€šã‚Šã‚«ãƒ†ã‚´ãƒªãƒ¼é…åˆ—ï¼ˆã¾ãŸã¯å˜ä½“ï¼‰
    const c = st.cats.find(x=>x.id===mode);
    data = c ? [c] : [];
    jsonName = `${VERSION}_${ts}_action_${c ? c.name : 'unknown'}.json`;
  }

  // ZIPåœ§ç¸®ã›ãšç›´æ¥JSONã¨ã—ã¦å‡ºåŠ›ï¼ˆJSZipä¾å­˜æ’é™¤ãƒ»é«˜é€ŸåŒ–ï¼‰
  try {
    const jsonStr = JSON.stringify(data, jsonJstReplacer, 2);
    const blob = new Blob([jsonStr], {type:'application/json'});
    if(await saveBlob(blob, jsonName)) { addIoLog('export', jsonName, true); showToast('ä¿å­˜ã—ã¾ã—ãŸ: ' + jsonName); }
  } catch(e) {
    alert('JSONå‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}
async function expImages() {
  if (!window.JSZip) { alert('JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
  document.body.style.cursor = 'wait';
  try {
    const zip = new JSZip();
    let count = 0;
    const mode = document.getElementById('csv-sel').value;

    st.cats.forEach(c => {
      if(mode !== 'all' && c.id !== mode) return;
      // cameraã ã‘ã§ãªãfileã‚¿ã‚¤ãƒ—ã‚‚å«ã‚ã‚‹
      const targetFields = c.fields.filter(f => f.type === 'camera' || f.type === 'file');
      if (targetFields.length === 0) return;

      c.records.forEach(r => {
        targetFields.forEach(f => {
          const val = r[f.id];
          // data URIã‚¹ã‚­ãƒ¼ãƒ ã§å§‹ã¾ã£ã¦ã„ã‚‹ã‹ç¢ºèª
          if (val && typeof val === 'string' && val.startsWith('data:')) {
            const dt = getDt(r);
            const yyyy = dt.getFullYear();
            const mm = String(dt.getMonth() + 1).padStart(2, '0');
            const dd = String(dt.getDate()).padStart(2, '0');
            const hh = String(dt.getHours()).padStart(2, '0');
            const mi = String(dt.getMinutes()).padStart(2, '0');
            const ss = String(dt.getSeconds()).padStart(2, '0');
            const safeCat = c.name.replace(/[\\/:*?"<>|]/g, '_');
            const safeField = f.name.replace(/[\\/:*?"<>|]/g, '_');
            
            let filename;
            const storedName = r[f.id + '_name'];
            
            if (storedName) {
                // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’åˆ©ç”¨ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ä¸ã—ã¦ä¸€æ„æ€§ã‚’ç¢ºä¿ï¼‰
                filename = `${yyyy}${mm}${dd}-${hh}${mi}${ss}_${safeCat}_${safeField}_${storedName}`;
            } else {
                // ãƒ•ã‚¡ã‚¤ãƒ«åãŒãªã„å ´åˆã¯æ‹¡å¼µå­ã‚’æ¨æ¸¬ã—ã¦ç”Ÿæˆ
                let ext = getExtFromDataURI(val);
                filename = `${yyyy}${mm}${dd}-${hh}${mi}${ss}_${safeCat}_${safeField}_${r.id.slice(-4)}.${ext}`;
            }

            const base64Data = val.split(',')[1];
            if (base64Data) {
                zip.file(filename, base64Data, {base64: true});
                count++;
            }
          }
        });
      });
    });

    // åœ¨åº«ç”»åƒã®å‡ºåŠ› (å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠæ™‚ã®ã¿)
    if (mode === 'all' && st.stock && Array.isArray(st.stock)) {
      st.stock.forEach(item => {
        if (item.image && typeof item.image === 'string' && item.image.startsWith('data:image')) {
          const safeName = item.name.replace(/[\\/:*?"<>|]/g, '_');
          let ext = 'jpg';
          if (item.image.includes('image/png')) ext = 'png';
          else if (item.image.includes('image/webp')) ext = 'webp';
          const filename = `stock_${safeName}.${ext}`;
          const base64Data = item.image.split(',')[1];
          zip.file(filename, base64Data, {base64: true});
          count++;
        }
      });
    }

    if (count === 0) { alert('å‡ºåŠ›å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'); return; }
    const blob = await zip.generateAsync({type:"blob"});
    const ts = getTS();
    const name = `${VERSION}_${ts}_files.zip`;
    if(await saveBlob(blob, name)) { addIoLog('export', name, true); showToast('ä¿å­˜ã—ã¾ã—ãŸ: ' + name); }
  } catch(e) { console.error(e); alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); }
  finally { document.body.style.cursor = 'default'; }
}

function renderPaginationControls(containerId, currentPage, totalRecords, onClickHandlerName) {
  const container = document.getElementById(containerId);
  if (!container) return;

  if (totalRecords <= RECS_PER_PAGE) {
    container.innerHTML = '';
    return;
  }

  const totalPages = Math.ceil(totalRecords / RECS_PER_PAGE);
  const prevDisabled = currentPage === 1 ? 'disabled' : '';
  const nextDisabled = currentPage === totalPages ? 'disabled' : '';

  container.innerHTML = `
    <button class="btn-sub" onclick="${onClickHandlerName}(-1)" ${prevDisabled}>&lt; å‰ã¸</button>
    <span>${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸</span>
    <button class="btn-sub" onclick="${onClickHandlerName}(1)" ${nextDisabled}>æ¬¡ã¸ &gt;</button>
  `;
}

function changeInputPage(direction) {
  const catId = st.cur;
  if (!catId) return;
  let currentPage = st.pagination.input[catId] || 1;
  const cat = st.cats.find(c => c.id === catId);
  if (!cat) return;
  const totalPages = Math.ceil(cat.records.length / RECS_PER_PAGE);
  
  let newPage = currentPage + direction;
  
  if (newPage < 1) newPage = 1;
  if (newPage > totalPages) newPage = totalPages;

  if (newPage !== currentPage) {
    st.pagination.input[catId] = newPage;
    r();
  }
}

function changeAnalysisPage(direction) {
  let newPage = st.pagination.analysis + direction;
  st.pagination.analysis = newPage;
  renderAnalysisList(); // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆæ™‚ã¯å†æ¤œç´¢ã›ãšæç”»ã®ã¿æ›´æ–°
}

// æ’ä¾¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
function toggleCal() {
  const el = document.getElementById('cal-area');
  if (el.style.display === 'none') { // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ãã¨ã
    el.style.display = 'block';
    // åˆå›è¡¨ç¤ºæ™‚ã®ã¿æœˆé¸æŠã‚’åˆæœŸåŒ–ã€ãã‚Œä»¥å¤–ã¯å¸¸ã«å†æç”»
    if (document.getElementById('cal-month').options.length === 0) {
      initCal();
    } else {
      rCal();
    }
  } else { // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‰ã˜ã‚‹ã¨ã
    el.style.display = 'none';
  }
}
function initCal() {
  const sel = document.getElementById('cal-month'); const d = new Date(); sel.innerHTML = '';
  for(let i=0; i<13; i++) {
    const y = d.getFullYear(); const m = d.getMonth() + 1;
    const opt = document.createElement('option'); opt.value = `${y}-${String(m).padStart(2,'0')}`; opt.text = `${y}-${String(m).padStart(2,'0')}`; sel.appendChild(opt);
    d.setMonth(d.getMonth() - 1);
  }
  sel.selectedIndex = 0; rCal();
}
function rCal() {
  const val = document.getElementById('cal-month').value; if(!val) return;
  const [y, m] = val.split('-').map(Number);
  
  // å‰æœˆè¨ˆç®—
  const pd = new Date(y, m-1, 1); pd.setMonth(pd.getMonth()-1);
  const py = pd.getFullYear(); const pm = pd.getMonth()+1;

  let h = '';
  // å‰æœˆï¼ˆå°åˆ·ç”¨ï¼‰
  h += `<div class="print-only" style="margin-bottom:20px; page-break-inside:avoid;"><h3>${py}-${String(pm).padStart(2,'0')}</h3>${makeCalHTML(py, pm)}</div>`;
  // å½“æœˆ
  h += `<div style="page-break-inside:avoid;"><h3 class="print-only">${y}-${String(m).padStart(2,'0')}</h3>${makeCalHTML(y, m)}</div>`;
  
  // ãƒ¡ãƒ¢æ¬„ï¼ˆå°åˆ·ç”¨ï¼‰
  h += `<div class="print-only" style="margin-top:20px; border:2px solid #444; height:150px; padding:5px;"><span style="font-size:12px; font-weight:bold;">ãƒ¡ãƒ¢</span></div>`;

  document.getElementById('cal-body').innerHTML = h;
}

function makeCalHTML(y, m) {
  const cat = getTargetCat('toilet');
  const res = {};
  if(cat) {
    const f = cat.fields.find(f => f.name === 'ä¾¿ã®é‡');
    if(f) {
      cat.records.forEach(r => {
        const dt = getDt(r);
        if(dt.getFullYear() === y && dt.getMonth() + 1 === m) {
          const d = dt.getDate(); const v = r[f.id];
          if(res[d] === undefined) res[d] = false;
          if(v && v !== 'ã‚¼ãƒ­') res[d] = true;
        }
      });
    }
  }
  let okCnt = 0, ngCnt = 0;
  Object.values(res).forEach(v => { if(v) okCnt++; else if(v===false) ngCnt++; });
  
  const water = {};
  const waterCats = st.cats.filter(c => c.name.includes('æ°´åˆ†') || c.name.includes('é£²'));
  waterCats.forEach(catW => {
    const fW = catW.fields.find(f => f.name.includes('é‡') && !f.name.includes('ä»Šæ—¥ã®') && !f.name.includes('åˆè¨ˆ'));
    if(fW) {
      catW.records.forEach(r => {
        const dt = getDt(r);
        if(dt.getFullYear() === y && dt.getMonth() + 1 === m) {
          const d = dt.getDate();
          let s = String(r[fW.id]||'0').replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/,/g, '');
          // æ—¥ä»˜ãƒ»æ™‚åˆ»ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é™¤å»
          s = s.replace(/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/g, '')
               .replace(/\d{1,2}[\/\-]\d{1,2}/g, '')
               .replace(/\d{1,2}:\d{1,2}/g, '');
          const matches = s.match(/-?\d+(\.\d+)?/g);
          if (matches) {
            matches.forEach(m => water[d] = (water[d] || 0) + parseFloat(m));
          }
        }
      });
    }
  });

  const first = new Date(y, m-1, 1).getDay(); const last = new Date(y, m, 0).getDate();
  let h = '<table style="width:100%; border-collapse:collapse; text-align:center; table-layout:fixed; border:2px solid #444;">';
  h += '<tr style="background:#eee; font-size:12px; border-bottom:2px solid #444;"><th style="color:red; border-right:2px solid #444;">æ—¥</th><th style="border-right:2px solid #444;">æœˆ</th><th style="border-right:2px solid #444;">ç«</th><th style="border-right:2px solid #444;">æ°´</th><th style="border-right:2px solid #444;">æœ¨</th><th style="border-right:2px solid #444;">é‡‘</th><th style="color:blue">åœŸ</th></tr><tr>';
  let d = 1; for(let i=0; i<first; i++) h += '<td style="border-right:2px solid #444; border-bottom:2px solid #444;"></td>';
  const waterTarget = st.settings.waterTarget || 1500;
  const cell = (day) => {
    const mk = res[day]
      ? '<span style="color:#6f42c1;font-weight:bold;font-size:30px;line-height:1;">â˜‘</span>'
      : (res[day] === false
        ? '<span style="color:#dc3545;font-weight:bold;font-size:30px;line-height:1;">â˜’</span>'
        : '<span style="display:inline-block;width:20px;"></span>');
    const val = water[day] || 0;
    let bg = '#fff';
    if (val > 0) {
      bg = val >= waterTarget ? '#d4edda' : '#f8d7da';
    }
    const w = val > 0 ? `<div style="font-size:10px;color:#333;font-weight:bold;line-height:1.1;">${val}</div>` : '';
    const content = `<div style="display:flex; align-items:center; justify-content:center; margin-top:0; min-height:32px;">${mk}</div>`;
    return `<td onclick="showDayDetail(${y},${m},${day})" style="padding:2px; border-right:2px solid #444; border-bottom:2px solid #444; font-size:12px; vertical-align:top; cursor:pointer; background:${bg};">${day}${w}${content}</td>`;
  };
  for(let i=first; i<7; i++) { if(d<=last) { h+=cell(d); d++; } } h+='</tr>';
  while(d<=last) { h+='<tr>'; for(let i=0; i<7; i++) { if(d<=last) { h+=cell(d); d++; } else { h+='<td style="border-right:2px solid #444; border-bottom:2px solid #444;"></td>'; } } h+='</tr>'; }
  h += '</table>';
  h += `<div style="font-size:11px; margin-top:5px; text-align:right; color:#666;">å‡¡ä¾‹: <span style="color:#6f42c1;font-weight:bold;">â˜‘</span>å‡ºãŸ(${okCnt}æ—¥) <span style="color:#dc3545;font-weight:bold;">â˜’</span>å‡ºãªã„(${ngCnt}æ—¥) <span style="color:#007bff;">OK</span>/<span style="color:#dc3545;">ä¸è¶³</span>(ç›®æ¨™${waterTarget}ml)</div>`;
  return h;
}

window.handleExtItemClick = function(checkbox) {
  try {
    const itemName = checkbox.value;
    if (!st.extSelectedItems) {
      st.extSelectedItems = [];
    }
    const index = st.extSelectedItems.indexOf(itemName);
    if (index > -1) {
      st.extSelectedItems.splice(index, 1);
    }
    if (checkbox.checked) {
      st.extSelectedItems.push(itemName);
    }
    if (st.extCurrentIdx >= 0 && st.extFiles[st.extCurrentIdx]) st.extFiles[st.extCurrentIdx].selectedItems = st.extSelectedItems;
    saveExtData();
  } catch (e) {
    const errorDetails = `ã‚¨ãƒ©ãƒ¼: ${e.message}\nã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:\n${e.stack || ''}`;
    showCopyableError('é …ç›®é¸æŠå‡¦ç†ã‚¨ãƒ©ãƒ¼', errorDetails);
  }
};

// æ’ä¾¿2é‡å††ã‚°ãƒ©ãƒ•
function togglePoopChart() {
  const el = document.getElementById('poop-chart-area');
  if(el.style.display==='none') {
    el.style.display='block';
    // åˆæœŸæ—¥ä»˜è¨­å®šï¼ˆæœªè¨­å®šã®å ´åˆï¼‰
    if (!document.getElementById('poop-start-date').value) {
      const now = new Date();
      const start = new Date(now);
      start.setDate(1); start.setMonth(start.getMonth() - 1);
      document.getElementById('poop-start-date').value = formatDateYMD(start);
      document.getElementById('poop-end-date').value = formatDateYMD(now);
    }
    renderPoopChart();
  }
  else { el.style.display='none'; }
}
function renderPoopChart() {
  const ctx = document.getElementById('poopDoublePieChart').getContext('2d');
  const toiletCat = getTargetCat('toilet');
  if (!toiletCat) { alert('ã€Œãƒˆã‚¤ãƒ¬ã€ã‚«ãƒ†ã‚´ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  const statusField = toiletCat.fields.find(f => f.name === 'ä¾¿ã®çŠ¶æ…‹');
  if (!statusField) { alert('ã€Œä¾¿ã®çŠ¶æ…‹ã€é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  const sDateVal = document.getElementById('poop-start-date').value;
  const eDateVal = document.getElementById('poop-end-date').value;
  const sDate = sDateVal ? new Date(sDateVal) : null; if(sDate) sDate.setHours(0,0,0,0);
  const eDate = eDateVal ? new Date(eDateVal) : null; if(eDate) eDate.setHours(23,59,59,999);

  const dailyStatus = {};
  toiletCat.records.forEach(r => {
    const d = getDt(r);
    if (sDate && d < sDate) return;
    if (eDate && d > eDate) return;
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    if (!dailyStatus[k]) dailyStatus[k] = [];
    const val = r[statusField.id];
    if (val) dailyStatus[k].push(val);
  });

  if (Object.keys(dailyStatus).length === 0) { alert('å¯¾è±¡æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  const aggregated = [];
  let totalToiletCount = 0;
  Object.keys(dailyStatus).sort().forEach(date => {
    const statuses = dailyStatus[date];
    totalToiletCount += statuses.length;
    const actual = statuses.filter(s => s !== 'å‡ºãªã„');
    let umu = 'æ’ä¾¿ãªã—', detail = 'å‡ºãªã„';
    if (actual.length > 0) {
      umu = 'æ’ä¾¿ã‚ã‚Š';
      const counts = {}; actual.forEach(x => { counts[x] = (counts[x]||0)+1; });
      detail = Object.keys(counts).reduce((a, b) => counts[a] >= counts[b] ? a : b);
    }
    aggregated.push({ date, umu, detail });
  });

  const grouped = { 'æ’ä¾¿ã‚ã‚Š': {}, 'æ’ä¾¿ãªã—': {} };
  aggregated.forEach(x => {
    if (!grouped[x.umu][x.detail]) grouped[x.umu][x.detail] = 0;
    grouped[x.umu][x.detail]++;
  });

  const totalPoopAru = aggregated.filter(x => x.umu === 'æ’ä¾¿ã‚ã‚Š').length;
  const totalPoopNashi = aggregated.filter(x => x.umu === 'æ’ä¾¿ãªã—').length;

  const poopAruSegmentCount = Object.keys(grouped['æ’ä¾¿ã‚ã‚Š']).length;
  const poopNashiSegmentCount = Object.keys(grouped['æ’ä¾¿ãªã—']).length;

  const labels = [], dataOut = [], colOut = [], dataIn = [], colIn = [], segmentRecords = [];
  const colorMap = { 'ç¡¬ã„':'#8b4513', 'ã‚³ãƒ­ã‚³ãƒ­':'#d17d56', 'æ™®é€š':'#cd853f', 'è»Ÿä¾¿':'#f4a460', 'æŸ”ã‚‰ã‹ã„':'#deb887', 'ä¸‹ç—¢':'#bdb76b', 'å‡ºãªã„':'#ffcccc', 'æ’ä¾¿ã‚ã‚Š':'#ffcc99', 'æ’ä¾¿ãªã—':'#ffcccc', 'default':'#d3d3d3' };

  ['æ’ä¾¿ã‚ã‚Š', 'æ’ä¾¿ãªã—'].forEach(umu => {
    Object.entries(grouped[umu]).forEach(([det, cnt]) => {
      labels.push(det); dataOut.push(cnt); colOut.push(colorMap[det] || colorMap['default']);
      dataIn.push(cnt); colIn.push(colorMap[umu]);
      
      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å¯¾å¿œã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
      segmentRecords.push(
        aggregated.filter(x => x.umu === umu && x.detail === det).sort((a,b) => new Date(b.date) - new Date(a.date))
      );
    });
  });

  if (window.myPoopChart) window.myPoopChart.destroy();
  const totalDays = aggregated.length;
  const dateRangeStr = `${aggregated[0].date} ã€œ ${aggregated[aggregated.length-1].date}`;
  const avgToiletCount = totalDays > 0 ? (totalToiletCount / totalDays).toFixed(1) : 0;

  // è©³ç´°ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
  document.getElementById('poop-chart-details').style.display = 'none';

  // å¼•ãå‡ºã—ç·šã‚’æç”»ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³
  const outsideLabelsPlugin = {
    id: 'outsideLabels',
    afterDatasetsDraw(chart, args, options) {
      const { ctx, chartArea: { top, bottom, left, right } } = chart;
      chart.data.datasets.forEach((dataset, i) => {
        if (i !== 0) return; // å¤–å´ã®å††ã‚°ãƒ©ãƒ•ã®ã¿
        const meta = chart.getDatasetMeta(i);
        if (meta.hidden) return;

        const points = [];
        const cx = (left + right) / 2;
        const cy = (top + bottom) / 2;

        meta.data.forEach((element, index) => {
          if (dataset.data[index] === 0) return;
          const angle = element.startAngle + (element.endAngle - element.startAngle) / 2;
          const outerRadius = element.outerRadius;
          
          // åŸºæœ¬ä½ç½®è¨ˆç®—
          const r = outerRadius + 15;
          const x = cx + Math.cos(angle) * r;
          const y = cy + Math.sin(angle) * r;
          const isRight = (x >= cx);
          
          points.push({
            index, angle, outerRadius, x, y, cx, cy, isRight,
            text: [chart.data.labels[index], dataset.data[index] + 'æ—¥']
          });
        });

        // é‡ãªã‚Šå›é¿ï¼ˆYåº§æ¨™ã‚½ãƒ¼ãƒˆï¼†èª¿æ•´ï¼‰
        const leftPoints = points.filter(p => !p.isRight).sort((a, b) => a.y - b.y);
        const rightPoints = points.filter(p => p.isRight).sort((a, b) => a.y - b.y);
        const adjust = (pts) => {
          const minSpacing = 20;
          for (let j = 1; j < pts.length; j++) {
            if (pts[j].y < pts[j-1].y + minSpacing) pts[j].y = pts[j-1].y + minSpacing;
          }
        };
        adjust(leftPoints);
        adjust(rightPoints);

        ctx.save();
        ctx.font = 'bold 9px sans-serif';
        ctx.textBaseline = 'middle';

        [...leftPoints, ...rightPoints].forEach(p => {
          const startX = cx + Math.cos(p.angle) * p.outerRadius;
          const startY = cy + Math.sin(p.angle) * p.outerRadius;
          
          // æŠ˜ã‚Œç‚¹ï¼ˆElbowï¼‰
          const midR = p.outerRadius + 10;
          const midX = cx + Math.cos(p.angle) * midR;
          const midY = cy + Math.sin(p.angle) * midR;
          
          // ãƒ©ãƒ™ãƒ«ä½ç½®ã¸ã®æ°´å¹³ç·šï¼ˆè§’åº¦ãŒãã¤ã„å ´åˆã¯å¤–å´ã¸å‡ºã™ï¼‰
          const extraX = Math.abs(Math.cos(p.angle)) < 0.5 ? 20 : 0;
          const labelX = p.isRight ? (midX + 15 + extraX) : (midX - 15 - extraX);
          const endX = p.isRight ? labelX + 10 : labelX - 10;

          ctx.beginPath();
          ctx.moveTo(startX, startY);
          ctx.lineTo(midX, midY);
          ctx.lineTo(labelX, p.y); // Yåº§æ¨™èª¿æ•´é©ç”¨
          ctx.lineTo(endX, p.y);   // æ°´å¹³ç·š
          
          ctx.strokeStyle = '#999'; ctx.lineWidth = 1; ctx.stroke();
          
          ctx.fillStyle = '#333';
          ctx.textAlign = p.isRight ? 'left' : 'right';
          const textX = p.isRight ? endX + 3 : endX - 3;
          ctx.fillText(p.text[0], textX, p.y - 5);
          ctx.fillText(p.text[1], textX, p.y + 5);
        });
        ctx.restore();
      });
    }
  };

  window.myPoopChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [
        { 
          data: dataOut, backgroundColor: colOut, borderWidth: 1, weight: 1,
          datalabels: {
            display: false // ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§æç”»ã™ã‚‹ãŸã‚ç„¡åŠ¹åŒ–
          }
        },
        { 
          data: dataIn, backgroundColor: colIn, borderWidth: 1, weight: 0.6,
          datalabels: {
            color: '#000', font: { weight: 'bold', size: 12 },
            formatter: (val, ctx) => {
               if(val===0) return '';
               // ã€Œå‡ºãŸã€ã®ã¿è¡¨ç¤º
               if (poopAruSegmentCount > 0 && ctx.dataIndex === Math.floor((poopAruSegmentCount - 1) / 2)) {
                 return 'å‡ºãŸ\n' + totalPoopAru + 'æ—¥';
               }
               return '';
            }
          }
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      layout: { padding: 50 },
      onClick: (e, elements) => {
        if (!elements || elements.length === 0) return;
        const idx = elements[0].index;
        const recs = segmentRecords[idx];
        const label = labels[idx];
        
        const listEl = document.getElementById('poop-chart-details-body');
        const titleEl = document.getElementById('poop-detail-title');
        const container = document.getElementById('poop-chart-details');
        
        titleEl.innerText = `(${label}: ${recs.length}æ—¥)`;
        listEl.innerHTML = recs.map(r => 
          `<div style="padding:6px 10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>${r.date}</span><span style="font-weight:bold;">${r.detail}</span></div>`
        ).join('');
        container.style.display = 'block';
      },
      plugins: {
        title: { display: true, text: `æ’ä¾¿çŠ¶æ³ (${dateRangeStr} / ${totalDays}æ—¥é–“)`, font: { size: st.settings.graphTitleFontSize || 14 } },
        subtitle: {
          display: true,
          text: `ãƒˆã‚¤ãƒ¬å›æ•°: ${totalToiletCount}å› (å¹³å‡: ${avgToiletCount}å›/æ—¥)`,
          font: { size: (st.settings.graphTitleFontSize || 14) - 2 },
          color: '#555',
          padding: { bottom: 10 }
        },
        legend: { display: false },
        datalabels: { display: true },
        tooltip: { callbacks: { label: (ctx) => {
            const val = ctx.raw;
            if (ctx.datasetIndex === 1) {
                 const color = ctx.chart.data.datasets[1].backgroundColor[ctx.dataIndex];
                 return (color === colorMap['æ’ä¾¿ã‚ã‚Š'] ? 'å‡ºãŸ' : 'å‡ºãªã„') + `: ${val}æ—¥`;
            }
            return `${ctx.chart.data.labels[ctx.dataIndex]}: ${val}æ—¥`;
        }}}
      }
    },
    plugins: [ChartDataLabels, outsideLabelsPlugin]
  });
}

// ãƒã‚¤ãƒ©ãƒ³åˆ†æ
function toggleMylanChart() {
  const el = document.getElementById('mylan-chart-area');
  if(el.style.display==='none') {
    el.style.display='block';
    if (!document.getElementById('mylan-start-date').value) {
      const now = new Date();
      const start = new Date(now);
      start.setDate(1); start.setMonth(start.getMonth() - 1);
      document.getElementById('mylan-start-date').value = formatDateYMD(start);
      document.getElementById('mylan-end-date').value = formatDateYMD(now);
    }
    renderMylanChart();
  } else { el.style.display='none'; }
}

function renderMylanChart() {
  const ctx = document.getElementById('mylanPieChart').getContext('2d');
  const sDateVal = document.getElementById('mylan-start-date').value;
  const eDateVal = document.getElementById('mylan-end-date').value;
  const sDate = sDateVal ? new Date(sDateVal) : null; if(sDate) sDate.setHours(0,0,0,0);
  const eDate = eDateVal ? new Date(eDateVal) : null; if(eDate) eDate.setHours(23,59,59,999);

  // 1. æœç”¨ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ãƒã‚¤ãƒ©ãƒ³ or ã‚¯ãƒ¬ãƒ¡ã‚¸ãƒ³)
  let takeRecs = [];
  st.cats.forEach(c => {
    c.records.forEach(r => {
      const dt = getDt(r);
      if (sDate && dt < sDate) return;
      if (eDate && dt > eDate) return;
      
      // å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’ãƒã‚§ãƒƒã‚¯
      const txt = c.fields.map(f => r[f.id]).join(' ');
      if (txt.includes('ãƒã‚¤ãƒ©ãƒ³') || txt.includes('ã‚¯ãƒ¬ãƒ¡ã‚¸ãƒ³')) {
        takeRecs.push({ dt: dt, id: r.id });
      }
    });
  });
  takeRecs.sort((a,b) => a.dt - b.dt);

  if (takeRecs.length === 0) { alert('æŒ‡å®šæœŸé–“å†…ã«ã€Œãƒã‚¤ãƒ©ãƒ³ã€ã¾ãŸã¯ã€Œã‚¯ãƒ¬ãƒ¡ã‚¸ãƒ³ã€ã®è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

  // 2. æ’ä¾¿ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
  const toiletCat = getTargetCat('toilet');
  let poopRecs = [];
  if (toiletCat) {
    const statusF = toiletCat.fields.find(f => f.name === 'ä¾¿ã®çŠ¶æ…‹');
    const amountF = toiletCat.fields.find(f => f.name === 'ä¾¿ã®é‡');
    toiletCat.records.forEach(r => {
      const dt = getDt(r);
      // æœç”¨ãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šå¾Œã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªã®ã§ã€æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ã¯é–‹å§‹æ—¥ã ã‘è€ƒæ…®
      if (sDate && dt < sDate) return;
      
      let isPoop = false;
      if (statusF && r[statusF.id] && r[statusF.id] !== 'å‡ºãªã„') isPoop = true;
      if (amountF && r[amountF.id] && r[amountF.id] !== 'ã‚¼ãƒ­') isPoop = true;
      
      if (isPoop) poopRecs.push({ dt: dt });
    });
  }
  poopRecs.sort((a,b) => a.dt - b.dt);

  // 3. ãƒãƒƒãƒãƒ³ã‚°ã¨æ—¥æ•°è¨ˆç®—
  const counts = { '24æ™‚é–“ä»¥å†…': 0, '48æ™‚é–“ä»¥å†…': 0, '72æ™‚é–“ä»¥å†…': 0, '3æ—¥è¶…': 0, 'æ’ä¾¿ãªã—': 0 };
  let totalCount = 0;
  let totalHours = 0;
  let validCount = 0;

  takeRecs.forEach(take => {
    const nextPoop = poopRecs.find(p => p.dt > take.dt);
    if (nextPoop) {
      const diffMs = nextPoop.dt - take.dt;
      const diffHours = diffMs / (1000 * 60 * 60);
      totalHours += diffHours;
      validCount++;

      if (diffHours <= 24) counts['24æ™‚é–“ä»¥å†…']++;
      else if (diffHours <= 48) counts['48æ™‚é–“ä»¥å†…']++;
      else if (diffHours <= 72) counts['72æ™‚é–“ä»¥å†…']++;
      else counts['3æ—¥è¶…']++;
    } else {
      counts['æ’ä¾¿ãªã—']++;
    }
    totalCount++;
  });

  const avgHours = validCount > 0 ? (totalHours / validCount).toFixed(1) : 0;
  document.getElementById('mylan-stats').innerText = `ç·æœç”¨å›æ•°: ${totalCount}å› / å¹³å‡æ’ä¾¿æ‰€è¦æ™‚é–“: ${avgHours}æ™‚é–“`;

  if (window.myMylanChart) window.myMylanChart.destroy();
  window.myMylanChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        data: Object.values(counts),
        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6c757d']
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'æœç”¨ã‹ã‚‰æ’ä¾¿ã¾ã§ã®æ™‚é–“åˆ†å¸ƒ', font: { size: st.settings.graphTitleFontSize || 14 } },
        datalabels: {
          color: '#fff', font: { weight: 'bold' },
          formatter: (val, ctx) => {
            if (val === 0) return '';
            const label = ctx.chart.data.labels[ctx.dataIndex];
            const pct = ((val / totalCount) * 100).toFixed(1) + '%';
            return `${label}\n${val}å›\n(${pct})`;
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// â–¼â–¼â–¼ è¿½åŠ : ã‚«ãƒ†ã‚´ãƒªãƒ¼è¡Œã®è‰²æ›´æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function updateCategoryColor(details) {
  if (!details) return;
  const summary = details.querySelector('summary');
  if (!summary) return;
  
  const hasChecked = details.querySelector('input[type="checkbox"]:checked');
  const type = details.dataset.catType; // 'INT' or 'EXT'
  
  if (hasChecked) {
    summary.style.backgroundColor = '#cce5ff'; // é¸æŠæ™‚ã®è–„ã„é’
  } else {
    summary.style.backgroundColor = (type === 'EXT') ? '#e7f1ff' : '#f0f0f0';
  }
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : çµ±åˆåˆ†ææ©Ÿèƒ½ â–¼â–¼â–¼
function renderIntegratedItemSelector() {
  const container = document.getElementById('analysis-item-selector');
  if (!container) return;
  
  let html = '';
  
  // 1. å†…éƒ¨ãƒ‡ãƒ¼ã‚¿
  st.cats.forEach(c => {
    if (!c.fields || c.fields.length === 0) return;
    const validFields = c.fields.filter(f => f.type !== 'camera' && f.type !== 'file');
    if (validFields.length === 0) return;

    const catKey = `INT:${c.id}`;
    const allSelected = validFields.every(f => st.analysisSelection.has(`${catKey}:${f.id}`));
    const anySelected = validFields.some(f => st.analysisSelection.has(`${catKey}:${f.id}`));
    const btnText = allSelected ? 'å…¨è§£é™¤' : 'å…¨é¸æŠ';
    const bgColor = anySelected ? '#cce5ff' : '#f0f0f0';

    html += `<details data-cat-type="INT" style="margin-bottom:5px; border:1px solid #ddd; border-radius:4px; background:#fff;">
      <summary style="font-weight:bold; font-size:12px; background:${bgColor}; padding:5px 8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;"><span>${esc(c.name)}</span><button class="btn-sub" style="padding:1px 6px; font-size:10px; background:#6c757d; color:white;" onclick="event.preventDefault(); toggleAnalysisCategory('${catKey}', this)">${btnText}</button></summary>
      <div style="padding:5px; display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:5px;">`;
    validFields.forEach(f => {
      const key = `${catKey}:${f.id}`;
      const checked = st.analysisSelection.has(key) ? 'checked' : '';
      html += `<label style="display:flex; align-items:center; font-size:11px; margin:0; background:#fff; padding:2px; border:1px solid #eee; border-radius:3px;">
        <input type="checkbox" value="${key}" ${checked} onclick="toggleAnalysisItem(this)" style="width:auto; margin-right:4px;">${esc(f.name)}
      </label>`;
    });
    html += `</div></details>`;
  });

  // 2. å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿
  if (st.extFiles && st.extFiles.length > 0) {
    st.extFiles.forEach((f, idx) => {
      if (!f.data || f.data.length === 0) return;
      const items = [...new Set(f.data.map(d => d.item))];
      
      const fileKey = `EXT:${idx}`;
      const allSelected = items.every(item => st.analysisSelection.has(`${fileKey}:${encodeURIComponent(item)}`));
      const anySelected = items.some(item => st.analysisSelection.has(`${fileKey}:${encodeURIComponent(item)}`));
      const btnText = allSelected ? 'å…¨è§£é™¤' : 'å…¨é¸æŠ';
      const bgColor = anySelected ? '#cce5ff' : '#e7f1ff';

      html += `<details data-cat-type="EXT" style="margin-bottom:5px; border:1px solid #ddd; border-radius:4px; background:#fff;">
        <summary style="font-weight:bold; font-size:12px; background:${bgColor}; padding:5px 8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;"><span>[å¤–] ${esc(f.name)}</span><button class="btn-sub" style="padding:1px 6px; font-size:10px; background:#6c757d; color:white;" onclick="event.preventDefault(); toggleAnalysisCategory('${fileKey}', this)">${btnText}</button></summary>
        <div style="padding:5px; display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:5px;">`;
      items.forEach(item => {
        const safeKey = `${fileKey}:${encodeURIComponent(item)}`;
        const checked = st.analysisSelection.has(safeKey) ? 'checked' : '';
        html += `<label style="display:flex; align-items:center; font-size:11px; margin:0; background:#fff; padding:2px; border:1px solid #eee; border-radius:3px;">
          <input type="checkbox" value="${safeKey}" ${checked} onclick="toggleAnalysisItem(this)" style="width:auto; margin-right:4px;">${esc(item)}
        </label>`;
      });
      html += `</div></details>`;
    });
  }
  
  container.innerHTML = html;
}

function toggleAnalysisCategory(prefix, btn) {
  const inputs = document.querySelectorAll(`#analysis-item-selector input[value^="${prefix}:"]`);
  const allChecked = Array.from(inputs).every(i => i.checked);
  const newState = !allChecked;
  
  inputs.forEach(cb => {
    cb.checked = newState;
    if (newState) st.analysisSelection.add(cb.value);
    else st.analysisSelection.delete(cb.value);
  });
  
  if(btn) {
    btn.innerText = newState ? 'å…¨è§£é™¤' : 'å…¨é¸æŠ';
    updateCategoryColor(btn.closest('details'));
  }
}

function toggleAnalysisItem(cb) {
  if (cb.checked) st.analysisSelection.add(cb.value);
  else st.analysisSelection.delete(cb.value);
  updateCategoryColor(cb.closest('details'));
}

function toggleAllAnalysisItems(on) {
  const cbs = document.querySelectorAll('#analysis-item-selector input[type="checkbox"]');
  cbs.forEach(cb => {
    cb.checked = on;
    if (on) st.analysisSelection.add(cb.value);
    else st.analysisSelection.delete(cb.value);
  });
  document.querySelectorAll('#analysis-item-selector details').forEach(d => updateCategoryColor(d));
}

function executeIntegratedAnalysis(mode) {
  // ãƒ‡ãƒ¼ã‚¿åé›†
  const data = [];
  st.analysisSelection.forEach(key => {
    const parts = key.split(':');
    const type = parts[0];
    
    if (type === 'INT') {
      const catId = parts[1];
      const fieldId = parts[2];
      const cat = st.cats.find(c => c.id === catId);
      if (cat) {
        const field = cat.fields.find(f => f.id === fieldId);
        if (field) {
          cat.records.forEach(r => {
            const val = r[fieldId];
            if (val !== undefined && val !== null && val !== '') {
              data.push({
                date: toJSTISOString(getDt(r)), // å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿åˆ†æã¯ISOæ–‡å­—åˆ—ãªã©ã‚’æœŸå¾…
                item: field.name,
                val: val,
                unit: '',
                ref: ''
              });
            }
          });
        }
      }
    } else if (type === 'EXT') {
      const fIdx = parseInt(parts[1]);
      const itemName = decodeURIComponent(parts.slice(2).join(':'));
      const file = st.extFiles[fIdx];
      if (file && file.data) {
        file.data.forEach(d => {
          if (d.item === itemName) {
            data.push(d);
          }
        });
      }
    }
  });
  
  if (data.length === 0) {
    alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  
  // st.extData ã‚’æ›´æ–° (ã“ã‚ŒãŒ renderExtTable/Graph ã§ä½¿ã‚ã‚Œã‚‹)
  st.extData = data;
  // é¸æŠé …ç›®ãƒªã‚¹ãƒˆã‚‚æ›´æ–° (renderExtTableç­‰ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨)
  st.extSelectedItems = [...new Set(data.map(d => d.item))];
  
  // æç”»
  if (mode === 'table') renderExtTable();
  else renderExtGraph();
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : é£Ÿäº‹å ±å‘Šæ›¸ä½œæˆæ©Ÿèƒ½ â–¼â–¼â–¼
function renderMealReport() {
  const sDateVal = document.getElementById('meal-start-date').value;
  const eDateVal = document.getElementById('meal-end-date').value;
  
  if (!sDateVal) { alert('é–‹å§‹æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„'); return; }
  
  const sDate = new Date(sDateVal); sDate.setHours(0,0,0,0);
  const eDate = eDateVal ? new Date(eDateVal) : new Date(); eDate.setHours(23,59,59,999);

  // ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢ ("é£Ÿäº‹"ã‚’å«ã‚€ã‚‚ã®)
  const cat = st.cats.find(c => c.name.includes('é£Ÿäº‹'));
  if (!cat) { alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼åã«ã€Œé£Ÿäº‹ã€ã‚’å«ã‚€ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }

  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œç´¢
  const fType = cat.fields.find(f => f.name.includes('åŒºåˆ†') || f.name.includes('ç¨®åˆ¥') || f.name.includes('Type'));
  const fContent = cat.fields.find(f => f.name.includes('å†…å®¹') || f.name.includes('ãƒ¡ãƒ‹ãƒ¥ãƒ¼') || f.name.includes('è©³ç´°'));
  // å†™çœŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (å†™çœŸ1, å†™çœŸ2, å†™çœŸ3 ã¾ãŸã¯ ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…¨ã¦)
  let fPhotos = cat.fields.filter(f => f.name.includes('å†™çœŸ') || f.name.includes('ç”»åƒ'));
  if (fPhotos.length === 0) fPhotos = cat.fields.filter(f => f.type === 'camera');
  // åå‰é †ã«ã‚½ãƒ¼ãƒˆ (å†™çœŸ1, å†™çœŸ2...ã¨ãªã‚‹ã‚ˆã†ã«)
  fPhotos.sort((a,b) => a.name.localeCompare(b.name));

  // ãƒ¬ã‚³ãƒ¼ãƒ‰æŠ½å‡º
  const recs = cat.records.filter(r => {
    const d = getDt(r);
    return d >= sDate && d <= eDate;
  });
  
  // æ™‚ç³»åˆ—é †ã«ã‚½ãƒ¼ãƒˆ
  recs.sort((a,b) => getDt(a) - getDt(b));

  if (recs.length === 0) { alert('æŒ‡å®šæœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }

  // æ‰‹æ›¸ãè¨˜å…¥æ¬„ã®ç”Ÿæˆ
  const defaultHeader = 'æ°å,æ€§åˆ¥,å¹´é½¢,èº«é•·,ä½“é‡,æ¨™æº–ä½“é‡,åç¸®æœŸè¡€åœ§,æ‹¡å¼µæœŸè¡€åœ§,HbA1c,è¡€ç³–å€¤,é‹å‹•,é£²é…’,å–«ç…™';
  const fieldsStr = (st.settings && st.settings.mealReportHeaderFields) || defaultHeader;
  const headerItems = fieldsStr.split(/[,ã€\n]+/).map(s => s.trim()).filter(s => s);
  let headerHtml = `<div style="display:flex; flex-wrap:wrap; gap:15px; row-gap:10px; margin-bottom:15px; border:1px solid #333; padding:10px; align-items:center;">`;
  headerItems.forEach(item => {
      let label = item;
      let val = '';
      if (item.includes(':') || item.includes('ï¼š')) {
          const parts = item.split(/[:ï¼š]/);
          label = parts[0].trim();
          val = parts.slice(1).join(':').trim();
      }

      let width = '50px';
      if (label === 'æ°å') width = '100px';
      else if (label.includes('è¡€åœ§') || label === 'æ¨™æº–ä½“é‡') width = '40px';
      headerHtml += `<div style="display:flex; align-items:end; font-size:10px;">
        <span style="white-space:nowrap; font-weight:bold;">${esc(label)}</span>
        ${val ? `<span style="border-bottom:1px solid #333; margin-left:2px; padding:0 5px; min-width:${width}; text-align:center;">${esc(val)}</span>` : `<div style="width:${width}; border-bottom:1px solid #333; margin-left:2px;"></div>`}
      </div>`;
  });
  headerHtml += `</div>`;

  let html = `
    <div style="font-family:'Hiragino Mincho ProN', 'Yu Mincho', serif;">
      <h1 style="text-align:center; font-size:22px; margin-bottom:10px;">é£Ÿäº‹è¨˜éŒ²å ±å‘Šæ›¸</h1>
      ${headerHtml}
      <div style="text-align:right; font-size:12px; margin-bottom:20px;">
        æœŸé–“: ${formatDateYMD(sDate)} ï½ ${formatDateYMD(eDate)}<br>
        ä½œæˆæ—¥: ${formatDateYMD(new Date())}
      </div>
      <div style="border-top:2px solid #333;">
  `;

  let lastDateStr = '';
  
  recs.forEach(r => {
    const dt = getDt(r);
    const dateStr = formatDateYMD(dt);
    const timeStr = dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    
    // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼
    if (dateStr !== lastDateStr) {
      if (lastDateStr !== '') html += '</div></div>';
      html += `<div style="margin-top:15px; page-break-inside:avoid; break-inside:avoid;">`;
      html += `<div style="background:#f0f0f0; padding:5px 10px; font-weight:bold; border-bottom:1px solid #ccc; page-break-after:avoid; break-after:avoid;">${dateStr}</div>`;
      html += `<div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; padding:10px; border-bottom:1px solid #eee; page-break-before:avoid; break-before:avoid;">`;
      lastDateStr = dateStr;
    }

    const typeVal = fType ? (r[fType.id] || '-') : '';
    const contentVal = fContent ? (r[fContent.id] || '') : '';
    
    let barColor = '#dee2e6';
    if (typeVal.includes('æœ')) barColor = '#28a745';
    else if (typeVal.includes('æ˜¼')) barColor = '#fd7e14';
    else if (typeVal.includes('å¤•') || typeVal.includes('æ™©')) barColor = '#0d6efd';
    else if (typeVal.includes('é–“') || typeVal.includes('ãŠã‚„ã¤')) barColor = '#d63384';
    else if (typeVal.includes('å¤œ')) barColor = '#6f42c1';

    // å†™çœŸãƒ‡ãƒ¼ã‚¿ã®åé›†
    const photos = fPhotos.map(f => r[f.id]).filter(v => v);
    
    // 2æšã”ã¨ã«åˆ†å‰²
    const chunks = [];
    if (photos.length === 0) chunks.push([]);
    else {
        for (let i = 0; i < photos.length; i += 2) {
            chunks.push(photos.slice(i, i + 2));
        }
    }

    chunks.forEach((chunk, idx) => {
        const isContinuation = idx > 0;
        const displayTime = isContinuation ? 'ã¤ã¥ã' : timeStr;
        const displayType = isContinuation ? '' : typeVal;
        const displayContent = isContinuation ? '' : contentVal;
        const borderStyle = isContinuation ? `border-top:1px dashed ${barColor};` : `border-bottom:3px solid ${barColor};`;

        html += `
          <div style="border:1px solid #eee; padding:8px; border-radius:4px; page-break-inside:avoid; background:#fff;">
            <div style="display:flex; align-items:baseline; gap:5px; margin-bottom:5px; ${borderStyle} padding-bottom:4px; min-height:22px;">
              <span style="font-weight:bold; color:#333; font-size:12px;">${displayTime}</span>
              ${displayType ? `<span style="font-weight:bold; background:#e7f1ff; color:#0056b3; padding:1px 4px; border-radius:3px; font-size:10px;">${esc(displayType)}</span>` : ''}
            </div>
            ${displayContent ? `<div style="margin-bottom:6px; white-space:pre-wrap; font-size:10px;">${esc(displayContent)}</div>` : ''}
            <div style="display:flex; gap:5px; flex-wrap:wrap;">
              ${chunk.map(src => `<div style="text-align:center; flex:1; min-width:60px;"><img src="${src}" style="max-width:100%; max-height:100px; width:auto; height:auto; border:1px solid #ddd; border-radius:4px;"></div>`).join('')}
            </div>
          </div>
        `;
    });
  });

  if (lastDateStr !== '') html += '</div></div>';
  html += `</div></div>`;
  
  document.getElementById('meal-report-body').innerHTML = html;
  document.getElementById('meal-report-area').style.display = 'block';
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// GASãƒ¡ãƒ¢è¡¨ç¤ºï¼ˆä¿ç•™ã‚¿ã‚¹ã‚¯ï¼‰
function showGasMemo() {
  document.getElementById('modal-title').innerText = 'GASé€£æºï¼ˆãƒ¡ãƒ¼ãƒ«äºˆç´„é€ä¿¡ï¼‰';
  document.getElementById('modal-body').innerHTML = `
    <p><strong>ã€ä¿ç•™ä¸­ã‚¿ã‚¹ã‚¯ã€‘</strong></p>
    <p>Gmailã®äºˆç´„é€ä¿¡ã‚’å¤–éƒ¨ã‹ã‚‰è¡Œã†ãŸã‚ã®GASé€£æºæ©Ÿèƒ½æ¡ˆã§ã™ã€‚</p>
    <hr>
    <p><strong>å®Ÿè£…æ–¹é‡:</strong></p>
    <ol style="margin-left:20px;">
      <li>Google Apps Script (GAS) ã§Webã‚¢ãƒ—ãƒªã‚’ä½œæˆ</li>
      <li>ã“ã®ã‚¢ãƒ—ãƒªã‹ã‚‰GASã¸ãƒ‡ãƒ¼ã‚¿ï¼ˆå®›å…ˆã€æ—¥æ™‚ã€æœ¬æ–‡ï¼‰ã‚’é€ä¿¡</li>
      <li>GASå´ã§ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã€æŒ‡å®šæ—¥æ™‚ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œ</li>
    </ol>
    <p style="margin-top:10px; color:#666;">â€»ç¾åœ¨ã¯ä¿ç•™ä¸­ã§ã™ã€‚</p>
  `;
  document.getElementById('modal-overlay').style.display = 'flex';
}

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
function showDayDetail(y, m, d) {
  // æ°´åˆ†é‡ã®é›†è¨ˆ
  let totalWater = 0;
  const waterCats = st.cats.filter(c => c.name.includes('æ°´åˆ†') || c.name.includes('é£²'));
  waterCats.forEach(cat => {
    const fW = cat.fields.find(f => f.name.includes('é‡') && !f.name.includes('ä»Šæ—¥ã®') && !f.name.includes('åˆè¨ˆ'));
    if (fW) {
      cat.records.forEach(r => {
        const dt = getDt(r);
        if(dt.getFullYear() === y && dt.getMonth() + 1 === m && dt.getDate() === d) {
          let s = String(r[fW.id]||'0').replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/,/g, '');
          // æ—¥ä»˜ãƒ»æ™‚åˆ»ã®ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é™¤å»
          s = s.replace(/\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/g, '')
               .replace(/\d{1,2}[\/\-]\d{1,2}/g, '')
               .replace(/\d{1,2}:\d{1,2}/g, '');
          const matches = s.match(/-?\d+(\.\d+)?/g);
          if (matches) {
            matches.forEach(m => totalWater += parseFloat(m));
          }
        }
      });
    }
  });

  const cats = st.cats.filter(c => c.id === 'cat_other' || c.name.includes('ãƒˆã‚¤ãƒ¬') || c.id === 'cat_water' || c.name.includes('æ°´åˆ†è£œçµ¦'));
  let allRecs = [];
  
  // å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åé›†ã—ã¦çµ±åˆ
  cats.forEach(c => {
    const recs = c.records.filter(r => { const dt=getDt(r); return dt.getFullYear()===y && dt.getMonth()+1===m && dt.getDate()===d; });
    recs.forEach(r => {
      allRecs.push({ ...r, _catName: c.name, _fields: c.fields, _cid: c.id, _icon: c.icon });
    });
  });

  // æ™‚ç³»åˆ—ã‚½ãƒ¼ãƒˆ
  allRecs.sort((a,b) => getDt(a) - getDt(b));

  let html = '';

  if (totalWater > 0) {
    const waterTarget = st.settings.waterTarget || 1500;
    const col = totalWater < waterTarget ? '#dc3545' : '#007bff';
    html += `<div style="text-align:center; margin-bottom:10px; padding:8px; background:#f8f9fa; border:1px solid #ddd; border-radius:8px; font-weight:bold; color:#333;">
      æœ¬æ—¥ã®æ°´åˆ†æ‘‚å–é‡: <span style="color:${col}; font-size:18px;">${totalWater}ml</span>
    </div>`;
  }

  if(allRecs.length > 0) {
    html += '<div style="display:flex; flex-direction:column; gap:8px;">';
    allRecs.forEach(r => {
      const tm = getDt(r).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      const isToilet = r._cid === 'cat_other' || r._catName.includes('ãƒˆã‚¤ãƒ¬');
      const icon = r._icon || (isToilet ? 'ğŸš½' : 'ğŸ’§');
      const bg = isToilet ? '#e7f1ff' : '#e0f7fa';
      const bd = isToilet ? '#b6d4fe' : '#b2ebf2';
      
      const body = r._fields.map(f => r[f.id] ? `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed rgba(0,0,0,0.05); padding:2px 0;"><span style="color:#666; font-size:11px;">${f.name}</span><span style="font-weight:bold; font-size:12px;">${r[f.id]}</span></div>` : '').filter(x=>x).join('');
      
      html += `<div style="display:flex; gap:10px; padding:10px; background:${bg}; border-left:4px solid ${bd}; border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
        <div style="display:flex; flex-direction:column; align-items:center; min-width:40px;"><span style="font-size:20px;">${icon}</span><span style="font-size:10px; font-weight:bold; color:#555; margin-top:2px;">${tm}</span></div>
        <div style="flex:1;"><div style="font-size:11px; font-weight:bold; color:#444; margin-bottom:4px;">${r._catName}</div>${body}</div></div>`;
    });
    html += '</div>';
  }
  if(!html) html = '<div style="padding:20px; text-align:center; color:#666;">è¨˜éŒ²ãªã—</div>';
  document.getElementById('modal-title').innerText = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')} ã®è¨˜éŒ²`;
  document.getElementById('modal-body').innerHTML = html;
  document.getElementById('modal-overlay').style.display = 'flex';
}

// å…¥å‡ºåŠ›ãƒ­ã‚°ç®¡ç†
function addIoLog(type, name, skipBackup = false) {
  if (!st.ioLogs) st.ioLogs = [];
  st.ioLogs.unshift({ ts: Date.now(), type: type, name: name });
  // 48æ™‚é–“ä»¥å‰ã‚’å‰Šé™¤
  const limit = Date.now() - (48 * 60 * 60 * 1000);
  st.ioLogs = st.ioLogs.filter(l => l.ts > limit);
  save(skipBackup);
  if(st.view === 'maint') renderIoLogs();
}
function renderIoLogs() {
  const el = document.getElementById('io-logs'); if(!el) return;
  if(!st.ioLogs || st.ioLogs.length === 0) { el.innerHTML = '<div style="font-size:12px; color:#999; padding:5px;">å±¥æ­´ãªã—</div>'; return; }
  el.innerHTML = st.ioLogs.map(l => {
    const d = new Date(l.ts);
    const dateStr = formatDateYMDHM(d);
    const color = l.type === 'import' ? '#d63384' : '#0d6efd';
    return `<div style="font-size:11px; border-bottom:1px solid #eee; padding:4px 0;"><span style="color:${color}; font-weight:bold; margin-right:5px;">[${l.type==='import'?'å–è¾¼':'å‡ºåŠ›'}]</span><span style="color:#666; margin-right:5px;">${dateStr}</span><span>${l.name}</span></div>`;
  }).join('');
}

// å¤–éƒ¨CSVåˆ†æ
function loadExtCSV(input) {
  const file = input.files[0];
  if(!file) return;
  
  // å‡¦ç†ä¸­ã¯å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–ã—ã€ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¾…æ©ŸçŠ¶æ…‹ã«ã™ã‚‹
  input.disabled = true;
  document.body.style.cursor = 'wait';

  st.extFileName = file.name;
  st.extFileDate = new Date().toISOString();
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const text = e.target.result;
      const data = parseExtCSV(text);
      if (data) {
        addOrUpdateExtFile(file.name, data);
      }
    } finally {
      // å‡¦ç†çµ‚äº†å¾Œã«æœ‰åŠ¹åŒ–
      input.disabled = false;
      document.body.style.cursor = 'default';
    }
  };
  // UTF-8 (BOMä»˜ãå¯¾å¿œ) ã§èª­ã¿è¾¼ã¿
  reader.readAsText(file);
}

function parseExtCSV(text) {
  // BOMé™¤å»
  if (text.charCodeAt(0) === 0xFEFF) { text = text.slice(1); }
  const lines = text.split(/\r\n|\n/).filter(line => line.trim());
  if (lines.length < 2) { alert('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã‹ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return null; }
  
  const parsedData = [];
  
  // ç°¡æ˜“CSVè¡Œãƒ‘ãƒ¼ã‚¹ (å¼•ç”¨ç¬¦å¯¾å¿œ)
  const parseLine = (line) => {
    const res = [];
    let cur = '', inQuote = false;
    for(let i=0; i<line.length; i++) {
      const c = line[i];
      if(c === '"') { inQuote = !inQuote; }
      else if(c === ',' && !inQuote) { res.push(cur.trim().replace(/^"|"$/g, '')); cur = ''; }
      else { cur += c; }
    }
    res.push(cur.trim().replace(/^"|"$/g, ''));
    return res;
  };

  const header = parseLine(lines[0]);
  
  // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåˆ¤å®š: ãƒ‡ãƒ¼ã‚¿1è¡Œç›®ã®1åˆ—ç›®ãŒæ—¥ä»˜ã‹ã©ã†ã‹
  let isMatrix = false;
  if (lines.length > 1) {
    const firstRow = parseLine(lines[1]);
    // 1åˆ—ç›®ãŒæ—¥ä»˜ã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã§ããªã‘ã‚Œã°æ¨ªæŒã¡(é …ç›®å)ã¨ã¿ãªã™
    if (firstRow[0] && isNaN(Date.parse(firstRow[0]))) {
      isMatrix = true;
    } else if (!firstRow[0]) {
       // 1åˆ—ç›®ãŒç©ºã®å ´åˆã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®4åˆ—ç›®ãŒæ—¥ä»˜ã‹ã©ã†ã‹ã§åˆ¤æ–­
       if (header.length > 3 && !isNaN(Date.parse(header[3]))) isMatrix = true;
    }
  }

  if (isMatrix) {
    // --- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ2: æ¨ªæŒã¡ (è¡Œ=é …ç›®, åˆ—=æ—¥ä»˜) ---
    // header: [é …ç›®å, åŸºæº–å€¤, å˜ä½, æ—¥ä»˜1, æ—¥ä»˜2...]
    const dateCols = [];
    for(let i=3; i<header.length; i++) {
      if(header[i]) dateCols.push({ idx: i, date: header[i] });
    }

    for(let i=1; i<lines.length; i++) {
      const row = parseLine(lines[i]);
      if(row.length < 3) continue;
      
      const item = row[0];
      const refVal = row[1];
      const unit = row[2];
      
      if(item) {
        dateCols.forEach(d => {
          if (d.idx < row.length) {
            const val = row[d.idx];
            if(val !== undefined && val !== '') {
              parsedData.push({ date: d.date, item: item, unit: unit, val: val, ref: refVal });
            }
          }
        });
      }
    }
  } else {
    // --- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ1: ç¸¦æŒã¡ (è¡Œ=æ—¥ä»˜, åˆ—=é …ç›®) ---
    // header: [æ—¥ä»˜, é …ç›®1, é …ç›®2...]
    const itemCols = [];
    for(let i=1; i<header.length; i++) {
      if(header[i]) itemCols.push({ idx: i, name: header[i] });
    }

    for(let i=1; i<lines.length; i++) {
      const row = parseLine(lines[i]);
      if(row.length < 1) continue;
      
      const dateStr = row[0];
      if (!dateStr || isNaN(Date.parse(dateStr))) continue;

      itemCols.forEach(col => {
        if (col.idx < row.length) {
          const val = row[col.idx];
          if (val !== undefined && val !== '') {
            parsedData.push({ date: dateStr, item: col.name, unit: '', val: val, ref: '' });
          }
        }
      });
    }
  }

  // è‡ªå‹•è¨ˆç®—: TP/Cre, ãƒŠãƒˆã‚«ãƒªæ¯”
  const dates = [...new Set(parsedData.map(d => d.date))];
  dates.forEach(date => {
    const dayRecs = parsedData.filter(d => d.date === date);
    const getV = (k) => {
      const r = dayRecs.find(d => d.item.includes(k) && !d.item.includes('å®šæ€§') && !d.item.includes('æ¯”'));
      if(!r) return null;
      const m = String(r.val).match(/-?\d+(\.\d+)?/);
      return m ? parseFloat(m[0]) : null;
    };

    // TP/Cre (1æ—¥å°¿è›‹ç™½æ’æ³„é‡)
    const pVal = getV('å°¿è›‹ç™½');
    const cVal = getV('å°¿ã‚¯ãƒ¬ã‚¢ãƒãƒ‹ãƒ³') || getV('å°¿ä¸­ã‚¯ãƒ¬ã‚¢ãƒãƒ‹ãƒ³');
    if(pVal !== null && cVal !== null && cVal !== 0) {
      const val = (pVal / cVal).toFixed(2);
      parsedData.push({ date: date, item: 'TP/Cre(1æ—¥å°¿è›‹ç™½æ’æ³„é‡)', unit: 'g/gCr', val: val, ref: '< 0.15' });
    }

    // è“„å°¿ãƒŠãƒˆã‚«ãƒªæ¯”
    const naVal = getV('å°¿ä¸­ãƒŠãƒˆãƒªã‚¦ãƒ ') || getV('å°¿ä¸­Na');
    const kVal = getV('å°¿ä¸­ã‚«ãƒªã‚¦ãƒ ') || getV('å°¿ä¸­K');
    if(naVal !== null && kVal !== null && kVal !== 0) {
      const val = (naVal / kVal).toFixed(2);
      parsedData.push({ date: date, item: 'è“„å°¿ãƒŠãƒˆã‚«ãƒªæ¯”', unit: '', val: val, ref: '' });
    }
  });

  return parsedData;
}

async function addExtFileFromPicker() {
  try {
    if (!window.showOpenFilePicker) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'); return; }
    const [handle] = await window.showOpenFilePicker({
      types: [{
        description: 'CSV/Text Files',
        accept: {'text/csv': ['.csv'], 'text/plain': ['.txt', '.csv']}
      }]
    });
    const file = await handle.getFile();
    const text = await file.text();
    const data = parseExtCSV(text);
    if (data) {
      addOrUpdateExtFile(file.name, data, handle);
    }
  } catch (e) {
    if (e.name !== 'AbortError') alert('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

function addOrUpdateExtFile(name, data, handle = null, silent = false) {
  if (!st.extFiles) st.extFiles = [];
  const idx = st.extFiles.findIndex(f => f.name === name);
  const fileObj = {
    name: name,
    date: new Date().toISOString(),
    data: data,
    selectedItems: [],
    handle: handle
  };
  
  if (idx >= 0) {
    // ä¸Šæ›¸ã: æ—¢å­˜ã®é¸æŠçŠ¶æ…‹ã‚’å¼•ãç¶™ãï¼ˆæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹é …ç›®ã®ã¿ï¼‰
    const oldFile = st.extFiles[idx];
    const oldSel = oldFile.selectedItems || [];
    const newItems = new Set(data.map(d => d.item));
    fileObj.selectedItems = oldSel.filter(i => newItems.has(i));
    
    // ãƒãƒ³ãƒ‰ãƒ«ã®å¼•ç¶™ã
    if (!fileObj.handle && oldFile.handle) {
        fileObj.handle = oldFile.handle;
    }

    st.extFiles[idx] = fileObj;
    switchExtFile(idx);
    if (!silent) alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${name}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);
  } else {
    // æ–°è¦è¿½åŠ 
    st.extFiles.push(fileObj);
    switchExtFile(st.extFiles.length - 1);
    if (!silent) alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
  }
  renderIntegratedItemSelector();
  saveExtData();
}

function switchExtFile(idx) {
  if (!st.extFiles || !st.extFiles[idx]) return;
  st.extCurrentIdx = idx;
  const f = st.extFiles[idx];
  st.extData = f.data;
  st.extFileName = f.name;
  st.extFileDate = f.date;
  st.extSelectedItems = f.selectedItems || [];
  
  renderExtFileList();
  renderIntegratedItemSelector();
  
  // ä»¥å‰ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
  document.getElementById('ext-result').innerHTML = '';
}

function deleteExtFile(idx) {
  if (!confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  st.extFiles.splice(idx, 1);
  if (st.extFiles.length === 0) {
    st.extCurrentIdx = -1;
    st.extData = [];
    st.extFileName = null;
    st.extFileDate = null;
    st.extSelectedItems = [];
    renderIntegratedItemSelector();
    document.getElementById('ext-result').innerHTML = '';
  } else {
    // å‰Šé™¤ã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¿œã˜ã¦èª¿æ•´
    if (st.extCurrentIdx >= idx) st.extCurrentIdx = Math.max(0, st.extCurrentIdx - 1);
    switchExtFile(st.extCurrentIdx);
  }
  renderExtFileList();
  renderIntegratedItemSelector();
  saveExtData();
}

function renderExtFileList() {
  const el = document.getElementById('ext-file-list');
  if (!st.extFiles || st.extFiles.length === 0) {
    el.style.display = 'none';
    return;
  }
  el.style.display = 'block';
  el.innerHTML = st.extFiles.map((f, i) => {
    const dateStr = formatDateYMDHM(f.date);
    const reloadBtn = f.handle ? `<button class="btn-sub" style="background:#28a745; padding:2px 8px; font-size:10px; margin-right:5px;" onclick="reloadExtFile(${i})">å†èª­è¾¼</button>` : '';
    return `
      <div style="display:flex; justify-content:space-between; align-items:center; padding:5px; background:#fff; border-bottom:1px solid #eee;">
        <div>
          <div style="font-size:12px; font-weight:bold;">${esc(f.name)}</div>
          <div style="font-size:10px; color:#666;">æ›´æ–°: ${dateStr}</div>
        </div>
        <div>
          ${reloadBtn}
          <button class="btn-sub" style="background:#dc3545; padding:2px 8px; font-size:10px;" onclick="deleteExtFile(${i})">å‰Šé™¤</button>
        </div>
      </div>
    `;
  }).join('');
}

async function reloadExtFile(idx) {
  const f = st.extFiles[idx];
  if (!f || !f.handle) return;
  
  try {
    // æ¨©é™ç¢ºèª
    const opts = { mode: 'read' };
    if ((await f.handle.queryPermission(opts)) !== 'granted') {
       if ((await f.handle.requestPermission(opts)) !== 'granted') return;
    }
    
    const file = await f.handle.getFile();
    const text = await file.text();
    const data = parseExtCSV(text);
    if (data) {
      // ãƒãƒ³ãƒ‰ãƒ«ã¯ãã®ã¾ã¾ç¶­æŒã—ã¦æ›´æ–°
      addOrUpdateExtFile(file.name, data, f.handle, true);
      showToast('å†èª­è¾¼å®Œäº†: ' + file.name);
    }
  } catch(e) {
    alert('å†èª­è¾¼ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

async function saveExtData() {
  try {
    if (st.extCurrentIdx >= 0 && st.extFiles[st.extCurrentIdx]) {
       st.extFiles[st.extCurrentIdx].selectedItems = st.extSelectedItems;
    }
    await idb.set(KEY_EXT, st.extFiles);
    await idb.set(KEY_EXT + '_idx', st.extCurrentIdx);
  } catch(e) {}
}

function isAbnormal(val, ref) {
  if(!val || !ref) return false;
  const v = parseFloat(val);
  if(isNaN(v)) return false;
  // å€¤ã«H/LãŒå«ã¾ã‚Œã‚‹å ´åˆ
  if(typeof val === 'string' && (val.includes('H') || val.includes('L'))) return true;
  // ç¯„å›² "min - max" or "min ~ max"
  // å…¨è§’ãƒãƒ«ãƒ€ã€Œï½ã€ã«å¯¾å¿œ
  const range = ref.match(/([\d\.]+)\s*[\-~ï½]\s*([\d\.]+)/);
  if(range) {
    const min = parseFloat(range[1]);
    const max = parseFloat(range[2]);
    return (v < min || v > max);
  }
  // ä¸Šé™ä¸‹é™
  if(ref.match(/(?:ä»¥ä¸‹|<=|=<)\s*([\d\.]+)/)) return v > parseFloat(RegExp.$1);
  if(ref.match(/(?:ä»¥ä¸Š|>=|=>)\s*([\d\.]+)/)) return v < parseFloat(RegExp.$1);
  // "40 =<" (40 <= å€¤ -> å€¤ã¯40ä»¥ä¸Š)
  if(ref.match(/([\d\.]+)\s*(?:=<|<=)/)) return v < parseFloat(RegExp.$1);
  return false;
}

function getRefRange(ref) {
  if (!ref) return null;
  let min = null, max = null;
  // å…¨è§’ãƒãƒ«ãƒ€ã€Œï½ã€ã«å¯¾å¿œ
  const range = ref.match(/([\d\.]+)\s*[\-~ï½]\s*([\d\.]+)/);
  if (range) {
    min = parseFloat(range[1]); max = parseFloat(range[2]);
  } else {
    if (ref.match(/(?:ä»¥ä¸‹|<=|=<)\s*([\d\.]+)/)) max = parseFloat(RegExp.$1);
    if (ref.match(/(?:ä»¥ä¸Š|>=|=>)\s*([\d\.]+)/)) min = parseFloat(RegExp.$1);
    if (ref.match(/([\d\.]+)\s*(?:=<|<=)/)) min = parseFloat(RegExp.$1);
  }
  if (min === null && max === null) return null;
  return { min, max };
}

function renderExtTable(forceRender = false) {
  const resDiv = document.getElementById('ext-result');
  if(!forceRender && resDiv.querySelector('table')) {
    resDiv.innerHTML = '';
    return;
  }

  const checks = st.extSelectedItems || []; // executeIntegratedAnalysisã§ã‚»ãƒƒãƒˆã•ã‚Œã‚‹
  if(checks.length === 0) { alert('é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

  // ã‚½ãƒ¼ãƒˆè¨­å®šåˆæœŸåŒ–
  if (!st.extTableSort) st.extTableSort = { col: 'date', asc: false };

  const aggMode = document.querySelector('input[name="ext-agg-mode"]:checked')?.value || 'daily';
  // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š
  const range = document.getElementById('ext-graph-range')?.value || 'all';
  let limitDate = null;
  if(range !== 'all') {
    limitDate = new Date();
    limitDate.setHours(0, 0, 0, 0);
    if(range === '1y') limitDate.setFullYear(limitDate.getFullYear() - 1);
    else if(range === '2y') limitDate.setFullYear(limitDate.getFullYear() - 2);
    else if(range === '3y') limitDate.setFullYear(limitDate.getFullYear() - 3);
  }

  // é›†ç´„å‡¦ç† (æ—¥ä»˜å˜ä½)
  const aggMap = {}; // { 'YYYY-MM-DD': { dateObj: Date, dateKey: String, items: { 'ItemName': [rec1, rec2...], ... } } }
  
  st.extData.forEach(d => {
    const dObj = new Date(d.date);
    if (isNaN(dObj.getTime())) return;
    if (limitDate && dObj < limitDate) return;

    const dateKey = (aggMode === 'raw') ? formatDateYMDHM(dObj) : formatDateYMD(dObj);
    if (!aggMap[dateKey]) {
      const groupDateObj = new Date(dObj);
      if (aggMode === 'daily') {
        groupDateObj.setHours(0, 0, 0, 0);
      }
      aggMap[dateKey] = { dateObj: groupDateObj, dateKey: dateKey, items: {} };
    }
    if (!aggMap[dateKey].items[d.item]) {
      aggMap[dateKey].items[d.item] = [];
    }
    aggMap[dateKey].items[d.item].push(d);
  });

  // è¡Œãƒªã‚¹ãƒˆä½œæˆ
  let rows = Object.values(aggMap);

  // å€¤å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼ (é›†ç´„å¾Œã®å€¤)
  const getAggValue = (row, item) => {
    const recs = row.items[item];
    if (!recs || recs.length === 0) return null;
    
    // æ•°å€¤æŠ½å‡º
    const nums = recs.map(r => {
      const originalVal = String(r.val).trim();
      // æ—¥ä»˜ã‚„æ™‚åˆ»ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã¯æ•°å€¤ã¨ã—ã¦æ‰±ã‚ãªã„
      if (originalVal.includes(':') || /^\d{4,}[-/]\d{1,2}[-/]\d{1,2}/.test(originalVal)) {
        return null;
      }
      const s = originalVal.replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0)).replace(/,/g, '');
      // å…ˆé ­ãŒæ•°å€¤ã€ã¾ãŸã¯ã€Œç´„ã€ã€Œ~ã€ãªã©ã§å§‹ã¾ã‚‹æ•°å€¤ã®ã¿å¯¾è±¡ã¨ã™ã‚‹ (è–¬å‰¤åãªã©ãŒæ•°å€¤ã¨ã—ã¦èª¤èªã•ã‚Œã‚‹ã®ã‚’é˜²ã)
      if (/^([ç´„~ã€œ\s]*)-?\d/.test(s)) {
          const m = s.match(/-?\d+(\.\d+)?/);
          return m ? parseFloat(m[0]) : null;
      }
      return null;
    }).filter(n => n !== null);

    // å…¨ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ•°å€¤ã¨ã—ã¦è§£é‡ˆã§ããŸå ´åˆã®ã¿å¹³å‡å€¤ã‚’è¨ˆç®—
    if (nums.length === recs.length && nums.length > 0) {
      const sum = nums.reduce((a, b) => a + b, 0);
      // å°æ•°ç‚¹ä»¥ä¸‹2æ¡ã§ä¸¸ã‚ã¦æ•°å€¤ã«æˆ»ã™
      return parseFloat((sum / nums.length).toFixed(2));
    }
    
    // ãã‚Œä»¥å¤–ã¯ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦çµåˆè¡¨ç¤º (é‡è¤‡æ’é™¤)
    const uniqueVals = [...new Set(recs.map(r => String(r.val)))];
    return uniqueVals.join(', ');
  };

  // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
  rows.sort((a, b) => {
    if (st.extTableSort.col === 'date') {
      const da = a.dateObj.getTime();
      const db = b.dateObj.getTime();
      return st.extTableSort.asc ? da - db : db - da;
    }
    
    const va = getAggValue(a, st.extTableSort.col);
    const vb = getAggValue(b, st.extTableSort.col);
    
    if (va === null && vb === null) return 0;
    if (va === null) return 1; // ãƒ‡ãƒ¼ã‚¿ãªã—ã¯æœ«å°¾
    if (vb === null) return -1;
    
    if (typeof va === 'number' && typeof vb === 'number') {
      return st.extTableSort.asc ? va - vb : vb - va;
    }
    const sa = String(va);
    const sb = String(vb);
    return st.extTableSort.asc ? sa.localeCompare(sb) : sb.localeCompare(sa);
  });

  const getSortMark = (col) => {
    if (st.extTableSort.col !== col) return '<span style="color:#ccc; font-size:10px; margin-left:2px;">â‡…</span>';
    return st.extTableSort.asc ? '<span style="color:#007bff; margin-left:2px;">â–²</span>' : '<span style="color:#007bff; margin-left:2px;">â–¼</span>';
  };

  let h = `<div style="margin-bottom:10px; text-align:right;">
    <button class="btn-sub" onclick="exportAnalysisCSV()" style="background:#28a745; color:white;">CSVå‡ºåŠ›</button>
    <button class="btn-sub" onclick="document.getElementById('ext-result').innerHTML=''; showNav();">é–‰ã˜ã‚‹</button>
  </div>`;
  
  // 20è¡Œå˜ä½ã§è¡¨ç¤ºã—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è¡¨ç¤º (max-heightã‚’è¨­å®š) + åˆ—å¹…å¤‰æ›´å¯¾å¿œ (table-layout:fixed)
  const initialTableWidth = 120 + checks.length * 150; // åˆæœŸå¹…è¨ˆç®—
  h += '<div style="overflow:auto; max-height:70vh; border:1px solid #ddd; position:relative;">';
  h += `<table id="ext-main-table" style="width:${initialTableWidth}px; table-layout:fixed; border-collapse:separate; border-spacing:0; font-size:14px;">`;
  
  // åˆ—å®šç¾© (colgroup)
  h += '<colgroup>';
  h += `<col id="ext-col-0" style="width:120px;">`;
  checks.forEach((_, i) => {
      h += `<col id="ext-col-${i+1}" style="width:150px;">`;
  });
  h += '</colgroup>';

  // ãƒ˜ãƒƒãƒ€ãƒ¼ (æ—¥ä»˜ + é¸æŠé …ç›®)
  const dateHeader = (aggMode === 'raw') ? 'æ—¥æ™‚' : 'è¨ºæ–­æ—¥';
  h += `<thead style="position:sticky; top:0; z-index:20;"><tr style="background:#f0f2f5;">`;
  h += `<th style="border-right:1px solid #ccc; border-bottom:1px solid #ccc; padding:8px; position:sticky; left:0; top:0; z-index:30; background:#f0f2f5; cursor:pointer; white-space:normal; word-break:break-all;" onclick="toggleExtTableSort('date')">${dateHeader}${getSortMark('date')}<div class="resizer" onmousedown="initResize(event, 0, 'ext')" onclick="event.stopPropagation()"></div></th>`;
  h += checks.map((item, i) => {
    const info = st.extData.find(d => d.item === item);
    const unit = info?.unit || '';
    const ref = info?.ref || '';
    const safeItem = esc(item.replace(/'/g, "\\'"));
    return `<th style="border-right:1px solid #ccc; border-bottom:1px solid #ccc; padding:8px; position:sticky; top:0; z-index:20; background:#f0f2f5; cursor:pointer; white-space:normal; word-break:break-all;" onclick="toggleExtTableSort('${safeItem}')">
      <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div>${esc(item)} <span style="font-size:12px; color:#666;">${esc(unit)}</span>${getSortMark(item)}</div>
        <button class="btn-sub" style="padding:0; width:20px; height:20px; line-height:20px; font-size:14px; background:#fff; color:#dc3545; border:1px solid #dc3545; border-radius:50%; margin-left:5px; flex-shrink:0;" title="ã“ã®åˆ—ã‚’éš ã™" onclick="event.stopPropagation(); hideExtColumn('${safeItem}')">Ã—</button>
      </div>
      <div style="font-size:11px; color:#888; font-weight:normal;">${esc(ref)}</div>
      <div class="resizer" onmousedown="initResize(event, ${i+1}, 'ext')" onclick="event.stopPropagation()"></div>
    </th>`;
  }).join('');
  h += '</tr></thead><tbody>';
  
  // ãƒ‡ãƒ¼ã‚¿è¡Œ (æ—¥ä»˜ã”ã¨)
  rows.forEach(row => {
    h += `<tr><td style="border-right:1px solid #ddd; border-bottom:1px solid #ddd; padding:8px; font-weight:bold; position:sticky; left:0; z-index:10; background:#fff; white-space:normal; word-break:break-all;">${row.dateKey}</td>`;
    h += checks.map(item => {
      const val = getAggValue(row, item);
      const recs = row.items[item];
      const ref = recs && recs.length > 0 ? recs[0].ref : '';
      
      const isAb = val !== null ? isAbnormal(val, ref) : false;
      const style = isAb ? 'color:red; font-weight:bold;' : 'color:#333;';
      const title = (recs && recs.length > 1 && typeof val === 'number') ? ` title="å¹³å‡å€¤ (å…ƒãƒ‡ãƒ¼ã‚¿: ${recs.map(r => r.val).join(', ')})"` : '';
      return `<td${title} style="border-right:1px solid #ddd; border-bottom:1px solid #ddd; padding:8px; text-align:center; background:#fff; ${style} white-space:normal; word-break:break-all;">${val !== null ? esc(val) : '-'}</td>`;
    }).join('');
    h += '</tr>';
  });
  h += '</tbody></table></div>';
  resDiv.innerHTML = h;
}

function toggleExtTableSort(col) {
  if (!st.extTableSort) st.extTableSort = { col: 'date', asc: false };
  if (st.extTableSort.col === col) {
    st.extTableSort.asc = !st.extTableSort.asc;
  } else {
    st.extTableSort.col = col;
    st.extTableSort.asc = (col !== 'date'); // æ—¥ä»˜ä»¥å¤–ã¯æ˜‡é †ã‚¹ã‚¿ãƒ¼ãƒˆã€æ—¥ä»˜ã¯é™é †ã‚¹ã‚¿ãƒ¼ãƒˆ
  }
  renderExtTable(true);
}

function hideExtColumn(item) {
  if (!st.extSelectedItems) return;
  const idx = st.extSelectedItems.indexOf(item);
  if (idx > -1) {
    st.extSelectedItems.splice(idx, 1);
    saveExtData();
    updateExtUI();
    renderExtTable(true);
  }
}

async function exportAnalysisCSV() {
  const checks = st.extSelectedItems || [];
  if (checks.length === 0 || !st.extData) { alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  const aggMode = document.querySelector('input[name="ext-agg-mode"]:checked')?.value || 'daily';
  // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
  const range = document.getElementById('ext-graph-range')?.value || 'all';
  let limitDate = null;
  if(range !== 'all') {
    limitDate = new Date();
    limitDate.setHours(0, 0, 0, 0);
    if(range === '1y') limitDate.setFullYear(limitDate.getFullYear() - 1);
    else if(range === '2y') limitDate.setFullYear(limitDate.getFullYear() - 2);
    else if(range === '3y') limitDate.setFullYear(limitDate.getFullYear() - 3);
  }

  // é›†ç´„å‡¦ç†
  const aggMap = {};
  st.extData.forEach(d => {
    const dObj = new Date(d.date);
    if (isNaN(dObj.getTime())) return;
    if (limitDate && dObj < limitDate) return;
    const dateKey = (aggMode === 'raw') ? formatDateYMDHM(dObj) : formatDateYMD(dObj);
    if (!aggMap[dateKey]) aggMap[dateKey] = { dateObj: dObj, dateKey: dateKey, items: {} };
    if (!aggMap[dateKey].items[d.item]) aggMap[dateKey].items[d.item] = [];
    aggMap[dateKey].items[d.item].push(d);
  });

  // æ—¥ä»˜é †ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
  const rows = Object.values(aggMap).sort((a, b) => b.dateObj - a.dateObj);

  // å€¤å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼
  const getAggValue = (row, item) => {
    const recs = row.items[item];
    if (!recs || recs.length === 0) return null;
    const nums = recs.map(r => {
      const s = String(r.val).replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0)).replace(/,/g, '');
      const m = s.match(/-?\d+(\.\d+)?/);
      return m ? parseFloat(m[0]) : null;
    }).filter(n => n !== null);
    if (nums.length > 0) {
      const sum = nums.reduce((a, b) => a + b, 0);
      return parseFloat((sum / nums.length).toFixed(2));
    }
    return recs[0].val;
  };

  // CSVä½œæˆ
  let csv = "\uFEFFæ—¥ä»˜"; // BOMä»˜ã
  checks.forEach(item => {
    const info = st.extData.find(d => d.item === item);
    const unit = info?.unit ? `(${info.unit})` : '';
    csv += `,${item}${unit}`;
  });
  csv += "\n";

  rows.forEach(row => {
    csv += `"${row.dateKey}"`;
    checks.forEach(item => {
      const val = getAggValue(row, item);
      let csvVal = (val !== null) ? String(val) : '';
      if (csvVal.includes(',')) csvVal = `"${csvVal.replace(/"/g, '""')}"`;
      csv += `,${csvVal}`;
    });
    csv += "\n";
  });

  const blob = new Blob([csv], {type:'text/csv'});
  const ts = getTS();
  const name = `${VERSION}_${ts}_analysis_export.csv`;
  if(await saveBlob(blob, name)) { addIoLog('export', name, true); showToast('ä¿å­˜ã—ã¾ã—ãŸ: ' + name); }
}


window.cycleGraphMode = function() {
  if (st.extGraphMode === undefined) st.extGraphMode = 0;
  st.extGraphMode = (st.extGraphMode + 1) % 4;
  const modes = ['é€šå¸¸', 'ç§»å‹•å¹³å‡ã®ã¿', 'æ•°å€¤è¡¨ç¤º', 'å‰å›å·®åˆ†'];
  showToast('ã‚°ãƒ©ãƒ•ãƒ¢ãƒ¼ãƒ‰: ' + modes[st.extGraphMode]);
  renderExtGraph(true);
};

const EXT_CHART_COLORS = ['#007bff', '#dc3545', '#28a745', '#fd7e14', '#6f42c1', '#e83e8c', '#17a2b8', '#6610f2', '#20c997', '#ffc107'];

function createExtDataset(item, rawDataForItem, colorIdx, limitDate) {
    const aggMode = document.querySelector('input[name="ext-agg-mode"]:checked')?.value || 'daily';
    const rawData = rawDataForItem;
    
    let maxDecimals = 0;
    rawData.forEach(d => {
        const s = String(d.val).trim();
        const m = s.match(/-?\d+(\.\d+)?/);
        if (m && m[1]) {
            const len = m[1].length - 1;
            if (len > maxDecimals) maxDecimals = len;
        }
    });

    const aggMap = {};

    rawData.forEach(d => {
        const dObj = new Date(d.date);
        if (isNaN(dObj.getTime())) return;
        if (limitDate && dObj < limitDate) return;

        const dateKey = (aggMode === 'raw') ? formatDateYMDHM(dObj) : formatDateYMD(dObj);
        if (!aggMap[dateKey]) {
            const groupDateObj = new Date(dObj);
            if (aggMode === 'daily') {
                groupDateObj.setHours(0, 0, 0, 0);
            }
            aggMap[dateKey] = { dateObj: groupDateObj, dateStr: dateKey, values: [], unit: d.unit, ref: d.ref };
        }

        let val = null;
        const originalVal = String(d.val).trim();
        // æ—¥ä»˜ã‚„æ™‚åˆ»ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã¯æ•°å€¤ã¨ã—ã¦æ‰±ã‚ãªã„
        if (originalVal.includes(':') || /^\d{4,}[-/]\d{1,2}[-/]\d{1,2}/.test(originalVal)) {
            // val remains null
        } else if (typeof d.val === 'number') {
            val = d.val;
        } else {
            const s = originalVal.replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0)).replace(/,/g, '');
            const match = s.match(/-?\d+(\.\d+)?/);
            if(match) val = parseFloat(match[0]);
        }

        if (val !== null) {
            aggMap[dateKey].values.push(val);
        }
    });

    let aggregatedData = Object.values(aggMap).map(entry => {
        if (entry.values.length === 0) return null;
        const sum = entry.values.reduce((a, b) => a + b, 0);
        const avg = sum / entry.values.length;
        return {
            date: entry.dateStr,
            dateObj: entry.dateObj,
            val: parseFloat(avg.toFixed(4)),
            unit: entry.unit,
            ref: entry.ref
        };
    }).filter(d => d !== null);

    aggregatedData.sort((a, b) => a.dateObj - b.dateObj);

    if (st.extGraphMode === 3) {
      const diffData = [];
      for(let i=1; i<aggregatedData.length; i++) {
        const curr = aggregatedData[i].val;
        const prev = aggregatedData[i-1].val;
        const diff = curr - prev;
        diffData.push({ ...aggregatedData[i], val: parseFloat(diff.toFixed(4)) });
      }
      aggregatedData = diffData;
    }

    const dataPoints = aggregatedData.map(d => {
        return { x: d.dateObj.getTime(), y: d.val, unit: d.unit, ref: d.ref, origDate: d.date };
    });

    if (dataPoints.length === 0) return null;

    return {
        label: item + (st.extGraphMode === 3 ? ' (å‰å›å·®åˆ†)' : ''),
        data: dataPoints,
        borderColor: EXT_CHART_COLORS[colorIdx % EXT_CHART_COLORS.length],
        backgroundColor: EXT_CHART_COLORS[colorIdx % EXT_CHART_COLORS.length],
        tension: 0.1,
        pointRadius: st.settings.graphMarkerShow ? (st.settings.graphMarkerSize || 4) : 0,
        borderWidth: st.settings.graphLineWidth || 2,
        pointHoverRadius: 6,
        unit: dataPoints[0].unit || '',
        ref: aggregatedData[0]?.ref || '',
        decimals: maxDecimals
    };
}

function getExtChartOptions(yAxes) {
    const fontSize = st.settings.graphAxisFontSize || 10;
    return {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false }, // â† ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®æŒ™å‹•ã‚’æ”¹å–„
      scales: {
          x: {
              type: 'linear', position: 'bottom',
              ticks: {
                  font: { size: fontSize },
                  callback: function(value) { const d = new Date(value); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
              },
              title: { display: false }
          },
          ...yAxes
      },
      plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: fontSize + 2 }, boxWidth: 12 } },
          tooltip: {
              callbacks: {
                  title: function(context) { if (context.length > 0) { const d = new Date(context[0].parsed.x); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; } return ''; },
                  label: function(context) {
                      let label = context.dataset.label || '';
                      if (label) label += ': ';
                      if (context.parsed.y !== null) {
                          const val = context.parsed.y;
                          label += (val > 0 && st.extGraphMode === 3 ? '+' : '') + val;
                          const unit = context.raw.unit;
                          if(unit) label += ' ' + unit;
                      }
                      return label;
                  }
              }
          },
          datalabels: {
              display: st.extGraphMode === 2 ? 'auto' : false,
              align: 'top', offset: 4, color: '#333',
              font: { size: fontSize, weight: 'bold' },
              formatter: function(value) { return value.y; }
          }
      }
    };
}

const extAnnotationPlugin = {
    id: 'customAnnotation',
    beforeDatasetsDraw(chart, args, options) {
        const { ctx, chartArea: { top, bottom, left, right }, scales } = chart;
        chart.data.datasets.forEach(dataset => {
            const refRange = getRefRange(dataset.ref);
            if (!refRange) return;
            const yScale = scales[dataset.yAxisID || 'y'];
            if (!yScale) return;
            const yMin = refRange.min !== null ? refRange.min : yScale.min;
            const yMax = refRange.max !== null ? refRange.max : yScale.max;
            const yMinPixel = yScale.getPixelForValue(yMin);
            const yMaxPixel = yScale.getPixelForValue(yMax);
            ctx.save();
            ctx.fillStyle = 'rgba(102, 187, 106, 0.2)';
            ctx.fillRect(left, yMaxPixel, right - left, yMinPixel - yMaxPixel);
            if (st.extGraphMode !== 3) {
                ctx.strokeStyle = 'rgba(76, 175, 80, 0.5)'; ctx.lineWidth = 1;
                if (refRange.max !== null) { ctx.beginPath(); ctx.moveTo(left, yMaxPixel); ctx.lineTo(right, yMaxPixel); ctx.stroke(); }
                if (refRange.min !== null) { ctx.beginPath(); ctx.moveTo(left, yMinPixel); ctx.lineTo(right, yMinPixel); ctx.stroke(); }
            }
            ctx.restore();
        });
    }
};

const extLatestLinePlugin = {
    id: 'latestLineAnnotation',
    beforeDatasetsDraw(chart, args, options) {
        const { ctx, chartArea: { top, bottom, left, right }, scales } = chart;
        const yScale = scales.y;
        if (!yScale) return;
        chart.data.datasets.forEach(dataset => {
            if (dataset.data.length > 0) {
                const lastDataPoint = dataset.data[dataset.data.length - 1];
                const yPixel = yScale.getPixelForValue(lastDataPoint.y);
                if (yPixel >= top && yPixel <= bottom) {
                    ctx.save();
                    ctx.strokeStyle = st.settings.graphLatestLineColor || '#ff0000';
                    ctx.lineWidth = st.settings.graphLatestLineWidth || 1;
                    ctx.setLineDash([6, 3]);
                    ctx.beginPath(); ctx.moveTo(left, yPixel); ctx.lineTo(right, yPixel); ctx.stroke();
                    ctx.restore();
                }
            }
        });
    }
};

const extValueLabelsPlugin = {
    id: 'valueLabels',
    afterDatasetsDraw(chart, args, options) {
        const { ctx } = chart;
        const meta = chart.getDatasetMeta(0);
        if (!meta.data.length) return;
        const datasetObj = chart.data.datasets[0];
        const dataset = datasetObj.data;
        const decimals = datasetObj.decimals !== undefined ? datasetObj.decimals : 2;
        let minIdx = 0, maxIdx = 0;
        dataset.forEach((p, i) => {
            if (p.y < dataset[minIdx].y) minIdx = i;
            if (p.y > dataset[maxIdx].y) maxIdx = i;
        });
        const points = [
            { label: 'åˆé …', idx: 0, color: '#6c757d' },
            { label: 'æœ«é …', idx: dataset.length - 1, color: st.settings.graphLatestLineColor || '#ff0000' },
            { label: 'æœ€å°', idx: minIdx, color: '#007bff' },
            { label: 'æœ€å¤§', idx: maxIdx, color: '#dc3545' }
        ];
        const uniquePoints = [];
        const seenIndices = new Set();
        points.forEach(p => {
            if (!seenIndices.has(p.idx)) { seenIndices.add(p.idx); uniquePoints.push({ ...p, labels: [p.label] }); }
            else { const existing = uniquePoints.find(up => up.idx === p.idx); if (existing) existing.labels.push(p.label); }
        });
        ctx.save(); ctx.font = 'bold 11px sans-serif';
        uniquePoints.forEach(({ labels, idx, color }) => {
            const point = dataset[idx];
            const model = meta.data[idx];
            if (!model) return;
            const text = `${labels.join('ãƒ»')}: ${point.y.toFixed(decimals)}`;
            const textMetrics = ctx.measureText(text);
            let rectX = model.x - textMetrics.width / 2 - 5, rectY = model.y - 22;
            if (rectX < chart.chartArea.left) rectX = chart.chartArea.left;
            if (rectX + textMetrics.width + 10 > chart.chartArea.right) rectX = chart.chartArea.right - textMetrics.width - 10;
            if (rectY < chart.chartArea.top) rectY = model.y + 8;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.85)'; ctx.fillRect(rectX, rectY, textMetrics.width + 10, 16);
            ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.strokeRect(rectX, rectY, textMetrics.width + 10, 16);
            ctx.fillStyle = color; ctx.textAlign = 'left'; ctx.textBaseline = 'middle'; ctx.fillText(text, rectX + 5, rectY + 8);
        });
        ctx.restore();
    }
};

// â–¼â–¼â–¼ è¿½åŠ : ç›¸é–¢ä¿‚æ•°è¨ˆç®—ãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function getCorrelations(x, y) {
  const n = x.length;
  if (n < 2) return null;

  // 1. Pearson (ç©ç‡ç›¸é–¢ä¿‚æ•°)
  const meanX = x.reduce((a, b) => a + b, 0) / n;
  const meanY = y.reduce((a, b) => a + b, 0) / n;
  let num = 0, denX = 0, denY = 0;
  for (let i = 0; i < n; i++) {
    const dx = x[i] - meanX;
    const dy = y[i] - meanY;
    num += dx * dy;
    denX += dx * dx;
    denY += dy * dy;
  }
  const pearson = (denX > 0 && denY > 0) ? num / Math.sqrt(denX * denY) : null;

  // ãƒ©ãƒ³ã‚¯ä»˜ã‘ãƒ˜ãƒ«ãƒ‘ãƒ¼
  const getRanks = (arr) => {
    const sorted = arr.map((v, i) => ({ v, i })).sort((a, b) => a.v - b.v);
    const ranks = new Array(n).fill(0);
    let i = 0;
    while (i < n) {
      let j = i;
      while (j < n - 1 && sorted[j].v === sorted[j + 1].v) j++;
      const rank = (i + j + 2) / 2;
      for (let k = i; k <= j; k++) ranks[sorted[k].i] = rank;
      i = j + 1;
    }
    return ranks;
  };

  // 2. Spearman (é †ä½ç›¸é–¢ä¿‚æ•°)
  const rankX = getRanks(x);
  const rankY = getRanks(y);
  const meanRX = rankX.reduce((a, b) => a + b, 0) / n;
  const meanRY = rankY.reduce((a, b) => a + b, 0) / n;
  let numS = 0, denRX = 0, denRY = 0;
  for (let i = 0; i < n; i++) {
    const dx = rankX[i] - meanRX;
    const dy = rankY[i] - meanRY;
    numS += dx * dy;
    denRX += dx * dx;
    denRY += dy * dy;
  }
  const spearman = (denRX > 0 && denRY > 0) ? numS / Math.sqrt(denRX * denRY) : null;

  // 3. Kendall (é †ä½ç›¸é–¢ä¿‚æ•° Tau-b)
  let concordant = 0, discordant = 0, tieX = 0, tieY = 0;
  for (let i = 0; i < n - 1; i++) {
    for (let j = i + 1; j < n; j++) {
      const dx = x[i] - x[j];
      const dy = y[i] - y[j];
      const sign = dx * dy;
      if (sign > 0) concordant++;
      else if (sign < 0) discordant++;
      if (dx === 0) tieX++;
      if (dy === 0) tieY++;
    }
  }
  const n0 = n * (n - 1) / 2;
  const denom = Math.sqrt((n0 - tieX) * (n0 - tieY));
  const kendall = denom > 0 ? (concordant - discordant) / denom : null;

  return { pearson, spearman, kendall, n };
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : ç§»å‹•å¹³å‡è¨ˆç®—ãƒ˜ãƒ«ãƒ‘ãƒ¼ â–¼â–¼â–¼
function calculateMovingAverage(data, period) {
  const maData = [];
  for (let i = 0; i < data.length; i++) {
    if (i < period - 1) continue;
    let sum = 0;
    for (let j = 0; j < period; j++) {
      sum += data[i - j].y;
    }
    maData.push({ x: data[i].x, y: sum / period });
  }
  return maData;
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

function renderExtCombinedGraph(resDiv, checks, dataByItem, limitDate, h) {
    const datasets = [];
    const yAxes = {};
    const maPeriod = parseInt(document.getElementById('ext-ma-period').value) || 3;
    let maMode;
    if (st.extGraphMode === 3) { // 'å‰å›å·®åˆ†'
        maMode = 'off';
    } else { // 0: 'é€šå¸¸', 1: 'ç§»å‹•å¹³å‡ã®ã¿', 2: 'æ•°å€¤è¡¨ç¤º'
        maMode = (st.extGraphMode === 1) ? 'only' : document.querySelector('input[name="ext-ma-mode"]:checked')?.value || 'on';
    }

    checks.forEach((item, idx) => {
        const ds = createExtDataset(item, dataByItem[item] || [], idx, limitDate);
        if (!ds) return;
        const axisId = 'y-' + (ds.unit || 'default');
        if (!yAxes[axisId]) {
            const isLeft = Object.keys(yAxes).length % 2 === 0;
            yAxes[axisId] = {
                type: 'linear', display: true, position: isLeft ? 'left' : 'right',
                title: { display: true, text: ds.unit },
                grid: {
                    drawOnChartArea: isLeft, // Only draw grid lines for the left axis
                    color: (ctx) => (ctx.tick.value === 0 && st.extGraphMode === 3) ? '#dc3545' : 'rgba(0,0,0,0.1)',
                    lineWidth: (ctx) => (ctx.tick.value === 0 && st.extGraphMode === 3) ? 2 : 1
                },
                beginAtZero: st.extGraphMode === 3
            };
        }
        ds.yAxisID = axisId;
        
        // 2ã¤ç›®ä»¥é™ã®è¦ç´ ã¯æ£’ã‚°ãƒ©ãƒ•ã«ã™ã‚‹
        if (idx > 0) {
            ds.type = 'bar';
            ds.order = 1; // ç·šã‚ˆã‚Šå¾Œã‚ã«æç”»ã•ã‚Œãªã„ã‚ˆã†ã«é †åºåˆ¶å¾¡ï¼ˆChart.jsã®ä»•æ§˜ã«ã‚ˆã‚‹ãŒã€é€šå¸¸ã¯ç·šãŒä¸Šï¼‰
        } else {
            ds.type = 'line';
            ds.order = 0;
        }
        
        if (maMode !== 'only') {
            datasets.push(ds);
        }

        // â–¼â–¼â–¼ ç§»å‹•å¹³å‡ç·šã®è¿½åŠ  â–¼â–¼â–¼
        if (maPeriod > 1 && maMode !== 'off') {
            const maData = calculateMovingAverage(ds.data, maPeriod);
            if (maData.length > 0) {
                datasets.push({
                    label: item + ` (MA${maPeriod})`,
                    data: maData,
                    borderColor: (maMode === 'only') ? ds.borderColor : (st.settings.graphMaLineColor || '#ff9800'),
                    borderWidth: st.settings.graphMaLineWidth || 2,
                    pointRadius: 0,
                    tension: 0.4,
                    yAxisID: axisId,
                    borderDash: (maMode === 'on') ? [5, 5] : [], // è¤‡åˆã‚°ãƒ©ãƒ•ã§ã¯ONã®æ™‚ã ã‘ç‚¹ç·šã«ã—ã¦åŒºåˆ¥
                    fill: false,
                    type: 'line' // ç§»å‹•å¹³å‡ã¯å¸¸ã«ç·š
                });
            }
        }
        // â–²â–²â–²
    });

    // â–¼â–¼â–¼ è¿½åŠ : ç›¸é–¢ä¿‚æ•°è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ â–¼â–¼â–¼
    let correlationHtml = '';
    if (checks.length >= 2) {
        const item1 = checks[0];
        const item2 = checks[1];
        
        // å…±é€šãƒ‡ãƒ¼ã‚¿æŠ½å‡º
        const data1 = st.extData.filter(d => d.item === item1);
        const data2 = st.extData.filter(d => d.item === item2);
        const map1 = new Map();
        data1.forEach(d => map1.set(d.date, d.val));
        
        const pairs = [];
        data2.forEach(d => {
            if (map1.has(d.date)) {
                // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
                if (limitDate && new Date(d.date) < limitDate) return;
                
                // æ•°å€¤å¤‰æ›
                const parseVal = (v) => { const m = String(v).match(/-?\d+(\.\d+)?/); return m ? parseFloat(m[0]) : NaN; };
                const v1 = parseVal(map1.get(d.date));
                const v2 = parseVal(d.val);
                
                if (!isNaN(v1) && !isNaN(v2)) pairs.push({ x: v1, y: v2 });
            }
        });
        
        if (pairs.length >= 3) { // æœ€ä½3ãƒ‡ãƒ¼ã‚¿ä»¥ä¸Šã§è¨ˆç®—
            const corrs = getCorrelations(pairs.map(p => p.x), pairs.map(p => p.y));
            if (corrs) {
                const fmt = (v) => v !== null ? v.toFixed(3) : '-';
                correlationHtml = `<div style="font-size:11px; background:#f8f9fa; padding:5px; border-bottom:1px solid #eee; margin-bottom:5px; line-height:1.4;">
                    <b>ç›¸é–¢åˆ†æ (${esc(item1)} vs ${esc(item2)}) [n=${corrs.n}]</b><br>
                    Pearson: <b>${fmt(corrs.pearson)}</b> | Spearman: <b>${fmt(corrs.spearman)}</b> | Kendall: <b>${fmt(corrs.kendall)}</b>
                  </div>`;
            }
        }
    }
    // â–²â–²â–² è¿½åŠ  â–²â–²â–²

    if (datasets.length === 0) { resDiv.innerHTML = '<div class="card">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }

    resDiv.innerHTML = `<div class="card" id="ext-chart-card-combined" style="padding:10px; cursor:pointer;">${correlationHtml}<div style="height:${h}px; position:relative;"><canvas id="extChart"></canvas></div></div><div style="text-align:center; margin-top:5px;"><button class="btn-sub" onclick="document.getElementById('ext-result').innerHTML=''; showNav();">é–‰ã˜ã‚‹</button></div>`;
    document.getElementById('ext-chart-card-combined').onclick = cycleGraphMode;
    const ctx = document.getElementById('extChart').getContext('2d');
    window.myExtCharts.push(new Chart(ctx, { type: 'line', data: { datasets }, options: getExtChartOptions(yAxes), plugins: [ChartDataLabels, extAnnotationPlugin] }));
}

function renderExtSingleGraph(resDiv, checks, dataByItem, limitDate, h) {
    let html = '';
    const validCharts = [];
    const maPeriod = parseInt(document.getElementById('ext-ma-period').value) || 3;
    let maMode;
    if (st.extGraphMode === 3) { // 'å‰å›å·®åˆ†'
        maMode = 'off';
    } else { // 0: 'é€šå¸¸', 1: 'ç§»å‹•å¹³å‡ã®ã¿', 2: 'æ•°å€¤è¡¨ç¤º'
        maMode = (st.extGraphMode === 1) ? 'only' : document.querySelector('input[name="ext-ma-mode"]:checked')?.value || 'on';
    }

    checks.forEach((item, idx) => {
        const ds = createExtDataset(item, dataByItem[item] || [], idx, limitDate);
        if (!ds) return;
        html += `<div class="card" id="ext-chart-card-${idx}" style="padding:10px; margin-bottom:10px; cursor:pointer;"><h3 style="font-size:14px; margin-bottom:5px;">${esc(item)} <span style="font-size:11px; font-weight:normal;">(åŸºæº–å€¤: ${esc(ds.ref || '-')})</span></h3><div style="height:${h}px; position:relative;"><canvas id="extChart-${idx}"></canvas></div></div>`;
        
        const chartDatasets = [];
        if (maMode !== 'only') {
            chartDatasets.push(ds);
        }
        // â–¼â–¼â–¼ ç§»å‹•å¹³å‡ç·šã®è¿½åŠ  â–¼â–¼â–¼
        if (maPeriod > 1 && maMode !== 'off') {
            const maData = calculateMovingAverage(ds.data, maPeriod);
            if (maData.length > 0) {
                chartDatasets.push({
                    label: `ç§»å‹•å¹³å‡ (${maPeriod})`,
                    data: maData,
                    borderColor: (maMode === 'only') ? ds.borderColor : (st.settings.graphMaLineColor || '#ff9800'),
                    borderWidth: st.settings.graphMaLineWidth || 2,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: false,
                    decimals: ds.decimals
                });
            }
        }
        // â–²â–²â–²
        validCharts.push({ idx, datasets: chartDatasets, unit: ds.unit });
    });

    if (validCharts.length === 0) { resDiv.innerHTML = '<div class="card">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }

    html += `<div style="text-align:center; margin-top:5px;"><button class="btn-sub" onclick="document.getElementById('ext-result').innerHTML=''; showNav();">é–‰ã˜ã‚‹</button></div>`;
    resDiv.innerHTML = html;

    validCharts.forEach(({ idx, datasets, unit }) => {
        document.getElementById(`ext-chart-card-${idx}`).onclick = cycleGraphMode;
        const ctx = document.getElementById(`extChart-${idx}`).getContext('2d');
        const yAxes = { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: unit }, grid: { color: (ctx) => (ctx.tick.value === 0 && st.extGraphMode === 3) ? '#dc3545' : 'rgba(0,0,0,0.1)', lineWidth: (ctx) => (ctx.tick.value === 0 && st.extGraphMode === 3) ? 2 : 1 }, beginAtZero: st.extGraphMode === 3 } };
        const plugins = [ChartDataLabels, extAnnotationPlugin, extLatestLinePlugin];
        if (st.extGraphMode === 0 || st.extGraphMode === 1) plugins.push(extValueLabelsPlugin);
        window.myExtCharts.push(new Chart(ctx, { type: 'line', data: { datasets: datasets }, options: getExtChartOptions(yAxes), plugins: plugins }));
    });
}

function renderExtGraph(forceRender = false) {
  const resDiv = document.getElementById('ext-result');
  if (!forceRender && (resDiv.querySelector('canvas') || resDiv.querySelector('svg'))) {
    resDiv.innerHTML = '';
    showNav();
    return;
  }

  const checks = st.extSelectedItems || []; // executeIntegratedAnalysisã§ã‚»ãƒƒãƒˆã•ã‚Œã‚‹
  if(checks.length === 0) {
    if (!forceRender) { alert('é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„'); }
    return;
  }

  // â˜…â˜…â˜… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„: ãƒ‡ãƒ¼ã‚¿ã‚’é …ç›®ã”ã¨ã«äº‹å‰ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ– â˜…â˜…â˜…
  const dataByItem = st.extData.reduce((acc, d) => {
      // é¸æŠã•ã‚Œã¦ã„ã‚‹é …ç›®ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
      if (checks.includes(d.item)) {
          if (!acc[d.item]) acc[d.item] = [];
          acc[d.item].push(d);
      }
      return acc;
  }, {});

  const nav = document.querySelector('.nav');
  if (nav) nav.style.display = 'none';

  const range = document.getElementById('ext-graph-range')?.value || 'all';
  let limitDate = null;
  if(range !== 'all') {
    limitDate = new Date();
    limitDate.setHours(0, 0, 0, 0);
    if(range === '1y') limitDate.setFullYear(limitDate.getFullYear() - 1);
    else if(range === '2y') limitDate.setFullYear(limitDate.getFullYear() - 2);
    else if(range === '3y') limitDate.setFullYear(limitDate.getFullYear() - 3);
  }

  const mode = document.querySelector('input[name="ext-graph-mode"]:checked')?.value || 'single';

  if (window.myExtCharts) window.myExtCharts.forEach(c => c && c.destroy());
  window.myExtCharts = [];
  if (window.myExtChart) { window.myExtChart.destroy(); window.myExtChart = null; }

  const h = st.settings.graphHeight || 360;

  if (mode === 'combined') {
      renderExtCombinedGraph(resDiv, checks, dataByItem, limitDate, h);
  } else {
      renderExtSingleGraph(resDiv, checks, dataByItem, limitDate, h);
  }

  setupNavReappear();
}

// â–¼â–¼â–¼ è¿½åŠ : ã‚°ãƒ©ãƒ•è¡¨ç¤ºæ™‚ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ç”¨é–¢æ•° â–¼â–¼â–¼
function showNav() {
  const nav = document.querySelector('.nav');
  if (nav && nav.style.display === 'none') {
    nav.style.display = 'grid';
    if (navHideTimer) {
      clearTimeout(navHideTimer);
      navHideTimer = null;
    }
    if (navScrollListener) {
      window.removeEventListener('scroll', navScrollListener);
      navScrollListener = null;
    }
  }
}

function setupNavReappear() {
  if (navScrollListener) window.removeEventListener('scroll', navScrollListener);
  if (navHideTimer) clearTimeout(navHideTimer);

  navScrollListener = () => {
    if (window.scrollY === 0) {
      showNav();
      return;
    }
    if (navHideTimer) clearTimeout(navHideTimer);
    navHideTimer = setTimeout(showNav, 60000); // 1åˆ†
  };
  window.addEventListener('scroll', navScrollListener);
  navHideTimer = setTimeout(showNav, 60000); // 1åˆ†
}

// ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
async function checkStorage() {
  const el = document.getElementById('storage-stats');
  if (!navigator.storage || !navigator.storage.estimate) {
    el.innerHTML = 'ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚';
    return;
  }
  el.innerHTML = 'è¨ˆç®—ä¸­...';
  try {
    const [est, persisted] = await Promise.all([
      navigator.storage.estimate(),
      navigator.storage.persisted ? navigator.storage.persisted() : Promise.resolve(false)
    ]);
    
    const toMB = (b) => (b / (1024 * 1024)).toFixed(2);
    const toGB = (b) => (b / (1024 * 1024 * 1024)).toFixed(2);
    
    const usageStr = toMB(est.usage) + ' MB';
    const quotaStr = est.quota > 1024*1024*1024 ? toGB(est.quota) + ' GB' : toMB(est.quota) + ' MB';
    const pStr = persisted ? '<span style="color:#28a745; font-weight:bold;">è¨±å¯æ¸ˆã¿ (ä¿è­·ä¸­)</span>' : '<span style="color:#dc3545; font-weight:bold;">æœªè¨±å¯ (è‡ªå‹•å‰Šé™¤ã®å¯èƒ½æ€§ã‚ã‚Š)</span>';

    el.innerHTML = `
      <div style="display:grid; grid-template-columns:100px 1fr; gap:5px;">
        <div>ä½¿ç”¨é‡:</div><div><b>${usageStr}</b></div>
        <div>ä¸Šé™(ç›®å®‰):</div><div><b>${quotaStr}</b></div>
        <div>æ°¸ç¶šåŒ–çŠ¶æ…‹:</div><div>${pStr}</div>
      </div>
      <button class="btn-sub" style="margin-top:10px;" onclick="checkStorage()">æƒ…å ±ã‚’æ›´æ–°</button>
    `;
  } catch (e) {
    el.innerHTML = 'æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e;
  }
}
async function reqPersist() {
  if (!navigator.storage || !navigator.storage.persist) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'); return; }
  const res = await navigator.storage.persist();
  if (res) {
    alert('æ°¸ç¶šåŒ–ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚\nã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¸è¶³æ™‚ã‚‚ãƒ‡ãƒ¼ã‚¿ã¯ä¿è­·ã•ã‚Œã¾ã™ã€‚');
  } else {
    alert('æ°¸ç¶šåŒ–ã¯è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n\nã€ãƒ’ãƒ³ãƒˆã€‘\nãƒ–ãƒ©ã‚¦ã‚¶ã®ä»•æ§˜ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®æ“ä½œã‚’è¡Œã†ã¨è¨±å¯ã•ã‚Œã‚„ã™ããªã‚Šã¾ã™ï¼š\nãƒ»ã‚¢ãƒ—ãƒªã‚’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã™ã‚‹\nãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã—ã¦é »ç¹ã«ä½¿ç”¨ã™ã‚‹\n\nâ€»è¨±å¯ã•ã‚Œãªãã¦ã‚‚ã€ç©ºãå®¹é‡ãŒååˆ†ã«ã‚ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚');
  }
  checkStorage();
}

// ãƒ‡ãƒ¼ã‚¿å–è¾¼ãƒ»æ•´ç†
async function importJSON(input) {
  if (!input.files || !input.files[0]) return;
  const file = input.files[0];
  input.disabled = true;
  document.body.style.cursor = 'wait';

  try {
    let content = '';
    if (file.name.toLowerCase().endsWith('.zip')) {
      if (!window.JSZip) throw new Error('JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      const zip = await JSZip.loadAsync(file);
      // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™ (éš ã—ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã¯é™¤å¤–)
      const jsonFile = Object.values(zip.files).find(f => !f.dir && f.name.toLowerCase().endsWith('.json') && !f.name.startsWith('__MACOSX'));
      if (!jsonFile) throw new Error('ZIPãƒ•ã‚¡ã‚¤ãƒ«å†…ã«JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      content = await jsonFile.async('string');
    } else {
      content = await file.text();
    }

    if (!content || !content.trim()) {
      throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™ã€‚æ­£ã—ã„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    }
    const json = JSON.parse(content);
    const mode = document.querySelector('input[name="json-import-mode"]:checked').value;

    let newCats = [];
    let newStock = [];
    let newSettings = null;
    let newExtFiles = [];

    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåˆ¤å®š
    if (json.format === 'full_backup' || (json.cats && Array.isArray(json.cats))) {
      // æ–°å½¢å¼ (ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
      newCats = json.cats || [];
      newStock = json.stock || [];
      newSettings = json.settings || null;
      newExtFiles = json.extFiles || [];
    } else if (Array.isArray(json)) {
      // æ—§å½¢å¼ (ã‚«ãƒ†ã‚´ãƒªãƒ¼é…åˆ—)
      newCats = json;
    } else if (json.id && json.name) {
      // æ—§å½¢å¼ (å˜ä½“ã‚«ãƒ†ã‚´ãƒªãƒ¼)
      newCats = [json];
    }

    if (mode === 'merge') {
      let addCat = 0, addRec = 0;
      newCats.forEach(src => {
        const dst = st.cats.find(c => c.id === src.id);
        if (dst) {
          // ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨è¨˜éŒ²ã‚’ãƒãƒ¼ã‚¸
          if (src.fields) {
            src.fields.forEach(sf => {
              if (!dst.fields.find(df => df.id === sf.id)) dst.fields.push(sf);
            });
          }
          // ãƒ«ãƒ¼ãƒ«ã®ãƒãƒ¼ã‚¸
          if (src.rules && Array.isArray(src.rules)) {
            if (!dst.rules) dst.rules = [];
            src.rules.forEach(r => {
              if (!dst.rules.includes(r)) dst.rules.push(r);
            });
          }
          if (src.records) {
            src.records.forEach(sr => {
              if (!dst.records.find(dr => dr.id === sr.id)) {
                dst.records.push(sr);
                addRec++;
              }
            });
            dst.records.sort((a, b) => getDt(b) - getDt(a));
          }
        } else {
          // ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã€ä¸¸ã”ã¨è¿½åŠ 
          st.cats.push(src);
          addCat++;
          if (src.records) addRec += src.records.length;
        }
      });
      
      // åœ¨åº«ã®ãƒãƒ¼ã‚¸
      if (newStock.length > 0) {
        if (!st.stock) st.stock = [];
        const existingNames = new Set(st.stock.map(s => s.name));
        newStock.forEach(s => {
          if (!existingNames.has(s.name)) {
            st.stock.push(s);
          }
        });
      }
      
      // è¨­å®šã®ãƒãƒ¼ã‚¸ (ãƒ•ã‚¡ã‚¤ãƒ«å´ã‚’å„ªå…ˆã—ã¦ä¸Šæ›¸ã)
      if (newSettings) {
        st.settings = { ...st.settings, ...newSettings };
        console.log('Settings merged.');
      }
      
      // å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ¼ã‚¸
      if (newExtFiles.length > 0) {
        if (!st.extFiles) st.extFiles = [];
        newExtFiles.forEach(nf => {
          const idx = st.extFiles.findIndex(ef => ef.name === nf.name);
          if (idx >= 0) st.extFiles[idx] = nf; // ä¸Šæ›¸ã
          else st.extFiles.push(nf);
        });
        saveExtData();
      }

      alert(`ãƒãƒ¼ã‚¸å®Œäº† (ã‚«ãƒ†ã‚´ãƒª+${addCat}, è¨˜éŒ²+${addRec})`);
    } else {
      if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å‰Šé™¤ã—ã¦ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
      st.cats = newCats;
      if (newStock.length > 0) st.stock = newStock;
      if (newSettings) st.settings = newSettings;
      if (newExtFiles.length > 0) {
        st.extFiles = newExtFiles;
        st.extCurrentIdx = -1;
        saveExtData();
      }
      alert("ä¸Šæ›¸ãå®Œäº†");
    }

    save(true);
    addIoLog('import', file.name, true);
    r();
    alert("å®Œäº†");
  } catch (err) {
    console.error(err);
    const errorDetails = `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${err.message}\nã‚¨ãƒ©ãƒ¼å: ${err.name}\n\nã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:\n${err.stack || 'N/A'}`;
    showCopyableError('ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã‚¨ãƒ©ãƒ¼', errorDetails);
  } finally {
    input.disabled = false;
    document.body.style.cursor = 'default';
    input.value = '';
  }
}
async function clean() {
  const ds = document.getElementById('cl-date').value;
  if (!ds) return;
  const target = new Date(ds);
  target.setHours(23, 59, 59, 999);
  const ts = getTS();
  const blob = new Blob([JSON.stringify({ format: 'full_backup', version: VERSION, cats: st.cats, stock: st.stock, settings: st.settings, extFiles: st.extFiles }, jsonJstReplacer, 2)], {type:'application/json'});
  const fname = `${VERSION}_${ts}_å…¨ä»¶è¡Œå‹•ãƒ­ã‚°.json`;
  const saved = await saveBlob(blob, fname);
  if (saved) addIoLog('export', fname, true);
  st.cats.forEach(c => c.records = c.records.filter(r => getDt(r) > target)); // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜å¾Œã«å‰Šé™¤
  save(); r(); alert('æ•´ç†å®Œäº†');
}

async function resetApp() {
  const input = prompt('ã€è­¦å‘Šã€‘\nã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚\n\nå®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€ŒåˆæœŸåŒ–ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
  if(input && input.trim() === 'åˆæœŸåŒ–') {
    const ts = getTS();
    const name = `${VERSION}_${ts}_action_all_backup.json`;
    const blob = new Blob([JSON.stringify({ format: 'full_backup', version: VERSION, cats: st.cats, stock: st.stock, settings: st.settings, extFiles: st.extFiles }, jsonJstReplacer, 2)], {type:'application/json'});
    const res = await saveBlob(blob, name);
    if(res === false) { alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸãŸã‚ã€åˆæœŸåŒ–ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚'); return; }
    
    await new Promise(resolve => setTimeout(resolve, 1000)); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾…ã¡
    await idb.clear();
    localStorage.removeItem(KEY);
    sessionStorage.setItem('reset_toast', 'true');
    location.reload();
  } else if (input !== null) {
    alert('å…¥åŠ›å†…å®¹ãŒä¸€è‡´ã—ãªã„ãŸã‚ã€åˆæœŸåŒ–ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚');
  }
}

(async function init() {
  let saved = null;
  window.myExtCharts = [];
  try {
    saved = await idb.get(KEY);
    // ç§»è¡Œå‡¦ç†: IDBã«ãªãLocalStorageã«ã‚ã‚‹å ´åˆ
    if (!saved) {
      const ls = localStorage.getItem(KEY);
      if (ls) {
        try {
          saved = JSON.parse(ls);
          await idb.set(KEY, saved);
        } catch (e) {
          console.error("LocalStorage data parse error:", e);
        }
      }
    }
  } catch(e) {
    alert('DB Error: ' + e);
  }
  if(saved) {
    st.cats = saved;
    // ãƒ­ã‚°èª­ã¿è¾¼ã¿
    try {
      const l = await idb.get(KEY_LOGS);
      if(l) st.ioLogs = l;
      const stk = await idb.get(KEY_STOCK);
      if(stk) st.stock = stk;
      const s = await idb.get(KEY_SETTINGS);
      if(s) st.settings = {...st.settings, ...s};
      applyTheme(); // ãƒ†ãƒ¼ãƒé©ç”¨
    } catch(e){}

    // â–¼â–¼â–¼ è¿½åŠ : ãƒ†ã‚­ã‚¹ãƒˆå€™è£œã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ç§»è¡Œ â–¼â–¼â–¼
    let migrated = false;
    st.cats.forEach(c => {
        if (c.fields) {
            c.fields.forEach(f => {
                if (f.type === 'text' && f.options && f.options.length > 0 && typeof f.options[0] === 'string') {
                    f.options = f.options.map(opt => ({ text: opt, ts: Date.now() }));
                    migrated = true;
                }
            });
        }
    });
    if (migrated) save(); // ç§»è¡ŒãŒè¡Œã‚ã‚ŒãŸå ´åˆã¯ä¿å­˜ã™ã‚‹
    // â–²â–²â–² è¿½åŠ  â–²â–²â–²

    // ãƒ‡ãƒ¼ã‚¿ä¿®å¾©: ä¸æ­£ãªé …ç›®å®šç¾©ã‚’è‡ªå‹•å‰Šé™¤
    st.cats.forEach(c => {
      if(Array.isArray(c.fields)) {
        c.fields = c.fields.filter(f => f && f.name);
      }
    });
    // ãƒ‡ãƒ¼ã‚¿çµ±åˆ: å‚ç…§(reference)ã‚’é¸æŠè‚¢(select)ã«å¤‰æ›
    st.cats.forEach(c => {
      if(c.fields) c.fields.forEach(f => {
        if(f.type === 'reference') {
          const ref = (c.refs||[]).find(r=>r.groupId===f.refId);
          f.type = 'select'; f.options = ref ? [...ref.items] : (f.options||[]); delete f.refId;
        }
      });
      delete c.refs; delete c.referenceTables;
    });
    // å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
      const savedExt = await idb.get(KEY_EXT);
      if (savedExt) {
        if (Array.isArray(savedExt) && savedExt.length > 0 && savedExt[0].data) {
           // æ–°å½¢å¼ (ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—)
           st.extFiles = savedExt;
           const savedIdx = await idb.get(KEY_EXT + '_idx');
           const idx = (savedIdx !== undefined && savedIdx !== null) ? savedIdx : 0;
           switchExtFile(idx);
           renderExtFileList();
        } else if (Array.isArray(savedExt)) {
           // æ—§å½¢å¼ (ãƒ‡ãƒ¼ã‚¿é…åˆ—ãã®ã‚‚ã®) -> 1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ç§»è¡Œ
           const fname = await idb.get(KEY_EXT + '_fname') || 'imported_data.csv';
           const fdate = await idb.get(KEY_EXT + '_fdate') || new Date().toISOString();
           const sel = await idb.get(KEY_EXT + '_sel') || [];
           st.extFiles = [{
              name: fname, date: fdate, data: savedExt, selectedItems: sel
           }];
           renderExtFileList();
        }
      }
    } catch(e) { console.error(e); }
  } else {
    st.cats = JSON.parse(JSON.stringify(DEFAULT_DATA));
    st.settings = { realtimeBackup: false, graphHeight: 360, graphLineColor: '#007bff', graphLineWidth: 3, graphMaLineColor: '#ff9800', graphMaLineWidth: 3, graphLatestLineColor: '#ff0000', graphLatestLineWidth: 1, graphDataFontSize: 10, graphAxisFontSize: 10, graphTitleFontSize: 14, graphMinLabelSpacing: 8, graphXAxisInterval: 'auto', waterTarget: 1500, imageMaxWidth: 800, imageQuality: 80, graphMarkerShow: true, graphMarkerSize: 4, searchHistory: [], searchNotHistory: [], searchHistoryCount: 5 };
    save();
    saveSettings();
  }
  if(st.cats.length>0) st.cur = st.cats[0].id;
  cancelCat(); // ãƒ‘ãƒ¬ãƒƒãƒˆåˆæœŸåŒ–
  r();

  // â–¼â–¼â–¼ ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®šã‚’è¿½åŠ  â–¼â–¼â–¼
  const deviceType = getDeviceType(); // 'pc', 'tablet', 'smartphone'
  document.body.classList.add('device-' + deviceType);
  // â–²â–²â–² ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®šã‚’è¿½åŠ  â–²â–²â–²

  if(sessionStorage.getItem('reset_toast')) {
    showToast('åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    sessionStorage.removeItem('reset_toast');
  }

  // â–¼â–¼â–¼ è¿½åŠ : ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š â–¼â–¼â–¼
  document.getElementById('main-nav').addEventListener('click', e => {
    if (e.target.dataset.view) {
      v(e.target.dataset.view);
    }
  });

  // â–¼â–¼â–¼ è¿½åŠ : å¸³ç°¿åœ¨åº«è‡ªå‹•è¨ˆç®—ãƒªã‚¹ãƒŠãƒ¼ (ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²) â–¼â–¼â–¼
  const formIn = document.getElementById('form-in');
  if (formIn) {
    const calcStockHandler = (e) => {
      if (st.view !== 'input') return;
      const c = st.cats.find(x => x.id === st.cur);
      if (!c) return;

      const fDrug = c.fields.find(f => f.name === 'è–¬å‰¤');
      const fType = c.fields.find(f => f.name === 'åœ¨åº«åŒºåˆ†');
      const fAmount = c.fields.find(f => f.name === 'ç™»éŒ²æ•°');
      const fStock = c.fields.find(f => f.name === 'å¸³ç°¿åœ¨åº«æ•°');

      if (!fDrug || !fType || !fAmount || !fStock) return;

      // å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ã®å…¥åŠ›ã‹åˆ¤å®š
      const t = e.target;
      const ids = [fDrug.id, fType.id, fAmount.id];
      let match = false;
      if (t.id && ids.some(id => t.id === 'i-' + id)) match = true;
      if (t.classList && ids.some(id => t.classList.contains('multi-' + id))) match = true;
      
      if (!match) return;

      // å€¤å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼
      const getVal = (fid) => {
        const el = document.getElementById('i-' + fid);
        if (el) return el.value;
        const multis = document.querySelectorAll('.multi-' + fid);
        if (multis.length > 0) return Array.from(multis).map(m => m.value.trim()).filter(v=>v).join(' ');
        return '';
      };

      const drugVal = getVal(fDrug.id);
      const typeVal = getVal(fType.id);
      const amountInput = getVal(fAmount.id);
      // æœªå…¥åŠ›ãªã‚‰0ã€å…¥åŠ›ãŒã‚ã‚Œã°çµ¶å¯¾å€¤ï¼ˆãƒã‚¤ãƒŠã‚¹å…¥åŠ›å¯¾ç­–ï¼‰
      const amountVal = amountInput === '' ? 0 : Math.abs(parseFloat(amountInput));

      if (!drugVal || !typeVal) return;

      const drugs = drugVal.split(/[\s,]+/).filter(d => d);
      const results = [];

      drugs.forEach(drugName => {
        let prevStock = null;
        for (const r of c.records) {
          if (st.editR && r.id === st.editR) continue;
          const rDrug = r[fDrug.id] || '';
          if (rDrug.includes(drugName)) {
            const rStockVal = r[fStock.id];
            if (rStockVal) {
              if (/^-?\d+(\.\d+)?$/.test(rStockVal)) {
                prevStock = parseFloat(rStockVal);
              } else {
                const escapedName = drugName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const match = rStockVal.match(new RegExp(`${escapedName}\\s*[:=]\\s*(-?\\d+(\\.\\d+)?)`));
                if (match) prevStock = parseFloat(match[1]);
              }
            }
            if (prevStock !== null) break;
          }
        }

        let newStock = 0;
        if (prevStock !== null) {
          if (typeVal === 'æ£šå¸') {
             // æ£šå¸ã§æœªå…¥åŠ›ã®å ´åˆã¯ç›´å‰å€¤ã‚’ç¶­æŒ
             newStock = (amountInput === '') ? prevStock : amountVal;
          }
          else if (typeVal === 'ä½¿ç”¨') newStock = prevStock - amountVal;
          else if (typeVal === 'è£œå……') newStock = prevStock + amountVal;
          else newStock = prevStock; // æƒ³å®šå¤–ã®åŒºåˆ†ãªã‚‰ç¶­æŒ
        } else {
          // ç›´å‰ãƒ‡ãƒ¼ã‚¿ãªã—
          if (typeVal === 'æ£šå¸') newStock = amountVal;
          else if (typeVal === 'ä½¿ç”¨') newStock = -amountVal; // 0ã‹ã‚‰æ¸›ç®—
          else if (typeVal === 'è£œå……') newStock = amountVal;
          else newStock = amountVal;
        }
        newStock = parseFloat(newStock.toFixed(6));
        results.push({ name: drugName, val: newStock });
      });

      const resStr = results.length === 1 ? results[0].val : results.map(r => `${r.name}:${r.val}`).join(' ');
      
      const elStock = document.getElementById('i-' + fStock.id);
      if (elStock) elStock.value = resStr;
      else { const ms = document.querySelectorAll('.multi-' + fStock.id); if(ms.length>0) ms[0].value = resStr; }
    };

    formIn.addEventListener('input', calcStockHandler);
    formIn.addEventListener('change', calcStockHandler);
    formIn.addEventListener('change', checkRules);
  }

  // â–¼â–¼â–¼ è¿½åŠ : å„ç¨®æœŸé–“æŒ‡å®šã®åˆæœŸå€¤è¨­å®š (å‰æœˆ1æ—¥ã€œå½“æ—¥) â–¼â–¼â–¼
  const datePairs = [
    {s: 'anlz-start-date', e: 'anlz-end-date'},
    {s: 'meal-start-date', e: 'meal-end-date'},
    {s: 'poop-start-date', e: 'poop-end-date'},
    {s: 'mylan-start-date', e: 'mylan-end-date'}
  ];
  
  const now = new Date();
  const start = new Date(now);
  start.setDate(1); start.setMonth(start.getMonth() - 1);
  
  const sStr = formatDateYMD(start);
  const eStr = formatDateYMD(now);

  datePairs.forEach(p => {
    const sEl = document.getElementById(p.s);
    const eEl = document.getElementById(p.e);
    if (sEl && !sEl.value) sEl.value = sStr;
    if (eEl && !eEl.value) eEl.value = eStr;
  });
  // â–²â–²â–² è¿½åŠ  â–²â–²â–²
})(); // init end

// â–¼â–¼â–¼ è¿½åŠ : ã‚¢ãƒ—ãƒªæ¦‚è¦è¡¨ç¤º â–¼â–¼â–¼
function showAppSummary() {
  const title = 'ã€Œè¡Œå‹•ãƒ­ã‚°ï¼–ï¼‘ï¼ã€ã®æ¦‚è¦';
  const content = `
    <p style="text-align:right; font-size:12px; color:#666;">æ—¥ä»˜ï¼š2025-12-28</p>
    <p>ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€Œè¡Œå‹•ãƒ­ã‚°ï¼–ï¼‘ï¼ã€ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã™ã‚‹å€‹äººç”¨ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ãƒ»åˆ†æãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ ã‚µãƒ¼ãƒãƒ¼ã‚’å¿…è¦ã¨ã›ãšã€HTMLãƒ•ã‚¡ã‚¤ãƒ«å˜ä½“ã§å‹•ä½œã—ã€ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆIndexedDBï¼‰ã«ä¿å­˜ã•ã‚Œã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
    
    <h4 style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:5px;">1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¦‚è¦</h4>
    <ul style="margin-left:20px; font-size:14px; line-height:1.6;">
      <li><strong>ç›®çš„:</strong> æ—¥ã€…ã®è¡Œå‹•ï¼ˆæ’æ³„ã€æ°´åˆ†è£œçµ¦ã€æœè–¬ãªã©ï¼‰ã®è¨˜éŒ²ã¨ã€å¥åº·çŠ¶æ…‹ã®å¯è¦–åŒ–ãƒ»åˆ†æã€‚</li>
      <li><strong>ç‰¹å¾´:</strong> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒãªãã¦ã‚‚å‹•ä½œã—ã€ãƒ‡ãƒ¼ã‚¿ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç«¯æœ«å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãŒå®ˆã‚‰ã‚Œã¾ã™ã€‚PCã€ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãã‚Œãã‚Œã®ç”»é¢ã‚µã‚¤ã‚ºã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</li>
    </ul>

    <h4 style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:5px;">2. ä¸»è¦æ©Ÿèƒ½ï¼ˆã‚¿ãƒ–æ§‹æˆï¼‰</h4>
    <div style="font-size:14px; line-height:1.6; margin-left:10px;">
      <h5>â‘  è¨˜éŒ² (Input)</h5>
      <p style="margin-left:1em;">æ—¥ã€…ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã™ã‚‹ãƒ¡ã‚¤ãƒ³ç”»é¢ã§ã™ã€‚ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ‡ã‚Šæ›¿ãˆã€ãƒ†ã‚­ã‚¹ãƒˆã€æ•°å€¤ã€é¸æŠè‚¢ã€æ—¥ä»˜ã€æ™‚åˆ»ã«åŠ ãˆã€<strong>ã‚«ãƒ¡ãƒ©æ’®å½±ï¼ˆç”»åƒæ·»ä»˜ï¼‰</strong>ã‚‚å¯èƒ½ã§ã™ã€‚å…¥åŠ›è£œåŠ©ã‚„åœ¨åº«é€£å‹•æ©Ÿèƒ½ã‚‚å‚™ã‚ã£ã¦ã„ã¾ã™ã€‚</p>
      <h5>â‘¡ æ¤œç´¢ (Search)</h5>
      <p style="margin-left:1em;">è“„ç©ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€æ—¥ä»˜ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§æ¤œç´¢ãƒ»é–²è¦§ã—ã¾ã™ã€‚</p>
      <h5>â‘¢ åˆ†æ (Analysis)</h5>
      <p style="margin-left:1em;">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ©ãƒ•ã‚„è¡¨ã§å¯è¦–åŒ–ã—ã¾ã™ã€‚å¤–éƒ¨CSVãƒ‡ãƒ¼ã‚¿ã®åˆ†æã‚„ã€æ’ä¾¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€æ’ä¾¿çŠ¶æ³ã‚°ãƒ©ãƒ•ã€ãƒã‚¤ãƒ©ãƒ³åˆ†æãªã©ã®å†…éƒ¨ãƒ‡ãƒ¼ã‚¿åˆ†æãŒå¯èƒ½ã§ã™ã€‚</p>
      <h5>â‘£ åœ¨åº« (Stock)</h5>
      <p style="margin-left:1em;">è–¬å‰¤ãªã©ã®åœ¨åº«ã‚’ç®¡ç†ã—ã¾ã™ã€‚æ®‹è–¬ãƒªã‚¹ãƒˆã®å°åˆ·ã€è¨˜éŒ²ã‹ã‚‰ã®è‡ªå‹•é›†è¨ˆã€CSVå‡ºåŠ›ã€è–¬å‰¤ãƒã‚¹ã‚¿ã®å–è¾¼ãŒã§ãã¾ã™ã€‚</p>
      <h5>â‘¤ ä¿å®ˆ (Maint)</h5>
      <p style="margin-left:1em;">ã‚¢ãƒ—ãƒªã®è¨­å®šã‚„ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚’è¡Œã„ã¾ã™ã€‚ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚„é …ç›®ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã€JSONã§ã®ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒã€ç”»åƒã®ä¸€æ‹¬å‡ºåŠ›ã€åœ¨åº«é€£æºã®è¨ºæ–­æ©Ÿèƒ½ãªã©ãŒã‚ã‚Šã¾ã™ã€‚</p>
    </div>

    <h4 style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:5px;">3. ç‰¹å¾´çš„ãªãƒ­ã‚¸ãƒƒã‚¯</h4>
    <ul style="margin-left:20px; font-size:14px; line-height:1.6;">
      <li><strong>å¸³ç°¿åœ¨åº«æ•°ã®è‡ªå‹•è¨ˆç®—:</strong> ã€Œåœ¨åº«åŒºåˆ†ï¼ˆä½¿ç”¨ãƒ»è£œå……ãƒ»æ£šå¸ï¼‰ã€ã¨ã€Œç™»éŒ²æ•°ã€ã‹ã‚‰ã€ç›´å‰ã®è¨˜éŒ²ã‚’åŸºã«åœ¨åº«æ•°ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚</li>
      <li><strong>IndexedDBã®åˆ©ç”¨:</strong> å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚„ç”»åƒã‚’æ‰±ã†ãŸã‚ã€ãƒ–ãƒ©ã‚¦ã‚¶å†…è”µã®é«˜æ€§èƒ½ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</li>
      <li><strong>å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ:</strong> HTML, CSS, JavaScriptãŒ1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±åˆã•ã‚Œã¦ãŠã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ã ã‘ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„ç§»è¡ŒãŒå®Œçµã—ã¾ã™ã€‚</li>
    </ul>

    <h4 style="margin-top:15px; border-bottom:1px solid #eee; padding-bottom:5px;">4. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯</h4>
    <ul style="margin-left:20px; font-size:14px; line-height:1.6;">
      <li><strong>è¨€èª:</strong> HTML5, CSS3, JavaScript (ES6+)</li>
      <li><strong>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª:</strong> Chart.js, chartjs-plugin-datalabels, JSZip</li>
      <li><strong>ãƒ‡ãƒ¼ã‚¿ä¿å­˜:</strong> IndexedDB (ãƒ–ãƒ©ã‚¦ã‚¶å†…è”µDB)</li>
    </ul>
    
    <p style="margin-top:15px;">ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ãŒä½¿ã„ã‚„ã™ã„ã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãªãŒã‚‰ã€é•·æœŸçš„ãªå¥åº·ç®¡ç†ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã‹ã¤è©³ç´°ã«è¨˜éŒ²ãƒ»åˆ†æã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
  `;

  document.getElementById('modal-title').innerText = title;
  document.getElementById('modal-body').innerHTML = content;
  document.getElementById('modal-overlay').style.display = 'flex';
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : åœ¨åº«é€£æºè¨ºæ–­æ©Ÿèƒ½ â–¼â–¼â–¼
function debugStockConfig() {
  const c = st.cats.find(x => x.id === st.cur);
  if (!c) { alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã€Œé …ç›®è¨­å®šã€ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); return; }
  
  const req = ['è–¬å‰¤', 'åœ¨åº«åŒºåˆ†', 'ç™»éŒ²æ•°', 'å¸³ç°¿åœ¨åº«æ•°'];
  const missing = req.filter(n => !c.fields.find(f => f.name === n));
  
  if (missing.length > 0) {
    alert(`ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘\nã‚«ãƒ†ã‚´ãƒªãƒ¼ã€Œ${c.name}ã€ã«ä»¥ä¸‹ã®é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:\n\n${missing.join(', ')}\n\nâ€»é …ç›®åã¯ä¸€å­—ä¸€å¥æ­£ç¢ºã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã®æœ‰ç„¡ãªã©ï¼‰ã€‚`);
    return;
  }

  const fType = c.fields.find(f => f.name === 'åœ¨åº«åŒºåˆ†');
  // Check options
  const opts = (fType.options || []).map(o => typeof o === 'string' ? o : o.text);
  const reqOpts = ['æ£šå¸', 'ä½¿ç”¨', 'è£œå……'];
  const missingOpts = reqOpts.filter(o => !opts.includes(o));
  
  if (missingOpts.length > 0) {
    alert(`ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘\nã€Œåœ¨åº«åŒºåˆ†ã€ã®é¸æŠè‚¢ã«ä»¥ä¸‹ãŒä¸è¶³ã—ã¦ã„ã¾ã™:\n\n${missingOpts.join(', ')}\n\nâ€»è‡ªå‹•è¨ˆç®—ã«ã¯ã“ã‚Œã‚‰ã®é¸æŠè‚¢ãŒå¿…é ˆã§ã™ã€‚`);
    return;
  }

  alert(`ã€OKã€‘\nã‚«ãƒ†ã‚´ãƒªãƒ¼ã€Œ${c.name}ã€ã®è¨­å®šã¯æ­£å¸¸ã§ã™ã€‚\n\nè¨˜éŒ²ç”»é¢ã§ã€Œè–¬å‰¤ã€ã€Œåœ¨åº«åŒºåˆ†ã€ã€Œç™»éŒ²æ•°ã€ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã€Œå¸³ç°¿åœ¨åº«æ•°ã€ãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚\n\nâ€»è¨ˆç®—ã•ã‚Œãªã„å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«(F12)ã‚’ç¢ºèªã™ã‚‹ã‹ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã¿ã¦ãã ã•ã„ã€‚`);
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : è‡ªå‹•å…¥åŠ›ãƒ«ãƒ¼ãƒ«æ©Ÿèƒ½ â–¼â–¼â–¼
function addRuleItem() {
  addListItem('cat-rules-container', 'cat-rule-new', 'loadRuleToBuilder');
}

// â–¼â–¼â–¼ è¿½åŠ : ãƒ«ãƒ¼ãƒ«ä½œæˆæ”¯æ´æ©Ÿèƒ½ â–¼â–¼â–¼
let rbFieldOptions = '';

function renderRuleBuilder(catId) {
  const cat = st.cats.find(c => c.id === catId);
  if (!cat) return;
  
  rbFieldOptions = (cat.fields || []).map(f => `<option value="${f.id}">${esc(f.name)}</option>`).join('');
  
  document.getElementById('rb-blocks-container').innerHTML = '';
  addRbBlock('IF');
}

function addRbBlock(type) {
  const container = document.getElementById('rb-blocks-container');
  const div = document.createElement('div');
  div.className = 'rb-block';
  div.style.cssText = "background:#fff; border:1px solid #ddd; padding:5px; border-radius:5px; margin-bottom:5px;";
  
  const label = type === 'IF' ? 'ã‚‚ã— (If)' : 'ãã†ã§ãªã ã‚‚ã— (Else If)';
  const delBtn = type === 'IF' ? '' : `<button class="btn-sub" style="background:#dc3545; padding:8px 12px; margin-left:auto;" onclick="this.closest('.rb-block').remove()">å‰Šé™¤</button>`;

  div.innerHTML = `
    <div class="d-flex align-center gap-1 mb-1" style="border-bottom:1px solid #eee; padding-bottom:5px;">
      <span style="font-size:12px; font-weight:bold; color:#0056b3;">${label}</span>
      ${delBtn}
    </div>
    <div class="rb-sub-block mb-1">
       <div class="d-flex align-center gap-1">
         <span style="font-size:11px; font-weight:bold; color:#555;">æ¡ä»¶</span>
         <button class="btn-sub" style="padding:0 6px; font-size:10px; background:#28a745;" onclick="addRbCondition(this)">ï¼‹</button>
       </div>
       <div class="rb-list rb-conditions-list"></div>
    </div>
    <div class="rb-sub-block">
       <div class="d-flex align-center gap-1">
         <span style="font-size:11px; font-weight:bold; color:#555;">çµæœ</span>
         <button class="btn-sub" style="padding:0 6px; font-size:10px; background:#28a745;" onclick="addRbResult(this)">ï¼‹</button>
       </div>
       <div class="rb-list rb-results-list"></div>
    </div>
  `;
  container.appendChild(div);
  
  addRbCondition(div.querySelector('.rb-conditions-list'));
  addRbResult(div.querySelector('.rb-results-list'));
}

function addRbCondition(target, defaultFid, defaultOp, defaultVal, defaultLogic) {
  let container;
  if (target instanceof HTMLElement) {
    if (target.classList.contains('rb-list')) container = target;
    else container = target.closest('.rb-sub-block').querySelector('.rb-list');
  } else return;

  const div = document.createElement('div');
  div.className = 'rb-row mt-1';
  div.style.cssText = "background:#fff; border:1px solid #eee; padding:8px; border-radius:5px; box-shadow:0 1px 2px rgba(0,0,0,0.05);";
  
  let logicHtml = '';
  if (container.children.length > 0) {
      logicHtml = `<select class="rb-logic" style="width:auto; padding:8px; font-size:12px; background:#f8f9fa; margin-right:5px; border:1px solid #ddd; border-radius:3px;"><option value="and">ã‹ã¤ (AND)</option><option value="or">ã¾ãŸã¯ (OR)</option></select>`;
  }

  div.innerHTML = `
    <div class="d-flex justify-between align-center mb-1">
       <div>${logicHtml}<span style="font-size:11px; font-weight:bold; color:#555;">æ¡ä»¶</span></div>
       <button class="btn-sub" style="background:#dc3545; padding:0 12px; height:30px; line-height:30px; font-size:16px;" onclick="this.closest('.rb-row').remove()">Ã—</button>
    </div>
    <div class="d-flex gap-1 mb-1" style="flex-wrap:wrap;">
      <select class="rb-field" style="flex:2; min-width:120px; padding:12px; border:1px solid #ddd; border-radius:4px;" onchange="updateRbRow(this)">${rbFieldOptions}</select>
      <select class="rb-op" style="flex:1; min-width:70px; padding:12px; border:1px solid #ddd; border-radius:4px;">
         <option value="=">ãŒ</option>
         <option value="!=">ä»¥å¤–</option>
         <option value=">=">ä»¥ä¸Š</option>
         <option value="<=">ä»¥ä¸‹</option>
         <option value=">">è¶…</option>
         <option value="<">æœªæº€</option>
      </select>
    </div>
    <div class="rb-val-container" style="width:100%;"></div>
  `;
  container.appendChild(div);
  if (defaultFid) div.querySelector('.rb-field').value = defaultFid;
  if (defaultOp) div.querySelector('.rb-op').value = defaultOp;
  if (defaultLogic && logicHtml) div.querySelector('.rb-logic').value = defaultLogic.toLowerCase();
  updateRbRow(div.querySelector('.rb-field'), defaultVal);
}

function addRbResult(target, defaultFid, defaultVal) {
  let container;
  if (target instanceof HTMLElement) {
    if (target.classList.contains('rb-list')) container = target;
    else container = target.closest('.rb-sub-block').querySelector('.rb-list');
  } else return;

  const div = document.createElement('div');
  div.className = 'rb-row mt-1';
  div.style.cssText = "background:#fff; border:1px solid #eee; padding:8px; border-radius:5px; box-shadow:0 1px 2px rgba(0,0,0,0.05);";

  const resultOptions = rbFieldOptions + 
    `<option value="__ALERT__" style="color:#dc3545;">âš ï¸ è­¦å‘Š (Alert)</option>` +
    `<option value="__TOAST__" style="color:#007bff;">ğŸ’¬ é€šçŸ¥ (Toast)</option>` +
    `<option value="__LOCK__" style="color:#6610f2;">ğŸ”’ ãƒ­ãƒƒã‚¯ (Lock)</option>` +
    `<option value="__UNLOCK__" style="color:#6610f2;">ğŸ”“ è§£é™¤ (Unlock)</option>`;

  div.innerHTML = `
    <div class="d-flex justify-between align-center mb-1">
       <span style="font-size:11px; font-weight:bold; color:#555;">çµæœ</span>
       <button class="btn-sub" style="background:#dc3545; padding:0 12px; height:30px; line-height:30px; font-size:16px;" onclick="this.closest('.rb-row').remove()">Ã—</button>
    </div>
    <div class="d-flex gap-1 align-center mb-1" style="flex-wrap:wrap;">
      <select class="rb-field" style="flex:1; min-width:120px; padding:12px; border:1px solid #ddd; border-radius:4px;" onchange="updateRbRow(this)">${resultOptions}</select>
      <span style="font-size:12px; white-space:nowrap;">ã‚’</span>
    </div>
    <div class="rb-val-container" style="width:100%;"></div>
    <div style="text-align:right; font-size:11px; margin-top:4px; color:#666;">ã«ã™ã‚‹</div>
  `;
  container.appendChild(div);
  if (defaultFid) div.querySelector('.rb-field').value = defaultFid;
  updateRbRow(div.querySelector('.rb-field'), defaultVal);
}

function updateRbRow(selectEl, initialVal = '') {
  const cat = st.cats.find(c => c.id === st.editCat);
  if (!cat) return;
  
  const row = selectEl.closest('.rb-row');
  const container = row.querySelector('.rb-val-container');
  const fieldId = selectEl.value;
  
  if (fieldId === '__LOCK__' || fieldId === '__UNLOCK__') {
    const nameOpts = cat.fields.map(f => `<option value="${esc(f.name)}">${esc(f.name)}</option>`).join('');
    container.innerHTML = `<select class="rb-val" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:4px;">${nameOpts}</select>`;
    if(initialVal) {
       const valSelect = container.querySelector('.rb-val');
       if(valSelect) valSelect.value = initialVal;
    }
    return;
  }

  if (fieldId.startsWith('__')) {
    container.innerHTML = `<input class="rb-val" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" value="${esc(initialVal)}" style="margin:0; padding:12px; width:100%; border:1px solid #ddd; border-radius:4px;">`;
    return;
  }

  const field = cat.fields.find(f => f.id === fieldId);
  
  if (field && (field.type === 'select' || (field.options && field.options.length > 0))) {
    let optsHtml = '';
    if (field.options) {
        optsHtml = field.options.map(o => {
            const t = typeof o === 'string' ? o : o.text;
            return `<option value="${esc(t)}">${esc(t)}</option>`;
        }).join('');
    }
    const listId = 'rb-list-' + Math.random().toString(36).substr(2, 9);
    container.innerHTML = `<div style="display:flex; gap:2px;">
      <input class="rb-val" list="${listId}" placeholder="å€¤ã‚’é¸æŠ/å…¥åŠ›" value="${esc(initialVal)}" style="margin:0; padding:12px; flex:1; border:1px solid #ddd; border-radius:4px;">
      <datalist id="${listId}">${optsHtml}</datalist>
      <button class="btn-sub" onclick="openAggBuilder(this.parentElement.querySelector('.rb-val'))" style="padding:0 10px; font-size:12px; background:#17a2b8; color:white;" title="é›†è¨ˆã‚¯ã‚¨ãƒªä½œæˆ">é›†è¨ˆ</button>
    </div>`;
  } else {
    container.innerHTML = `<div style="display:flex; gap:2px;">
      <input class="rb-val" placeholder="å€¤ã‚’å…¥åŠ›" value="${esc(initialVal)}" style="margin:0; padding:12px; flex:1; border:1px solid #ddd; border-radius:4px;">
      <button class="btn-sub" onclick="openAggBuilder(this.parentElement.querySelector('.rb-val'))" style="padding:0 10px; font-size:12px; background:#17a2b8; color:white;" title="é›†è¨ˆã‚¯ã‚¨ãƒªä½œæˆ">é›†è¨ˆ</button>
      <button class="btn-sub" onclick="this.parentElement.querySelector('.rb-val').value='EMPTY'" style="padding:0 10px; font-size:12px;" title="ç©º(æœªå…¥åŠ›)ã‚’æŒ‡å®š">ç©º</button>
    </div>`;
  }
}

function reflectRuleBuilder() {
  const cat = st.cats.find(c => c.id === st.editCat);
  if (!cat) return;

  const blocks = document.querySelectorAll('.rb-block');
  const ruleParts = [];

  blocks.forEach(block => {
    const condRows = block.querySelectorAll('.rb-conditions-list .rb-row');
    let condStr = "";
    condRows.forEach((row, idx) => {
      const fid = row.querySelector('.rb-field').value;
      const op = row.querySelector('.rb-op').value;
      const val = row.querySelector('.rb-val').value.trim();
      const logicEl = row.querySelector('.rb-logic');
      const logic = (idx > 0 && logicEl) ? logicEl.value : '';

      const f = cat.fields.find(x => x.id === fid);
      if (f) {
          if (idx > 0) condStr += ` ${logic} `;
          condStr += `[${f.name}] ${op} '${val}'`;
      }
    });

    const resRows = block.querySelectorAll('.rb-results-list .rb-row');
    const results = [];
    resRows.forEach(row => {
      const fid = row.querySelector('.rb-field').value;
      const val = row.querySelector('.rb-val').value.trim();
      if (fid === '__ALERT__') results.push(`[è­¦å‘Š] = '${val}'`);
      else if (fid === '__TOAST__') results.push(`[é€šçŸ¥] = '${val}'`);
      else if (fid === '__LOCK__') results.push(`[ãƒ­ãƒƒã‚¯] = '${val}'`);
      else if (fid === '__UNLOCK__') results.push(`[ãƒ­ãƒƒã‚¯è§£é™¤] = '${val}'`);
      else {
        const f = cat.fields.find(x => x.id === fid);
        if (f) results.push(`[${f.name}] = '${val}'`);
      }
    });

    if (condStr && results.length > 0) {
      ruleParts.push(`if ${condStr} then ${results.join(' ')}`);
    }
  });

  if (ruleParts.length === 0) {
    alert('æ¡ä»¶ã¨çµæœã‚’å°‘ãªãã¨ã‚‚1ã¤ãšã¤è¨­å®šã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  // 2ã¤ç›®ä»¥é™ã® "if" ã‚’ "else if" ã«ç½®æ›ã—ã¦çµåˆã™ã‚‹æ‰‹ã‚‚ã‚ã‚‹ãŒã€
  // å˜ç´”ã« join(' else ') ã§ã¤ãªãã¨ "if ... then ... else if ... then ..." ã«ãªã‚‹
  // æœ€åˆã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ "if ...", 2ã¤ç›®ã¯ "if ..." ãªã®ã§ã€join(' else ') ã™ã‚‹ã¨ "if ... else if ..." ã¨ãªã‚‹
  const ruleInput = document.getElementById('cat-rule-new');
  ruleInput.value = ruleParts.join(' else ');
  autoResize(ruleInput);
}

function loadRuleToBuilder(ruleStr) {
  const cat = st.cats.find(c => c.id === st.editCat);
  if (!cat) return;
  
  const findFieldId = (name) => {
      if (name === '__ALERT__' || name === '__TOAST__' || name === '__LOCK__' || name === '__UNLOCK__') return name;
      if (name === 'ALERT' || name === 'è­¦å‘Š') return '__ALERT__';
      if (name === 'TOAST' || name === 'é€šçŸ¥') return '__TOAST__';
      if (name === 'LOCK' || name === 'ãƒ­ãƒƒã‚¯') return '__LOCK__';
      if (name === 'UNLOCK' || name === 'ãƒ­ãƒƒã‚¯è§£é™¤') return '__UNLOCK__';
      const f = cat.fields.find(x => x.name === name);
      return f ? f.id : null;
  };
  
  // è§£æãƒ˜ãƒ«ãƒ‘ãƒ¼
  const parseSegment = (str, isResult) => {
      const items = [];
      let names = cat.fields.map(f => f.name);
      if (isResult) names = [...names, 'ALERT', 'è­¦å‘Š', 'TOAST', 'é€šçŸ¥', 'LOCK', 'ãƒ­ãƒƒã‚¯', 'UNLOCK', 'ãƒ­ãƒƒã‚¯è§£é™¤'];
      names.sort((a,b) => b.length - a.length);
      if (names.length === 0) return [];

      const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const pattern = new RegExp(names.map(n => escapeRegExp(n)).join('|'), 'g');
      const matches = [...str.matchAll(pattern)];
      
      matches.forEach((m, i) => {
          const name = m[0];
          const nextIndex = (i + 1 < matches.length) ? matches[i+1].index : str.length;
          let raw = str.substring(m.index + name.length, nextIndex);
          
          let op = '=';
          let val = raw;
          let logic = null;
          
          // æ¼”ç®—å­ã¨å€¤ã®åˆ†é›¢
          const opMatch = val.match(/^\s*(\]|ï¼‰)?\s*(=|!=|<>|>=|<=|>|<|is|ä»¥ä¸Š|ä»¥ä¸‹|è¶…|æœªæº€)\s*/i);
          if (opMatch && !isResult) {
              let detectedOp = opMatch[2];
              if (detectedOp.toLowerCase() === 'is') detectedOp = '=';
              if (detectedOp === '<>') detectedOp = '!=';
              if (detectedOp === 'ä»¥ä¸Š') detectedOp = '>=';
              if (detectedOp === 'ä»¥ä¸‹') detectedOp = '<=';
              if (detectedOp === 'è¶…') detectedOp = '>';
              if (detectedOp === 'æœªæº€') detectedOp = '<';
              op = detectedOp;
              val = val.substring(opMatch[0].length);
          } else {
              val = val.replace(/^\s*(\]|ï¼‰)?\s*(=)?\s*/, '');
          }
          
          // å€¤ã®æœ«å°¾ã«ã‚ã‚‹æ¬¡ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é–‹å§‹è¨˜å·ãªã©ã‚’å…ˆã«é™¤å»
          val = val.replace(/[\s,\[ï¼»ï¼ˆ]+$/, '');

          // å€¤ã®å¾Œã‚ã«ã‚ã‚‹ and/or ã‚’æ¤œå‡ºã—ã¦é™¤å»
          if (val.match(/\s+or$/i)) {
              logic = 'OR';
              val = val.replace(/\s+or$/i, '');
          } else if (val.match(/\s+and$/i)) {
              logic = 'AND';
              val = val.replace(/\s+and$/i, '');
          }

          // å€¤ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
          val = val.trim();
          // å¤šé‡ã‚¯ã‚©ãƒ¼ãƒˆã«å¯¾å¿œ (''å€¤'' -> å€¤)
          while ((val.startsWith("'") && val.endsWith("'") && val.length >= 2) || (val.startsWith('"') && val.endsWith('"') && val.length >= 2)) {
              val = val.substring(1, val.length - 1);
          }
          
          const fid = findFieldId(name);
          if (fid) items.push({ fid, op, val, logic });
      });
      return items;
  };

  document.getElementById('rb-blocks-container').innerHTML = '';

  // else if ã§åˆ†å‰²
  const blocks = ruleStr.split(/\s+else\s+if\s+/i);
  
  blocks.forEach((blockStr, idx) => {
    // å…ˆé ­ã® "if" ã‚’é™¤å»
    blockStr = blockStr.replace(/^\s*if\s+/i, '');
    
    const parts = blockStr.split(/\s+then\s+/i);
    if (parts.length < 2) return; // ä¸æ­£ãªãƒ–ãƒ­ãƒƒã‚¯ã¯ã‚¹ã‚­ãƒƒãƒ—

    const ifPart = parts[0].trim();
    const thenPart = parts.slice(1).join(' then ').trim();

    addRbBlock(idx === 0 ? 'IF' : 'ELSE IF');
    const blockDivs = document.querySelectorAll('.rb-block');
    const currentBlock = blockDivs[blockDivs.length - 1];
    
    // åˆæœŸè¿½åŠ ã•ã‚ŒãŸç©ºè¡Œã‚’å‰Šé™¤
    currentBlock.querySelector('.rb-conditions-list').innerHTML = '';
    currentBlock.querySelector('.rb-results-list').innerHTML = '';

    const conditions = parseSegment(ifPart, false);
    const results = parseSegment(thenPart, true);

    if (conditions.length > 0) {
        conditions.forEach((c, i) => {
            const prevLogic = (i > 0) ? conditions[i-1].logic : null;
            addRbCondition(currentBlock.querySelector('.rb-conditions-list'), c.fid, c.op, c.val, prevLogic);
        });
    } else {
        addRbCondition(currentBlock.querySelector('.rb-conditions-list'));
    }

    if (results.length > 0) results.forEach(r => addRbResult(currentBlock.querySelector('.rb-results-list'), r.fid, r.val));
    else addRbResult(currentBlock.querySelector('.rb-results-list'));
  });

  showToast('ãƒ«ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ€ãƒ¼ã«ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

function checkRules(e) {
  if (st.view !== 'input') return;
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ã‚ˆã‚‹å¤‰æ›´ã®å ´åˆã€ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ«ãƒ¼ãƒ«é©ç”¨ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
  if (e.isTrusted && e.target.dataset.ruleActive) {
      delete e.target.dataset.ruleActive;
      delete e.target.dataset.originalValue;
  }

  const c = st.cats.find(x => x.id === st.cur);
  if (!c || !c.rules || c.rules.length === 0) return;

  let changedFieldId = null;
  if (e.target.id && e.target.id.startsWith('i-')) {
    changedFieldId = e.target.id.substring(2);
  } else {
     c.fields.forEach(f => {
       if (e.target.classList.contains('multi-' + f.id)) changedFieldId = f.id;
     });
  }
  
  if (!changedFieldId) return;
  const changedField = c.fields.find(f => f.id === changedFieldId);
  if (!changedField) return;

  const currentVal = e.target.value.trim();
  console.log(`[RuleCheck] Field: ${changedField.name}, Value: '${currentVal}'`);
  c.rules.forEach((rule, idx) => applyRule(c, rule, changedField, currentVal, idx));
}

// â–¼â–¼â–¼ è¿½åŠ : é›†è¨ˆãƒ»ã‚µãƒ–ã‚¯ã‚¨ãƒªæ©Ÿèƒ½ â–¼â–¼â–¼
function formatDateStr(fmt, d) {
  const y = d.getFullYear();
  const m = d.getMonth() + 1;
  const dd = d.getDate();
  const h = d.getHours();
  const mi = d.getMinutes();
  const s = d.getSeconds();
  return fmt.replace(/yyyy/gi, y)
            .replace(/mm/gi, String(m).padStart(2,'0'))
            .replace(/dd/gi, String(dd).padStart(2,'0'))
            .replace(/hh/gi, String(h).padStart(2,'0'))
            .replace(/mi/gi, String(mi).padStart(2,'0'))
            .replace(/ss/gi, String(s).padStart(2,'0'));
}

function resolveSubQueries(text, currentCat) {
  // 1. Quoted queries (e.g. 'select ...') - allows ) inside where clause
  text = text.replace(/(['"])(select\s+(sum|count|avg|max|min)\s*\(\s*\[?(.+?)\]?\s*\)\s+from\s+\[?(.+?)\]?(?:\s+where\s+(.+?))?)\1/gi, 
    (match, quote, query, func, fieldName, catName, whereClause) => {
      // æ‹¬å¼§ã®ä¸æ•´åˆã‚’ä¿®æ­£ (æœ«å°¾ã®ä½™åˆ†ãªé–‰ã˜æ‹¬å¼§ã‚’é™¤å»)
      if (whereClause) {
        const open = (whereClause.match(/\(/g) || []).length;
        const close = (whereClause.match(/\)/g) || []).length;
        if (close > open) {
          let diff = close - open;
          while (diff > 0 && whereClause.trim().endsWith(')')) {
            whereClause = whereClause.trim().slice(0, -1);
            diff--;
          }
        }
      }
      const val = evaluateAggregation(func, fieldName, catName, whereClause, currentCat);
      return val;
  });

  // 2. Unquoted queries - stricter lookahead to avoid consuming closing parens of wrapper
  const pattern = /select\s+(sum|count|avg|max|min)\s*\(\s*\[?(.+?)\]?\s*\)\s+from\s+\[?(.+?)\]?(?:\s+where\s+(.+?))?(?=\s*(?:$|[)\],=><!&|]))/gi;
  return text.replace(pattern, (match, func, fieldName, catName, whereClause) => {
    return evaluateAggregation(func, fieldName, catName, whereClause, currentCat);
  });
}

function evaluateAggregation(func, fieldName, catName, whereClause, currentCat) {
  const targetCat = st.cats.find(c => c.name === catName || c.id === catName);
  if (!targetCat) return 0;

  let targetField = null;
  if (fieldName !== '*') {
    targetField = targetCat.fields.find(f => f.name === fieldName || f.id === fieldName);
    if (!targetField && func.toLowerCase() !== 'count') return 0;
  }

  let records = targetCat.records;
  if (whereClause) {
    records = records.filter(r => evaluateWhereClause(r, targetCat, whereClause, currentCat));
  }

  if (func.toLowerCase() === 'count') return records.length;

  const values = [];
  records.forEach(r => {
    const val = r[targetField.id];
    if (val !== undefined && val !== null && val !== '') {
       let s = String(val).replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/,/g, '');
       const match = s.match(/-?\d+(\.\d+)?/);
       if (match) {
         const num = parseFloat(match[0]);
         if (!isNaN(num)) values.push(num);
       }
    }
  });

  if (values.length === 0) return 0;

  switch (func.toLowerCase()) {
    case 'sum': return values.reduce((a, b) => a + b, 0);
    case 'avg': return values.reduce((a, b) => a + b, 0) / values.length;
    case 'max': return Math.max(...values);
    case 'min': return Math.min(...values);
  }
  return 0;
}

function evaluateWhereClause(record, targetCat, condition, currentCat) {
  let evalStr = condition;
  // Remove [Category] prefix if present (e.g. [é£²æ°´] æ—¥ä»˜ -> æ—¥ä»˜)
  evalStr = evalStr.replace(new RegExp('\\[?' + targetCat.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\]?\\s*', 'gi'), '');

  // 1. Keywords replacement
  evalStr = evalStr.replace(/now\s*\(\)/gi, "'" + toJSTISOString(new Date()) + "'");
  evalStr = evalStr.replace(/today\s*\(\)/gi, "'" + toJSTISOString(new Date()).split('T')[0] + "'");

  // 2. Fields replacement
  targetCat.fields.forEach(f => {
      const pattern = new RegExp(`\\[${f.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]`, 'g');
      evalStr = evalStr.replace(pattern, () => { const v = record[f.id]; return v ? `'${String(v).replace(/'/g, "\\'")}'` : "''"; });
  });
  evalStr = evalStr.replace(/\[?(dt|date|æ—¥ä»˜)\]?/gi, "'" + toJSTISOString(getDt(record)) + "'");

  if (currentCat) {
      currentCat.fields.forEach(f => {
          const pattern = new RegExp(`\\[${f.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]`, 'g');
          if (evalStr.match(pattern)) {
             const el = document.getElementById('i-' + f.id);
             let val = el ? el.value : '';
             if (!el) { const ms = document.querySelectorAll('.multi-' + f.id); if (ms.length > 0) val = Array.from(ms).map(m => m.value.trim()).filter(v=>v).join(' '); }
             evalStr = evalStr.replace(pattern, `'${val.replace(/'/g, "\\'")}'`);
          }
      });
  }

  // 3. Format function (after fields are resolved to strings)
  const getDateObj = (expr) => {
      let v = expr.trim();
      if ((v.startsWith("'") && v.endsWith("'")) || (v.startsWith('"') && v.endsWith('"'))) v = v.slice(1, -1);
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
  };
  evalStr = evalStr.replace(/format\s*\(([^,]+),\s*((?:'[^']*'|"[^"]*"|[^)])+)\)/gi, (_, fmt, valExpr) => {
      const d = getDateObj(valExpr);
      return d ? "'" + formatDateStr(fmt.trim(), d) + "'" : "''";
  });

  evalStr = evalStr.replace(/(^|[^=<>!])=([^=]|$)/g, '$1==$2').replace(/\s+<>\s+/g, ' != ').replace(/\s+and\s+/gi, ' && ').replace(/\s+or\s+/gi, ' || ');
  try { return new Function('number','int','float','str', 'return ' + evalStr)(Number, parseInt, parseFloat, String); } catch (e) {
    console.warn('Rule condition eval error:', e, '\nOriginal:', condition, '\nEval:', evalStr);
    return false;
  }
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// ãƒ«ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã®è§£æã¨å®Ÿè¡Œã‚’è¡Œã†ãƒ˜ãƒ«ãƒ‘ãƒ¼
function parseAndExecuteRuleBlock(cat, blockStr, triggerField, triggerVal, ruleIndex) {
  // 0. ã‚µãƒ–ã‚¯ã‚¨ãƒª(é›†è¨ˆ)ã®è§£æ±º
  blockStr = resolveSubQueries(blockStr, cat);

  // 1. then ã§æ¡ä»¶éƒ¨ã¨å®Ÿè¡Œéƒ¨ã«åˆ†å‰²
  const thenMatch = blockStr.match(/\s+then\s+/i);
  if (!thenMatch) return false;
  
  const ifPart = blockStr.substring(0, thenMatch.index).trim();
  const thenPart = blockStr.substring(thenMatch.index + thenMatch[0].length).trim();

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼: å€¤ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
  const cleanRuleValue = (s) => {
    let v = s.trim();
    v = v.replace(/^[=ï¼:ï¼š\->â†’\sã€€\]ï¼½)ï¼‰}ï½]+|[=ï¼:ï¼š\->â†’\sã€€,\[ï¼»(ï¼ˆ{ï½›]+$/g, '');
    const quoteMatch = v.match(/^(['"])(.*)\1$/);
    if (quoteMatch) v = quoteMatch[2];
    else v = v.replace(/^\[(.*)\]$/, '$1').replace(/^ã€Œ(.*)ã€$/, '$1').replace(/^ã€(.*)ã€$/, '$1');
    if (v.toUpperCase() === 'EMPTY' || v.toUpperCase() === 'NULL' || v === 'ç©º' || v === 'æœªå…¥åŠ›') return '';
    return v;
  };

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤å–å¾—
  const getFieldValue = (fid) => {
    const el = document.getElementById('i-' + fid);
    if (el) return el.value;
    const multis = document.querySelectorAll('.multi-' + fid);
    if (multis.length > 0) return Array.from(multis).map(m => m.value.trim()).filter(v=>v).join(' ');
    return '';
  };

  // 2. æ¡ä»¶éƒ¨ã®è©•ä¾¡
  // æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«é€€é¿
  const stringLiterals = [];
  let evalStr = ifPart.replace(/(['"])(.*?)\1/g, (match) => {
      stringLiterals.push(match);
      return `__STR_${stringLiterals.length - 1}__`;
  });

  // æ‹¬å¼§ã‚’ä¸€æ™‚çš„ãªãƒˆãƒ¼ã‚¯ãƒ³ã«é€€é¿ (æ­£è¦è¡¨ç¾ã§ã®èª¤æ¤œçŸ¥é˜²æ­¢)
  const LPAREN = '__LPAREN__';
  const RPAREN = '__RPAREN__';
  evalStr = evalStr.replace(/\(/g, ` ${LPAREN} `).replace(/\)/g, ` ${RPAREN} `);

  // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãƒªã‚¹ãƒˆ (é•·ã„é †)
  const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const fieldNames = cat.fields.map(f => f.name).sort((a, b) => b.length - a.length);
  if (fieldNames.length === 0) return false;
  
  const fieldPattern = fieldNames.map(n => escapeRegExp(n)).join('|');
  const opPattern = "(?:>=|=>|<=|=<|!=|<>|>|<|=|is|ä»¥ä¸Š|ä»¥ä¸‹|è¶…|æœªæº€)";

  // æ¡ä»¶å¼ç½®æ›: [Field] op Val -> true/false
  // Valã®çµ‚ç«¯ã¯ AND, OR, ), RPAREN, è¡Œæœ«
  const condRegex = new RegExp(`(\\[?(?:${fieldPattern})\\]?)\\s*(${opPattern})?\\s*((?:(?!\\s+(?:and|or)\\s+|\\)|${RPAREN}).)*)`, 'gi');

  evalStr = evalStr.replace(condRegex, (match, fNameRaw, opRaw, valRaw) => {
      let fName = fNameRaw.replace(/^\[|\]$/g, '');
      let field = cat.fields.find(f => f.name === fName);
      if (!field) return 'false';

      let op = opRaw || '=';
      let val = valRaw.trim();
      
      // å€¤ã®å¾©å…ƒ
      val = val.replace(/__STR_(\d+)__/g, (_, idx) => {
          const s = stringLiterals[parseInt(idx)];
          return s.substring(1, s.length - 1); // ã‚¯ã‚©ãƒ¼ãƒˆé™¤å»
      });
      // ã‚¯ã‚©ãƒ¼ãƒˆãªã—ã®å ´åˆã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
      if (!valRaw.includes('__STR_')) val = cleanRuleValue(val);

      // æ¼”ç®—å­æ­£è¦åŒ–
      if (op.match(/(>=|=>|ä»¥ä¸Š)/)) op = '>=';
      else if (op.match(/(<=|=<|ä»¥ä¸‹)/)) op = '<=';
      else if (op.match(/(>|è¶…)/)) op = '>';
      else if (op.match(/(<|æœªæº€)/)) op = '<';
      else if (op.match(/(!=|<>)/)) op = '!=';
      else op = '=';

      // è©•ä¾¡
      const rawTriggerVal = (triggerField && field.id === triggerField.id) ? triggerVal : getFieldValue(field.id);
      const currentVal = String(rawTriggerVal).trim();
      
      const nCurr = parseFloat(currentVal);
      const nCond = parseFloat(val);
      const isNum = !isNaN(nCurr) && !isNaN(nCond) && currentVal !== '' && val !== '';

      // æ­£è¦åŒ–æ¯”è¼ƒç”¨ (å…¨è§’åŠè§’ãƒ»å¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–)
      const norm = (s) => String(s).replace(/[ï¼-ï½]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0)).toLowerCase().trim();

      let res = false;
      switch (op) {
          case '>=': res = isNum ? nCurr >= nCond : currentVal >= val; break;
          case '<=': res = isNum ? nCurr <= nCond : currentVal <= val; break;
          case '>': res = isNum ? nCurr > nCond : currentVal > val; break;
          case '<': res = isNum ? nCurr < nCond : currentVal < val; break;
          case '!=': res = (currentVal != val) && (norm(currentVal) != norm(val)); break;
          default: res = (currentVal == val) || (norm(currentVal) == norm(val)); break;
      }
      return res ? 'true' : 'false';
  });

  // è«–ç†æ¼”ç®—å­ç½®æ›
  evalStr = evalStr.replace(/\s+and\s+/gi, ' && ').replace(/\s+or\s+/gi, ' || ');

  // æ‹¬å¼§ã‚’å¾©å…ƒ
  evalStr = evalStr.replace(new RegExp(LPAREN, 'g'), '(').replace(new RegExp(RPAREN, 'g'), ')');

  // å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ & è©•ä¾¡
  if (/[^truefals\s&|()]/.test(evalStr)) {
      console.warn('Rule syntax error (unsafe chars):', evalStr);
      return false;
  }

  try {
      const result = new Function('return ' + evalStr)();
      if (!result) return false;
  } catch (e) {
      console.warn('Rule eval error:', e);
      return false;
  }

  // 3. å®Ÿè¡Œéƒ¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  const actionLiterals = [];
  let actionStr = thenPart.replace(/(['"])(.*?)\1/g, (match) => {
      actionLiterals.push(match);
      return `__STR_${actionLiterals.length - 1}__`;
  });

  const specialKeywords = ['ALERT', 'è­¦å‘Š', 'TOAST', 'é€šçŸ¥', 'LOCK', 'ãƒ­ãƒƒã‚¯', 'UNLOCK', 'ãƒ­ãƒƒã‚¯è§£é™¤'];
  const actionTargets = [...fieldNames, ...specialKeywords].sort((a,b)=>b.length-a.length);
  const targetPattern = actionTargets.map(n => escapeRegExp(n)).join('|');
  
  const actionRegex = new RegExp(`(\\[?(?:${targetPattern})\\]?)\\s*=\\s*((?:(?!\\[?(?:${targetPattern})\\]?\\s*=).)*)`, 'gi');

  let match;
  while ((match = actionRegex.exec(actionStr)) !== null) {
      let targetName = match[1].replace(/^\[|\]$/g, '');
      let valRaw = match[2].trim();
      
      // 1. è‡ªç”»é¢ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã‚’ç½®æ›
      cat.fields.forEach(f => {
          const fNameEsc = f.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const pattern = new RegExp(`\\[${fNameEsc}\\]`, 'g');
          if (valRaw.match(pattern)) {
             const v = getFieldValue(f.id);
             valRaw = valRaw.replace(pattern, `'${String(v).replace(/'/g, "\\'")}'`);
          }
      });

      // 2. ãƒªãƒ†ãƒ©ãƒ«å¾©å…ƒ
      let valExpanded = valRaw.replace(/__STR_(\d+)__/g, (_, idx) => {
          const s = actionLiterals[parseInt(idx)];
          return s; // ã‚¯ã‚©ãƒ¼ãƒˆä»˜ãã®ã¾ã¾æˆ»ã™
      });

      // 3. å¼ã¨ã—ã¦è©•ä¾¡
      let val;
      try {
          // æ•°å€¤å¤‰æ›ãƒ˜ãƒ«ãƒ‘ãƒ¼ (å˜ä½ä»˜ãæ–‡å­—åˆ—ãªã©ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡º)
          const smartNum = (v) => {
             if(typeof v === 'number') return v;
             if(!v) return 0;
             const s = String(v).replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0)).replace(/,/g, '');
             const m = s.match(/-?\d+(\.\d+)?/);
             return m ? parseFloat(m[0]) : 0;
          };
          val = new Function('number','int','float','str', 'return ' + valExpanded)(smartNum, parseInt, parseFloat, String);
      } catch (e) {
          val = valExpanded; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
          // æ—¢å­˜ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‡¦ç†
          val = val.replace(/^[=ï¼:ï¼š\->â†’\sã€€\]ï¼½)ï¼‰}ï½]+|[=ï¼:ï¼š\->â†’\sã€€,\[ï¼»(ï¼ˆ{ï½›]+$/g, '');
          const quoteMatch = val.match(/^(['"])(.*)\1$/);
          if (quoteMatch) val = quoteMatch[2];
          else val = val.replace(/^\[(.*)\]$/, '$1').replace(/^ã€Œ(.*)ã€$/, '$1').replace(/^ã€(.*)ã€$/, '$1');
          if (val.toUpperCase() === 'EMPTY' || val.toUpperCase() === 'NULL' || val === 'ç©º' || val === 'æœªå…¥åŠ›') val = '';
      }

      const isAlert = (targetName === 'ALERT' || targetName === 'è­¦å‘Š');
      const isToast = (targetName === 'TOAST' || targetName === 'é€šçŸ¥');
      const isLock = (targetName === 'LOCK' || targetName === 'ãƒ­ãƒƒã‚¯');
      const isUnlock = (targetName === 'UNLOCK' || targetName === 'ãƒ­ãƒƒã‚¯è§£é™¤');
      const targetField = cat.fields.find(f => f.name === targetName);

      if (isAlert) alert(val);
      else if (isToast) showToast(val);
      else if (isLock || isUnlock) {
          const fToLock = cat.fields.find(f => f.name === val);
          if (fToLock) {
              const el = document.getElementById('i-' + fToLock.id);
              if (el) {
                  el.disabled = isLock;
                  el.style.backgroundColor = isLock ? '#e9ecef' : '';
              } else {
                  const multis = document.querySelectorAll('.multi-' + fToLock.id);
                  multis.forEach(m => { m.disabled = isLock; m.style.backgroundColor = isLock ? '#e9ecef' : ''; });
                  const box = document.getElementById('box-' + fToLock.id);
                  if (box) {
                      const btns = box.parentElement.querySelectorAll('button');
                      btns.forEach(b => b.disabled = isLock);
                  }
              }
          }
      }
      else if (targetField) {
          const targetEl = document.getElementById('i-' + targetField.id);
          let changed = false;
          if (targetEl) {
              // ãƒ«ãƒ¼ãƒ«é©ç”¨çŠ¶æ…‹ã®ä¿å­˜
              if (ruleIndex !== undefined) {
                  if (!targetEl.dataset.ruleActive) {
                      targetEl.dataset.originalValue = targetEl.value;
                  }
                  targetEl.dataset.ruleActive = ruleIndex;
              }
              const cur = targetEl.value;
              targetEl.value = val;
              if (targetEl.value !== cur) {
                  targetEl.dispatchEvent(new Event('change', {bubbles: true}));
                  targetEl.classList.remove('highlight-change');
                  void targetEl.offsetWidth;
                  targetEl.classList.add('highlight-change');
                  changed = true;

                  // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
                  if (targetField.type === 'select') {
                      const grp = document.getElementById('sel-grp-' + targetField.id);
                      if (grp) {
                          grp.querySelectorAll('.option-btn').forEach(b => {
                              const isSel = (b.innerText === targetEl.value);
                              b.style.background = isSel ? '#007bff' : '#fff';
                              b.style.color = isSel ? '#fff' : '#333';
                          });
                      }
                  }
              }
          } else {
              const multis = document.querySelectorAll('.multi-' + targetField.id);
              if (multis.length > 0) {
                  // ãƒ«ãƒ¼ãƒ«é©ç”¨çŠ¶æ…‹ã®ä¿å­˜
                  if (ruleIndex !== undefined) {
                      if (!multis[0].dataset.ruleActive) {
                          multis[0].dataset.originalValue = multis[0].value;
                      }
                      multis[0].dataset.ruleActive = ruleIndex;
                  }
                  const cur = multis[0].value;
                  multis[0].value = val;
                  if (multis[0].value !== cur) {
                      multis[0].dispatchEvent(new Event('change', {bubbles: true}));
                      multis[0].classList.remove('highlight-change');
                      void multis[0].offsetWidth;
                      multis[0].classList.add('highlight-change');
                      changed = true;
                  }
              }
          }
          if (changed) showToast(`ãƒ«ãƒ¼ãƒ«é©ç”¨: ${targetField.name} â†’ ${val}`);
      }
  }

  return true; // å®Ÿè¡Œå®Œäº†
}

function applyRule(cat, rule, triggerField, triggerVal, ruleIndex) {
  // 0. ãƒˆãƒªã‚¬ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãƒ«ãƒ¼ãƒ«å…¨ä½“ã«å«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ— (ç°¡æ˜“ãƒã‚§ãƒƒã‚¯)
  if (!rule.includes(`[${triggerField.name}]`)) return;
  
  // 1. else if ã§åˆ†å‰²ã—ã¦é †æ¬¡è©•ä¾¡
  const blocks = rule.split(/\s+else\s+if\s+/i);
  let matched = false;
  
  for (let i = 0; i < blocks.length; i++) {
    // å…ˆé ­ã® "if" ã‚’é™¤å»
    let blockStr = blocks[i].replace(/^\s*if\s+/i, '');
    
    // ãƒ–ãƒ­ãƒƒã‚¯ã‚’è©•ä¾¡ã€‚æ¡ä»¶ä¸€è‡´ã—ã¦å®Ÿè¡Œã•ã‚ŒãŸã‚‰çµ‚äº† (else if ãƒã‚§ãƒ¼ãƒ³)
    if (parseAndExecuteRuleBlock(cat, blockStr, triggerField, triggerVal, ruleIndex)) {
      matched = true;
      break;
    }
  }
  
  // ã©ã®ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚‚ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆã€ã‹ã¤ã€ä»¥å‰ã“ã®ãƒ«ãƒ¼ãƒ«ã§å¤‰æ›´ã•ã‚ŒãŸé …ç›®ãŒã‚ã‚Œã°æˆ»ã™
  if (!matched) {
      rollbackRule(ruleIndex);
  }
}

function rollbackRule(ruleIndex) {
  const targets = document.querySelectorAll(`[data-rule-active="${ruleIndex}"]`);
  targets.forEach(el => {
    if (el.dataset.originalValue !== undefined) {
      const oldVal = el.dataset.originalValue;
      if (el.value !== oldVal) {
          el.value = oldVal;
          el.dispatchEvent(new Event('change', {bubbles: true}));
          el.classList.add('highlight-change');
          
          // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
          if (el.id && el.id.startsWith('i-')) {
             const fid = el.id.substring(2);
             const grp = document.getElementById('sel-grp-' + fid);
             if (grp) {
                 grp.querySelectorAll('.option-btn').forEach(b => {
                     const isSel = (b.innerText === el.value);
                     b.style.background = isSel ? '#007bff' : '#fff';
                     b.style.color = isSel ? '#fff' : '#333';
                 });
             }
          }
      }
    }
    delete el.dataset.ruleActive;
    delete el.dataset.originalValue;
  });
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : é›†è¨ˆã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ â–¼â–¼â–¼
let aggTargetInput = null;

function openAggBuilder(targetInput) {
  aggTargetInput = targetInput;
  const catsOpts = st.cats.map(c => `<option value="${c.id}">${esc(c.name)}</option>`).join('');
  
  const html = `
    <div style="padding:5px;">
      <p style="font-size:12px; color:#666; margin-bottom:10px;">ä»–ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚„é …ç›®ã®å€¤ã‚’é›†è¨ˆã—ã¦æ¡ä»¶ã«ä½¿ãˆã¾ã™ã€‚</p>
      
      <label style="font-size:12px; font-weight:bold;">1. è¨ˆç®—æ–¹æ³•</label>
      <select id="agg-func" class="main-sel" style="padding:8px; margin-bottom:10px;">
        <option value="sum">åˆè¨ˆ (SUM)</option>
        <option value="avg">å¹³å‡ (AVG)</option>
        <option value="count">ä»¶æ•° (COUNT)</option>
        <option value="max">æœ€å¤§ (MAX)</option>
        <option value="min">æœ€å° (MIN)</option>
      </select>

      <label style="font-size:12px; font-weight:bold;">2. å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
      <select id="agg-cat" class="main-sel" style="padding:8px; margin-bottom:10px;" onchange="updateAggBuilderFields()">${catsOpts}</select>

      <label style="font-size:12px; font-weight:bold;">3. å¯¾è±¡é …ç›®</label>
      <select id="agg-field" class="main-sel" style="padding:8px; margin-bottom:10px;"></select>

      <label style="font-size:12px; font-weight:bold;">4. å¯¾è±¡æœŸé–“ãƒ»æ¡ä»¶</label>
      <select id="agg-cond-preset" class="main-sel" style="padding:8px; margin-bottom:5px;" onchange="updateAggCondition(this.value)">
        <option value="">å…¨æœŸé–“ (æ¡ä»¶ãªã—)</option>
        <option value="this_month">ä»Šæœˆ</option>
        <option value="today">ä»Šæ—¥</option>
        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ  (æ‰‹å…¥åŠ›)</option>
      </select>
      <textarea id="agg-where" placeholder="æ¡ä»¶ (Whereå¥) ä¾‹: [ä½“èª¿]='æ‚ªã„'" style="width:100%; height:60px; font-family:monospace; font-size:12px; display:none;"></textarea>

      <div style="margin-top:15px; text-align:right;">
        <button class="btn-main" onclick="insertAggQuery()" style="width:auto; display:inline-block;">ã‚¯ã‚¨ãƒªã‚’æŒ¿å…¥</button>
      </div>
    </div>
  `;
  
  document.getElementById('modal-title').innerText = 'é›†è¨ˆã‚¯ã‚¨ãƒªä½œæˆ';
  document.getElementById('modal-body').innerHTML = html;
  document.getElementById('modal-overlay').style.display = 'flex';
  updateAggBuilderFields();
}

function updateAggBuilderFields() {
  const catId = document.getElementById('agg-cat').value;
  const cat = st.cats.find(c => c.id === catId);
  const fieldSel = document.getElementById('agg-field');
  if (!cat) { fieldSel.innerHTML = ''; return; }
  let opts = cat.fields.map(f => `<option value="${esc(f.name)}">${esc(f.name)}</option>`).join('');
  opts = `<option value="*">ï¼ˆãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ï¼‰</option>` + opts;
  fieldSel.innerHTML = opts;
}

function updateAggCondition(val) {
  const whereArea = document.getElementById('agg-where');
  whereArea.style.display = (val === 'custom') ? 'block' : 'none';
}

function insertAggQuery() {
  const func = document.getElementById('agg-func').value;
  const catId = document.getElementById('agg-cat').value;
  const cat = st.cats.find(c => c.id === catId);
  const fieldName = document.getElementById('agg-field').value;
  const condType = document.getElementById('agg-cond-preset').value;
  let whereClause = document.getElementById('agg-where').value.trim();

  if (!cat) return;
  if (condType === 'this_month') whereClause = "format(yyyy-mm, [æ—¥ä»˜]) = format(yyyy-mm, now())";
  else if (condType === 'today') whereClause = "format(yyyy-mm-dd, [æ—¥ä»˜]) = format(yyyy-mm-dd, now())";

  let query = `select ${func}(${(fieldName === '*' || !fieldName) ? '*' : `[${fieldName}]`}) from [${cat.name}]`;
  if (whereClause) query += ` where ${whereClause}`;

  if (aggTargetInput) {
    aggTargetInput.value = query;
    aggTargetInput.dispatchEvent(new Event('input', {bubbles:true}));
    aggTargetInput.focus();
  }
  closeModal();
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : ã‚«ãƒ†ã‚´ãƒªãƒ¼éŸ³å£°é¸æŠæ©Ÿèƒ½ â–¼â–¼â–¼
function startCatVoiceInput() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
    return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'ja-JP';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  const btn = document.getElementById('btn-mic-cat');
  if(btn) {
      btn.style.background = '#dc3545'; // éŒ²éŸ³ä¸­ã¯èµ¤ã
      btn.innerText = 'ğŸ‘‚';
  }
  showToast('ã‚«ãƒ†ã‚´ãƒªãƒ¼åã‚’è©±ã—ã¦ãã ã•ã„...');

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript.trim();
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢ (åå‰ã®éƒ¨åˆ†ä¸€è‡´ãªã©ã§æŸ”è»Ÿã«)
    let match = st.cats.find(c => c.name === transcript) || 
                st.cats.find(c => transcript.includes(c.name)) || 
                st.cats.find(c => c.name.includes(transcript));

    if (match) {
      st.cur = match.id;
      cancelEdit();
      r();
      showToast(`ã€Œ${match.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
    } else {
      showToast(`ã€Œ${transcript}ã€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
    }
  };

  recognition.onend = () => { if(btn) { btn.style.background = '#17a2b8'; btn.innerText = 'ğŸ¤'; } };
  recognition.onerror = (e) => { 
    if(btn) { btn.style.background = '#17a2b8'; btn.innerText = 'ğŸ¤'; } 
    if(e.error === 'not-allowed') {
      if (location.protocol === 'file:') {
        alert('ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®åˆ¶é™ã€‘\nç¾åœ¨ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«(file://)ã§é–‹ã„ã¦ã„ã¾ã™ã€‚\nChromeãªã©ã®ä¸»è¦ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ãƒã‚¤ã‚¯ä½¿ç”¨ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚\n\néŸ³å£°å…¥åŠ›ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã‚’ãŠè©¦ã—ãã ã•ã„ï¼š\n1. VS Codeã®ã€ŒLive Serverã€ç­‰ã‚’ä½¿ã£ã¦ http://localhost ã§é–‹ã\n2. Webã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ HTTPS ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹');
      } else {
        alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã“ã®ã‚µã‚¤ãƒˆã®ãƒã‚¤ã‚¯æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\nãƒ»éHTTPSç’°å¢ƒã§ã¯å‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚');
      }
    } else if(e.error !== 'no-speech') {
      showToast('ã‚¨ãƒ©ãƒ¼: ' + e.error); 
    }
  };
  recognition.start();
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²

// â–¼â–¼â–¼ è¿½åŠ : é¸æŠè‚¢å±•é–‹ãƒ»ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆ¶å¾¡ â–¼â–¼â–¼
function selectOption(fid, val, btn) {
  const input = document.getElementById('i-' + fid);
  let isDeselect = false;
  if (input) {
      if (input.value === val) {
          input.value = '';
          isDeselect = true;
      } else {
          input.value = val;
      }
      input.dispatchEvent(new Event('change', {bubbles: true}));
      input.dispatchEvent(new Event('input', {bubbles: true}));
  }
  const grp = document.getElementById('sel-grp-' + fid);
  if (grp) {
    grp.querySelectorAll('.option-btn').forEach(b => {
      const isSel = (!isDeselect && b === btn);
      b.style.background = isSel ? '#007bff' : '#fff';
      b.style.color = isSel ? '#fff' : '#333';
    });
  }
  if (!isDeselect) moveFocusToNext(btn);
}

function toggleMultiOption(fid, val, btn) {
  const input = document.getElementById('i-' + fid);
  if (!input) return;
  
  let currentVals = input.value ? input.value.split(' ').filter(v=>v) : [];
  const idx = currentVals.indexOf(val);
  
  if (idx > -1) {
    currentVals.splice(idx, 1);
    btn.style.background = '#fff';
    btn.style.color = '#333';
  } else {
    currentVals.push(val);
    btn.style.background = '#007bff';
    btn.style.color = '#fff';
  }
  
  input.value = currentVals.join(' ');
  input.dispatchEvent(new Event('change', {bubbles: true}));
  input.dispatchEvent(new Event('input', {bubbles: true}));
}

function focusFirstInput() {
  const form = document.getElementById('form-in');
  if (!form) return;
  const selector = 'select:not([disabled]), input:not([type="hidden"]):not([disabled]), textarea:not([disabled]), button.option-btn';
  const first = form.querySelector(selector);
  if (first) first.focus();
}

function moveFocusToNext(current) {
  const form = document.getElementById('form-in');
  if (!form) return;
  const selector = 'select:not([disabled]), input:not([type="hidden"]):not([disabled]), textarea:not([disabled]), button.btn-main:not([disabled]), button.option-btn';
  const focusables = Array.from(form.querySelectorAll(selector));
  const idx = focusables.indexOf(current);
  if (idx > -1) {
    let nextIdx = idx + 1;
    if (current.classList.contains('option-btn')) {
        const currentFid = current.dataset.fid;
        while (nextIdx < focusables.length) {
            const nextEl = focusables[nextIdx];
            if (nextEl.classList.contains('option-btn') && nextEl.dataset.fid === currentFid) nextIdx++;
            else break;
        }
    }
    if (nextIdx < focusables.length) focusables[nextIdx].focus();
  }
}

const formInEl = document.getElementById('form-in');
if (formInEl) {
  formInEl.addEventListener('change', (e) => {
    if (e.target.matches('select, input, textarea') && e.target.type !== 'file' && e.target.type !== 'hidden') moveFocusToNext(e.target);
  });
  formInEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.matches('input')) { e.preventDefault(); moveFocusToNext(e.target); }
  });
}
// â–²â–²â–² è¿½åŠ  â–²â–²â–²
</script>
</body>
</html>