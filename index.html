<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›»å­å¸³ç°¿ä¿å­˜ï¼ˆå¹´åº¦ç®¡ç†SPAï¼‰</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&display=swap');

body {
  font-family: 'Noto Sans JP', "Helvetica Neue", Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f4f4f4;
  color: #333;
  line-height: 1.6;
  font-weight: bold;
  font-style: italic;
}

.container {
  max-width: 800px;
  margin: 20px auto;
  background: #fff;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}

h2 {
  text-align: center;
  letter-spacing: 0.1em;
  color: #2c3e50;
  margin-bottom: 10px;
}

h3 {
  font-size: 1.1rem;
  color: #555;
  border-left: 3px solid #d4a373;
  padding-left: 15px;
  margin-top: 30px;
  margin-bottom: 20px;
}

hr {
  border: 0;
  height: 1px;
  background: #eee;
  margin: 30px 0;
}

/* ãƒœã‚¿ãƒ³å…±é€š */
button {
  background-color: #fff;
  color: #555;
  border: 1px solid #ddd;
  padding: 10px 20px;
  border-radius: 30px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  margin: 5px;
  outline: none;
  font-weight: bold;
  font-style: italic;
}

button:hover {
  background-color: #f9f9f9;
  border-color: #bbb;
  transform: translateY(-2px);
}

button:active {
  transform: translateY(0);
}

button:disabled {
  background-color: #eee;
  color: #aaa;
  border-color: #eee;
  cursor: not-allowed;
  transform: none;
}

/* ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
#saveBtn, button[onclick="search()"], #initBtn {
  background-color: #2c3e50;
  color: #fff;
  border: none;
  box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2);
}

#saveBtn:hover, button[onclick="search()"]:hover, #initBtn:hover {
  background-color: #34495e;
  box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3);
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.nav-bar {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-bottom: 30px;
}

.nav-bar button {
  border: none;
  background: transparent;
  color: #888;
  border-bottom: 2px solid transparent;
  border-radius: 0;
  padding: 10px 30px;
  margin: 0;
}

.nav-bar button:hover {
  color: #d4a373;
  background: transparent;
  transform: none;
}

.nav-bar button.active {
  color: #2c3e50;
  border-bottom-color: #d4a373;
}

/* å¹´åº¦ã‚¿ãƒ– */
#yearTabs {
  text-align: center;
  margin-bottom: 10px;
}

#yearTabs button {
  background: transparent;
  border: 1px solid transparent;
  color: #999;
  font-size: 0.9rem;
}

#yearTabs button.active-year {
  color: #d4a373;
  border: 1px solid #d4a373;
  background-color: #fff;
}

#yearSummary {
  text-align: center;
  font-size: 0.9rem;
  color: #888;
  margin-bottom: 20px;
}

/* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
input[type="text"],
input[type="number"],
input[type="date"],
input[type="file"] {
  width: 100%;
  padding: 8px 12px;
  margin-bottom: 8px;
  border: 1px solid #eee;
  border-radius: 8px;
  box-sizing: border-box;
  font-size: 1rem;
  background-color: #fafafa;
  transition: border-color 0.3s;
  font-weight: bold;
  font-style: italic;
}

input:focus {
  outline: none;
  border-color: #d4a373;
  background-color: #fff;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ« */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.03);
  border-radius: 8px;
  overflow: hidden;
}

th {
  background-color: #f8f8f8;
  color: #555;
  padding: 15px;
  text-align: left;
  border-bottom: 2px solid #eee;
  border-right: none;
  border-left: none;
  border-top: none;
}

td {
  padding: 15px;
  border-bottom: 1px solid #eee;
  border-right: none;
  border-left: none;
  color: #666;
}

tr:last-child td {
  border-bottom: none;
}

/* ãã®ä»–UI */
.view { display: none; }
.view.active { 
  display: block; 
  animation: fadeIn 0.4s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

#cameraUI {
  background: #000;
  border-radius: 8px;
  overflow: hidden;
}

fieldset {
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}

legend {
  color: #888;
  padding: 0 10px;
  font-size: 0.9rem;
}

/* ãƒˆãƒªãƒŸãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« */
#cropModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

/* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
#toast {
  visibility: hidden;
  min-width: 250px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 4px;
  padding: 16px;
  position: fixed;
  z-index: 10000;
  left: 50%;
  transform: translateX(-50%);
  bottom: 30px;
  font-size: 1rem;
  opacity: 0;
  transition: opacity 0.3s, bottom 0.3s;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

#toast.show {
  visibility: visible;
  opacity: 1;
  bottom: 50px;
}

/* ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
#scrollTopBtn {
  display: none;
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 9999;
  width: 50px;
  height: 50px;
  border: none;
  border-radius: 50%;
  background-color: #d4a373;
  color: #fff;
  font-size: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  cursor: pointer;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  padding: 0;
  margin: 0;
}

#scrollTopBtn:hover {
  background-color: #b08d55;
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}
</style>
</head>

<body>

<div class="container">

<h2>é›»å­å¸³ç°¿ä¿å­˜ï¼ˆå¹´åº¦ç®¡ç†ï¼‰</h2>

<!-- å¹´åº¦ã‚¿ãƒ– -->
<div id="yearTabs"></div>
<div id="yearSelectContainer" style="display:none; text-align:center; margin-bottom:10px;">
  <label>å¹´åº¦åˆ‡æ›¿: <select id="pastYearSelect" onchange="changePastYear(this.value)" style="width:auto; display:inline-block; padding:5px; font-size:0.9rem;"></select></label>
</div>
<div id="yearSummary"></div>

<!-- ãƒŠãƒ“ -->
<div class="nav-bar">
  <button id="btn-capture" onclick="showView('capture')" class="active">ç™»éŒ²</button>
  <button id="btn-search" onclick="showView('search')">æ¤œç´¢</button>
  <button id="btn-maintenance" onclick="showView('maintenance')">ä¿å®ˆ</button>
</div>

<!-- ç™»éŒ²ç”»é¢ -->
<section id="capture" class="view active">
  <h3>é ˜åæ›¸ç™»éŒ²</h3>
  <input type="date" id="date">
  <input type="text" id="amount" placeholder="é‡‘é¡" inputmode="numeric" onfocus="removeComma(this)" onblur="addComma(this)">
  <input type="text" id="vendor" placeholder="å–å¼•å…ˆ">
  <div id="vendorHistory" style="margin-bottom: 5px; font-size: 0.85rem;"></div>
  <input type="text" id="description" placeholder="å†…å®¹">
  <div id="descHistory" style="margin-bottom: 5px; font-size: 0.85rem;"></div>
  <input type="file" id="file" accept="image/*,.pdf">
  <img id="preview" style="max-width:300px; display:none; margin-bottom:10px;">
  <div id="imageAdjustments" style="display:none; margin-bottom:10px; background:#f9f9f9; padding:10px; border-radius:8px;">
    <label style="font-size:0.9rem;">æ˜ã‚‹ã•: <span id="brightnessVal" style="font-weight:bold;">100</span>%</label>
    <input type="range" id="brightnessRange" min="50" max="150" value="100" style="width:100%; cursor:pointer;" oninput="updatePreviewFilter()">
  </div>
  <iframe id="pdfPreview" style="width:100%; height:300px; display:none; margin-bottom:10px; border:1px solid #ccc;"></iframe>
  
  <button type="button" id="cropBtn" onclick="startCropping()" style="display:none; margin-bottom:15px;">ç”»åƒã‚’ãƒˆãƒªãƒŸãƒ³ã‚°</button><br>
  <button type="button" id="cameraBtn" onclick="startCamera()">ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
  <div id="cameraUI" style="display:none; margin-top:10px; border:1px solid #ccc; padding:5px;">
    <div style="position:relative; width:100%; max-width:400px; margin:0 auto;">
      <video id="cameraVideo" autoplay playsinline muted style="width:100%; display:block;"></video>
      <div id="cameraGrid" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">
        <div style="position:absolute; top:33.3%; width:100%; height:1px; background:rgba(255,255,255,0.5); box-shadow:0 0 2px #000;"></div>
        <div style="position:absolute; top:66.6%; width:100%; height:1px; background:rgba(255,255,255,0.5); box-shadow:0 0 2px #000;"></div>
        <div style="position:absolute; left:33.3%; height:100%; width:1px; background:rgba(255,255,255,0.5); box-shadow:0 0 2px #000;"></div>
        <div style="position:absolute; left:66.6%; height:100%; width:1px; background:rgba(255,255,255,0.5); box-shadow:0 0 2px #000;"></div>
      </div>
    </div>
    <canvas id="cameraCanvas" style="display:none;"></canvas><br>
    <label style="display:block; margin:5px 0;"><input type="checkbox" onchange="document.getElementById('cameraGrid').style.display=this.checked?'block':'none'"> ã‚°ãƒªãƒƒãƒ‰ç·šã‚’è¡¨ç¤º</label>
    <button onclick="takePhoto()">æ’®å½±</button>
    <button onclick="stopCamera()">é–‰ã˜ã‚‹</button>
  </div><br><br>
  <button id="saveBtn" onclick="save()">ä¿å­˜</button>
  <button type="button" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
</section>

<!-- ãƒˆãƒªãƒŸãƒ³ã‚°ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="cropModal">
  <div style="background:#fff; padding:10px; border-radius:8px; max-width:90%; max-height:90%; display:flex; flex-direction:column; width: 600px;">
    <div style="flex:1; overflow:hidden; min-height:200px; background:#eee;">
      <img id="cropImage" style="max-width:100%; max-height: 60vh; display:block;">
    </div>
    <div style="margin-top:10px; text-align:center;">
      <button onclick="rotateImage(-90)">â†º å·¦å›è»¢</button>
      <button onclick="rotateImage(90)">â†» å³å›è»¢</button>
      <button onclick="applyCrop()">åˆ‡ã‚ŠæŠœãç¢ºå®š</button>
      <button onclick="cancelCrop()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- æ¤œç´¢ç”»é¢ -->
<section id="search" class="view">
  <h3>æ¤œç´¢</h3>
  <input type="date" id="from">
  <input type="date" id="to">
  <input type="number" id="min" placeholder="æœ€å°é‡‘é¡">
  <input type="number" id="max" placeholder="æœ€å¤§é‡‘é¡">
  <input type="text" id="vendorSearch" placeholder="å–å¼•å…ˆ">
  <input type="text" id="descSearch" placeholder="å†…å®¹">
  <input type="text" id="excludeSearch" placeholder="é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
  <div id="excludeHistory" style="margin-bottom: 5px; font-size: 0.85rem;"></div>
  <button onclick="search()">æ¤œç´¢</button>
  <button onclick="clearSearch()">ã‚¯ãƒªã‚¢</button>

  <table>
    <thead>
      <tr>
        <th>æ—¥ä»˜</th><th>é‡‘é¡</th><th>å–å¼•å…ˆ</th><th>å†…å®¹</th><th>ä¿å­˜æ—¥æ™‚</th><th>ç”»åƒ</th><th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="result"></tbody>
  </table>
</section>

<!-- ä¿å®ˆç”»é¢ -->
<section id="maintenance" class="view">
  <h3>ä¿å®ˆ</h3>
  <fieldset>
    <legend>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š</legend>
    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
      <label>ç™»éŒ²ç”»é¢: <input type="color" id="colorCapture" onchange="saveThemeColors()"></label>
      <label>æ¤œç´¢ç”»é¢: <input type="color" id="colorSearch" onchange="saveThemeColors()"></label>
      <label>ä¿å®ˆç”»é¢: <input type="color" id="colorMaintenance" onchange="saveThemeColors()"></label>
      <button onclick="resetThemeColors()" style="margin-left:auto; font-size:0.8rem;">åˆæœŸå€¤ã«æˆ»ã™</button>
    </div>
  </fieldset>
  <br>
  <fieldset>
    <legend>ç”»è³ªè¨­å®šï¼ˆã‚«ãƒ¡ãƒ©ï¼‰</legend>
    <div style="margin-top:10px;">
      <label>æœ€å¤§ç”»åƒå¹…: <span id="cameraMaxWidthDisplay" style="font-weight:bold;">1600</span> px</label><br>
      <input type="range" id="cameraMaxWidth" min="100" max="1600" step="100" style="width:100%; max-width:300px; cursor:pointer;" oninput="document.getElementById('cameraMaxWidthDisplay').textContent = this.value" onchange="saveCameraSettings()">
    </div>
    <div style="margin-top:10px;">
      <label>ç”»è³ª(JPEGåœ§ç¸®ç‡): <span id="cameraQualityDisplay" style="font-weight:bold;">80</span> %</label><br>
      <input type="range" id="cameraQuality" min="10" max="100" step="5" style="width:100%; max-width:300px; cursor:pointer;" oninput="document.getElementById('cameraQualityDisplay').textContent = this.value" onchange="saveCameraSettings()">
    </div>
  </fieldset>
  <br>
  <fieldset>
    <legend>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±</legend>
    <div id="storageInfo">
      <p style="margin:5px 0;">ä½¿ç”¨é‡: <span id="storageUsage">-</span> / <span id="storageQuota">-</span></p>
      <p style="margin:5px 0;">æ°¸ç¶šåŒ–: <span id="storagePersisted">-</span></p>
      <button onclick="updateStorageInfo()" style="margin-top:5px;">æƒ…å ±ã‚’æ›´æ–°</button>
      <button onclick="requestPersistence()" id="persistBtn" style="margin-top:5px;">æ°¸ç¶šåŒ–ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
    </div>
  </fieldset>
  <br>
  <fieldset>
    <legend>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</legend>
    <label>ãƒ•ã‚¡ã‚¤ãƒ«åæ¥é ­è¾: <input type="text" id="backupPrefixInput" style="width:200px;"></label>
    <button onclick="saveBackupPrefix()">è¨­å®šä¿å­˜</button>
    <br>
    <label style="margin-top:10px; display:block;"><input type="checkbox" id="backupDateCheck" onchange="saveBackupDate()"> ãƒ•ã‚¡ã‚¤ãƒ«åã«æ—¥ä»˜(YYYYMMDD)ã‚’ä»˜ä¸</label>
  </fieldset>
  <br>
  <fieldset>
    <legend>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š</legend>
    <label><input type="checkbox" id="autoBackupToggle" onchange="saveAutoBackupSettings()"> è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
    <div style="margin-top:10px;">
      <label>å®Ÿè¡Œé »åº¦: <span id="autoBackupFreqDisplay" style="font-weight:bold; color:#2c3e50;">1</span> æ—¥ã”ã¨ã«å®Ÿè¡Œ</label><br>
      <input type="range" id="autoBackupFreq" min="1" max="30" style="width:100%; max-width:300px; cursor:pointer;" oninput="document.getElementById('autoBackupFreqDisplay').textContent = this.value" onchange="saveAutoBackupSettings()">
    </div>
    <div style="margin-top:10px;">
      <label>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆ(è¨˜éŒ²): <input type="text" id="autoBackupDest" style="width:100%; box-sizing:border-box; background-color:#eee;" placeholder="æœªè¨­å®š" readonly></label>
      <button onclick="selectBackupDirectory()" style="margin-top:5px; font-size:0.8rem;">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
      <button onclick="clearBackupDirectory()" style="margin-top:5px; font-size:0.8rem;">ã‚¯ãƒªã‚¢</button>
    </div>
  </fieldset>
  <br>
  <fieldset>
    <legend>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</legend>
    <button onclick="backupYear(currentYear)">è¡¨ç¤ºå¹´åº¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <hr>
    <div style="margin-top:10px;">
      <label>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(JSON)ã‹ã‚‰å¾©å…ƒ:</label><br>
      <input type="file" id="importFile" accept=".json"><br>
      <div style="margin-top:5px; font-size:0.9rem;">
        <label style="margin-right:10px;"><input type="radio" name="importMode" value="overwrite" checked> é‡è¤‡ã¯ä¸Šæ›¸ã</label>
        <label><input type="radio" name="importMode" value="skip"> é‡è¤‡ã¯ã‚¹ã‚­ãƒƒãƒ—</label>
      </div>
      <button onclick="importData()" style="margin-top:5px;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
      <p style="font-size:0.8em; color:gray;">â€»åŒIDã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™(ç”»åƒã¯å¾©å…ƒã•ã‚Œã¾ã›ã‚“)</p>
    </div>
  </fieldset>
  <br>
  <fieldset>
    <legend>ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</legend>
    <button onclick="showResetUI()" id="initBtn">å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
    <div id="resetUI" style="display:none; border:1px solid red; padding:10px; margin-top:10px; background-color:#fff0f0;">
      <p style="color:red; font-weight:bold;">ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚<br>å®Ÿè¡Œã™ã‚‹ã«ã¯åˆæœŸåŒ–ã¨å…¥åŠ›ã—ã¦å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
      <p>æ‰¿èªãƒ¯ãƒ¼ãƒ‰ã¯&lt;åˆæœŸåŒ–&gt;ã¨ã—ã¦ãã ã•ã„</p>
      <input type="text" id="resetConfirmInput" placeholder="åˆæœŸåŒ–">
      <button onclick="executeReset()">å®Ÿè¡Œ</button>
      <button onclick="hideResetUI()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </fieldset>
  <br>
  <fieldset>
    <legend>å‰å¹´åº¦ãƒ­ãƒƒã‚¯è¨­å®š</legend>
    <p>ç¾åœ¨ã®çŠ¶æ…‹: <span id="lockStatus" style="font-weight:bold;"></span></p>
    <button onclick="toggleLock(true)" id="lockBtn">å‰å¹´åº¦ãƒ­ãƒƒã‚¯</button>
    <button onclick="toggleLock(false)" id="unlockBtn">ãƒ­ãƒƒã‚¯è§£é™¤</button>
  </fieldset>
  <br>
  <fieldset>
    <legend>å±¥æ­´è¡¨ç¤ºè¨­å®š</legend>
    <label>å…¥åŠ›å±¥æ­´ã®è¡¨ç¤ºæ•°: <input type="number" id="historyLimitInput" style="width:50px;" min="1" max="20"></label>
    <button onclick="saveHistoryLimit()">è¨­å®šä¿å­˜</button>
  </fieldset>
</section>

<div id="toast"></div>
<button id="scrollTopBtn" onclick="scrollToTop()" title="ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹">â–²</button>

<script>
/* ===== SPAåŸºæœ¬ ===== */
function showView(id) {
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  
  document.querySelectorAll(".nav-bar button").forEach(b => b.classList.remove("active"));
  const btn = document.getElementById("btn-" + id);
  if(btn) btn.classList.add("active");

  const container = document.querySelector(".container");
  if (themeColors[id]) {
    container.style.backgroundColor = themeColors[id];
  }

  if (id === "capture" && db) {
    updateVendorHistory();
    updateDescHistory();
  }
  if (id === "maintenance") {
    updateStorageInfo();
  }
  if (id === "search") {
    updateExcludeHistory();
  }
}

/* ===== IndexedDB ===== */
let db;
const req = indexedDB.open("receiptDB", 3);
req.onupgradeneeded = e => {
  db = e.target.result;
  const store = e.oldVersion < 1 ? db.createObjectStore("receipts", { keyPath: "id" }) : e.target.transaction.objectStore("receipts");
  
  if (!store.indexNames.contains("fiscalYear")) store.createIndex("fiscalYear", "fiscalYear", { unique: false });
  if (!store.indexNames.contains("date")) store.createIndex("date", "date", { unique: false });
  if (!store.indexNames.contains("amount")) store.createIndex("amount", "amount", { unique: false });
  if (!store.indexNames.contains("vendor")) store.createIndex("vendor", "vendor", { unique: false });
  
  if (e.oldVersion < 3) {
    db.createObjectStore("settings");
  }
};
req.onsuccess = e => {
  db = e.target.result;
  initYearTabs();
  updateYearSummary();
  updateVendorHistory();
  updateDescHistory();
  updateLockUI();
  initHistoryLimit();
  initBackupPrefix();
  initAutoBackupSettings();
  clearForm();
  initThemeColors();
  initCameraSettings();
  showView('capture');
};

/* ===== å¹´åº¦ç®¡ç† ===== */
const CURRENT_YEAR = new Date().getFullYear().toString();
let currentYear = CURRENT_YEAR;

/* å¹´åº¦ã‚¿ãƒ–ç”Ÿæˆ */
function initYearTabs() {
  const y = document.getElementById("yearTabs");
  y.innerHTML = "";

  // éå»å¹´åº¦ã‚¿ãƒ– (åˆæœŸå€¤ã¯å‰å¹´åº¦)
  const btnPast = document.createElement("button");
  btnPast.id = "tab-past";
  const prevYear = (Number(CURRENT_YEAR) - 1).toString();
  // ç¾åœ¨é¸æŠä¸­ã®å¹´åº¦ãŒéå»ãªã‚‰ãã‚Œã‚’è¡¨ç¤ºã€ãã†ã§ãªã‘ã‚Œã°å‰å¹´åº¦ã‚’è¡¨ç¤º
  const initialPastYear = (Number(currentYear) < Number(CURRENT_YEAR)) ? currentYear : prevYear;
  btnPast.textContent = initialPastYear + "å¹´åº¦";
  
  btnPast.onclick = () => {
    const yearOnTab = btnPast.textContent.replace("å¹´åº¦", "");
    currentYear = yearOnTab;
    updateAvailableYears();
    highlightYear();
    search();
    updateYearSummary();
  };
  y.appendChild(btnPast);

  // ç¾åœ¨å¹´åº¦ã‚¿ãƒ–
  const btnCurrent = document.createElement("button");
  btnCurrent.textContent = CURRENT_YEAR + "å¹´åº¦";
  btnCurrent.onclick = () => {
    currentYear = CURRENT_YEAR;
    document.getElementById("yearSelectContainer").style.display = "none";
    highlightYear();
    search();
    updateYearSummary();
  };
  y.appendChild(btnCurrent);

  // ç¿Œå¹´åº¦ã‚¿ãƒ–
  const btnNext = document.createElement("button");
  btnNext.textContent = (Number(CURRENT_YEAR) + 1) + "å¹´åº¦";
  btnNext.onclick = () => {
    currentYear = (Number(CURRENT_YEAR) + 1).toString();
    document.getElementById("yearSelectContainer").style.display = "none";
    highlightYear();
    search();
    updateYearSummary();
  };
  y.appendChild(btnNext);

  highlightYear();
}

/* éå¹´åº¦ãƒ­ãƒƒã‚¯ */
function highlightYear() {
  [...yearTabs.children].forEach(b => {
    if (b.textContent.startsWith(currentYear)) b.classList.add("active-year");
    else b.classList.remove("active-year");
    b.style.fontWeight = ""; // ä»¥å‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
  });
  // ãƒ­ãƒƒã‚¯ä¸­ã‹ã¤ç¾åœ¨å¹´åº¦ã§ãªã„å ´åˆã¯ä¿å­˜ãƒœã‚¿ãƒ³ç„¡åŠ¹
  if (currentYear !== CURRENT_YEAR && isPastLocked) {
    saveBtn.disabled = true;
  } else {
    saveBtn.disabled = false;
  }
}

function updateAvailableYears() {
  const select = document.getElementById("pastYearSelect");
  select.innerHTML = "";
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‰å¹´åº¦ã¯å¿…ãšå«ã‚ã‚‹
  const defaultPrev = (Number(CURRENT_YEAR) - 1).toString();
  const years = new Set([defaultPrev]);
  
  // DBã‹ã‚‰å­˜åœ¨ã™ã‚‹å¹´åº¦ã‚’å–å¾—
  const tx = db.transaction("receipts", "readonly");
  const store = tx.objectStore("receipts");
  const index = store.index("fiscalYear");
  
  const req = index.openKeyCursor(null, "nextunique");
  req.onsuccess = (e) => {
    const cursor = e.target.result;
    if (cursor) {
      const y = cursor.key.toString();
      if (y < CURRENT_YEAR) {
        years.add(y);
      }
      cursor.continue();
    } else {
      // é™é †ã§ã‚½ãƒ¼ãƒˆã—ã¦selectã«è¿½åŠ 
      const sortedYears = Array.from(years).sort((a, b) => b - a);
      sortedYears.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y + "å¹´åº¦";
        if (y === currentYear) opt.selected = true;
        select.appendChild(opt);
      });
      document.getElementById("yearSelectContainer").style.display = "block";
    }
  };
}

function changePastYear(val) {
  currentYear = val;
  const btnPast = document.getElementById("tab-past");
  if (btnPast) btnPast.textContent = val + "å¹´åº¦";
  highlightYear();
  search();
  updateYearSummary();
}

/* ===== ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ ===== */
let isPastLocked = localStorage.getItem("isPastLocked") !== "false"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ­ãƒƒã‚¯(true)

function toggleLock(locked) {
  isPastLocked = locked;
  localStorage.setItem("isPastLocked", locked);
  updateLockUI();
  highlightYear();
  alert(locked ? "éå»ã®å¹´åº¦ã‚’ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ" : "ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ");
}

function updateLockUI() {
  const status = document.getElementById("lockStatus");
  if (status) {
    status.textContent = isPastLocked ? "ãƒ­ãƒƒã‚¯ä¸­ (ç·¨é›†ä¸å¯)" : "è§£é™¤ä¸­ (ç·¨é›†å¯)";
    status.style.color = isPastLocked ? "red" : "blue";
  }
  document.getElementById("lockBtn").disabled = isPastLocked;
  document.getElementById("unlockBtn").disabled = !isPastLocked;
}

/* ===== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š ===== */
let backupPrefix = localStorage.getItem("backupPrefix") || "ã‚¯ãƒªãƒ‹ãƒƒã‚¯";
let isBackupDate = localStorage.getItem("isBackupDate") === "true";

function initBackupPrefix() {
  const input = document.getElementById("backupPrefixInput");
  if (input) input.value = backupPrefix;
  const check = document.getElementById("backupDateCheck");
  if (check) check.checked = isBackupDate;
}

function saveBackupPrefix() {
  const input = document.getElementById("backupPrefixInput");
  const val = input.value.trim();
  if (!val) return alert("æ¥é ­è¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  backupPrefix = val;
  localStorage.setItem("backupPrefix", backupPrefix);
  alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
}

function saveBackupDate() {
  const check = document.getElementById("backupDateCheck");
  isBackupDate = check.checked;
  localStorage.setItem("isBackupDate", isBackupDate);
}

function getYYYYMMDD() {
  const d = new Date();
  const y = d.getFullYear();
  const m = (d.getMonth() + 1).toString().padStart(2, '0');
  const day = d.getDate().toString().padStart(2, '0');
  return y + m + day;
}

/* ===== è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š ===== */
let autoBackupEnabled = localStorage.getItem("autoBackupEnabled") === "true";
let autoBackupFreq = Number(localStorage.getItem("autoBackupFreq")) || 1;
let lastBackupDate = localStorage.getItem("lastBackupDate") || "";
let backupDirectoryHandle = null;

async function initAutoBackupSettings() {
  const toggle = document.getElementById("autoBackupToggle");
  const freq = document.getElementById("autoBackupFreq");
  const freqDisplay = document.getElementById("autoBackupFreqDisplay");
  if (toggle) toggle.checked = autoBackupEnabled;
  if (freq) {
    freq.value = autoBackupFreq;
    if (freqDisplay) freqDisplay.textContent = autoBackupFreq;
  }
  
  // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒãƒ³ãƒ‰ãƒ«ã®å¾©å…ƒ
  try {
    const tx = db.transaction("settings", "readonly");
    const req = tx.objectStore("settings").get("backupDirectoryHandle");
    req.onsuccess = async () => {
      if (req.result) {
        backupDirectoryHandle = req.result;
        document.getElementById("autoBackupDest").value = backupDirectoryHandle.name;
      }
    };
  } catch (e) {
    console.error("Settings load error:", e);
  }
}

async function selectBackupDirectory() {
  try {
    const handle = await window.showDirectoryPicker();
    if (handle) {
      backupDirectoryHandle = handle;
      document.getElementById("autoBackupDest").value = handle.name;
      
      const tx = db.transaction("settings", "readwrite");
      tx.objectStore("settings").put(handle, "backupDirectoryHandle");
      alert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆã‚’ã€Œ${handle.name}ã€ã«è¨­å®šã—ã¾ã—ãŸ`);
    }
  } catch (e) {
    if (e.name !== 'AbortError') {
      alert("ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚¨ãƒ©ãƒ¼: " + e.message);
    }
  }
}

function clearBackupDirectory() {
  backupDirectoryHandle = null;
  document.getElementById("autoBackupDest").value = "";
  const tx = db.transaction("settings", "readwrite");
  tx.objectStore("settings").delete("backupDirectoryHandle");
}

function saveAutoBackupSettings() {
  autoBackupEnabled = document.getElementById("autoBackupToggle").checked;
  autoBackupFreq = document.getElementById("autoBackupFreq").value;
  
  localStorage.setItem("autoBackupEnabled", autoBackupEnabled);
  localStorage.setItem("autoBackupFreq", autoBackupFreq);
}

function showToast(message) {
  const t = document.getElementById("toast");
  if (!t) return;
  t.textContent = message;
  t.classList.add("show");
  setTimeout(() => { t.classList.remove("show"); }, 3000);
}

async function checkAndRunAutoBackup() {
  if (!autoBackupEnabled) return;
  
  const todayStr = getYYYYMMDD();
  if (lastBackupDate === todayStr) return; // æœ¬æ—¥å®Ÿè¡Œæ¸ˆã¿

  // æœ€çµ‚å®Ÿè¡Œæ—¥ã¨ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯
  // lastBackupDateãŒãªã„ã€ã¾ãŸã¯æŒ‡å®šæ—¥æ•°ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆã«å®Ÿè¡Œ
  // ç°¡æ˜“çš„ã«æ–‡å­—åˆ—æ¯”è¼ƒã§æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ã‚Œã°é »åº¦ãƒã‚§ãƒƒã‚¯ã¸é€²ã‚€å®Ÿè£…ã§ã‚‚è‰¯ã„ãŒã€ã“ã“ã§ã¯æ—¥ä»˜å·®åˆ†ã‚’è¨ˆç®—
  let diffDays = 100; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®Ÿè¡Œå¯¾è±¡ã¨ã™ã‚‹
  if (lastBackupDate) {
    const ly = parseInt(lastBackupDate.substring(0, 4));
    const lm = parseInt(lastBackupDate.substring(4, 6)) - 1;
    const ld = parseInt(lastBackupDate.substring(6, 8));
    const lastDate = new Date(ly, lm, ld);
    const now = new Date();
    const todayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
  }

  if (diffDays >= autoBackupFreq) {
    await backupAll();
    lastBackupDate = todayStr;
    localStorage.setItem("lastBackupDate", lastBackupDate);
    showToast("è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ");
  }
}

/* ===== ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š ===== */
const DEFAULT_COLORS = {
  capture: "#fff0f5",
  search: "#f0f8ff",
  maintenance: "#fff3cd"
};
let themeColors = JSON.parse(localStorage.getItem("themeColors")) || {...DEFAULT_COLORS};

function initThemeColors() {
  const cCap = document.getElementById("colorCapture");
  const cSearch = document.getElementById("colorSearch");
  const cMaint = document.getElementById("colorMaintenance");
  
  if (cCap) cCap.value = themeColors.capture;
  if (cSearch) cSearch.value = themeColors.search;
  if (cMaint) cMaint.value = themeColors.maintenance;
}

function saveThemeColors() {
  themeColors.capture = document.getElementById("colorCapture").value;
  themeColors.search = document.getElementById("colorSearch").value;
  themeColors.maintenance = document.getElementById("colorMaintenance").value;
  localStorage.setItem("themeColors", JSON.stringify(themeColors));
  
  // ç¾åœ¨ã®ç”»é¢ã®è‰²ã‚’å³æ™‚åæ˜ 
  const currentView = document.querySelector(".view.active").id;
  if (themeColors[currentView]) {
    document.querySelector(".container").style.backgroundColor = themeColors[currentView];
  }
}

function resetThemeColors() {
  if(!confirm("ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’åˆæœŸå€¤ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
  themeColors = {...DEFAULT_COLORS};
  localStorage.setItem("themeColors", JSON.stringify(themeColors));
  initThemeColors();
  
  const currentView = document.querySelector(".view.active").id;
  if (themeColors[currentView]) {
    document.querySelector(".container").style.backgroundColor = themeColors[currentView];
  }
}

/* ===== ç”»åƒèª¿æ•´å‡¦ç† ===== */
function processImage(file, brightness) {
  return new Promise((resolve) => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      URL.revokeObjectURL(url);
      let width = img.width;
      let height = img.height;
      
      // ãƒªã‚µã‚¤ã‚ºè¨ˆç®—
      if (width > cameraMaxWidth || height > cameraMaxWidth) {
        if (width > height) {
          height = Math.round(height * (cameraMaxWidth / width));
          width = cameraMaxWidth;
        } else {
          width = Math.round(width * (cameraMaxWidth / height));
          height = cameraMaxWidth;
        }
      }
      
      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      
      // æ˜ã‚‹ã•èª¿æ•´
      if (brightness && brightness !== 100) {
        ctx.filter = `brightness(${brightness}%)`;
      }
      
      ctx.drawImage(img, 0, 0, width, height);
      
      canvas.toBlob((blob) => {
        if (!blob) return resolve(file);
        const newFile = new File([blob], file.name, {
          type: "image/jpeg",
          lastModified: Date.now()
        });
        resolve(newFile);
      }, "image/jpeg", cameraQuality / 100);
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      resolve(file);
    };
    img.src = url;
  });
}

function resetImageAdjustments() {
  const range = document.getElementById("brightnessRange");
  if (range) range.value = 100;
  const val = document.getElementById("brightnessVal");
  if (val) val.textContent = 100;
  const preview = document.getElementById("preview");
  if (preview) preview.style.filter = "none";
  const div = document.getElementById("imageAdjustments");
  if (div) div.style.display = "block";
}

function updatePreviewFilter() {
  const val = document.getElementById("brightnessRange").value;
  document.getElementById("brightnessVal").textContent = val;
  document.getElementById("preview").style.filter = `brightness(${val}%)`;
}

/* ===== å±¥æ­´è¨­å®š ===== */
let historyLimit = Number(localStorage.getItem("historyLimit")) || 5;

function initHistoryLimit() {
  const input = document.getElementById("historyLimitInput");
  if (input) input.value = historyLimit;
}

function saveHistoryLimit() {
  const input = document.getElementById("historyLimitInput");
  const val = Number(input.value);
  if (val < 1) return alert("1ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  historyLimit = val;
  localStorage.setItem("historyLimit", historyLimit);
  alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
}

/* ===== ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ ===== */
let stream;

// Android/iPadãªã©ã®ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã¯ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’æ¨å¥¨ï¼‰
if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || (navigator.userAgent.includes("Mac") && navigator.maxTouchPoints > 1)) {
  const btn = document.getElementById("cameraBtn");
  if (btn) btn.style.display = "none";
}

async function startCamera() {
  const video = document.getElementById("cameraVideo");
  const ui = document.getElementById("cameraUI");
  
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
  
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("ã‚«ãƒ¡ãƒ©APIãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚\n(file://å½¢å¼ã§ã¯ã“ã®æ©Ÿèƒ½ã¯ä½¿ãˆã¾ã›ã‚“)\n\nã€ä»£æ›¿ç­–ã€‘\nä¸Šã®ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚\nã‚¹ãƒãƒ›ã®æ¨™æº–ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦æ’®å½±ã§ãã¾ã™ã€‚");
    return;
  }

  try {
    // ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆã€PCç­‰ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    try {
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: "environment",
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      });
    } catch (e) {
      // åˆå›å¤±æ•—æ™‚ã¯åˆ¶ç´„ãªã—ã§å†è©¦è¡Œ
      // æ¨©é™æ‹’å¦ã®å ´åˆã¯å†è©¦è¡Œã›ãšã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
      if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
        throw e;
      }
      // åˆ¶ç´„ã‚¨ãƒ©ãƒ¼ãªã©ã®å ´åˆã¯ã€åˆ¶ç´„ãªã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¡ãƒ©ï¼‰ã§å†è©¦è¡Œ
      console.warn("Camera constraints failed, retrying with defaults:", e);
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    }
    video.srcObject = stream;
    video.onloadedmetadata = () => {
      video.play().catch(e => console.error("Video play error:", e));
    };
    ui.style.display = "block";
  } catch (err) {
    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
      alert("ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n(file://å½¢å¼ã§ã¯ã“ã®æ©Ÿèƒ½ã¯ä½¿ãˆã¾ã›ã‚“)\n\nã€ä»£æ›¿ç­–ã€‘\nä¸Šã®ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚\nã‚¹ãƒãƒ›ã®æ¨™æº–ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦æ’®å½±ã§ãã¾ã™ã€‚");
    } else {
      alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.name + "\n" + err.message);
    }
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  document.getElementById("cameraUI").style.display = "none";
}

function takePhoto() {
  const video = document.getElementById("cameraVideo");
  const canvas = document.getElementById("cameraCanvas");
  
  if (!stream) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  canvas.toBlob(blob => {
    const f = new File([blob], `capture_${Date.now()}.png`, { type: "image/png" });
    const dt = new DataTransfer();
    dt.items.add(f);
    file.files = dt.files;

    preview.src = URL.createObjectURL(f);
    preview.style.display = "block";
    document.getElementById("cropBtn").style.display = "inline-block";
    resetImageAdjustments();
    
    stopCamera();
    alert("æ’®å½±ã—ã¾ã—ãŸ");
  }, "image/png");
}

/* ===== ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ===== */
file.onchange = function() {
  const f = this.files[0];
  const pdfPreview = document.getElementById("pdfPreview");

  if (f && f.type.startsWith("image/")) {
    preview.src = URL.createObjectURL(f);
    preview.style.display = "block";
    pdfPreview.style.display = "none";
    document.getElementById("cropBtn").style.display = "inline-block";
    resetImageAdjustments();
  } else if (f && f.type === "application/pdf") {
    preview.style.display = "none";
    pdfPreview.src = URL.createObjectURL(f);
    pdfPreview.style.display = "block";
    document.getElementById("cropBtn").style.display = "none";
    document.getElementById("imageAdjustments").style.display = "none";
  } else {
    preview.style.display = "none";
    pdfPreview.style.display = "none";
    document.getElementById("cropBtn").style.display = "none";
    document.getElementById("imageAdjustments").style.display = "none";
  }
};

/* ===== ã‚¯ãƒªã‚¢ ===== */
function clearForm() {
  const now = new Date();
  const y = now.getFullYear();
  const m = (now.getMonth() + 1).toString().padStart(2, '0');
  const d = now.getDate().toString().padStart(2, '0');
  date.value = `${y}-${m}-${d}`;
  amount.value = "";
  vendor.value = "";
  description.value = "";
  file.value = "";
  preview.src = "";
  preview.style.display = "none";
  document.getElementById("pdfPreview").src = "";
  document.getElementById("pdfPreview").style.display = "none";
  document.getElementById("cropBtn").style.display = "none";
  document.getElementById("imageAdjustments").style.display = "none";
}

/* ===== ãƒˆãƒªãƒŸãƒ³ã‚°æ©Ÿèƒ½ ===== */
let cropper;

function startCropping() {
  const f = file.files[0];
  if (!f) return;
  
  const modal = document.getElementById("cropModal");
  const img = document.getElementById("cropImage");
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå‰ã«ç”»åƒã‚’ã‚»ãƒƒãƒˆ
  img.src = URL.createObjectURL(f);
  modal.style.display = "flex";
  
  // CropperåˆæœŸåŒ–
  if (cropper) cropper.destroy();
  cropper = new Cropper(img, {
    viewMode: 1,
    autoCropArea: 0.9,
  });
}

function rotateImage(degree) {
  if (cropper) cropper.rotate(degree);
}

function applyCrop() {
  if (!cropper) return;
  
  cropper.getCroppedCanvas().toBlob((blob) => {
    const originalFile = file.files[0];
    const newFile = new File([blob], originalFile.name, { type: "image/png" });
    
    const dt = new DataTransfer();
    dt.items.add(newFile);
    file.files = dt.files;
    
    preview.src = URL.createObjectURL(newFile);
    cancelCrop();
  }, "image/png");
}

function cancelCrop() {
  document.getElementById("cropModal").style.display = "none";
  if (cropper) cropper.destroy();
  cropper = null;
}

/* ===== å–å¼•å…ˆå±¥æ­´æ›´æ–° ===== */
function updateVendorHistory() {
  const tx = db.transaction("receipts", "readonly");
  const store = tx.objectStore("receipts");
  // å…¨ä»¶å–å¾—ã—ã¦JSã§ã‚½ãƒ¼ãƒˆãƒ»æŠ½å‡º
  store.getAll().onsuccess = e => {
    const all = e.target.result;
    // savedAtã®é™é †ï¼ˆæ–°ã—ã„é †ï¼‰
    all.sort((a, b) => (new Date(a.savedAt) < new Date(b.savedAt) ? 1 : -1));

    const history = [];
    const seen = new Set();
    for (const r of all) {
      if (r.vendor && !seen.has(r.vendor)) {
        seen.add(r.vendor);
        history.push(r.vendor);
        if (history.length >= historyLimit) break; // è¨­å®šä»¶æ•°ã‚’è¡¨ç¤º
      }
    }

    const container = document.getElementById("vendorHistory");
    container.innerHTML = "";
    if (history.length > 0) {
      container.textContent = "å–å¼•å…ˆ: ";
      history.forEach(v => {
        const span = document.createElement("span");
        span.textContent = v;
        span.style.cssText = "display:inline-block; margin-right:8px; cursor:pointer; text-decoration:underline; color:blue;";
        span.onclick = () => { vendor.value = v; };
        container.appendChild(span);
      });
    }
  };
}

/* ===== å†…å®¹å±¥æ­´æ›´æ–° ===== */
function updateDescHistory() {
  const tx = db.transaction("receipts", "readonly");
  const store = tx.objectStore("receipts");
  store.getAll().onsuccess = e => {
    const all = e.target.result;
    all.sort((a, b) => (new Date(a.savedAt) < new Date(b.savedAt) ? 1 : -1));

    const history = [];
    const seen = new Set();
    for (const r of all) {
      if (r.description && !seen.has(r.description)) {
        seen.add(r.description);
        history.push(r.description);
        if (history.length >= historyLimit) break;
      }
    }

    const container = document.getElementById("descHistory");
    container.innerHTML = "";
    if (history.length > 0) {
      container.textContent = "å†…å®¹å±¥æ­´: ";
      history.forEach(v => {
        const span = document.createElement("span");
        span.textContent = v;
        span.style.cssText = "display:inline-block; margin-right:8px; cursor:pointer; text-decoration:underline; color:blue;";
        span.onclick = () => { description.value = v; };
        container.appendChild(span);
      });
    }
  };
}

/* ===== ç™»éŒ² ===== */
async function save() {
  let f = file.files[0];
  const amountVal = amount.value.replace(/,/g, ""); // ã‚«ãƒ³ãƒã‚’é™¤å»
  if (!date.value) return alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (!amountVal) return alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (!vendor.value) return alert("å–å¼•å…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (!f) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
  if (currentYear !== CURRENT_YEAR && isPastLocked) return alert("éå»ã®å¹´åº¦ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™");

  // ç”»åƒèª¿æ•´ãƒ»åœ§ç¸®å‡¦ç†
  if (f.type.startsWith("image/")) {
    const brightness = parseInt(document.getElementById("brightnessRange").value, 10);
    try {
      f = await processImage(f, brightness);
    } catch (e) {
      console.error("Image processing error:", e);
    }
  }

  const buf = await f.arrayBuffer();
  const hash = await crypto.subtle.digest("SHA-256", buf);
  const hashHex = [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2,"0")).join("");

  const tx = db.transaction("receipts", "readwrite");
  tx.objectStore("receipts").add({
    id: crypto.randomUUID(),
    fiscalYear: currentYear,
    date: date.value,
    amount: Number(amountVal),
    vendor: vendor.value,
    description: description.value,
    file: f,
    hash: hashHex,
    savedAt: new Date().toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }),
    locked: true
  });

  alert("ä¿å­˜ã—ã¾ã—ãŸ");
  updateYearSummary();
  clearForm();
  updateVendorHistory();
  updateDescHistory();
  checkAndRunAutoBackup();
}

/* ===== é‡‘é¡å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ===== */
function removeComma(input) {
  if (input.value) {
    input.value = input.value.replace(/,/g, "");
  }
}

function addComma(input) {
  const val = input.value.replace(/,/g, "");
  if (val && !isNaN(val)) {
    input.value = Number(val).toLocaleString();
  }
}

/* ===== æ¤œç´¢ ===== */
function search() {
  result.innerHTML = "";
  const excludeVal = document.getElementById("excludeSearch").value.trim();
  if (excludeVal) {
    saveExcludeHistory(excludeVal);
    updateExcludeHistory();
  }

  const tx = db.transaction("receipts", "readonly");
  const index = tx.objectStore("receipts").index("fiscalYear");
  index.openCursor(IDBKeyRange.only(currentYear)).onsuccess = e => {
    const c = e.target.result;
    if (!c) return;
    const r = c.value;

    if (
      (!from.value || r.date >= from.value) &&
      (!to.value || r.date <= to.value) &&
      (!min.value || r.amount >= min.value) &&
      (!max.value || r.amount <= max.value) &&
      (!vendorSearch.value || r.vendor.includes(vendorSearch.value)) &&
      (!descSearch.value || (r.description && r.description.includes(descSearch.value))) &&
      (!excludeVal || !((r.vendor && r.vendor.includes(excludeVal)) || (r.description && r.description.includes(excludeVal))))
    ) {
      const tr = document.createElement("tr");
      const savedAtStr = r.savedAt.includes("T") ? new Date(r.savedAt).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }) : r.savedAt;
      const amountStr = "Â¥" + r.amount.toLocaleString();
      [r.date, amountStr, r.vendor, r.description || "", savedAtStr].forEach(text => {
        const td = document.createElement("td");
        td.textContent = text;
        tr.appendChild(td);
      });

      const tdImg = document.createElement("td");
      if (r.file) {
        const url = URL.createObjectURL(r.file);
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        
        if (r.file.type === "application/pdf") {
          a.textContent = "ğŸ“„PDF";
          a.style.color = "#d32f2f";
          a.style.fontWeight = "bold";
          a.style.textDecoration = "none";
        } else {
          const img = document.createElement("img");
          img.src = url;
          img.style.maxWidth = "80px";
          img.style.maxHeight = "80px";
          a.appendChild(img);
        }
        tdImg.appendChild(a);
      }
      tr.appendChild(tdImg);

      const tdOp = document.createElement("td");
      if (r.deletedAt) {
        tdOp.innerHTML = `<span style="color:red; font-weight:bold;">å‰Šé™¤æ¸ˆã¿</span><br><span style="font-size:0.8em; color:red;">${r.deletedAt}</span>`;
        tr.style.backgroundColor = "#fff0f0";
      } else {
        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.onclick = () => deleteReceipt(r.id);
        tdOp.appendChild(delBtn);
      }
      tr.appendChild(tdOp);
      result.appendChild(tr);
    }
    c.continue();
  };
}

/* ===== æ¤œç´¢ã‚¯ãƒªã‚¢ ===== */
function clearSearch() {
  from.value = "";
  to.value = "";
  min.value = "";
  max.value = "";
  vendorSearch.value = "";
  descSearch.value = "";
  document.getElementById("excludeSearch").value = "";
  result.innerHTML = "";
}

/* ===== é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±¥æ­´ ===== */
function saveExcludeHistory(val) {
  let history = JSON.parse(localStorage.getItem("excludeHistory")) || [];
  history = history.filter(h => h !== val);
  history.unshift(val);
  if (history.length > historyLimit) history.length = historyLimit;
  localStorage.setItem("excludeHistory", JSON.stringify(history));
}

function updateExcludeHistory() {
  const container = document.getElementById("excludeHistory");
  if (!container) return;
  
  const history = JSON.parse(localStorage.getItem("excludeHistory")) || [];
  container.innerHTML = "";
  
  if (history.length > 0) {
    container.textContent = "å±¥æ­´: ";
    history.forEach(v => {
      const span = document.createElement("span");
      span.textContent = v;
      span.style.cssText = "display:inline-block; margin-right:8px; cursor:pointer; text-decoration:underline; color:blue;";
      span.onclick = () => { document.getElementById("excludeSearch").value = v; };
      container.appendChild(span);
    });
    const clearBtn = document.createElement("span");
    clearBtn.textContent = "[å±¥æ­´å‰Šé™¤]";
    clearBtn.style.cssText = "cursor:pointer; color:red; font-size:0.8em; margin-left:5px;";
    clearBtn.onclick = () => { localStorage.removeItem("excludeHistory"); updateExcludeHistory(); };
    container.appendChild(clearBtn);
  }
}

/* ===== å‰Šé™¤å‡¦ç† ===== */
function deleteReceipt(id) {
  if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å‰Šé™¤å±¥æ­´ãŒæ®‹ã‚Šã¾ã™")) return;
  
  const tx = db.transaction("receipts", "readwrite");
  const store = tx.objectStore("receipts");
  const req = store.get(id);
  
  req.onsuccess = () => {
    const data = req.result;
    if (data) {
      if (isPastLocked && data.fiscalYear !== CURRENT_YEAR) {
        alert("éå»ã®å¹´åº¦ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚\nå‰Šé™¤ã™ã‚‹ã«ã¯ä¿å®ˆç”»é¢ã§ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„ã€‚");
        tx.abort(); // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸­æ­¢
        return;
      }
      data.deletedAt = new Date().toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }); // å‰Šé™¤æ—¥æ™‚ã‚’è¨˜éŒ²(JST)
      store.put(data);
      alert("å‰Šé™¤ã—ã¾ã—ãŸ");
      search();
      updateYearSummary();
    }
  };
  // tx.oncompleteã§ã®alertã¯å‰Šé™¤ã—ã€onsuccesså†…ã§å‡¦ç†å®Œäº†å¾Œã«å®Ÿè¡Œ
}

/* ===== å¹´åº¦åˆ¥åˆè¨ˆ ===== */
function updateYearSummary() {
  let total = 0;
  const tx = db.transaction("receipts", "readonly");
  tx.objectStore("receipts").openCursor().onsuccess = e => {
    const c = e.target.result;
    if (!c) {
      yearSummary.textContent =
        `${currentYear}å¹´åº¦ åˆè¨ˆé‡‘é¡ï¼šÂ¥${total.toLocaleString()}`;
      return;
    }
    if (c.value.fiscalYear === currentYear && !c.value.deletedAt) total += c.value.amount;
    c.continue();
  };
}

/* ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ˜ãƒ«ãƒ‘ãƒ¼ (File System Access APIå¯¾å¿œ) */
async function saveFileToDirectory(filename, contentBlob) {
  if (backupDirectoryHandle) {
    try {
      // æ¨©é™ç¢ºèª
      const opts = { mode: 'readwrite' };
      if ((await backupDirectoryHandle.queryPermission(opts)) !== 'granted') {
        if ((await backupDirectoryHandle.requestPermission(opts)) !== 'granted') {
          throw new Error("ä¿å­˜æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
        }
      }
      const fileHandle = await backupDirectoryHandle.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(contentBlob);
      await writable.close();
      return true; // ä¿å­˜æˆåŠŸ
    } catch (e) {
      console.error("Directory save failed:", e);
      // å¤±æ•—æ™‚ã¯falseã‚’è¿”ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã›ã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã‹
      // ã“ã“ã§ã¯è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç­‰ã®å…¼ã­åˆã„ã‚‚ã‚ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãªã‚‰false
      return false;
    }
  }
  return false;
}

/* ===== è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ===== */
async function backupYear(year) {
  const tx = db.transaction("receipts", "readonly");
  const store = tx.objectStore("receipts");
  const index = store.index("fiscalYear");

  // æŒ‡å®šå¹´åº¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ä»¶å–å¾—
  const records = await new Promise(resolve => {
    index.getAll(IDBKeyRange.only(year)).onsuccess = e => resolve(e.target.result);
  });

  const rows = [["å¹´åº¦", "æ—¥ä»˜", "é‡‘é¡", "å–å¼•å…ˆ", "å†…å®¹", "ä¿å­˜æ—¥æ™‚", "ãƒãƒƒã‚·ãƒ¥"]];
  const json = [];

  for (const r of records) {
    rows.push([r.fiscalYear, r.date, r.amount, r.vendor, r.description || "", r.savedAt, r.hash]);
    
    // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Base64ã«å¤‰æ›ã—ã¦JSONã«å«ã‚ã‚‹
    const item = { ...r };
    if (item.file instanceof Blob) {
      item.fileData = await blobToBase64(item.file);
      delete item.file; // Blobã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯JSONåŒ–ã§ããªã„ãŸã‚å‰Šé™¤
    }
    json.push(item);
  }

  let filename = `${backupPrefix}_backup_${year}`;
  if (isBackupDate) filename += "_" + getYYYYMMDD();
  
  const csvBlob = new Blob([rows.map(r => r.join(",")).join("\n")], { type: "text/csv" });
  const jsonBlob = new Blob([JSON.stringify(json, null, 2)], { type: "application/json" });

  // è¨­å®šæ¸ˆã¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Œã°ãã“ã«ä¿å­˜
  if (backupDirectoryHandle) {
    const savedCsv = await saveFileToDirectory(filename + ".csv", csvBlob);
    const savedJson = await saveFileToDirectory(filename + ".json", jsonBlob);
    if (savedCsv && savedJson) {
      alert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã€Œ${backupDirectoryHandle.name}ã€ã«ä¿å­˜ã—ã¾ã—ãŸ`);
      return;
    }
  }

  // è¨­å®šãŒãªã„ã€ã¾ãŸã¯ä¿å­˜å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’ä¿ƒã™ï¼ˆæ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ™‚ã®ã¿ï¼‰
  // ã“ã“ã§ã¯backupYearã¯æ‰‹å‹•å‘¼ã³å‡ºã—å‰æãªã®ã§ã€ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’è©¦ã¿ã‚‹
  if (!backupDirectoryHandle && window.showDirectoryPicker) {
    if (confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\n(é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã¯æ¬¡å›ä»¥é™ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™)")) {
      await selectBackupDirectory();
      // å†å¸°çš„ã«å‘¼ã³å‡ºã—ã¦ä¿å­˜è©¦è¡Œ
      if (backupDirectoryHandle) {
        await backupYear(year);
        return;
      }
    }
  }

  // æœ€çµ‚æ‰‹æ®µï¼šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  download(csvBlob, filename + ".csv");
  download(jsonBlob, filename + ".json");
}

/* ===== ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ===== */
async function importData() {
  const fileInput = document.getElementById("importFile");
  const file = fileInput.files[0];
  if (!file) return alert("ãƒ•ã‚¡ã‚¤ãƒ«(JSON)ã‚’é¸æŠã—ã¦ãã ã•ã„");
  const mode = document.querySelector('input[name="importMode"]:checked').value; // overwrite or skip

  if (!confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã«ä¸Šæ›¸ããƒ»è¿½åŠ ã•ã‚Œã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

  try {
    const text = await file.text();
    const data = JSON.parse(text);

    if (!Array.isArray(data)) throw new Error("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");

    const tx = db.transaction("receipts", "readwrite");
    const store = tx.objectStore("receipts");

    // ã‚¹ã‚­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ—¢å­˜IDã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«å…¨ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãŠãï¼ˆä»¶æ•°ãŒå¤šã„å ´åˆã¯åˆ¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¨å¥¨ã ãŒä»Šå›ã¯ç°¡æ˜“å®Ÿè£…ï¼‰
    let existingIds = new Set();
    if (mode === "skip") {
      const keys = await new Promise((resolve) => {
        store.getAllKeys().onsuccess = (e) => resolve(e.target.result);
      });
      existingIds = new Set(keys);
    }
    
    let count = 0;
    let skipped = 0;
    for (const item of data) {
      if (mode === "skip" && existingIds.has(item.id)) {
        skipped++;
        continue;
      }

      // Base64ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯Blob(File)ã«å¾©å…ƒ
      if (item.fileData) {
        const res = await fetch(item.fileData);
        const blob = await res.blob();
        item.file = new File([blob], "restored_file", { type: blob.type });
        delete item.fileData;
      } else if (item.file && !(item.file instanceof Blob)) {
        delete item.file;
      }
      store.put(item);
      count++;
    }

    tx.oncomplete = () => {
      alert(`${count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚(ã‚¹ã‚­ãƒƒãƒ—: ${skipped}ä»¶)\nç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚`);
      location.reload();
    };
    tx.onerror = (e) => alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.target.error);
  } catch (err) {
    alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: " + err.message);
  }
}

/* ===== å…¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– ===== */
function showResetUI() {
  document.getElementById("resetUI").style.display = "block";
  document.getElementById("initBtn").disabled = true;
}

function hideResetUI() {
  document.getElementById("resetUI").style.display = "none";
  document.getElementById("initBtn").disabled = false;
  document.getElementById("resetConfirmInput").value = "";
}

async function executeReset() {
  const input = document.getElementById("resetConfirmInput").value;
  if (!input || input !== "åˆæœŸåŒ–") {
    alert("æ‰¿èªãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  
  // å…¨ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  await backupAll();

  // å‰Šé™¤å‡¦ç†
  const tx = db.transaction("receipts", "readwrite");
  tx.objectStore("receipts").clear();
  tx.oncomplete = () => {
    alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚");
    location.reload();
  };
}

async function backupAll() {
  const tx = db.transaction("receipts", "readonly");
  const store = tx.objectStore("receipts");

  // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const records = await new Promise(resolve => {
    store.getAll().onsuccess = e => resolve(e.target.result);
  });

  const rows = [["å¹´åº¦", "æ—¥ä»˜", "é‡‘é¡", "å–å¼•å…ˆ", "å†…å®¹", "ä¿å­˜æ—¥æ™‚", "ãƒãƒƒã‚·ãƒ¥", "å‰Šé™¤æ—¥æ™‚"]];
  const json = [];

  for (const v of records) {
    rows.push([v.fiscalYear, v.date, v.amount, v.vendor, v.description || "", v.savedAt, v.hash, v.deletedAt || ""]);
    
    // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Base64ã«å¤‰æ›
    const item = { ...v };
    if (item.file instanceof Blob) {
      item.fileData = await blobToBase64(item.file);
      delete item.file;
    }
    json.push(item);
  }

  let filename = `${backupPrefix}_backup_ALL`;
  if (isBackupDate) {
    filename += "_" + getYYYYMMDD();
  } else {
    filename += "_" + Date.now();
  }
  
  const csvBlob = new Blob([rows.map(r => r.join(",")).join("\n")], { type: "text/csv" });
  const jsonBlob = new Blob([JSON.stringify(json, null, 2)], { type: "application/json" });

  // è¨­å®šæ¸ˆã¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Œã°ãã“ã«ä¿å­˜
  if (backupDirectoryHandle) {
    const savedCsv = await saveFileToDirectory(filename + ".csv", csvBlob);
    const savedJson = await saveFileToDirectory(filename + ".json", jsonBlob);
    if (savedCsv && savedJson) {
      // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å‘¼ã³å‡ºã—æ™‚ã¯alertã‚’å‡ºã•ãªã„åˆ¶å¾¡ãŒå¿…è¦ã ãŒã€
      // backupAllã¯æ‰‹å‹•å‘¼ã³å‡ºã—ã¨è‡ªå‹•å‘¼ã³å‡ºã—(checkAndRunAutoBackup)ã®ä¸¡æ–¹ãŒã‚ã‚‹ã€‚
      // checkAndRunAutoBackupå´ã§åˆ¶å¾¡ã™ã‚‹ã‹ã€ã“ã“ã§ã¯æˆåŠŸã‚’è¿”ã™ã ã‘ã«ã™ã‚‹ã®ãŒè‰¯ã„ã€‚
      // ä»Šå›ã¯ç°¡æ˜“çš„ã«ã€æ‰‹å‹•å‘¼ã³å‡ºã—ã®UXã‚’å„ªå…ˆã—ã¦alertã¯å‡ºã•ãªã„ï¼ˆToastã§é€šçŸ¥æ¸ˆã¿ã®å ´åˆã‚‚ã‚ã‚‹ãŸã‚ï¼‰
      // ãŸã ã—æ‰‹å‹•æ™‚ã¯ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒæ¬²ã—ã„ã®ã§ã€å‘¼ã³å‡ºã—å…ƒã§åˆ¤æ–­ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã€‚
      return; 
    }
  }

  // è¨­å®šãŒãªã„å ´åˆï¼ˆæ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ™‚ï¼‰
  // checkAndRunAutoBackupã‹ã‚‰å‘¼ã°ã‚ŒãŸå ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾è©±ã§ããªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã¹ãã ãŒã€
  // backupAllã¯æ‰‹å‹•ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚‚å‘¼ã°ã‚Œã‚‹ã€‚
  // ã“ã“ã§ã¯ã€Œæ‰‹å‹•å®Ÿè¡Œã‹ã¤è¨­å®šãªã—ã€ã‚’åˆ¤å®šã™ã‚‹ã®ã¯é›£ã—ã„ã®ã§ã€
  // ç°¡æ˜“çš„ã«ã€Œè¨­å®šãªã—ãªã‚‰ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’ä¿ƒã™ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã€‚
  // ãŸã ã—è‡ªå‹•å®Ÿè¡Œä¸­ã«confirmãŒå‡ºã‚‹ã¨ã¾ãšã„ã®ã§ã€å¼•æ•°ã§åˆ¶å¾¡ã™ã‚‹ã€‚
  
  // â€»backupAllã®å¼•æ•°æ‹¡å¼µã¯æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿ãŒã‚ã‚‹ãŸã‚ã€
  // ã“ã“ã§ã¯ã€Œè¨­å®šãªã—ãªã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã®åŸºæœ¬å‹•ä½œã«åŠ ãˆã€
  // æ‰‹å‹•ãƒœã‚¿ãƒ³ã®onclickå´ã§åˆ¶å¾¡ã™ã‚‹ã®ãŒç†æƒ³ã ãŒã€ä»Šå›ã¯é–¢æ•°å†…ã§å‡¦ç†ã™ã‚‹ã€‚
  
  // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã©ã†ã‹ã¯å‘¼ã³å‡ºã—å…ƒã§åˆ¤æ–­ã§ããªã„ãŸã‚ã€
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆconfirm/showDirectoryPickerï¼‰ã¯
  // ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆå†…ã€ã§ãªã„ã¨ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
  // ã—ãŸãŒã£ã¦ã€è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ™‚ã¯ã“ã‚Œã‚‰ã¯ç„¡è¦–ã•ã‚Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã¾ãŸã¯å¤±æ•—ï¼‰ã«ãªã‚‹ã€‚
  
  try {
    if (!backupDirectoryHandle && window.showDirectoryPicker) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆå†…ã§ã‚ã‚Œã°ã“ã‚ŒãŒæ©Ÿèƒ½ã™ã‚‹
      if (confirm("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\n(é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã¯æ¬¡å›ä»¥é™ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™)")) {
        await selectBackupDirectory();
        if (backupDirectoryHandle) {
          const savedCsv = await saveFileToDirectory(filename + ".csv", csvBlob);
          const savedJson = await saveFileToDirectory(filename + ".json", jsonBlob);
          if (savedCsv && savedJson) {
             alert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã€Œ${backupDirectoryHandle.name}ã€ã«ä¿å­˜ã—ã¾ã—ãŸ`);
             return;
          }
        }
      }
    }
  } catch(e) {
    // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ™‚ãªã©ã«confirm/pickerãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ã“ã“ã«æ¥ã‚‹
    console.log("Manual directory selection skipped or failed:", e);
  }

  download(csvBlob, filename + ".csv");
  download(jsonBlob, filename + ".json");
}

function download(blob, name) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

/* Blobã‚’Base64(DataURL)ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° */
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

/* ===== ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç† ===== */
async function updateStorageInfo() {
  if (navigator.storage && navigator.storage.estimate) {
    const { usage, quota } = await navigator.storage.estimate();
    const usageMB = (usage / 1024 / 1024).toFixed(2);
    const quotaMB = (quota / 1024 / 1024).toFixed(2);
    document.getElementById("storageUsage").textContent = `${usageMB} MB`;
    document.getElementById("storageQuota").textContent = `${quotaMB} MB`;
    
    const persisted = await navigator.storage.persisted();
    const pElem = document.getElementById("storagePersisted");
    pElem.textContent = persisted ? "æœ‰åŠ¹ (è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã›ã‚“)" : "ç„¡åŠ¹ (ç©ºãå®¹é‡ä¸è¶³æ™‚ã«å‰Šé™¤ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)";
    pElem.style.color = persisted ? "green" : "red";
    document.getElementById("persistBtn").disabled = persisted;
  }
}

async function requestPersistence() {
  if (navigator.storage && navigator.storage.persist) {
    const isPersisted = await navigator.storage.persist();
    alert(isPersisted ? "æ°¸ç¶šåŒ–ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ" : "æ°¸ç¶šåŒ–ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n(ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½¿ç”¨é »åº¦ç­‰ã«ã‚ˆã‚Šè‡ªå‹•åˆ¤å®šã•ã‚Œã¾ã™)");
    updateStorageInfo();
  }
}

/* ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒˆãƒƒãƒ—æ©Ÿèƒ½ ===== */
window.onscroll = function() {
  const btn = document.getElementById("scrollTopBtn");
  if (btn) {
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
      btn.style.display = "flex";
    } else {
      btn.style.display = "none";
    }
  }
};

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>

</div><!-- /container -->

</body>
</html>
